/*! For license information please see 774.a294ec74c4842a233ebe.js.LICENSE.txt */
"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[774],{73927:(t,a,i)=>{i.d(a,{h:()=>s});var e=i(89103);class s extends e.QB{constructor(t,a){super(),this.width=t,this.height=a}}},27960:(t,a,i)=>{i.d(a,{d:()=>s});var e=i(52018);class s extends e.t{constructor(t="Unhandled Transition Exception"){super(t),this.name="TransitionException"}}},33790:(t,a,i)=>{i.r(a),i.d(a,{TRANSITION_DISTANCE_MULTIPLIER:()=>F,baseTransitionSpeedKey:()=>E,default:()=>q});var e=i(68909);var s=i(52885),o=i(68062),r=i(73927),n=i(75578),c=i(20599),h=i(89103);class m extends h.QB{constructor(t,a){super(),this.from=a,this.to=t,this.timestamp=Date.now()}}class p extends m{}var l=i(31093),D=i(94814),u=i(62568),d=i(25316),T=i(37105),f=i(3249),y=i(48734),v=i(13893),g=i(55141);class b extends g.u{}b.id="RESET_PITCH";class x extends g.u{}x.id="ENABLE_AUTO_ORTHO";class k extends g.u{}k.id="DISABLE_AUTO_ORTHO";var B=i(27960);class P extends B.d{constructor(t="Unhandled Camera Exception"){super(t),this.name="CameraTransitionException"}}class w extends B.d{constructor(t="Cannot move while the camera is already moving"){super(t),this.name="CameraTransitionException"}}var S=i(3066);class C{constructor(t,a){this.proxy=t,this.target=a}updateCameraPose(t){this.proxy.activeSession(this)&&this.target.updateCameraPose(t)}beginExternalTransition(){this.proxy.activeSession(this)&&this.target.beginExternalTransition()}endExternalTransition(){this.proxy.activeSession(this)&&this.target.endExternalTransition()}updateCameraPosition(t){this.proxy.activeSession(this)&&this.target.updateCameraPosition(t)}updateCameraRotation(t){this.proxy.activeSession(this)&&this.target.updateCameraRotation(t)}updateCameraFocus(t){this.proxy.activeSession(this)&&this.target.updateCameraFocus(t)}updateCameraProjection(t){this.proxy.activeSession(this)&&this.target.updateCameraProjection(t)}moveTo(t){return this.proxy.activeSession(this)?this.target.moveTo(t):l.i.resolve()}setBaseProjection(t){this.proxy.activeSession(this)&&this.target.setBaseProjection(t)}async cancelTransition(){if(this.proxy.activeSession(this))return this.target.cancelTransition()}updateTransitionSpeed(t){this.proxy.activeSession(this)&&this.target.updateTransitionSpeed(t)}}class j{constructor(t,a){this.controller=t,this.data=a,this.proxies=[]}get pose(){return this.data}activeSession(t){if(0===this.proxies.length)return!1;return this.proxies[this.proxies.length-1].controller===t}newSession(t){let a=null;if(-1!==this.proxies.findIndex((a=>a.requester===t)))throw new Error("Cannot create two sessions with the same requester");return(0,S.Sh)((()=>{if(!a){if(this.proxies.length>0){const t=this.proxies[this.proxies.length-1];t.requester.onAccessRevoked(t.controller)}a=new C(this,this.controller),this.proxies.push({controller:a,requester:t}),t.onAccessGranted(a)}}),(()=>{if(a){const t=this.proxies.findIndex((t=>t.controller===a));if(-1!==t){const a=this.proxies[t],i=t===this.proxies.length-1;if(i&&a.requester.onAccessRevoked(a.controller),this.proxies.splice(t,1),this.proxies.length>0&&i){const t=this.proxies[this.proxies.length-1];t.requester.onAccessGranted(t.controller)}}}}))}}var O=i(19968),A=i(45832);const I={[v.fl.Instant]:{blackoutTime:0,transitionTime:0},[v.fl.FadeToBlack]:{blackoutTime:u.Ay.camera.transitionBlackoutTime,transitionTime:2*u.Ay.camera.transitionBlackoutTime},[v.fl.Interpolate]:{blackoutTime:0,transitionTime:u.Ay.camera.transitionFadeTime},[v.fl.MoveToBlack]:{blackoutTime:u.Ay.camera.transitionBlackoutTime,transitionTime:u.Ay.camera.transitionFadeTime},[v.fl.OrbitTo]:{blackoutTime:0,transitionTime:u.Ay.camera.transitionFadeTime}},F=166,E="Transition time";class q extends n.n{constructor(){super(...arguments),this.name="camera-data",this.transitionSpeed=u.Ay.camera.transitionSpeed,this.baseTransitionTime=u.Ay.camera.baseTransitionTime,this.eulerCache=new e.Euler,this.quaternionCache=new e.Quaternion,this.computeOrbitDistance=()=>{if(this.visibleMeshBounds){const t=this.cameraData.pose,a=new e.Ray(t.position.clone(),t.forward().clone());return this.visibleMeshBounds.computeFocusPoint(a).distanceTo(t.position)/t.fovDistanceScale()}return this.cameraData.pose.fovCorrectedFocalDistance()}}async init(t,a){this.engine=a,this.market=a.market,this.canvas=await a.market.waitForData(T.p),this.cameraData=new c.M(this.canvas.width,this.canvas.height),this.market.register(c.M,this.cameraData),this.cameraPoseProxy=((t,a)=>new j(t,a))(this,this.cameraData.pose),a.market.waitForData(d.o).then((t=>{this.bindings.push(t.onPropertyChanged(E,(t=>{this.baseTransitionTime=t})),a.commandBinder.addBinding(x,(async()=>{this.cameraData.setAutoOrtho(!0)})),a.commandBinder.addBinding(k,(async()=>{this.cameraData.setAutoOrtho(!1)})))})),a.getModuleBySymbol(A.UN).then((t=>this.visibleMeshBounds=t)),this.bindings.push(a.commandBinder.addBinding(b,(async()=>this.resetPitch())),a.subscribe(r.h,(t=>this.cameraData.setCameraDimensions(t.width,t.height))))}onUpdate(t){}fromPose(t=!1){const a=this.cameraData.pose;return{position:t?a.fovCorrectedPosition().clone():a.position.clone(),rotation:a.rotation.clone(),projection:a.projection.clone(),focalDistance:t?a.fovCorrectedFocalDistance():a.focalDistance}}updateCameraPosition(t){this.cameraData.pose.position.copy(t),this.cameraData.pose.commit()}updateCameraProjection(t){this.cameraData.pose.projection.copy(t),this.cameraData.pose.commit()}updateCameraFocus(t){this.cameraData.pose.focalDistance=t,this.cameraData.pose.commit()}updateCameraRotation(t){this.cameraData.pose.rotation.copy(t),this.cameraData.pose.commit()}updateCameraPose(t){this.cameraData.pose.copy(t),this.cameraData.pose.commit()}resetPitch(){this.eulerCache.setFromQuaternion(this.cameraData.pose.rotation,"YXZ"),this.eulerCache.x=0,this.eulerCache.z=0,this.quaternionCache.setFromEuler(this.eulerCache),this.updateCameraRotation(this.quaternionCache)}canTransition(){return this.cameraData.canTransition()}moveTo(t){if(!this.canTransition())return l.i.reject(new w("Tried to start transition while another transition was active"));const a=I[t.transitionType],i=t.pose.rotation,e=t.pose.position,s=null==t.fadeToBlackSubType?v.pw.Full:t.fadeToBlackSubType;let r=t.projection;t.autoOrtho?r=void 0:t.pose.zoom&&(r&&(0,o.Gp)(r)||this.cameraData.isOrtho())&&(r=this.adjustProjectionZoom(r||this.cameraData.pose.projection.clone(),t.pose.zoom));const n=void 0!==t.blackoutTime?t.blackoutTime:a.blackoutTime,c=t.transitionType,h=t.transitionSpeedMultiplier?1/t.transitionSpeedMultiplier:1;let u=c===v.fl.Instant?0:t.transitionTime;if(void 0===u)if(t.transitionType===v.fl.Interpolate&&e){const t=e.distanceTo(this.cameraData.pose.position);u=this.baseTransitionTime+Math.log2(1+t)*F*this.transitionSpeed*h}else u=a.transitionTime;const d=this.fromPose(!!t.autoOrtho),T=c===v.fl.OrbitTo?t.targetPhi:void 0,g=c===v.fl.OrbitTo?D.p9:t.easing;this.beginInternalTransition({transitionType:c,transitionTime:u,blackoutTime:n,pose:{position:e,rotation:i},autoOrtho:!!t.autoOrtho,projection:r,easing:g,rotationDelay:t.rotationDelay||0,rotationDuration:t.rotationDuration||1,matrixDelay:t.matrixDelay||0,matrixDuration:t.matrixDuration||1,focalDistance:t.focalDistance||d.focalDistance,targetPhi:T,fadeToBlackSubType:s});const b={position:t.pose.position?t.pose.position.clone():void 0,rotation:t.pose.rotation?t.pose.rotation.clone():void 0,projection:t.projection?t.projection.clone():void 0,focalDistance:t.focalDistance?t.focalDistance:void 0};this.engine.broadcast(new m(b,d));const x=this.cameraData.transition.promise;if(!x)return l.i.reject(new P("Expected promise to have been created."));const k=this.progressInternalTransition.bind(this),B=this.shouldProgressInternalTransition.bind(this),S=this.endInternalTransition.bind(this),C=this;return x.notify(0),this.engine.startGenerator((function*(){let a=16;for(a>=C.cameraData.transition.duration&&(x.notify(.5),yield new y.oN);B(a);){k(a,n);const t=(0,f.qE)(a/C.cameraData.transition.duration,0,1);x.notify(t),yield new y.oN,a=16+Date.now()-C.cameraData.transition.startTime}S(t.transitionType),C.cameraData.commit(),x.notify(1),x.resolve(),C.engine.broadcast(new p(b,d))})),x.promise()}setBaseProjection(t){this.cameraData.setBaseProjection(t)}async cancelTransition(){if(this.cameraData.transition.active)return new Promise((t=>{(0,c.q)(this.cameraData.pose,this.cameraData.transition.to,!1);const a=Date.now()-this.cameraData.transition.startTime;this.cameraData.transition.duration=a,this.cameraData.transition.progress.stop(1),this.cameraData.pose.commit(),this.cameraData.transition.commit();const i=this.cameraData.transition.onPropertyChanged("active",(a=>{a||(i&&i.cancel(),t())}))}))}updateTransitionSpeed(t){if(this.cameraData.transition.active){const a=Date.now(),i=a-this.cameraData.transition.startTime,e=i/t,s=this.cameraData.transition.progress,o=(s.duration-i)/t+e;this.cameraData.transition.duration=o,this.cameraData.transition.startTime=a-e,s.modifyAnimation(s.value,s.endValue,o,s.easing,e),this.cameraData.transition.commit()}}beginExternalTransition(){this.cameraData.transition.activeInternal||(this.cameraData.transition.startTime=Date.now(),this.cameraData.transition.active=!0,this.cameraData.transition.promise=new l.i,this.cameraData.transition.commit())}endExternalTransition(){var t;this.cameraData.transition.activeInternal||(this.cameraData.transition.active=!1,null===(t=this.cameraData.transition.promise)||void 0===t||t.resolve(),this.cameraData.transition.commit())}beginInternalTransition(t){const a=t.transitionTime||0;if(this.cameraData.transition.startTime=Date.now(),this.cameraData.transition.duration=a,this.cameraData.transition.active=!0,this.cameraData.transition.promise=new l.i,this.cameraData.transition.activeInternal=!0,this.cameraData.transition.type=t.transitionType,this.cameraData.transition.progress.modifyAnimation(0,1,a,t.easing||D.dV),this.cameraData.transition.rotationDelay=t.rotationDelay||0,this.cameraData.transition.rotationDuration=t.rotationDuration||1,this.cameraData.transition.matrixDelay=t.matrixDelay||0,this.cameraData.transition.matrixDuration=t.matrixDuration||1,this.cameraData.transition.autoOrtho=!!t.autoOrtho,this.cameraData.transition.fadeToBlackSubType=t.fadeToBlackSubType||v.pw.Full,t.transitionType===v.fl.FadeToBlack&&(this.cameraData.transition.blackoutProgress.modifyAnimation(0,1,t.blackoutTime,D.p9),this.cameraData.transition.fadeToBlackSubType===v.pw.BlackToClear&&this.cameraData.transition.blackoutProgress.updateAbsolute(t.blackoutTime)),t.transitionType===v.fl.MoveToBlack){const t=500;this.cameraData.transition.blackoutProgress.modifyAnimation(0,1,a-2*t,D.sP,0,t)}this.cameraData.transition.from=this.fromPose(!!t.autoOrtho),this.cameraData.transition.to.position=t.pose.position?t.pose.position.clone():void 0,this.cameraData.transition.to.rotation=t.pose.rotation?t.pose.rotation.clone():void 0,this.cameraData.transition.to.projection=t.projection?t.projection.clone():void 0,this.cameraData.transition.to.focalDistance=t.focalDistance?t.focalDistance:void 0,t.transitionType===v.fl.FadeToBlack&&this.cameraData.transition.fadeToBlackSubType===v.pw.BlackToClear&&(0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),null!=t.targetPhi&&(this.cameraData.transition.orbitStartDistance=this.computeOrbitDistance(),this.cameraData.transition.orbitTarget=t.targetPhi,this.cameraData.transition.orbitStartPhi=this.cameraData.pose.phi(),this.cameraData.transition.instantOrbit=!(a>0),this.cameraData.pose.focalDistance=this.cameraData.transition.orbitStartDistance*this.cameraData.pose.fovDistanceScale()),this.cameraData.transition.commit()}shouldProgressInternalTransition(t){return this.cameraData.transition.type===v.fl.OrbitTo?this.cameraData.transition.progress.value<1:t<this.cameraData.transition.duration}progressInternalTransition(t,a){if(this.cameraData.transition.active){if(this.cameraData.transition.progress.updateAbsolute(t),this.cameraData.transition.type===v.fl.Interpolate)this.updateInterpolateTransition();else if(this.cameraData.transition.type===v.fl.FadeToBlack){let i=0;const e=this.cameraData.transition.duration;this.cameraData.transition.fadeToBlackSubType===v.pw.Full?t<=a?i=t:((0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),i=t>=e-a?e-t:a):this.cameraData.transition.fadeToBlackSubType===v.pw.ClearToBlack?t<=a?i=t:((0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),i=a):this.cameraData.transition.fadeToBlackSubType===v.pw.BlackToClear&&(i=t>=e-a?e-t:a),this.cameraData.transition.blackoutProgress.updateAbsolute(i),this.cameraData.transition.progress.updateAbsolute(t<=a?0:e)}else if(this.cameraData.transition.type===v.fl.MoveToBlack){const a=this.cameraData.transition.blackoutProgress;this.updateInterpolateTransition(),a.updateAbsolute(t-a.delay)}else this.cameraData.transition.type===v.fl.OrbitTo&&this.updateOrbitToTransition();this.cameraData.pose.commit(),this.cameraData.transition.commit()}}updateOrbitToTransition(){if(null!=this.cameraData.transition.orbitTarget){const t=(0,O.n4)(this.cameraData.pose,this.cameraData.transition.orbitTarget,this.cameraData.transition.orbitStartPhi,this.cameraData.transition.orbitStartDistance,this.cameraData.transition.instantOrbit,this.cameraData.pose);this.cameraData.transition.progress.updateProgress(t)}}updateInterpolateTransition(){const t=this.cameraData.transition.from,a=this.cameraData.transition.to;if(a.position&&t.position&&this.cameraData.pose.position.copy(t.position).lerp(a.position,this.cameraData.transition.progress.value),a.focalDistance&&t.focalDistance&&(this.cameraData.pose.focalDistance=(0,s.C)(t.focalDistance,a.focalDistance,this.cameraData.transition.progress.value)),a.rotation&&t.rotation){const i=(0,D.jv)(this.cameraData.transition.progress.easing,this.cameraData.transition.progress.value,this.cameraData.transition.progress.elapsed,this.cameraData.transition.progress.duration*this.cameraData.transition.rotationDuration,this.cameraData.transition.rotationDelay);this.cameraData.pose.rotation.copy(t.rotation).slerp(a.rotation,i)}if(this.cameraData.transition.autoOrtho)this.cameraData.pose.resetProjMatrix(),this.cameraData.pose.applyPhiBasedFovSquish();else if(a.projection&&t.projection){const i=(0,D.jv)(D.p_,this.cameraData.transition.progress.value,this.cameraData.transition.progress.elapsed,this.cameraData.transition.progress.duration*this.cameraData.transition.matrixDuration,this.cameraData.transition.matrixDelay);!function(t,a,i,e){const s=e.elements,o=t.elements,r=a.elements;for(let t=0;t<16;t++)s[t]=o[t]*(1-i)+r[t]*i}(t.projection,a.projection,i,this.cameraData.pose.projection)}}endInternalTransition(t){t!==v.fl.OrbitTo&&((0,c.q)(this.cameraData.transition.to,this.cameraData.pose,!1),this.cameraData.transition.autoOrtho&&(this.cameraData.pose.resetProjMatrix(),this.cameraData.pose.applyPhiBasedFovSquish())),this.cameraData.transition.type=null,this.cameraData.transition.active=!1,this.cameraData.transition.activeInternal=!1,this.cameraData.transition.progress.stop(1),t!==v.fl.FadeToBlack&&t!==v.fl.MoveToBlack||(this.cameraData.transition.fadeToBlackSubType===v.pw.ClearToBlack?this.cameraData.transition.blackoutProgress.stop(1):this.cameraData.transition.blackoutProgress.stop(0)),this.cameraData.pose.commit(),this.cameraData.transition.commit()}adjustProjectionZoom(t,a){const i=1/a;return t.elements[0]=i/this.canvas.aspectRatio,t.elements[5]=i,t}}},72354:(t,a,i)=>{i.d(a,{J:()=>o,b:()=>s});var e=i(89103);class s extends e.QB{constructor(t,a){super(),this.mode=t,this.fromMode=a}}class o extends e.QB{constructor(t){super(),this.source=t}}},79388:(t,a,i)=>{i.d(a,{aF:()=>r,lo:()=>s,ul:()=>o});var e=i(89103);class s extends e.QB{constructor(t){super(),this.pixelRatio=t}}class o extends e.QB{constructor(t){super(),this.event=t}}class r extends e.QB{constructor(t){super(),this.event=t}}}}]);