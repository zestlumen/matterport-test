/*! For license information please see split.3c32d1cd1670dc345d04.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[777],{34558:t=>{var e={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetScans"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"scans"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ScanDetails"},directives:[]}]}}]}}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ScanDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"Scan"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"index"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"alignment"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"options"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"timeOfDay"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"anchor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"camera"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vendor"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"captureMode"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"depthCameraType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"cameraTypes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"sensorSerialNumbers"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"serialNumber"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mountCalibrationVersion"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"softwareVersion"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:452}};e.loc.source={body:"query GetScans($modelId: ID!) {\n  model(id: $modelId) {\n    id\n    assets {\n      scans {\n        ...ScanDetails\n      }\n    }\n  }\n}\n\nfragment ScanDetails on Scan {\n  id\n  index\n  name\n  created\n  alignment\n  options\n  url\n  timeOfDay\n  anchor {\n    id\n  }\n  camera {\n    id\n    name\n    vendor\n    model\n    captureMode\n    depthCameraType\n    cameraTypes\n    sensorSerialNumbers\n    serialNumber\n    mountCalibrationVersion\n    softwareVersion\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(t,e){if("FragmentSpread"===t.kind)e.add(t.name.value);else if("VariableDefinition"===t.kind){var s=t.type;"NamedType"===s.kind&&e.add(s.name.value)}t.selectionSet&&t.selectionSet.selections.forEach((function(t){i(t,e)})),t.variableDefinitions&&t.variableDefinitions.forEach((function(t){i(t,e)})),t.definitions&&t.definitions.forEach((function(t){i(t,e)}))}var s={};function n(t,e){for(var i=0;i<t.definitions.length;i++){var s=t.definitions[i];if(s.name&&s.name.value==e)return s}}function o(t,e){var i={kind:t.kind,definitions:[n(t,e)]};t.hasOwnProperty("loc")&&(i.loc=t.loc);var o=s[e]||new Set,a=new Set,r=new Set;for(o.forEach((function(t){r.add(t)}));r.size>0;){var h=r;r=new Set,h.forEach((function(t){a.has(t)||(a.add(t),(s[t]||new Set).forEach((function(t){r.add(t)})))}))}return a.forEach((function(e){var s=n(t,e);s&&i.definitions.push(s)})),i}e.definitions.forEach((function(t){if(t.name){var e=new Set;i(t,e),s[t.name.value]=e}})),t.exports=e,t.exports.GetScans=o(e,"GetScans"),t.exports.ScanDetails=o(e,"ScanDetails")},78671:(t,e,i)=>{"use strict";i.d(e,{I:()=>s});const s="spaces.sdk.qa"},84917:(t,e,i)=>{"use strict";var s;function n(t){const e=new Date;e.setHours(0,0,0,0),t.setHours(0,0,0,0);const i=(e.getTime()-t.getTime())/864e5;if(0===i)return s.TODAY;if(1===i)return s.YESTERDAY;if(i<7)return s.THIS_WEEK;const n=Math.floor(i/7);return 1===n?s.ONE_WEEK_AGO:2===n?s.TWO_WEEKS_AGO:3===n?s.THREE_WEEKS_AGO:s.OLDER}i.d(e,{T:()=>s,n:()=>n}),function(t){t.TODAY="TODAY",t.YESTERDAY="YESTERDAY",t.THIS_WEEK="THIS_WEEK",t.ONE_WEEK_AGO="ONE_WEEK_AGO",t.TWO_WEEKS_AGO="TWO_WEEKS_AGO",t.THREE_WEEKS_AGO="THREE_WEEKS_AGO",t.OLDER="OLDER"}(s||(s={}))},49216:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>h});var s=i(43787),n=i(75578),o=i(45832),a=i(32484);const{TILEDMESH_SETTINGS:r}=a.yJ;class h extends n.n{constructor(){super(...arguments),this.name="automation-support"}async init(t,e){const i=window;if(i.MP_AUTOMATION)this.addAutomationHooks(e,i.MP_AUTOMATION);else{const t=performance.now(),s=setInterval((()=>{i.MP_AUTOMATION?(this.addAutomationHooks(e,i.MP_AUTOMATION),clearInterval(s)):performance.now()-t>5e3&&clearInterval(s)}),100)}}async addAutomationHooks(t,e){const i=await t.getModuleBySymbol(o.M7);e.estimatedGPUMemoryAllocated=()=>i.estimatedGPUMemoryAllocated(),e.maxLOD=()=>r.maxLOD,e.diGetContainer=s.Ks}}},97573:(t,e,i)=>{"use strict";i.d(e,{EH:()=>n,v6:()=>o});var s=i(64124);const n=(t=200)=>({resizeDimensions:[{property:s.U.width,setDimension:t=>t.width,duration:t},{property:s.U.height,setDimension:t=>t.height,duration:t},{property:s.U.top,setDimension:()=>0,duration:t},{property:s.U.left,setDimension:()=>0,duration:t}]}),o=(t,e,i,n=200)=>{const o=[];return void 0!==t&&o.push({property:s.U.width,setDimension:e=>e.width+t,duration:n}),void 0!==e&&o.push({property:s.U.height,setDimension:t=>t.height+e,duration:n}),void 0!==i&&o.push({property:s.U.left,setDimension:()=>i,duration:n}),{resizeDimensions:o}}},22299:(t,e,i)=>{"use strict";i.d(e,{J:()=>o});var s=i(92237),n=i(84710);class o extends n.B{constructor(){super(),this.name="cursor",this.opacity=new s.z(0),this.texture=null}}},62916:(t,e,i)=>{"use strict";var s;i.d(e,{S:()=>s}),function(t){t[t.Reticle=0]="Reticle",t[t.GridPlane=1]="GridPlane"}(s||(s={}))},83681:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>f});var s=i(75578),n=i(45832),o=i(20599),a=i(27947),r=i(99583),h=i(2993),l=i(79243),d=i(79070),c=i(81587),u=i(86866),p=i(78498);function m(t){const e=(0,p.p)(u.U$.toVisionSweepQuaternion(t.rotation));return{position:(0,p.I)(u.U$.toVisionVector(t.position)),rotation:e,aspect:t.aspect(),isOrtho:t.isOrtho(),fovX:t.fovX(),fovY:t.fovY()}}function g(t){return(0,c.$)(new Date(t))}class f extends s.n{constructor(){super(...arguments),this.name="dwell-analytics",this.pendingDwellEvents=[],this.onCameraChange=(0,l.n)((t=>{this.checkForDwellEvent(),t.clone(this.currentEvent.pose),this.currentEvent.startTimeMs=Date.now(),this.scheduleDwellTimeOutEvent()}),1e3),this.checkForDwellEvent=(t=!1)=>{const{startTimeMs:e,viewmode:i}=this.currentEvent;if(!e||this.appData.phase!==a.Jj.PLAYING)return;const s=Date.now(),n=s-e,o={pose:m(this.currentEvent.pose),durationMs:n,startTime:g(e),endTime:g(s),timedOut:t,viewmode:i};this.trackDwellEvent(o)},this.onViewmodeUpdate=t=>{t.value!==h.N3.Transition&&(this.currentEvent.viewmode=(0,h.Te)(t.value))},this.trackDwellEvent=t=>{this.pendingDwellEvents.push(t),this.trackPendingDwellEvents()},this.trackPendingDwellEvents=(0,l.n)((()=>{const t={events:JSON.stringify(this.pendingDwellEvents)};this.pendingDwellEvents=[],this.analytics.track("dwell_events",t)}),5e3),this.onBlur=()=>this.stopTrackingDwellTime(!1),this.stopTrackingDwellTime=(t=!1)=>{this.checkForDwellEvent(t),delete this.currentEvent.startTimeMs},this.resumeTrackingDwellTime=()=>{this.currentEvent.startTimeMs||(this.currentEvent.startTimeMs=Date.now()),this.scheduleDwellTimeOutEvent()},this.throttledResumeTrackingDwellTime=(0,l.n)(this.resumeTrackingDwellTime,100),this.scheduleDwellTimeOutEvent=(0,d.s)((()=>this.stopTrackingDwellTime(!0)),15e3)}async init(t,e){[this.analytics,this.cameraData,this.appData,this.viewmodeData]=await Promise.all([e.getModuleBySymbol(n.aF),e.market.waitForData(o.M),e.market.waitForData(a.zH),e.market.waitForData(r.X)]),this.currentEvent={pose:this.cameraData.pose.clone(),viewmode:(0,h.Te)(null)},this.bindings.push(this.cameraData.pose.onChanged(this.onCameraChange)),this.bindings.push(this.viewmodeData.onPropertyChanged("currentModeObservable",this.onViewmodeUpdate)),window.addEventListener("blur",this.onBlur),window.addEventListener("focus",this.resumeTrackingDwellTime),window.addEventListener("keydown",this.resumeTrackingDwellTime,{capture:!0}),window.addEventListener("touchcancel",this.resumeTrackingDwellTime),window.addEventListener("touchstart",this.resumeTrackingDwellTime),window.addEventListener("touchend",this.resumeTrackingDwellTime),window.addEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.addEventListener("mousemove",this.throttledResumeTrackingDwellTime)}dispose(t){super.dispose(t),window.removeEventListener("blur",this.onBlur),window.removeEventListener("focus",this.resumeTrackingDwellTime),window.removeEventListener("keydown",this.resumeTrackingDwellTime,{capture:!0}),window.removeEventListener("touchcancel",this.resumeTrackingDwellTime),window.removeEventListener("touchstart",this.resumeTrackingDwellTime),window.removeEventListener("touchend",this.resumeTrackingDwellTime),window.removeEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.removeEventListener("mousemove",this.throttledResumeTrackingDwellTime)}}},97006:(t,e,i)=>{"use strict";i.d(e,{E:()=>d});var s=i(74848),n=i(96540),o=i(72909),a=i(32485),r=i.n(a),h=function(t,e,i,s){var n,o=arguments.length,a=o<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var r=t.length-1;r>=0;r--)(n=t[r])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},l=function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};let d=class extends n.Component{constructor(t){super(t)}render(){const{iconClass:t,label:e,badgeStyle:i,onClick:n,className:o,imageUrl:a}=this.props;return(0,s.jsxs)("span",Object.assign({className:r()("badge",o,{clickable:!!n}),style:i,onClick:n},{children:[t&&(0,s.jsx)("span",{className:`icon badge-icon ${t}`}),e&&(0,s.jsx)("span",Object.assign({className:"badge-label"},{children:e})),a&&(0,s.jsx)("span",Object.assign({className:"badge-img"},{children:(0,s.jsx)("img",{src:a})}))]}))}};d=h([o.A,l("design:paramtypes",[Object])],d)},18633:(t,e,i)=>{"use strict";i.d(e,{OR:()=>a,Zl:()=>r,v0:()=>o,v3:()=>n,vp:()=>h});var s=i(92475);class n extends s.E{constructor(t,e,i,s){super(),this.position=t,this.clientPosition=e,this.delta=i,this.buttons=s}}class o extends s.E{constructor(t,e,i,s,n){super(),this.position=t,this.clientPosition=e,this.delta=i,this.buttons=s,this.progress=n}}class a extends s.E{constructor(t,e,i){super(),this.position=t,this.clientPosition=e,this.buttons=i}}class r extends s.E{constructor(t,e,i){super(),this.position=t,this.clientPosition=e,this.buttons=i}}class h extends s.E{constructor(t,e,i){super(),this.position=t,this.clientPosition=e,this.cancelled=i}}},34567:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>L});var s=i(75578),n=i(45832),o=i(15404),a=i(81530),r=i(35473),h=i(76234),l=i(45395),d=i(85182),c=i(20968),u=i(10843),p=i(85616),m=i(68909);class g extends p.v{constructor(){super(...arguments),this.position=new m.Vector3,this.floorId="",this.sid="",this.layerId="",this.text="",this.visible=!1,this.roomId=void 0,this.created=new Date,this.modified=new Date,this.version="3.1"}copy(t){return this.floorId=t.floorId,this.roomId=t.roomId,this.sid=t.sid,this.text=t.text,this.visible=t.visible,this.roomId=t.roomId,this.created=t.created,this.modified=t.modified,this.position.copy(t.position),this.version=t.version,this.commit(),this}}var f=i(51666),v=i(86866);const y=new u.Ay("mds-label-serialize");class b{constructor(){this.validate=t=>{if(!t)return!1;const e=["enabled","floorId","label","position"].filter((e=>!(e in t))),i=0===e.length,s=!!t.floorId&&"string"==typeof t.floorId,n=!!t.position&&(0,f.Z)(t.position),o=i&&s&&n;return o||y.debug("Label invalid:",{missingFields:e,validPosition:n}),o}}serialize(t,e){const i=D(t,e);return this.validate(i)?i:null}}class w{constructor(){this.validate=t=>{if(!t)return!1;const e=["enabled","label","position","floorId","roomId","layerId"];return Object.keys(t).every((t=>e.includes(t)))}}serialize(t,e){const i=D(t,e);return i&&this.validate(i)?i:null}}const D=(t,e)=>{const i={};return void 0!==t.visible&&(i.enabled=t.visible),void 0!==t.text&&(i.label=t.text),void 0!==t.position&&(0,f.Z)(t.position)&&(i.position=v.U$.toVisionVector(t.position)),void 0!==t.floorId&&""!==t.floorId&&(i.floorId=t.floorId),void 0!==t.roomId&&""!==t.roomId&&(i.roomId=t.roomId),e&&void 0!==t.layerId&&""!==t.layerId&&(i.layerId=t.layerId),Object.keys(i).length>0?i:null};var S=i(81587);const I=new u.Ay("mds-label-deserializer");class T{constructor(){this.validate=t=>{if(!t)return!1;const e=["id","created","modified","enabled","floor","label","position"].filter((e=>!(e in t))),i=0===e.length,s=!(!t.floor||!t.floor.id),n=!!t.position&&(0,f.Z)(t.position);return i&&s&&n||I.debug("Label invalid:",{missingFields:e,validFloor:s,validPosition:n}),i&&s&&n}}deserialize(t){var e;if(!t||!this.validate(t))return I.debug("Deserialized invalid Label data from MDS",t),null;const i=new g;return i.sid=t.id,i.layerId=(null===(e=t.layer)||void 0===e?void 0:e.id)||"",i.floorId=t.floor.id,i.text=t.label,i.visible=!!t.enabled,i.created=(0,S.X)(t.created),i.modified=(0,S.X)(t.modified),i.position=v.U$.fromVisionVector(t.position),t.room&&t.room.id&&(i.roomId=t.room.id),i}}var P=i(96069),E=i(80788),C=i(11751),M=i(74381);const x=new u.Ay("MdsLabelStore");class A extends c.g{constructor(t){super(t),this.prefetchKey="data.model.labels",this.layeredType=M.jM.LABEL,this.deserializer=new T,this.updateSerializer=new w,this.createSerializer=new b}async read(t){const{includeDisabled:e=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:e,includeLayers:this.readLayerId()};return this.query(P.GetLabels,i,t).then((t=>{var e,i;const s=null===(i=null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.labels;if(!s||!Array.isArray(s))return null;const n=[];for(const t of s){const e=this.deserializer.deserialize(t);e&&n.push(e)}return n.reduce(((t,e)=>(t[e.sid]=e,t)),{})}))}async create(t){const e=this.getViewId(),i=[];for(const s of t){const t=this.createSerializer.serialize(s,this.writeLayerId(s.layerId));if(!t)throw x.error("Failure saving label:",s.sid,s),new Error("Could not save Label");const n={modelId:e,labelId:s.sid,data:t,includeLayers:this.readLayerId()};await this.mutate(P.AddLabel,n).then((t=>{var e;const n=null===(e=t.data)||void 0===e?void 0:e.addLabel;if(!n)throw new Error("Could not save label: empty response");const o=(new g).copy(s);o.sid=n.id,o.commit(),x.debug(Object.assign({type:"addLabel"},t)),i.push(o)}))}return i}async update(t){if(!t||0===t.length)return;const e=this.getViewId();let i="";const s={};s.modelId=e,s.includeLayers=this.readLayerId();let n="";for(const e of t){const t=e.sid,o=this.updateSerializer.serialize(e,!1);if(!o)throw x.error("Failure updating label:",t,e),new Error("Could not update Label");i+=`, $patch${t}: LabelPatch!`,s[`patch${t}`]=o,n+=`patch${t}:\n        patchLabel(modelId: $modelId, labelId: "${t}", patch: $patch${t}) {\n          ...LabelDetails\n        }\n      `}const o=E.gql`
      mutation labelUpdate($modelId: ID! ${i}, $includeLayers: Boolean!) {
        ${n}
      }

      ${(0,C.y)(P.LabelDetails)}
    `;return this.mutate(o,s).then((t=>{x.debug(Object.assign({type:"patchLabel"},t))}))}async delete(t){if(!t||0===t.length)return;const e=this.getViewId();let i="";for(const e of t){if(!e||e&&!e.sid)throw x.error("Failure deleting label:",e),new Error("Could not update Label");i+=`delete${e.sid}: deleteLabel(modelId: $modelId, labelId: "${e.sid}") `}const s=E.gql`
      mutation batchDeleteLabel($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(s,{modelId:e}).then((()=>{}))}}var R=i(47737);class L extends s.n{constructor(){super(...arguments),this.name="label-data",this.monitor=null}async init(t,e){const{readonly:i}=t;this.engine=e,this.market=e.market,this.layersData=await e.market.waitForData(R.P),this.store=new A({context:this.layersData.mdsContext,readonly:t.readonly,includeDisabled:!t.readonly,baseUrl:t.baseUrl});const s=await this.store.read()||{},a=await e.getModuleBySymbol(n.T9),h=await e.getModuleBySymbol(n.PM);for(const t of Object.values(s))h.inferMeshIdsFromPoint(t,t.position,!1);this.labelData=e.market.tryGetData(d.B)||new d.B(s),this.store.onNewData((async t=>{var e;this.labelData.atomic((()=>{this.layersData.replaceBackendLayers(this.labelData.getCollection(),{})})),t&&this.labelData.atomic((()=>{this.layersData.replaceBackendLayers(this.labelData.getCollection(),t)})),null===(e=this.monitor)||void 0===e||e.clearDiffRecord()})),await this.store.refresh(),this.market.register(d.B,this.labelData),i||(this.monitor=new r.F(this.labelData.getCollection(),{aggregationType:l.D.Manual,shallow:!0},this.engine),this.bindings.push(a.onSave((()=>this.saveDiff()),{dataType:o.p.LABELS})))}dispose(t){this.store.dispose(),super.dispose(t)}async save(){return this.engine.commandBinder.issueCommand(new a.F({dataTypes:[o.p.LABELS]}))}getDiffRecord(){var t;return(null===(t=this.monitor)||void 0===t?void 0:t.getDiffRecord())||[]}async saveDiff(){if(!this.store||!this.monitor)return void this.log.warn("Labels changes will NOT be saved");this.monitor.commitChanges();const t=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const e=t.map((t=>{var e;const i=t.diff.layerId||(null===(e=this.labelData.getLabel(t.index))||void 0===e?void 0:e.layerId);return Object.assign(Object.assign({},t),{layerId:i})})).filter((t=>!this.layersData.isInMemoryLayer(t.layerId))),i=e.filter((t=>t.action===h.Xw.removed)).map((t=>({sid:t.index,layerId:t.layerId}))),s=e.filter((t=>t.action===h.Xw.added)).map((t=>this.labelData.getLabel(t.index))),n=e.filter((t=>t.action===h.Xw.updated)).map((t=>Object.assign(Object.assign({sid:t.index},t.diff),{layerId:t.layerId})));return Promise.all([this.store.delete(i),this.store.create(s),this.store.update(n)]).then((()=>{}))}onUpdate(t){}}},27145:(t,e,i)=>{"use strict";i.r(e),i.d(e,{USER_LABELS:()=>E,default:()=>gt});var s=i(75578),n=i(45832),o=i(85182),a=i(20599),r=i(39209),h=i(96319),l=i(22278),d=i(62372),c=i(50485),u=i(25316),p=i(37458),m=i(52514),g=i(68909),f=i(38069);const v={ColorDefault:f.V.WHITE.clone(),ColorHovered:f.V.MP_BRAND.clone(),ColorInvalid:new g.Color(16750933)};class y extends m.QM{use(t){this.userData.sid=t.data.sid,this.collider.data=t.data,this.collider.name=t.data.text,this.collider.labelMesh=t}}class b extends g.Mesh{constructor(){super(...arguments),this.hitTest=(()=>{const t=new g.Matrix4,e=new g.Ray,i=new g.Plane(new g.Vector3(0,0,-1)),s=new g.Vector3;return(n,o)=>{if(t.copy(this.matrixWorld).invert(),e.copy(n.ray).applyMatrix4(t),e.intersectPlane(i,s)){const t=this.scale.x/this.scale.y;let e=.5;t<1.5&&(e=1/t),Math.abs(s.x)<=e&&Math.abs(s.y)<=.75&&(s.applyMatrix4(this.matrixWorld),o.push({distance:n.ray.origin.distanceTo(s),point:s.clone(),object:this}))}}})()}labelVisible(){return!(!this.labelMesh||!this.labelMesh.labelVisible())}getId(){if(!this.data)throw new Error("LabelInputCollider used before configure");return this.data.sid}raycast(t,e){if(!this.labelVisible())return;if(this.material.depthTest)return void this.hitTest(t,e);const i=this.material.depthTest?e:[];this.hitTest(t,i),i.length>0&&(i[0].distance/=1e4,e.push(i[0]))}}class w{constructor(t={}){this.makeLabel=()=>{const t=new y(Object.assign({},this.textStyle));return t.scaleType=m.bF.WORLD,t.setRenderOrder(p.X.labels),t.setRenderLayer(this.layer),t.opacity=0,t},this.textStyle=m.Il.makeConfig(Object.assign({color:f.V.WHITE.clone(),background:!1,backgroundAsCollider:!0,backgroundColliderType:b,backgroundColor:f.V.PORTAL.clone(),backgroundOpacity:1,outline:!0,outlineWidth:.06,wordWrapWidth:void 0,disableDepth:!0},t))}setRenderLayer(t){this.layer=t}}var D=i(55141);class S extends D.u{constructor(t){super(),this.payload={ids:t}}}S.id="FILTER_LABEL_VISIBILITY";class I extends D.u{constructor(t){super(),this.payload={enabled:t}}}I.id="VISIBILITY_FILTER_ENABLED";var T=i(56413),P=i(92237);const E={LABEL_SIZE:0,FADE_DURATION:200};class C extends g.Object3D{constructor(t){super(),this.text=t,this.maxOpacity=1,this.labelAnim=new P.z(0),this.filtered=!1,this.hidden=!1,this.selectState={active:!1,on:()=>{},off:()=>{}},this.validState={active:!0,on:()=>{const t=this.hoverState.active?v.ColorHovered:v.ColorDefault;this.text.setColor(t)},off:()=>{this.text.setColor(v.ColorInvalid)}},this.hoverState={active:!1,on:()=>{this.validState.active&&this.text.setColor(v.ColorHovered)},off:()=>{this.validState.active&&this.text.setColor(v.ColorDefault)}},this.add(t)}use(t){this.data=t,this.userData.sid=t.sid,this.userData.data=t,this.text.use(this),this.labelUpdate(t.position,new g.Quaternion,"")}getId(){return this.data.sid}labelVisible(){return!this.filtered&&!this.hidden}updatePose(t,e){return this.labelUpdate(t,e,this.data.text),this}setMaxOpacity(t){this.maxOpacity=t,this.toggleLabel(this.labelVisible())}free(){this.labelAnim.value>0&&this.toggleLabel(!1)}tickAnimations(t){return this.animateLabelOpacity(.5*t),this}toggleLabel(t){this.hidden=!t,this.updateOpacity()}isHidden(){return this.hidden}toggleFiltered(t){t!==this.filtered&&(this.filtered=t,this.updateOpacity())}updateOpacity(){const t=this.labelVisible()?this.maxOpacity:0;this.labelAnim.endValue!==t&&this.labelAnim.modifyAnimation(this.labelAnim.value,t,E.FADE_DURATION)}animateLabelOpacity(t){const e=this.labelAnim.tick(t);Math.min(e,this.maxOpacity)!==this.text.opacity&&(this.text.opacity=e)}labelUpdate(t,e,i){this.text.position.copy(t),this.text.quaternion.copy(e),this.text.text=i}billboard(t,e,i,s,n,o,a){this.text.scaleBillboard(t,e,i,s,n,o,a)}}var M=i(10843);const x=new M.Ay("label-spawner");class A{constructor(t,e){this.map=t,this.maker=e,this.container=new g.Object3D,this.pool=[],this.bindings=[],this.meshesMap=(0,T.y)(),this.container.name="RoomLabels";const i=t.keys;for(const e of i){const i=t.get(e);this.add(i,e)}this.bindings.push(t.onElementChanged({onAdded:(t,e)=>{this.add(t,e),x.debug("LabelMesh: added:",e)},onRemoved:(t,e)=>{x.debug("LabelMesh: removing:",e);const i=this.meshesMap.get(e);i&&this.free(i)}}))}subscribe(t){return this.meshesMap.onElementChanged(t)}get(t){return this.meshesMap.get(t)}free(t){const e=t.getId(),i=this.meshesMap.get(e);i.free(),this.meshesMap.delete(e),this.container.remove(i),this.pool.push(i),x.debug("LabelMesh: removed:",i)}add(t,e){const i=this.get(e);if(i)return i;const s=this.pool.shift();if(void 0!==s)return s.use(t),this.container.add(s),this.meshesMap.set(e,s),s;{const i=new C(this.maker.makeLabel());return i.use(t),this.container.add(i),this.meshesMap.set(e,i),i}}dispose(){for(const t of this.meshesMap.values)this.free(t),t.text.dispose();this.meshesMap.clear();for(const t of this.pool)t.text.dispose();this.pool.length=0,this.bindings.forEach((t=>t.cancel()))}}var R=i(86866);class L{constructor(t,e,i,s){this.meshes=t,this.cameraData=i,this.screenFilter=s,this.dirty=!0,this.bindings=[],this.pendingMesh=null,this.setDirty=()=>{this.dirty=!0},this.bindings.push(i.onChanged(this.setDirty),e.onChanged(this.setDirty));for(const t of this.meshes.values)t.text.onGeomUpdate(this.setDirty);this.meshes.onElementChanged({onAdded:t=>t.text.onGeomUpdate(this.setDirty)})}dispose(){this.bindings.forEach((t=>t.cancel())),this.bindings.length=0}setPendingMeshId(t){if((!this.pendingMesh||this.pendingMesh.getId()!==t)&&(this.pendingMesh&&(this.pendingMesh.data.removeOnChanged(this.setDirty),this.pendingMesh=null),t)){const e=this.meshes.get(t);e.data.onChanged(this.setDirty),this.pendingMesh=e}}beforeRender(){if(!this.dirty)return;this.dirty=!1;const{position:t,rotation:e,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,n=this.cameraData.zoom(),o=this.cameraData.aspect(),a=(0,R.m9)(64-E.LABEL_SIZE,0,64,.02,.1);for(const r of this.meshes.values)r.isHidden()||(r.updatePose(r.data.position,e),r.billboard(t,e,i,n,s,o,a));this.screenFilter.update();for(const t of this.meshes.values)t.isHidden()||t.toggleFiltered(!this.screenFilter.visible(t.data.sid))}render(t){for(const e of this.meshes)e.tickAnimations(t)}deactivate(){}init(){}activate(){}}var O=i(35341),F=i.n(O),B=i(19968);class V{constructor(t,e,i){this.meshes=t,this.cameraData=e,this.enabled=i,this.tree=new(F()),this.visibleMap={},this._screenPosition=new g.Vector2,this._ndcPosition=new g.Vector3,this._cornerWorldPosition=new g.Vector3,this._cornerScreenPosition=new g.Vector2,this._selectedId=null,this.update=()=>{this.enabled()?(this.visibleMap={},this.updatePositions()):Object.keys(this.visibleMap).length&&(this.visibleMap={})}}visible(t){if(!(t in this.visibleMap))return!1;return t in this.visibleMap}setSelectedMeshId(t){this._selectedId=t}updatePositions(){this.tree.clear(),this.meshes().filter((t=>!t.isHidden())).map((t=>{(0,B.bz)(this.cameraData,t.text.position,this._screenPosition,this._ndcPosition);const{width:e,height:i}=t.text.getUnscaledSize();this._cornerWorldPosition.set(.5*e,-.5*i,0),t.text.updateMatrixWorld(),this._cornerWorldPosition.applyMatrix4(t.text.matrixWorld),(0,B.bz)(this.cameraData,this._cornerWorldPosition,this._cornerScreenPosition);const s=t.getId()!==this._selectedId?this._ndcPosition.z:-999;return this.describeBbox(t.text,this._screenPosition,this._cornerScreenPosition,s)})).sort(((t,e)=>t.depth-e.depth)).forEach((t=>{this.tree.collides(t)||(this.tree.insert(t),this.visibleMap[t.id]=t)}))}describeBbox(t,e,i,s){i.sub(e);const n=i.x,o=i.y;return{id:t.userData.sid,depth:s,minX:e.x-n,minY:e.y-o,maxX:e.x+n,maxY:e.y+o}}}var N=i(27947),k=i(56208),G=i(28475),H=i(73566),_=i(99583),U=i(47737);class W{constructor(t){this.meshes=t,this.initialized=!1,this.pendingMeshId=null,this.selectedMeshId=null,this.dirty=!0,this.bindings=[],this.labelIdVisibility={},this.visibilityFilterEnabled=!1,this.featureEnabled=()=>{if(!this.initialized)return!1;const t=this.appData.phase===N.Jj.PLAYING,e=this.settingsData.tryGetProperty(G.RP,!1),i=this.settingsData.tryGetProperty(k.Q$.Labels,!1)||this.toolsData.activeToolName===H.S0.LABELS,s=t&&e&&i;return this.settingsData.setProperty(G.LZ,s),s},this.visibleByTool=()=>{if(!this.initialized)return!1;const{activeToolName:t}=this.toolsData;return null===t||t===H.S0.LABELS||t===H.S0.PHOTOS||t===H.S0.SEARCH||t===H.S0.LAYERS},this.visibleByViewmode=()=>{const t=this.settingsData.tryGetProperty(k.Q$.LabelsDollhouse,!1)||this.toolsData.activeToolName===H.S0.LABELS,e=this.viewmodeData.isDollhouse()&&t,i=this.viewmodeData.isFloorplan()&&(this.appData.application===N.lg.WORKSHOP&&this.visibleByTool()||this.settingsData.tryGetProperty(k.Q$.Labels,!1)),s=this.viewmodeData.isDollhouse()&&this.settingsData.tryGetProperty(k.Q$.Labels,!1)&&this.cameraData.pose.isPitchFactorOrtho;return i||e||s},this.hiddenByTransition=()=>this.viewmodeData.transitionActive()||this.floorsViewData.transitionActive,this.visibleByFloor=t=>{if(!(this.toolsData.activeToolName===H.S0.LABELS)){const{roomSelectModeActive:t,floorSelectModeActive:e}=this.floorsViewData;if(!t)return!1;if(e)return!1}return this.viewmodeData.isFloorplan()?this.floorsViewData.currentFloor?this.floorsViewData.isCurrentOrAllFloors(t):this.floorsViewData.topFloorId===t:this.floorsViewData.isCurrentOrAllFloors(t)},this.setDirty=()=>{this.dirty=!0}}async init(t){[this.viewmodeData,this.floorsViewData,this.settingsData,this.toolsData,this.appData,this.layersData,this.cameraData]=await Promise.all([t.waitForData(_.X),t.waitForData(r.X),t.waitForData(u.o),t.waitForData(h.M),t.waitForData(N.zH),t.waitForData(U.P),t.waitForData(a.M)]);const e=await t.waitForData(o.B);[this.viewmodeData,this.floorsViewData,this.settingsData,this.toolsData,this.appData,e].forEach((t=>this.bindings.push(t.onChanged(this.setDirty)))),this.bindings.push(this.layersData.onCurrentLayersChanged(this.setDirty),this.cameraData.pose.isPitchFactorOrthoObservable.onChanged(this.setDirty)),this.meshes.onChanged(this.setDirty),this.initialized=!0}dispose(){this.bindings.forEach((t=>t.cancel())),this.bindings.length=0}setVisibilityFilterEnabled(t){this.visibilityFilterEnabled=t,this.setDirty()}updateLabelVisibility(t){this.labelIdVisibility=t.reduce(((t,e)=>(t[e]=!0,t)),{}),this.setDirty()}onUpdate(){if(!this.initialized||!this.dirty)return;this.dirty=!1;const t=this.featureEnabled()&&!this.hiddenByTransition()&&this.visibleByTool()&&this.visibleByViewmode(),e=t=>t.visible&&this.visibleByFloor(t.floorId)&&this.visibleById(t.sid)&&this.layerToggledOn(t.layerId)&&this.layersData.layerVisible(t.layerId);for(const i of this.meshes.values){const s=i.data.sid===this.pendingMeshId||i.data.sid===this.selectedMeshId,n=t&&(s||e(i.data));i.toggleLabel(n)}this.dirtyCb&&this.dirtyCb()}setPendingMeshId(t){this.pendingMeshId=t,this.setDirty()}setSelectedMeshId(t){this.selectedMeshId=t,this.setDirty()}setDirtyCallback(t){this.dirtyCb=t}visibleById(t){return!this.visibilityFilterEnabled||!!this.labelIdVisibility[t]}layerToggledOn(t){return this.appData.application===N.lg.WORKSHOP||this.layersData.layerToggled(t)}}var z=i(46793),j=i(13893),$=i(23184),X=i(31002),q=i(81544),Y=i(3066),Q=i(68986),Z=i(35699),K=i(77510),J=i(64491),tt=i(9997);class et{constructor(t,e,i,s,n,o){this.labelRenderer=t,this.issueCommand=e,this.input=i,this.floorsViewData=s,this.toolsData=n,this.roomNavigationPose=o,this.inputBindings=[],this.appStateBindings=[],this.raycasterRegistrationBindings=[],this.active=!0,this.enabled=!0,this.refresh=()=>{this.shouldBeInteractive!==this.active&&(this.inputBindings.forEach((t=>this.shouldBeInteractive?t.renew():t.cancel())),this.raycasterRegistrationBindings.forEach((t=>this.shouldBeInteractive?t.renew():t.cancel())),this.active=this.shouldBeInteractive)},this.refreshColliders=()=>{for(const t of this.labelRenderer.labelMeshIterator())this.shouldBeInteractive?this.input.registerMesh(t.text.collider,!1):this.input.unregisterMesh(t.text.collider)},this.clearColliders=()=>{for(const t of this.labelRenderer.labelMeshIterator())this.input.unregisterMesh(t.text.collider)},this.inputBindings.push(...this.setupInputBindings()),this.raycasterRegistrationBindings.push(...this.setupRaycasterBindings());const a=this.toolsData.onPropertyChanged("activeToolName",this.refresh),r=this.floorsViewData.makeFloorChangeSubscription(this.refresh),h=this.floorsViewData.onRoomSelectModeChange(this.refresh);this.appStateBindings.push(a,r,h),this.refresh()}toggleInput(t){this.enabled!==t&&(this.enabled=t,this.appStateBindings.forEach((e=>t?e.renew():e.cancel())),this.refresh())}get shouldBeInteractive(){return this.enabled&&null===this.toolsData.activeToolName&&this.floorsViewData.roomSelectModeActive}setupRaycasterBindings(){return[(0,Y.Sh)((()=>this.refreshColliders()),(()=>this.clearColliders()),!0,"toggleLabelMeshInput"),this.labelRenderer.subscribe({onAdded:t=>this.input.registerMesh(t.text.collider,!1),onRemoved:t=>this.input.unregisterMesh(t.text.collider)})]}setupInputBindings(){const t=$.f.is((t=>t instanceof b&&t.labelVisible())),e=this.input.registerMeshHandler(X.rX,t,((t,e)=>{const i=this.labelRenderer.getLabelMesh(e.getId());if(i){const t=i.data.roomId;if(t){const e=this.roomNavigationPose.getPoseForRoom(t,i.data.position);e&&this.issueCommand(new z.S2(z.w5.INSIDE,j.fl.Interpolate,e))}else this.issueCommand(new tt.rH({focusPosition:i.data.position,transition:j.fl.Interpolate}))}}));if((0,J.C8)())return[e];let i=null;return[new Q.P(this.input.registerMeshHandler(q.L,t,((t,e)=>{const s=this.labelRenderer.getLabelMesh(e.getId());s&&(s.hoverState.active=!0,s.hoverState.on(),i=s,this.issueCommand(new Z.X(K.b.FINGER)))})),this.input.registerMeshHandler(q.q,$.f.isType(b),((t,e)=>{i&&this.issueCommand(new Z.X(K.b.DEFAULT));const s=this.labelRenderer.getLabelMesh(e.getId());s&&(s.hoverState.active=!1,s.hoverState.off()),i=null})),(0,Y.Sh)((()=>{}),(()=>{i&&(i.hoverState.active=!1,i.hoverState.off(),this.issueCommand(new Z.X(K.b.DEFAULT)),i=null)}),!0,"labelHoverClear")),e]}}var it=i(81662),st=i(2993);const nt=new M.Ay("room-with-a-view");class ot{constructor(t,e,i){this.sweepData=t,this.roomData=e,this.meshData=i}getPoseForRoom(t,e){const i=this.bestViewForRoom(t,e);if(i){return{rotation:i.rotation,sweepID:i.sweepID,viewmode:st.N3.Panorama}}return null}bestViewForRoom(t,e){const i=this.sweepData.filter((e=>e.roomId===t&&e.enabled));if(0===i.length)return nt.debug("no sweeps in selected room",{roomId:t,scansInRoom:i}),null;let s=1;const n=this.roomData.get(t),o=this.meshData.meshGroups.rooms.get(n.meshSubgroup),a=(null==o?void 0:o.boundingBox.getSize(new g.Vector3).length())||1/0;e&&a>10&&(s=.1);const r=i.sort(((i,n)=>{let o=0,a=0;e&&(o=i.position.distanceTo(e),a=n.position.distanceTo(e));const r=i.neighbours.map((t=>this.sweepData.getSweep(t))).filter((e=>e.roomId===t)).length,h=n.neighbours.map((t=>this.sweepData.getSweep(t))).filter((e=>e.roomId===t)).length;return 1*s*(h-r)-3*(a-o)})),h=r[0];if(!h)return nt.debug("no start sweep",{roomId:t,scansInRoom:i,connectedness:r}),null;const l=h.neighbours.map((t=>this.sweepData.getSweep(t))).sort(((e,i)=>{let s=h.position.distanceTo(e.position),n=h.position.distanceTo(i.position);return e.roomId===t&&(s*=1e3),i.roomId===t&&(n*=1e3),n-s})).map((t=>({sweep:t,dist:h.position.distanceTo(t.position),rm:t.roomId}))),d=l[0];nt.warn({roomId:t,roomSize:a,scoring:r,byDistance:l,scansInRoom:i});const c=new g.Quaternion;if(1===i.length&&void 0!==d){const t=(new g.Matrix4).setPosition(h.position);t.lookAt(d.sweep.position,h.position,it.B1.UP),c.setFromRotationMatrix(t)}else{const t=(new g.Matrix4).setPosition(h.position);t.lookAt(h.position,d.sweep.position,it.B1.UP),c.setFromRotationMatrix(t)}return{sweepID:h.id,rotation:c}}}var at=i(74381),rt=i(56147),ht=i(94547),lt=i(15580),dt=i(58899),ct=i(84917);class ut extends dt.r{constructor(t,e,i,s,n){super(t,e,i),this.editMode=s,this.label=n,this.id=this.label.sid,this.title=this.label.text,this.icon="icon-toolbar-labels",this.typeId=at.jM.LABEL,this.floorId=this.label.floorId,this.roomId=this.label.roomId||"",this.layerId=this.label.layerId,this.dateBucket=(0,ct.n)(this.label.created),this.enabled=this.label.visible,this.onSelect=()=>{super.onSelect(),this.editMode||this.commandBinder.issueCommand(new tt.UZ(this.label))}}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}const{LABELS:pt}=rt.A.SHOWCASE;class mt extends s.n{constructor(){super(...arguments),this.name="user-labels",this.labelMeshIterator=()=>this.spawner.meshesMap.values,this.filterVisibleLabels=async t=>{this.visibilityRules.updateLabelVisibility(t.ids)},this.changeVisibilityFilterEnabled=async t=>{this.visibilityRules.setVisibilityFilterEnabled(t.enabled)}}async init(t,e){const[i,s,p,m,g,f,v,y,b,D,T]=await Promise.all([e.market.waitForData(o.B),e.market.waitForData(a.M),e.market.waitForData(r.X),e.market.waitForData(h.M),e.market.waitForData(d.A),e.market.waitForData(c.q),e.market.waitForData(l.U),e.getModuleBySymbol(n.M7),e.getModuleBySymbol(n.mL),e.getModuleBySymbol(n.gS),e.market.waitForData(u.o)]),P=y.getScene(),E=new w({assetBasePath:T.tryGetProperty("assetBasePath",""),lang:D.languageCode});E.setRenderLayer(e.claimRenderLayer("labels")),this.spawner=new A(i.getCollection(),E),P.add(this.spawner.container),this.visibilityRules=new W(this.spawner.meshesMap),this.visibilityRules.init(e.market),this.bindings.push(e.commandBinder.addBinding(S,this.filterVisibleLabels),e.commandBinder.addBinding(I,this.changeVisibilityFilterEnabled));this.labelFilter=new V(this.labelMeshIterator,s,(()=>this.visibilityRules.featureEnabled()&&this.visibilityRules.visibleByTool())),this.labelRenderer=new L(this.spawner.meshesMap,i.getCollection(),s,this.labelFilter),e.addComponent(this,this.labelRenderer),this.visibilityRules.setDirtyCallback(this.labelRenderer.setDirty);const C=new ot(g,f,v);this.labelNavInput=new et(this,e.commandBinder.issueCommand,b,p,m,C),this.toggleInput(!0),async function(t,e,i){const[s,n,o]=await Promise.all([t.market.waitForData(N.zH),t.market.waitForData(U.P),t.market.waitForData(h.M)]);let a=s.application===N.lg.WORKSHOP;const r=(i,s,o,r=[])=>{const h=[];return 0===r.length&&e.iterate((e=>{(a||e.visible&&n.layerToggled(e.layerId))&&i(e.text)&&h.push(new ut(t.commandBinder,n,s,a,e))})),t.commandBinder.issueCommand(new S(h.map((t=>t.id)))),h.sort(((t,e)=>t.title.localeCompare(e.title)))},l=e=>{t.commandBinder.issueCommand(new I(!!e))},d=t=>new Q.P(e.onChanged(t)),c=()=>{t.commandBinder.issueCommandWhenBound(new ht.Oc({id:at.jM.LABEL,groupPhraseKey:pt.SEARCH_GROUP_HEADER,getSimpleMatches:r,registerChangeObserver:d,onSearchActivatedChanged:l,groupOrder:30,groupIcon:"toolbar-labels",batchSupported:!0}))},u=()=>{t.commandBinder.issueCommandWhenBound(new ht.tf(at.jM.LABEL))},p=()=>{a=s.application===N.lg.WORKSHOP;const t=o.activeToolName===H.S0.LABELS,e=i.tryGetProperty(k.Q$.Labels,!1),n=i.tryGetProperty(lt.n9,!1),r=i.tryGetProperty(lt._z,!1);(e||t)&&(n||r||a)?c():u()},m=[s.onPropertyChanged("application",p),i.onChanged(p),o.onChanged(p)];return p(),new Q.P(...m)}(e,i,T).then((t=>this.bindings.push(t)))}dispose(t){super.dispose(t),this.visibilityRules.dispose(),this.spawner.dispose()}getLabelMesh(t){return t&&this.spawner.get(t)||null}addLabelMesh(t,e){return this.spawner.add(t,e)}freeLabelMesh(t){t&&this.spawner.free(t)}setPendingMeshId(t){this.visibilityRules.setPendingMeshId(t),this.labelRenderer.setPendingMeshId(t)}setSelectedMeshId(t){this.labelFilter.setSelectedMeshId(t),this.visibilityRules.setSelectedMeshId(t)}toggleInput(t){this.labelNavInput.toggleInput(t)}subscribe(t){return this.spawner.subscribe(t)}onUpdate(){this.visibilityRules&&this.visibilityRules.onUpdate()}}const gt=mt},18952:(t,e,i)=>{"use strict";i.d(e,{CW:()=>d,yp:()=>u});var s=i(68909),n=i(53172),o=i(19968);const a=new s.Vector2,r=new s.Vector3,h=new s.Vector2,l=new s.Vector2,d=(t,e,i)=>{const s=((t,e,i)=>((0,o.bz)(i,t,h),(0,o.bz)(i,e,l),{pixelDistance:h.distanceTo(l),startScreenPosition:h,endScreenPosition:l}))(t,e,i),n=((t,e,i)=>(r.copy(t).add(e).multiplyScalar(.5),(0,o.bz)(i,r,a),a))(t,e,i);return{screenPosition:n,rotation:c(h,l),pixelDistance:s.pixelDistance,startScreenPosition:s.startScreenPosition,endScreenPosition:s.endScreenPosition}},c=(t,e)=>{const i=t.y-e.y,s=t.x-e.x;let o=Math.atan2(i,s)*n.tm;return o=o>=90||o<=-90?o+180:o,o},u=(t,e=10,i=40)=>({width:Math.max(9*Math.max(t,2)+e,i),height:18+e})},8240:(t,e,i)=>{"use strict";i.r(e),i.d(e,{Group:()=>wt,Grouper:()=>bt,IMeasurementModeModule:()=>s.IMeasurementModeModule,MeasurementLabelBackgroundMesh:()=>Vt,MeasurementLabelRenderer:()=>Nt,MeasurementLineRenderer:()=>At,MeasurementModeData:()=>Z.s,MeasuringPhase:()=>Q.hb,default:()=>Ci,labelVisible:()=>Q.Vk});var s={};i.r(s);var n,o=i(75578),a=i(6539),r=i(45832),h=i(52514),l=i(74381),d=i(35568),c=i(77510),u=i(13893),p=i(35699),m=i(20599),g=i(39209),f=i(99583),v=i(2993),y=i(10843),b=i(68909),w=i(92237);!function(t){t[t.FloorplanOnly=0]="FloorplanOnly",t[t.ThreeD=1]="ThreeD"}(n||(n={}));var D=i(18952),S=i(40160),I=i(93818);const T=new y.Ay("line-data"),P=()=>({lineVisibleByFeatureType:!0,labelVisibleByFeatureType:!0});class E{constructor(t,e,i,s,o,a,r=P){this.cameraData=t,this.viewmodeData=e,this.floorsViewData=i,this.isCurrentSweepAligned=s,this.getUnits=o,this.isFeatureEnabled=a,this.visibleFilter=r,this.derivedDataCache={},this.dollhouseLineStyle=n.ThreeD,this.setVisibilityFilter=t=>{this.visibleFilter=t},this.resetVisibilityFilter=()=>{this.visibleFilter=P},this.make=(t,e,i)=>{const s=e(),{start_position:n,end_position:o,visible:a,floorId:r,type:h,text:l}=s,d=a&&this.isFeatureEnabled(),c=d&&this.visibleByFloorAndModes(r,h),u=void 0!==i?i.opacity.value:0,p=0===u||u===S.HT.LABEL_HIDDEN_OPACITY&&c;if(i&&p&&(!d||!c))return i;let m=c,g=c;if(c){const e=this.visibleFilter(t);m=m&&e.lineVisibleByFeatureType,g=g&&e.labelVisibleByFeatureType}let f=0;const v=n.distanceTo(o),y=(0,I.R5)(v,this.getUnits());if(g||!p){const{width:t,height:e}=(0,D.yp)(l.length+y.length),i=(0,D.CW)(n,o,this.cameraData);this.tmpVec.copy(i.startScreenPosition).sub(i.endScreenPosition);let s=Math.abs(this.tmpVec.y)<Math.abs(this.tmpVec.x)?e:t;S.HT.ALIGN_LABELS&&(s=t,f=i.rotation),g=g&&i.pixelDistance>s}let b;const T=m&&g?1:m&&!g?S.HT.LABEL_HIDDEN_OPACITY:0;i?(b=i.opacity,b.endValue===T&&m===i.visible&&g===i.labelVisible||b.modifyAnimation(b.value,T,S.HT.FADE_DURATION)):b=new w.z(0,T,S.HT.FADE_DURATION);const P={sid:t,rotation:f,labelVisible:g,visible:m,length:v,displayLength:y,labelContents:l.length>0?`${y} ${l}`:y,opacity:b};return this.derivedDataCache[t]={getLineData:e,previousDerivedData:P},P},this.update=t=>{if(this.derivedDataCache[t]){const{getLineData:e,previousDerivedData:i}=this.derivedDataCache[t];return this.make(t,e,i)}T.warn(`data not found for ${t}`)},this.get=t=>{if(this.derivedDataCache[t])return this.derivedDataCache[t].previousDerivedData},this.remove=t=>{this.derivedDataCache[t]&&delete this.derivedDataCache[t]},this.clear=()=>{this.derivedDataCache={}},this.visibleByFloorAndModes=(t,e)=>{if(this.floorsViewData.transition.progress.active)return!1;const i=this.viewmodeData.isInside(),s=this.viewmodeData.isFloorplan(),o=this.viewmodeData.isDollhouse(),a=this.cameraData.pose.pitchFactor(),r=this.floorsViewData.currentFloorId,h=!r,l=!(!r||r!==t),d=t===this.floorsViewData.topFloorId,c=e===n.FloorplanOnly&&(s||o&&a<=1e-5)&&(l||d&&h),u=e===this.dollhouseLineStyle&&o&&!(o&&a<=.9)&&(l||h);return e===n.ThreeD&&i&&this.isCurrentSweepAligned()||u||c},this.tmpVec=new b.Vector2}setDollhouseLineStyle(t){this.dollhouseLineStyle=t}}var C=i(78849),M=i(25316),x=i(56208),A=i(23339),R=i(87965),L=i(62372),O=i(27947),F=i(3071),B=i(8774),V=i(87951),N=i(5320),k=i(98159),G=i(55141);class H extends G.u{constructor(t,...e){super(),this.payload={sids:e,visible:t}}}H.id="MEASUREMENTS_SET_VISIBILITY";class _ extends G.u{constructor(t,e=""){super(),this.payload={sid:t,text:e}}}_.id="RENAME_MEASUREMENT";class U extends G.u{constructor(t){super(),this.payload=t}}U.id="MEASURE_CONTENTS_REPLACE";class W extends G.u{constructor(t){super(),this.payload={sids:t}}}W.id="FILTER_MEASUREMENT_VISIBILITY";class z extends G.u{constructor(t){super(),this.payload={enabled:t}}}z.id="MEASUREMENT_VISIBILITY_FILTER_ENABLED";class j extends G.u{constructor(t){super(),this.payload={groupId:t}}}j.id="NAVIGATE_TO_MEASUREMENT";var $=i(20246),X=i(17084),q=i(73566),Y=i(9360),Q=i(41535),Z=i(28454),K=i(53172),J=i(81662);var tt;!function(t){t[t.Axes=1]="Axes",t[t.PlanarAxes=2]="PlanarAxes",t[t.EdgesAndPlanarAxes=3]="EdgesAndPlanarAxes",t[t.Edges=4]="Edges",t[t.Free=5]="Free",t[t.Locked=6]="Locked"}(tt||(tt={}));const et={[J.os.UP]:{dir:Object.freeze(J.B1.UP.clone())},[J.os.DOWN]:{dir:Object.freeze(J.B1.DOWN.clone())},[J.os.BACK]:{dir:Object.freeze(J.B1.BACK.clone())},[J.os.LEFT]:{dir:Object.freeze(J.B1.LEFT.clone())},[J.os.RIGHT]:{dir:Object.freeze(J.B1.RIGHT.clone())},[J.os.FORWARD]:{dir:Object.freeze(J.B1.FORWARD.clone())}},it={[J.os.HORIZONTAL_PLANE]:{dir:Object.freeze(J.B1.HORIZONTAL_PLANE.clone())}},st=(()=>{let t=0;const e=new b.Vector3,i=new b.Vector3,s=new b.Vector3,n=new b.Vector3,o=999,a=Object.freeze(J.B1.ZERO.clone()),r=Object.keys(et).map((t=>Object.assign(Object.assign({},et[t]),{name:t,angleTo:o}))),h=Object.keys(it).map((t=>Object.assign(Object.assign({},it[t]),{name:t,angleTo:o}))),l=t=>(t+3)%2;let d=r[0];return(c,u,p=tt.Axes)=>{if(p===tt.Free)return{position:u.clone(),constrainedAxis:a,axisName:J.os.NONE};if(r.forEach((t=>t.angleTo=o)),h.forEach((t=>t.angleTo=o)),s.copy(u).sub(c),t=s.length(),t<.05)return{position:u.clone(),constrainedAxis:a,axisName:J.os.NONE};n.copy(s).normalize();const m=.05*Math.min(t,1);if(p!==tt.Locked){for(const t of r){const e=(0,K.H)(n.angleTo(t.dir));e<d.angleTo&&(d=t),t.angleTo=e}if(d.angleTo>20){const t=Math.abs(s.y);t*t<m&&(d=h[0])}}e.set(c.x*l(d.dir.x),c.y*l(d.dir.y),c.z*l(d.dir.z)),i.set(u.x*Math.abs(d.dir.x),u.y*Math.abs(d.dir.y),u.z*Math.abs(d.dir.z)).add(e);return p===tt.Locked||i.distanceToSquared(u)<m?{position:i.clone(),constrainedAxis:d.dir,axisName:d.name}:{position:u.clone(),constrainedAxis:a,axisName:J.os.NONE}}})(),nt=1081,ot=192,at=320,rt=128,ht={smoothness:.4,perspective:{fov:40,thresholdClose:1,thresholdFar:8,offsetClose:.25,offsetFar:.5,scale:1},ortho:{fov:5,thresholdClose:5,thresholdFar:20,offsetClose:15,offsetFar:30,scale:4}},lt={desktop:tt.Edges,floorplan:tt.Axes,mobile:tt.Edges,alt:tt.Free,shift:tt.PlanarAxes,shiftAlt:tt.EdgesAndPlanarAxes,disabled:tt.Free},dt=.15,ct=.1,ut=.1,pt=.5,mt=.035,gt=.025,ft="measurements";var vt=i(28913),yt=i(25712);class bt{constructor(t){this.contents=t,this.groupInfo=[],this.groupIndices=[],this.groupInfoMap={},this.groupIndicesMap={}}startGroup(t){const e=0===this.groupCount,i=this.contents.length!==this.groupIndices[this.groupCount-1];if(e||i){let e=t.sid;if(!e)for(e=(0,yt.W0)();this.groupInfoMap.hasOwnProperty(e);)e=(0,yt.W0)();const i=Object.assign(Object.assign({},t),{sid:e});this.groupInfo.push(i),this.groupInfoMap[e]=i,this.groupIndices.push(this.contents.length),this.groupIndicesMap[this.contents.length]=!0}return this.groupIndices.length-1}reset(){this.contents.atomic((()=>{for(let t=this.contents.length-1;t>=0;--t)this.removeFromIdx(t);this.groupIndices=[],this.groupInfo=[],this.groupIndicesMap={}}))}isStartIndex(t){return!!this.groupIndicesMap[t]}*groups(){for(let t=0;t<this.groupCount;++t)yield this.getGroup(t)}*[Symbol.iterator](){for(const t of this.contents)yield t}getGroupStartIndex(t){return this.groupIndices[t]}getGroup(t){const e=this.groupIndices[t],i=this.groupIndices[t+1],s=isNaN(i)?this.contents.length-1:i-1;return new wt(t,this.contents,e,s,Object.assign({},this.groupInfo[t]))}getGroupById(t){for(let e=0;e<this.groupInfo.length;e++)if(t===this.groupInfo[e].sid)return this.getGroup(e)}indexOfGroup(t){for(let e=0;e<this.groupInfo.length;e++)if(t(this.groupInfo[e]))return e;return-1}updateGroupInfo(t,e){const i=this.groupInfo[t].sid;delete this.groupInfoMap[i];const s=Object.assign({sid:i},e);this.groupInfo.splice(t,1,s),this.groupInfoMap[i]=s}get groupCount(){return this.groupIndices.length}get length(){return this.contents.length}get(t){return this.contents.get(t)}push(t){if(0===this.groupCount)throw Error("Grouper: Error pushing points when we have no groups!");return this.contents.push(t.clone()),this.contents.length}pop(){return this.removeFromIdx(this.contents.length-1)}removeFromIdx(t){if(t<this.contents.length&&t>=0&&this.contents.length>=0){const e=this.contents.get(t);return this.contents.remove(t),this.removeEmptyGroups(),e}}removeEmptyGroups(){this.contents.length<=this.groupIndices[this.groupCount-1]&&this.removeGroup(this.groupCount-1)}groupFromPointIndex(t){if(0>t||t>=this.length)return-1;let e=this.groupCount-1;for(;t<this.groupIndices[e];)--e;return e}removeGroup(t){if(t>this.groupCount||t<0)return;const e=this.getGroup(t);if(0===e.count)return;const i=this.groupIndices[t];this.groupIndices.splice(t,1),this.groupInfo.splice(t,1),delete this.groupInfoMap[e.info.sid],delete this.groupIndicesMap[i];for(let i=t;i<this.groupCount;++i){const t=this.groupIndices[i],s=t-e.count;this.groupIndices[i]=s,delete this.groupIndicesMap[t],this.groupIndicesMap[s]=!0}this.contents.splice(e.startIndex,e.count)}update(t,e){this.contents.update(t,e.clone())}copy(t,e=!0){return e&&this.reset(),this.contents.atomic((()=>{for(const e of t){this.startGroup(e.info);for(const t of e)this.push(t)}})),this}toString(){return`Grouper: { groupCount: ${this.groupCount}, length: ${this.length}, groups: [${[...this.groups()].map((t=>`${t}`))}]}`}}class wt{constructor(t,e,i,s,n){this.index=t,this.grouper=e,this.startIndex=i,this.endIndex=s,this.data=n}*[Symbol.iterator](){for(let t=0;t<this.count;++t)yield this.get(t)}get(t){if(!this.has(t))throw RangeError(`Out of range error ${t} / ${this.count-1}`);return this.grouper.get(this.startIndex+t)}has(t){return t>=0&&this.startIndex+t<=this.endIndex}get count(){return this.endIndex-this.startIndex+1}get info(){return this.data}get isClosed(){const t=this.grouper.get(this.startIndex),e=this.grouper.get(this.endIndex);return this.count>2&&t.distanceTo(e)<=.001}get length(){let t=0,e=null;for(let i=0;i<this.count;i++)e&&(t+=this.get(i).distanceTo(e)),e=this.get(i);return t}get segmentLengths(){const t=[];let e=null;for(let i=0;i<this.count;i++)e&&t.push(this.get(i).distanceTo(e)),e=this.get(i);return t}hasLength(){const t=this.grouper.get(this.startIndex),e=this.grouper.get(this.endIndex);return t&&e&&(this.isClosed||t.distanceTo(e)>.001)}clone(){const t=[],e={get:e=>t[e],contents:t};for(let t=0;t<this.count;t++)e.contents.push(this.get(t));return new wt(this.index,e,0,e.contents.length-1,Object.assign({},this.data))}describe(t=this.endIndex){return`GroupSegment${this.index}/${this.startIndex}/${t}}`}equals(t){if(this.count!==t.count||this.index!==t.index)return!1;if((0,vt.E7)(this.info,t.info))return!1;for(let e=0;e<this.count;++e)if(!this.get(e).equals(t.get(e)))return!1;return!0}}var Dt,St,It=i(46771),Tt=i(52943),Pt=i(3066);!function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED",t[t.UPDATED=2]="UPDATED",t[t.COUNT=3]="COUNT"}(Dt||(Dt={})),function(t){t[t.ADDED=1]="ADDED",t[t.REMOVED=2]="REMOVED",t[t.UPDATED=4]="UPDATED",t[t.ALL=7]="ALL"}(St||(St={}));const Et=(t,e)=>{const i=e&St.ADDED,s=e&St.REMOVED,n=e&St.UPDATED,o={};let a;return new Pt.WC((()=>t),(e=>a=t.onElementChanged((t=>(o.onAdded=i?t:void 0,o.onRemoved=s?t:void 0,o.onUpdated=n?t:void 0,o))(e))),(t=>{a&&a.cancel()}))};var Ct;!function(t){t[t.x=16711680]="x",t[t.y=32768]="y",t[t.z=255]="z",t[t.free=16777215]="free",t[t.xz=16711935]="xz",t[t.laser=16724312]="laser",t[t.yellow=16776960]="yellow",t[t.white=16777215]="white"}(Ct||(Ct={}));var Mt=i(68062),xt=i(30443);class At{constructor(t,e,i,s,n,o,a=()=>-1,r,h=16777215){this.points=t,this.createPointSubscription=e,this.cameraData=i,this.lineModule=s,this.mainLayer=n,this.lineLayer=o,this.selectedGroup=a,this.getLineDetails=r,this.lineColor=h,this.endpointGeometry=(0,xt.Wi)(),this.linePool=[],this.groupToLines={},this.pointToLines={},this.activeLines=[],this.cameraQuaternion=new b.Quaternion,this.cameraPosition=new b.Vector3,this.cameraProjection=new It.k,this.getLinesForPoint=t=>{const e=[];if(this.pointToLines[t])for(const i of this.pointToLines[t]){const t=i.getMesh(Tt.Y.line),{startIndex:s,endIndex:n,group:o}=t.userData;e.push({endIndex:n,startIndex:s,line:i,group:o})}return e},this.updateMaterialColors(this.lineColor),this.dataSubs=[this.createPointSubscription(St.REMOVED,((t,e)=>{this.resetLines()}))]}updateMaterialColors(t){const e=S.UP.lineDefault;this.lineMaterial=this.lineModule.makeLineMaterial(t,!0,{linewidth:e}),this.setStencilState(this.lineMaterial),this.endpointMaterial=this.lineModule.makeEndpointMaterial(t);const i={dashed:!0,dashSize:.025,gapSize:.05,linewidth:S.UP.dottedLineDefault};this.dottedLineMaterial=this.lineModule.makeLineMaterial(t,!1,i),this.setStencilState(this.dottedLineMaterial),this.xLineMaterial=this.lineModule.makeLineMaterial(Ct.x,!1,i),this.yLineMaterial=this.lineModule.makeLineMaterial(Ct.y,!1,i),this.zLineMaterial=this.lineModule.makeLineMaterial(Ct.z,!1,i),this.xzLineMaterial=this.lineModule.makeLineMaterial(Ct.xz,!1,i)}setStencilState(t){t.stencilRef=1,t.stencilFail=b.KeepStencilOp,t.stencilZFail=b.KeepStencilOp,t.stencilZPass=b.KeepStencilOp,t.stencilFunc=b.GreaterStencilFunc,t.stencilWrite=!0}setLineOpacityByGroup(t,e){const i=this.groupToLines[t];if(i)for(const t of i)t.opacity(e)}setLineOpacityByPoint(t,e){const i=this.getLinesForPoint(t);if(i)for(const t of i)t.line.opacity(e)}resetLines(){for(const t of this.lines)t.opacity(0),t.hide();this.groupToLines={},this.pointToLines={},this.lines.length=0}updateAllLines(){if(!(this.points.length<1)){for(let t=0;t<this.points.length;t++)this.updateLine(t);for(const t in this.groupToLines){const e=Number(t),i=this.groupToLines[e];for(const t of i)t.updateSelected(this.selectedGroup()===e)}}}init(){}dispose(){this.deactivate();for(const t of this.linePool)t.dispose();this.endpointGeometry.dispose(),this.dottedLineMaterial.dispose(),this.lineMaterial.dispose(),this.endpointMaterial.dispose(),this.xLineMaterial.dispose(),this.yLineMaterial.dispose(),this.zLineMaterial.dispose()}activate(){for(const t of this.dataSubs)t.renew()}deactivate(){for(const t of this.dataSubs)t.cancel();this.resetLines()}get lines(){return this.activeLines}get dottedMaterial(){return this.dottedLineMaterial}beforeRender(){this.cameraQuaternion.copy(this.cameraData.pose.rotation),this.cameraPosition.copy(this.cameraData.pose.position),this.cameraProjection.copy(this.cameraData.pose.projection)}get xMaterial(){return this.xLineMaterial}get yMaterial(){return this.yLineMaterial}get zMaterial(){return this.zLineMaterial}get xzMaterial(){return this.xzLineMaterial}render(){this.updateAllLines()}updateLine(t){const e=this.points.get(t),i=this.points.get(t+1),s=this.points.groupFromPointIndex(t)===this.points.groupFromPointIndex(t+1);e&&i&&s&&this.setLinePosition(t,e,i)}setLinePosition(t,e,i){let s=this.linePool[t];if(!s){const n=this.points.groupFromPointIndex(t);if(!this.getLineDetails(n,t,t+1).visible)return;const o=S.UP.endpointDefault>.01?this.endpointMaterial.clone():void 0;s=this.lineModule.makeLine(e,i,this.lineMaterial.clone(),o,(()=>!(0,Mt.Gp)(this.cameraProjection))),this.setupLine(s,t),s.setRenderLayer(this.mainLayer)}s.visible||this.setupLine(s,t),this.linePool[t]=s,s.updateResolution(this.cameraData.width,this.cameraData.height),s.updatePositions(e,i),s.updateBillboard({rotation:this.cameraQuaternion,position:this.cameraPosition,projection:this.cameraProjection})}setupLine(t,e){const i=this.points.groupFromPointIndex(e);t.children.forEach((t=>{t.userData.startIndex=e,t.userData.endIndex=e+1,t.userData.group=i,t.layers.mask=this.mainLayer.mask})),t.getMesh(Tt.Y.line).layers.mask=this.lineLayer.mask,this.activeLines.push(t),this.addLineToGroup(i,t),this.addLineToPoint(e,t),this.addLineToPoint(e+1,t),t.show(),t.opacity(0)}addLineToGroup(t,e){this.groupToLines[t]||(this.groupToLines[t]=[]),this.groupToLines[t].push(e)}addLineToPoint(t,e){this.pointToLines[t]||(this.pointToLines[t]=[]),this.pointToLines[t].push(e)}}var Rt=i(3249),Lt=i(19968),Ot=i(31002),Ft=i(81544),Bt=i(23184);class Vt extends b.Mesh{}class Nt{constructor(t,e,i,s,n,o,a,r,h,l,d){this.points=t,this.input=e,this.mobile=i,this.cameraData=s,this.renderLayer=n,this.renderOrder=o,this.textRenderer=a,this.getLineDetails=r,this.changeCursor=h,this.getPhase=l,this.setSelectedLine=d,this.meshPool=[],this.textContainer=new b.Object3D,this.textGeometry=new b.PlaneGeometry(1,1),this.tmpMidpoint=new b.Vector3,this.tmpCamPos=new b.Vector3,this.cameraRotation=new b.Quaternion,this.cameraProjection=new It.k,this.cameraPosition=new b.Vector3;this.inputSubs=[this.input.registerMeshHandler(Ot.rX,Bt.f.isType(Vt),((t,e)=>{var i,s;if(this.getPhase()===Q.hb.IDLE)return this.setSelectedLine(null===(s=null===(i=null==e?void 0:e.parent)||void 0===i?void 0:i.userData)||void 0===s?void 0:s.groupIndex),!0}))],this.mobile||this.inputSubs.push(...this.registerHoverHandlers()),this.deactivate(),this.deactivateInteraction()}registerHoverHandlers(){return[this.input.registerMeshHandler(Ft.L,Bt.f.isType(Vt),(()=>{this.getPhase()===Q.hb.IDLE&&this.changeCursor(c.b.FINGER)})),this.input.registerMeshHandler(Ft.q,Bt.f.isType(Vt),(()=>{this.changeCursor(c.b.DEFAULT)}))]}reset(){for(const t of this.meshPool)t&&(this.input.unregisterMesh(t.collider),this.textContainer.remove(t));this.meshPool=[]}init(){}dispose(){this.textGeometry.dispose()}activate(){}deactivate(){this.reset()}activateInteraction(){for(const t of this.inputSubs)t.renew()}deactivateInteraction(){for(const t of this.inputSubs)t.cancel()}get container(){return this.textContainer}beforeRender(){const t=this.cameraData.pose;this.cameraRotation.copy(t.rotation),this.cameraPosition.copy(t.position),this.cameraProjection.copy(t.projection);const e=(0,Mt.Rc)(this.cameraProjection),i=(0,Mt.Gp)(this.cameraProjection),s=this.cameraData.height,n=this.cameraData.zoom(),o=this.cameraData.aspect();for(let t=1;t<this.points.length;++t){const a=t-1,r=this.points.groupFromPointIndex(t),h=this.getLineDetails(r,a,t);if(!h||r!==this.points.groupFromPointIndex(a)){this.removeLabelMesh(t);continue}const l=this.points.get(a),d=this.points.get(t),c=this.setMeshVisible(t,h.labelVisible);if(!c)continue;c.text!==h.labelContents&&(c.text=h.labelContents);const u=this.cameraPosition.distanceTo(c.position);if(this.updateMeshPose(c,l,d,this.cameraRotation,this.cameraPosition,u,h.rotation,i),i||e)c.scaleFactor=gt*n;else{const t=(0,Lt.jn)(c.position,this.cameraPosition,this.cameraRotation,this.cameraProjection.asThreeMatrix4()),e=Math.abs(t.x);if(e<1){const t=(0,Mt.Nv)(this.cameraProjection,this.cameraPosition,c.position,s,ut),i=((0,Rt.qE)(o,1,2.5)+n)*mt,a=1+pt-e*pt-i;c.scaleFactor=Math.max(Math.min(1/t*a,3),.001)}else c.scaleFactor=.001}}for(let t=this.points.length;t<this.meshPool.length;t++)this.removeLabelMesh(t);this.meshPool=this.meshPool.slice(0,this.points.length)}setTextOpacityByPoint(t,e){const i=this.meshPool[t];i&&(i.opacity=e)}updateMeshPose(t,e,i,s,n,o,a,r){this.tmpMidpoint.copy(e).add(i).multiplyScalar(.5);const h=r?t=>this.tmpCamPos.copy(t).addScaledVector(J.B1.UP,.15):t=>this.tmpCamPos.copy(n).sub(t).setLength(.15*o).add(t);t.setPosition(this.tmpMidpoint,h),t.setOrientation(s,a)}render(){}setMeshVisible(t,e){let i=this.meshPool[t];if(!i&&e){i=this.textRenderer.createLabel(),i.setRenderLayer(this.renderLayer),i.renderOrder=this.renderOrder,i.opacity=1,i.visible=!1;const e=this.points.groupFromPointIndex(t);i.userData.groupIndex=e,this.textContainer.add(i),this.input.registerMesh(i.collider,!1),this.meshPool[t]=i}if(i){const t=e?.001:S.HT.LABEL_HIDDEN_OPACITY;if(i.visible=i.opacity>t,!i.visible)return null}return i}removeLabelMesh(t){const e=this.meshPool[t];e&&(this.textContainer.remove(e),e.dispose(),this.input.unregisterMesh(e.collider),this.meshPool[t]=null)}}var kt=i(36476);const Gt=i.p+"images/scope.svg";var Ht=i(32024),_t=i(22299),Ut=i(5243),Wt=i(62916);const zt=i.p+"images/vert_arrows.png",jt=i.p+"images/surface_grid_planar_256.png";var $t=i(37458);class Xt{constructor(t,e=kt.H.ALL){this.scene=t,this.layer=e,this.supportsMobile=!0,this.style=Wt.S.GridPlane,this.alignToNormal=!0,this.xzTex=(0,Ht.y)(zt),this.zyTex=(0,Ht.y)(jt),this.bindings=[],this.onOpacityUpdate=t=>{this.container.children.forEach((e=>{e.isMesh&&(e.material.opacity=Math.max(0,t.opacity.value))}))},this.onPositionUpdate=(t,e)=>{this.container.position.copy(t).addScaledVector(e,.005),this.alignToNormal&&(0,Mt.KK)(this.container,t,e)},this.scale=t=>{this.container.scale.set(t,t,t)},this.onRaycasterUpdate=t=>{t.hit&&t.hit.face&&this.onPositionUpdate(t.hit.point.clone(),t.hit.face.normal)},this.container=new b.Group;const i=new b.PlaneGeometry(.4,.4),s={color:16777215,side:b.DoubleSide,transparent:!0,depthTest:!0,depthWrite:!1};this.xzTex.generateMipmaps=!1,this.xzTex.minFilter=b.LinearFilter,this.xzMaterial=new b.MeshBasicMaterial(Object.assign(Object.assign({},s),{color:65280,map:this.xzTex})),this.xzMaterial.premultipliedAlpha=!1;const n=new b.Mesh(i,this.xzMaterial);n.rotateOnAxis(J.B1.LEFT,Math.PI/2),this.zyTex.generateMipmaps=!1,this.zyTex.minFilter=b.NearestFilter,this.zyMaterial=new b.MeshBasicMaterial(Object.assign(Object.assign({},s),{map:this.zyTex})),this.zyMaterial.premultipliedAlpha=!1;const o=new b.Mesh(i,this.zyMaterial);this.container.add(n,o),this.container.children.forEach((t=>{t.renderOrder=$t.X.reticule,t.layers.mask=this.layer.mask}))}init(){}render(){}dispose(){this.container.children.forEach((t=>{if(t.isMesh){t.geometry.dispose();const e=t.material;e.dispose(),e.map&&e.map.dispose()}}))}async activate(t){const e=await t.market.waitForData(_t.J),i=await t.market.waitForData(Ut.$);this.bindings.push(e.onChanged(this.onOpacityUpdate),i.onChanged(this.onRaycasterUpdate)),this.scene.add(this.container)}deactivate(t){for(const t of this.bindings)t.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(t){this.container.visible=t}}var qt=i(86866);class Yt{constructor(t,e,i,s,n,o){this.mobile=t,this.pointer=e,this.sceneInfo=i,this.renderToTexture=s,this.getLayer=n,this.editing=!1,this.editingStateChange=!1,this.setupCursorRenderCamera=()=>{const t=new b.PerspectiveCamera(ht.perspective.fov,1,.1,100);t.name="Cursor Peek Camera";const e=kt.H.ALL,i=["measurement-mode","measurement3d"];for(const t of i)e.removeLayers(this.getLayer(t));t.layers.mask=e.mask,t.updateProjectionMatrix();return{camera:t,update:(e,i,s)=>{t.fov=e,t.near=i,t.far=s,t.updateProjectionMatrix()}}};const a=(0,Ht.y)(Gt),r=new b.Vector2,h=t=>{const e=this.rttView.height,i=this.rttView.width,s=this.sceneInfo.cameraData;let n=e/2;const o=-i/2;n=t.y<e/2+n?e+n:-n;const a=t.x+o,h=s.height-t.y-n;return r.set(a,h)};this.cursorMesh=new Xt(this.sceneInfo.scene,this.getLayer("cursor-mesh")),this.cursorMesh.setVisible(!1);const l=new b.Vector3,d=new b.Quaternion,c=new b.Vector2;let u,p,m=o(),g=ht.perspective;this.renderIntersection=(t,e,n)=>{u||(p=this.setupCursorRenderCamera(),u=p.camera,p.update(ht.perspective.fov,.1,100)),m!==o()&&(g=o()?ht.ortho:ht.perspective,this.cursorMesh.scale(g.scale),p.update(g.fov,.1,100),m=o());const r=this.editingStateChange?1:ht.smoothness;if(e){if(i.playerCamera.getWorldPosition(l),i.playerCamera.getWorldQuaternion(d),o()){const t=i.cameraData.zoom(),s=(0,qt.m9)(t,g.thresholdClose,g.thresholdFar,g.offsetClose,g.offsetFar);u.position.copy(e.point).addScaledVector(J.B1.UP,s),u.quaternion.copy(d)}else{const t=(0,qt.m9)(e.distance,g.thresholdClose,g.thresholdFar,g.offsetClose,g.offsetFar),i=l.sub(e.point).setLength(t).add(e.point);u.position.lerp(i,r),u.lookAt(e.point)}u.updateMatrixWorld(),s.render(t,i.scene.scene,u),c.lerp(h(n),r),s.renderToScreen(t,!1,c,a)}this.editingStateChange=!1}}init(){}dispose(){}activate(){this.sceneInfo.scene.addChild(d.o.Root,this.cursorMesh.container);const t=this.mobile?rt:this.sceneInfo.cameraData.height>nt?at:ot;this.rttView=this.renderToTexture.createRenderTarget2D(t,t,{format:b.RGBAFormat},!1)}setMeasuringPhase(t){const e=this.mobile?!!Q.TI.mobile[t]:!!Q.TI.desktop[t];e!==this.editing&&(this.editingStateChange=!0,this.editing=e,this.cursorMesh.setVisible(this.editing))}deactivate(){this.sceneInfo.scene.removeChild(d.o.Root,this.cursorMesh.container),this.renderToTexture.disposeRenderTarget2D(this.rttView),this.editing=!1}beforeRender(){this.editing&&(this.hit=this.mobile?this.pointer.lastIntersection:this.pointer.getIntersection(),this.hit&&this.cursorMesh.onPositionUpdate(this.hit.point,this.hit.normal))}render(){if(this.editing&&this.hit){const{screenPosition:t}=(0,Lt.bz)(this.sceneInfo.cameraData,this.hit.point);this.renderIntersection(this.rttView,this.hit,t)}}}var Qt,Zt=i(83075),Kt=i(5984),Jt=i(52947);!function(t){t[t.SnapPoint=1]="SnapPoint",t[t.SnapLine=2]="SnapLine",t[t.AxisAny=3]="AxisAny",t[t.AxisX=4]="AxisX",t[t.AxisY=5]="AxisY",t[t.AxisZ=6]="AxisZ",t[t.Mesh=7]="Mesh",t[t.RoomMesh=8]="RoomMesh",t[t.LinePoint=9]="LinePoint",t[t.LineSegment=10]="LineSegment"}(Qt||(Qt={}));class te extends Jt.cF{constructor(t,e,i){super(t,e),this.featureType=i}}class ee extends Jt.cF{constructor(t,e,i){super(t,e),this.featureType=i}}const ie={[J.os.UP]:Qt.AxisY,[J.os.DOWN]:Qt.AxisY,[J.os.FORWARD]:Qt.AxisZ,[J.os.BACK]:Qt.AxisZ,[J.os.LEFT]:Qt.AxisX,[J.os.RIGHT]:Qt.AxisX,[J.os.HORIZONTAL_PLANE]:Qt.AxisY,NONE:void 0};var se;!function(t){t[t.UserAxis=1]="UserAxis",t[t.UserPoint=2]="UserPoint",t[t.UserLine=3]="UserLine",t[t.ModelFeature=4]="ModelFeature"}(se||(se={}));const ne={[Qt.LinePoint]:se.UserPoint,[Qt.LineSegment]:se.UserLine,[Qt.AxisAny]:se.UserAxis,[Qt.AxisX]:se.UserAxis,[Qt.AxisY]:se.UserAxis,[Qt.AxisZ]:se.UserAxis,[Qt.Mesh]:se.ModelFeature,[Qt.RoomMesh]:se.ModelFeature,[Qt.SnapLine]:se.ModelFeature,[Qt.SnapPoint]:se.ModelFeature};class oe{constructor(t,e,i,s){this.constraint=e,this.meshQuery=i,this.point=new b.Vector3,this.normal=new b.Vector3,ae(t,i)?this.updateFromIntersection(t,e):re(t,i)&&s&&this.updateFromSnapIntersection(t,e,s),this.source=t}updatePoint(t){return this.point.copy(t),this.source.point.copy(t),this}updateFromIntersection(t,e){return this.source=t,this.updateContents(e,t.point,t.face.normal,t.distance,t.object),this}updateFromSnapIntersection(t,e,i){return this.source=t,this.updateContents(e,t.point,i,t.distance,t.object),this}copy({constraint:t,point:e,normal:i,distance:s,object:n}){this.updateContents(t,e,i,s,n)}clone(){return new oe(this.source,this.constraint,this.meshQuery)}updateContents(t,e,i,s,n){this.constraint=t,this.point.copy(e),this.normal.copy(i),this.distance=s,this.object=n;const o=this.meshQuery.roomIdFloorIdFromObject(n);o&&(this.roomId=o.roomId||null,this.floorId=o.floorId),this.featureType=(t=>{if(t)return"featureType"in t&&void 0!==t.featureType?t.featureType:t instanceof b.Vector3||t instanceof Jt.F7?Qt.SnapPoint:Zt.m2.isRoomMesh(t)?Qt.RoomMesh:t instanceof Kt.r?Qt.Mesh:t instanceof b.Line3||t instanceof Jt.cF?Qt.SnapLine:void 0})(n)}}const ae=(t,e)=>t&&"face"in t&&void 0!==t.face&&(e.floorIdFromObject(t.object)||t.object.floorId),re=(t,e)=>t&&"isLineOctreeIntersection"in t&&e.floorIdFromObject(t.object),he=(()=>{class t extends b.Object3D{constructor(t,e,i,s){super(),this.floorId=t,this.roomId=e,this.meshGroup=i,this.meshSubGroup=s}}return(e,i,s,n,o,a,r)=>({point:e,object:new t(n,o,a,r),face:{a:0,b:1,c:2,normal:i,materialIndex:0},distance:s})})();var le=i(21440),de=i(6687),ce=i(94790),ue=i(46957);class pe extends b.Mesh{constructor(t,e,i,s,n,o,a,r,h,l,d,c){super(),this.pointGroups=t,this.input=e,this.cameraData=i,this.mobile=s,this.changeCursor=n,this.getPhase=o,this.changePhase=a,this.restorePreviousPhase=r,this.setSelectedLine=h,this.getSelected=l,this.onDragStart=d,this.onDragEnd=c,this.inputSubscriptions=[],this.groupVisible=[],this.raycast=(()=>{const t=new b.Vector3,e=new b.Vector3,i=new b.Vector3,s=(t,e,i)=>{if(t.isOrtho())return i.copy(e);{const s=S.HT.OFFSET_TOWARDS_CAMERA;return i.copy(t.position).sub(e).setLength(s).add(e)}};return(n,o)=>{const{pose:a,width:r}=this.cameraData,h=this.mobile?3:-2,l=S.UP.lineDefault+h,d=a.projection.asThreeMatrix4(),c=a.position;let u,p=0,m=0;for(let o=0;o<this.pointGroups.groupCount;++o){const h=this.pointGroups.getGroup(o);if(!(void 0!==this.editingGroup&&this.editingGroup!==o)&&this.groupVisible[o]){for(let g=0;g<h.count-1;++g){const f=s(a,h.get(g),e),v=s(a,h.get(g+1),i);if(f&&v){const e=n.ray.distanceSqToSegment(f,v,void 0,t),i=c.distanceTo(t);let s=(0,Mt.ff)(i,d,r)*l;if(s*=s,e<s){let i,a=t;this.editingPointIndex?i=this.editingPointIndex:f.distanceToSquared(t)<2*s?(i=m,a=f):v.distanceToSquared(t)<2*s&&(i=m+1,a=v),(!u||e<p)&&(u={distance:n.ray.origin.distanceTo(a),point:a,object:this,instanceId:o,index:i},p=e)}}m++}m++}else m+=h.count}u&&o.push(u)}})(),this.inputSubscriptions.push(...this.registerCommonInput()),s||this.inputSubscriptions.push(...this.registerHoverInput()),this.deactivate()}activate(){this.input.registerMesh(this,!1),this.inputSubscriptions.forEach((t=>t.renew()))}deactivate(){this.input.unregisterMesh(this),this.inputSubscriptions.forEach((t=>t.cancel()))}dispose(){this.deactivate()}setEditingGroup(t){this.editingGroup=t}setGroupVisible(t,e){this.groupVisible[t]=e}validJoint(t){return!!t&&void 0!==t.index}registerHoverInput(){return[this.input.registerMeshHandler(Ft.L,Bt.f.isType(pe),((t,e,i)=>{this.getPhase()===Q.hb.IDLE&&this.changeCursor(i&&void 0!==i.index?c.b.GRAB:c.b.FINGER)})),this.input.registerMeshHandler(Ft.q,Bt.f.isType(pe),((t,e,i)=>{this.getPhase()===Q.hb.IDLE&&this.changeCursor(c.b.DEFAULT)}))]}registerCommonInput(){return[this.input.registerMeshHandler(Ot.rX,Bt.f.isType(pe),((t,e,i)=>{if(!(0,ue.d)(t))return!1;if(this.getPhase()!==Q.hb.IDLE)return!1;const s=i&&void 0!==i.instanceId?i.instanceId:-1,n=this.getSelected()===s?-1:s;return this.setSelectedLine(n),!0})),this.input.registerMeshHandler(ce.jF,Bt.f.isType(pe),((t,e,i)=>!!(0,ue.d)(t)&&(!!Q.nm[this.getPhase()]&&(!this.validJoint(i)||(!i||void 0===i.instanceId||(this.getPhase()===Q.hb.EDITING||(this.editingPointIndex=i.index,this.onDragStart(i.instanceId),this.setSelectedLine(i.instanceId),this.changePhase(Q.hb.EDITING),this.mobile||this.changeCursor(c.b.GRABBING)),!0)))))),this.input.registerMeshHandler(ce._w,Bt.f.isType(pe),((t,e,i)=>this.getPhase()===Q.hb.EDITING&&(this.editingPointIndex=void 0,this.restorePreviousPhase(),this.onDragEnd(),this.mobile||this.changeCursor(c.b.DEFAULT),!0)))]}}const me=new y.Ay("snapping");class ge{constructor(t,e,i,s,n,o,a){this.raycaster=t,this.getConstraintStyle=e,this.floorsViewData=s,this.viewmodeData=n,this.meshQuery=o,this.cameraPoseData=a,this.origin=null,this.planeNormal=new b.Vector3,this.plane=new b.Plane,this.ray=new b.Ray,this.originChangedListeners=[],this.registeredSnapFeatures={[se.UserAxis]:[],[se.UserLine]:[],[se.UserPoint]:[],[se.ModelFeature]:[]},this.clearOrigin=()=>{this.origin=null,this.originChangedListeners.forEach((t=>t(null)))},this.setOrigin=(t,e=!1)=>{this.origin&&!e||(this.origin=t,this.plane.setFromNormalAndCoplanarPoint(this.origin.normal,this.origin.point),this.originChangedListeners.forEach((t=>t(this.origin))),me.debug("Updating origin",this.origin,{forceUpdate:e}))},this.setOriginFromPointer=t=>{if(this.origin)return;const e=this.getMeshIntersection();if(!e)return;const i=new oe(e,this.getConstraintStyle(),this.meshQuery);t&&i.updatePoint(t),this.setOrigin(i,!0)},this.snapFeatures=t=>this.registeredSnapFeatures[t].reduce(((t,e)=>t.concat(e.features)),[]),this.addSnapFeatures=(t,e,i)=>{const s=ne[e];this.registeredSnapFeatures[s].push({owner:t,features:i}),me.debug(`Adding ${i.length} snap feature groups`,Qt[e],e)},this.removeSnapFeatures=(t,e)=>{const i=ne[e],s=this.registeredSnapFeatures[i].findIndex((e=>e.owner===t));if(-1!==s){const t=this.registeredSnapFeatures[i].splice(s,1);me.debug(`Removing ${t.length} snap feature groups`,Qt[e],e)}else me.debug(`removeTemporarySnapFeature: ${e} ${Qt[e]} not found from`,t,this.registeredSnapFeatures)},this.filters={nop:t=>!0,isNotMeasurementInput:t=>!(t instanceof pe),meshVisible:t=>!!(0,de.aV)(t)&&(!this.viewmodeData.isDollhouse()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(t.meshGroup)),visibleFloor:t=>{const e=t.object;return!e||!e.meta||null==e.meta.meshGroup||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meta.meshGroup)},userPoints:t=>{if(void 0===t.object)return!1;if((e=t.object)&&e instanceof b.Vector3)for(const e of this.snapFeatures(se.UserPoint))if(e.equals(t.object))return!0;var e;return!1},userLines:t=>{if(void 0===t.object)return!1;if((e=t.object)&&"isSnapAxisLine3"in e||"isSnapUserLine3"in e||"isSnapLine3"in e||"start"in e&&"end"in e&&"closestPointToPoint"in e){for(const e of this.snapFeatures(se.UserLine))if(e.equals(t.object))return!0;for(const e of this.snapFeatures(se.UserAxis))if(e.equals(t.object))return!0}var e;return!1},userFeatures:t=>this.filters.userPoints(t)||this.filters.userLines(t)},this.meshSnapRadius=i?dt:ct}preload(){this.raycaster.snapping.preloadMeshSnapping()}getMeshIntersection(t){let e=[];const i=this.viewmodeData.isFloorplan()||this.viewmodeData.isDollhouse()&&this.cameraPoseData.pitchFactor()<.01;if(t&&t.origin&&t.normal)e=this.raycaster.picking.cast(t.origin,t.normal,this.filters.meshVisible);else if(i){const t=this.floorsViewData.getHighestVisibleFloor(),i=new b.Vector3(0,1,0),s=(new b.Plane).setFromNormalAndCoplanarPoint(i,new b.Vector3(0,t.boundingBox.max.y,0)),n=new b.Vector3;if(this.raycaster.pointer.pointerRay.intersectPlane(s,n)){const s=this.raycaster.pointer.pointerRay.origin.distanceTo(n);e=[he(n,i,s,t.id,null,t.meshGroup,null)]}}else e=this.raycaster.pointer.cast(this.filters.meshVisible);const s=e[0];return ae(s,this.meshQuery)?s:null}getIntersection(t){const e=this.getMeshIntersection(t);if(!e)return null;this.cachedHit||(this.cachedHit=new oe(e,this.getConstraintStyle(),this.meshQuery));const i=this.cachedHit.updateFromIntersection(e,this.getConstraintStyle()),s=this.raycaster.pointer.pointerRay;this.ray.set(s.origin,s.direction),this.planeNormal.copy(i.normal);switch(this.getConstraintStyle()){case tt.Free:return i;case tt.Axes:return this.lockToWorldAxes(i);case tt.PlanarAxes:const t=[...this.snapFeatures(se.UserAxis),...this.snapFeatures(se.UserLine),...this.snapFeatures(se.UserPoint)];return this.softSnapToEdges(i,t,this.filters.userFeatures);case tt.Edges:const e=[...this.snapFeatures(se.UserLine),...this.snapFeatures(se.UserPoint)];return this.softSnapToEdges(i,e,this.filters.visibleFloor);case tt.EdgesAndPlanarAxes:const s=[...this.snapFeatures(se.UserAxis),...this.snapFeatures(se.UserLine),...this.snapFeatures(se.UserPoint)];return this.softSnapToEdges(i,s,this.filters.visibleFloor)}return i}get lastIntersection(){return this.cachedHit}onOriginChanged(t,e=!1){const i={renew:()=>{this.originChangedListeners.push(t)},cancel:()=>{(0,le.Nz)(this.originChangedListeners,t)}};return e&&i.renew(),i}lockToWorldAxes(t){if(this.origin){const e=st(this.origin.point,t.point,tt.Axes);return this.cachedHit.copy(t),this.cachedHit.point.copy(e.position),this.cachedHit.constraint="NONE"!==e.axisName?tt.Axes:tt.Free,this.cachedHit.featureType=ie[e.axisName],this.cachedHit}return t}softSnapToEdges(t,e,i){const s=this.origin?this.origin.point:t.point,n=this.origin?this.origin.normal:t.normal;this.raycaster.snapping.add(...e);const o=this.raycaster.snapping.cast(this.ray,this.meshSnapRadius,s,n).filter(i),a=this.findClosestVisible(o);return this.raycaster.snapping.remove(...e),a?(this.cachedHit.updateFromSnapIntersection(a,this.getConstraintStyle(),n),this.cachedHit):t}findClosestVisible(t){let e=null;const i=new b.Vector3;for(const s of t){i.copy(s.point).sub(this.ray.origin).normalize();const t=this.raycaster.picking.pick(this.ray.origin,i,this.filters.meshVisible);if(!t||t.distance>s.distance-.05){e=s;break}}return e?{isLineOctreeIntersection:!0,distance:e.distance,distanceToRay:e.distanceToRay,point:e.point,object:e.object}:null}}var fe=i(79070);class ve{constructor(t,e,i,s){this.points=t,this.createPointSubscription=e,this.pointer=i,this.mobileCreateHackJob=s,this.subscriptions=[],this.lineSegments=[],this.updateSnapping=t=>{this.lineSegments.length>0&&(this.pointer.removeSnapFeatures(this,Qt.LineSegment),this.lineSegments.length=0);for(let e=0;e<this.points.length;e++)if(e!==t&&e!==t-1&&e!==t+1&&!this.points.isStartIndex(e)){const t=this.points.get(e),i=this.points.get(e-1);this.lineSegments.push(new ee(i,t,Qt.LineSegment))}this.lineSegments.length>0&&this.pointer.addSnapFeatures(this,Qt.LineSegment,this.lineSegments)}}init(){}dispose(){}activate(t){let e=-1,i=-1;const s=(0,fe.s)((()=>this.updateSnapping(this.points.length)),16);this.subscriptions.push(this.createPointSubscription(St.ADDED,s,!0),this.createPointSubscription(St.REMOVED,s,!0),this.createPointSubscription(St.UPDATED,((t,s)=>{s===e||this.mobileCreateHackJob()&&s===i||(this.updateSnapping(s),i=e,e=s)}),!0))}deactivate(){this.subscriptions.forEach((t=>t.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,Qt.LinePoint),this.pointer.removeSnapFeatures(this,Qt.LineSegment)}beforeRender(){}render(){}}var ye=i(72268);class be{constructor(t,e,i,s,n,o){this.points=t,this.pointer=i,this.getPhase=s,this.onDrag=n,this.onDragEnd=o,this.inputSubscriptions=[],this.dragging=!1,this.onDragBegin=(t,e,i)=>{if(!Q.y_[this.getPhase()])return!1;if(!i||void 0===i.index)return!1;this.dragging=!0;const s=this.points.isStartIndex(i.index)?i.index+1:i.index-1,n=this.points.get(s);return this.pointer.clearOrigin(),this.pointer.setOriginFromPointer(n),!0},this.onDragEndEvent=()=>!!Q.y_[this.getPhase()]&&(!!this.dragging&&(this.onDragEnd(),this.pointer.clearOrigin(),this.dragging=!1,!0)),this.onDragEvent=(t,e,i)=>{if(t.buttons!==ye.O.PRIMARY)return!1;if(!Q.y_[this.getPhase()])return!1;if(!i||void 0===i.index||void 0===i.instanceId)return!1;const s=this.pointer.getIntersection();return s&&this.points.update(i.index,s.point),this.onDrag(i.instanceId),!0},this.inputSubscriptions.push(e.registerMeshHandler(ce.SK,Bt.f.isType(pe),this.onDragBegin),e.registerMeshHandler(ce.jF,Bt.f.isType(pe),this.onDragEvent),e.registerMeshHandler(ce._w,Bt.f.isType(pe),this.onDragEndEvent)),this.deactivate()}activate(){for(const t of this.inputSubscriptions)t.renew()}deactivate(){for(const t of this.inputSubscriptions)t.cancel()}}var we=i(78079);class De{constructor(t,e,i,s,n,o,a){this.lines=t,this.getLinesForPoint=e,this.editingMaterial=i,this.createPointSubscription=s,this.getPhase=o,this.getSelected=a,this.bindings=[],this.onDragEnd=t=>{for(const t of this.lines)t.restoreLineMaterial()},this.onClick=(t,e,i)=>{if(this.getPhase()!==Q.hb.IDLE)return!1;for(const t of this.lines)t.restoreLineMaterial();if(!i||void 0===i.index)return!1;if(t.down){const t=i.index;void 0!==t&&this.styleLines(t)}return!1},this.styleLines=t=>{const e=this.getLinesForPoint(t);for(const t of e)t.group===this.getSelected()&&t.line.overrideLineMaterial(this.editingMaterial)},this.bindings.push(n.registerMeshHandler(we.CD,Bt.f.isType(pe),this.onClick),n.registerUnfilteredHandler(ce._w,this.onDragEnd),...this.setupLineStyler(this.createPointSubscription)),this.deactivate()}activate(){for(const t of this.bindings)t.renew()}deactivate(){for(const t of this.bindings)t.cancel()}setupLineStyler(t){return[t(St.ADDED,(()=>{const t=this.lines[this.lines.length-1];t&&t.restoreLineMaterial()}),!0),t(St.UPDATED,((t,e)=>{this.styleLines(e)}),!0)]}}var Se=i(18633),Ie=i(79875);class Te{constructor(t,e,i,s,o,a,r,h,l,d){this.points=t,this.setSelected=e,this.pointer=i,this.changePhase=s,this.getPhase=o,this.isFloorplan=a,this.currentFloorId=r,this.currentRoomId=h,this.currentLayerId=l,this.inferRoomAssociation=d,this.id=Te,this.onGroupCreated=t=>null,this.onGroupAddPoint=()=>null,this.onDone=()=>null,this.onEdit=t=>null,this.previousPhase=Q.hb.IDLE,this.currentLinePoints=0,this.previousPoint=new b.Vector3,this.inputSubscriptions=[],this.log=new y.Ay("measurement-creator"),this.isReadonly=!1,this.createNewLine=t=>{const e=this.inferRoomAssociation(t),i=t.roomId||e.roomId||this.currentRoomId()||void 0,s=t.floorId||e.floorId||this.currentFloorId();if(this.log.debug(`Starting measurement: floorId="${s}" roomId="${i}"`),!s)throw new Ie.v(`Cannot create new line on invalid floor '${s}'`);const o={visible:!0,roomId:i,floorId:s,type:this.isFloorplan()?n.FloorplanOnly:n.ThreeD,text:"",created:new Date,modified:new Date,temporary:this.isReadonly,layerId:this.currentLayerId()},a=this.points.startGroup(o);this.currentGroup=a,this.points.push(t.point),this.currentLinePoints=1,this.setSelected(a);const r=this.points.getGroup(a);this.onGroupCreated(r.info.sid),this.pointer.setOrigin(t,!0)},this.addPointToLine=t=>{this.previousPoint.copy(t.point),this.points.push(t.point),++this.currentLinePoints,this.onGroupAddPoint(),this.pointer.setOrigin(t,!0)},this.updateLastPoint=t=>{this.points.update(this.points.length-1,t.point)},this.getIntersection=()=>this.pointer.getIntersection(),this.setPhase=t=>{const e=this.getPhase();t!==e&&(this.previousPhase=e,this.changePhase(t))},this.restorePreviousPhase=()=>{this.setPhase(this.previousPhase)}}start(){if(this.getPhase()===Q.hb.IDLE){this.previousPoint.set(1e3,1e3,1e3),this.setPhase(Q.hb.CREATING),this.setSelected(-1);for(const t of this.inputSubscriptions)t.renew()}}cancelSubs(){for(const t of this.inputSubscriptions)t.cancel()}stop(){this.cancelSubs(),this.currentLinePoints=0,this.setSelected(-1),this.setPhase(Q.hb.IDLE),this.pointer.clearOrigin(),this.onDone()}syncReadonly(t){this.isReadonly=t}}class Pe extends Te{constructor(t,e,i,s,n,o,a,r,h,l,d,c,u,p,m){super(t,e,s,n,h,d,c,u,p,m),this.setCreatePointProgress=o,this.updateCreatePointHit=a,this.toggleCameraMovement=r,this.continuous=l,this.onLongPressSuccess=t=>{this.log.debug("onLongPressSuccess while in phase:",Q.hb[this.getPhase()]),this.getPhase()===Q.hb.CREATING?(this.createNewLine(t),this.addPointToLine(t)):this.getPhase()===Q.hb.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(t),this.addPointToLine(t)):this.updateLastPoint(t)),this.setPhase(Q.hb.POINT_PLACED)},this.onLongPressStart=t=>{if(t.buttons===ye.O.PRIMARY&&(this.getPhase()===Q.hb.CREATING||this.getPhase()===Q.hb.CREATING_NEXT_POINT)){const t=this.getIntersection();t&&(this.previousPoint.equals(t.point)||(this.setPhase(Q.hb.CONFIRMING_POINT),this.toggleCameraMovement(!1),this.setCreatePointProgress(Date.now(),Pe.longPressCreateThreshold),this.updateCreatePointHit(t),this.previousPhase===Q.hb.CREATING_NEXT_POINT&&(this.updateLastPoint(t),this.toggleLastPointDraggable(!1)),this.creatingPointTimeout=window.setTimeout((()=>{this.restorePreviousPhase(),this.onLongPressSuccess(t),this.toggleLastPointDraggable(!0)}),Pe.longPressCreateThreshold)))}},this.onLongPressEnd=()=>{this.getPhase()===Q.hb.CONFIRMING_POINT&&(this.log.debug("onLongPressEnd, cancelling confirmation"),this.setCreatePointProgress(0,Pe.longPressCreateThreshold),window.clearTimeout(this.creatingPointTimeout),this.toggleCameraMovement(!0),this.restorePreviousPhase()),this.getPhase()===Q.hb.CREATING_NEXT_POINT&&this.points.update(this.points.length-1,this.points.get(this.points.length-2)),this.setPlacedtoCreatePhase()},this.onDrag=()=>{const t=this.getIntersection();t&&(this.setPlacedtoCreatePhase(),this.setPhase(Q.hb.EDITING),this.previousPhase===Q.hb.CREATING_NEXT_POINT?this.updateLastTwoPoints(t):this.previousPhase===Q.hb.CREATING&&this.updateLastPoint(t))},this.onDragEnd=()=>{this.getPhase()===Q.hb.EDITING&&this.restorePreviousPhase(),this.getPhase()!==Q.hb.CREATING&&this.getPhase()!==Q.hb.CREATING_NEXT_POINT||(this.toggleLastPointDraggable(!1),this.toggleCameraMovement(!0))},this.toggleLastPointDraggable=t=>{t?(this.dragSub.renew(),this.dragEndSub.renew()):(this.dragSub.cancel(),this.dragEndSub.cancel())},this.updateLastTwoPoints=t=>{this.points.update(this.points.length-1,t.point),this.points.update(this.points.length-2,t.point)},this.dragSub=i(ce.jF,this.onDrag),this.dragEndSub=i(ce._w,this.onDragEnd),this.inputSubscriptions.push(i(Se.OR,this.onLongPressStart),i(Se.vp,this.onLongPressEnd),i(Ot.wR,(t=>t.preventDefault()))),this.dragSub.cancel(),this.dragEndSub.cancel(),this.cancelSubs()}start(){super.start()}stop(){if(this.getPhase()===Q.hb.CREATING_NEXT_POINT)if(this.continuous())this.points.pop();else{const t=this.points.getGroup(this.currentGroup);this.points.removeFromIdx(t.startIndex)}super.stop()}setPlacedtoCreatePhase(){this.getPhase()===Q.hb.POINT_PLACED&&(this.continuous()?(this.previousPhase===Q.hb.CREATING||this.previousPhase===Q.hb.CREATING_NEXT_POINT)&&this.setPhase(Q.hb.CREATING_NEXT_POINT):this.previousPhase===Q.hb.CREATING?this.setPhase(Q.hb.CREATING_NEXT_POINT):this.previousPhase===Q.hb.CREATING_NEXT_POINT&&this.setPhase(Q.hb.CREATING))}}Pe.longPressCreateThreshold=500;class Ee extends Te{constructor(t,e,i,s,n,o,a,r,h,l,d,c,u){super(t,e,s,n,o,a,r,h,l,c),this.continuous=d,this.meshQuery=u,this.onCreate=t=>{const e=this.previousPoint.distanceTo(t.point)>.01;if(this.getPhase()===Q.hb.CREATING)return this.createNewLine(t),this.addPointToLine(t),void this.setPhase(Q.hb.CREATING_NEXT_POINT);e&&this.getPhase()===Q.hb.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(t),this.addPointToLine(t)):this.finishLine(t))},this.onMouseMove=()=>{if(this.getPhase()===Q.hb.CREATING_NEXT_POINT){const t=this.getIntersection();t&&this.updateLastPoint(t)}},this.onMouseClick=t=>{if(t.button!==ye.m.PRIMARY||this.getPhase()===Q.hb.IDLE)return;const e=this.getIntersection();e&&this.onCreate(e)},this.onDoubleClick=t=>{if(t.preventDefault(),t.button!==ye.m.PRIMARY||this.getPhase()===Q.hb.IDLE)return;const e=this.getIntersection();if(e&&2===this.currentLinePoints){const t={origin:e.point.addScaledVector(e.normal,.05),normal:e.normal},i=this.pointer.getMeshIntersection(t);if(i)if(this.continuous()){this.points.pop();const t=new oe(i,tt.Free,this.meshQuery);this.addPointToLine(t),this.addPointToLine(t),this.setPhase(Q.hb.CREATING_NEXT_POINT)}else this.finishLine(new oe(i,tt.Free,this.meshQuery))}},this.inputSubscriptions.push(i(we.$3,this.onMouseMove),i(Ot.rX,this.onMouseClick),i(Ot.wR,this.onDoubleClick)),this.cancelSubs()}start(){super.start()}stop(){this.getPhase()===Q.hb.CREATING_NEXT_POINT&&(this.points.pop(),this.currentLinePoints<3&&this.points.pop()),super.stop()}finishLine(t){this.points.pop(),this.addPointToLine(t),this.setPhase(Q.hb.CREATING),this.onDone()}}var Ce=i(12554),Me=i(3694),xe=i(60043),Ae=i(68986),Re=i(28337),Le=i(71397),Oe=i(64491),Fe=i(41837);class Be{constructor(t,e,i,s,n){this.pointer=t,this.mobile=e,this.getPhase=i,this.scene=s,this.getLayer=n,this.subscriptions=[],this.editing=!1,this.axisLines=[],this.axisAlignmentHelper=new b.Object3D,this.updateSnapping=t=>{if(this.axisLines.length>0&&(this.pointer.removeSnapFeatures(this,Qt.AxisAny),this.axisLines.length=0),t){this.axisAlignmentHelper.position.copy(t.point);const e=(0,Mt.KK)(this.axisAlignmentHelper,t.point,t.normal);this.axisAlignmentHelper.updateMatrixWorld(!0);const i=this.axisAlignmentHelper.matrixWorld,s=100,n=(t,e,i,n)=>{const o=new te(t.clone().multiplyScalar(s),e.clone().multiplyScalar(s),n);return o.applyMatrix4(i),o},o=(new b.Matrix4).copyPosition(i);this.axisLines.push(n(J.B1.UP,J.B1.DOWN,o,Qt.AxisY)),e||this.axisLines.push(n(J.B1.FORWARD,J.B1.BACK,i,Qt.AxisY),n(J.B1.UP,J.B1.DOWN,i,Qt.AxisX),n(J.B1.LEFT,J.B1.RIGHT,i,Qt.AxisZ)),this.axisLines.length>0&&this.pointer.addSnapFeatures(this,Qt.AxisAny,this.axisLines)}}}init(){}dispose(){}activate(){this.subscriptions.push(this.pointer.onOriginChanged(this.updateSnapping,!0)),this.axisLineRenderer=new Ve(this.scene,this.getLayer("cursor-mesh"))}deactivate(){this.subscriptions.forEach((t=>t.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,Qt.AxisAny),this.axisLineRenderer.dispose(),this.axisLineRenderer=null}beforeRender(){const t=this.getPhase(),e=this.mobile?!!Q.TI.mobile[t]:!!Q.TI.desktop[t];e!==this.editing&&(this.editing=e,this.axisLineRenderer.clearLines())}render(){this.editing&&this.axisLineRenderer.render(this.pointer.lastIntersection,this.axisLines)}}class Ve{constructor(t,e){this.scene=t,this.layer=e,this.offsetFromMesh=.0075,this.featureColors={[Qt.AxisX]:Ct.x,[Qt.AxisZ]:Ct.z,[Qt.AxisY]:Ct.y},this.axesVisibleInConstraints={[tt.EdgesAndPlanarAxes]:!0,[tt.Axes]:!0,[tt.PlanarAxes]:!0},this.linesActive=[],this.linesFree=[],this.axesVisible=[],this.axisMat=new b.LineBasicMaterial({color:4095,linewidth:1,opacity:.75,transparent:!0,depthWrite:!1,depthTest:!0}),this.render=(t,e)=>{if(t&&this.axesVisibleInConstraints[t.constraint]&&e.length>0){if(e.length!==this.axesVisible.length)this.clearLines();else{this.axesVisible.every(((t,i)=>t.equals(e[i])))||this.clearLines()}if(this.container.parent!==this.scene.scene){for(const t of e){const e=this.getMesh(t);e.material.color.setHex(this.featureColors[t.featureType]),this.container.add(e),this.linesActive.push(e)}this.axesVisible=e.map((t=>t)),this.scene.addChild(d.o.Root,this.container),this.container.position.copy(t.normal).multiplyScalar(this.offsetFromMesh),this.container.updateMatrixWorld(!0)}}else this.clearLines()},this.clearLines=()=>{if(0!==this.linesActive.length){for(;this.linesActive.length>0;){const t=this.linesActive.pop();t&&(this.container.remove(t),this.linesFree.push(t))}this.scene.removeChild(d.o.Root,this.container)}},this.container=new b.Object3D}getMesh(t){let e=this.linesFree.pop();return e?e.geometry.setFromPoints([t.start,t.end]):(e=new Ne(t,this.axisMat.clone()),e.layers.mask=this.layer.mask),e}dispose(){for(this.clearLines();this.linesFree.length>0;){const t=this.linesFree.pop();t&&(this.container.remove(t),t.geometry.dispose(),t.material.dispose())}this.linesActive=[],this.linesFree=[],this.container=null}}class Ne extends b.Line{constructor(t,e){super(void 0,e),this.material=e,this.geometry=(new b.BufferGeometry).setFromPoints([t.start,t.end])}}var ke=i(15404),Ge=i(81530),He=i(47737),_e=i(93877),Ue=i(80788),We=i(96276),ze=i(20968),je=i(56388),$e=i(64639);const Xe={[n.FloorplanOnly]:l._f.LINETYPE_2D,[n.ThreeD]:l._f.LINETYPE_3D},qe={[l._f.LINETYPE_2D]:n.FloorplanOnly,[l._f.LINETYPE_3D]:n.ThreeD};class Ye{serialize(t,e){if(!t)return null;const i=[],{text:s,visible:n,type:o,floorId:a,roomId:r,layerId:h}=t.info;for(const e of t){const t={position:qt.U$.toVisionVector(e)};a&&(t.floorId=a),r&&(t.roomId=r),i.push(t)}const d={enabled:n,label:s,version:"3.2",lineType:Xe[o]||l._f.LINETYPE_3D,points:i};return e&&(d.layerId=h),this.validate(d)?d:null}validate(t){return!!t&&!(t.points.length<2)}}var Qe=i(81587);const Ze=new y.Ay("mds-measurement-serializer");class Ke{constructor(){this.points=(0,Ce.Z)([]),this.grouper=new bt(this.points)}deserialize(t){var e;if(!t||!Array.isArray(t))return Ze.debug("No contents",t),null;this.grouper.reset();for(const i of t)if(this.validate(i)){const t=i.lineType||l._f.LINETYPE_3D,s=qe[t],n=this.getModelContextFromPoint(i.points[0]),o=Object.assign(Object.assign({layerId:(null===(e=i.layer)||void 0===e?void 0:e.id)||"",sid:i.id,text:i.label||"",visible:i.enabled,type:s},n),{created:(0,Qe.X)(i.created),modified:(0,Qe.X)(i.modified),temporary:!1});this.grouper.startGroup(o),i.points.forEach((t=>this.grouper.push(qt.U$.fromVisionVector(t.position))))}else Ze.debug("Deserialized invalid Measurement data from MDS",i);return 0===this.grouper.length?null:this.grouper}validate(t){if(!t||"object"!=typeof t)return!1;const e=["id","points"].every((e=>e in t)),i=t.points&&Array.isArray(t.points)&&t.points.length>0,s=e&&i;return s||Ze.debug("Invalid MDS.MeasurementPath:",{hasRequiredFields:e,hasPoints:i,data:t}),s}getModelContextFromPoint(t){return{floorId:t.floor&&t.floor.id?t.floor.id:"",roomId:t.room&&t.room.id?t.room.id:""}}}class Je extends ze.g{constructor(){super(...arguments),this.serializer=new Ye,this.deserializer=new Ke,this.prefetchKey="data.model.measurementPaths",this.layeredType=l.jM.MEASUREMENTPATH}async read(t){const{readonly:e}=this.config,i={modelId:this.getViewId(),includeDisabled:!e,includeLayers:this.readLayerId()};return this.query($e.GetMeasurements,i,t).then((t=>{var e,i;if(!je.t.isOk(t,"model.measurementPaths"))throw new We.tW("MdsMeasurementModeStore.read failed");return this.deserializer.deserialize(null===(i=null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.measurementPaths)}))}async create(t){const e=this.getViewId(),i=this.serializer.serialize(t,this.writeLayerId(t.info.layerId));if(!i)throw new Error("Could not create Measurement");return this.mutate($e.AddMeasurement,{modelId:e,data:i}).then((t=>{var e,i;const s=null===(i=null===(e=t.data)||void 0===e?void 0:e.addMeasurementPath)||void 0===i?void 0:i.id;if(!s)throw new Error("Unable to add measurement!");return s}))}async update(t){if(!t||0===t.length)return Promise.resolve();const e=this.getViewId();let i="";const s={};s.modelId=e;let n="";for(const e of t){const t=e.info.sid,o=this.serializer.serialize(e,!1);if(!o)throw new Error("Could not update Measurement");s[`data${t}`]=o,i+=`, $data${t}: MeasurementPathPatch!`,n+=`patch${t}: patchMeasurementPath(modelId: $modelId, pathId: "${t}", patch: $data${t}) {\n        id\n      }`}const o=Ue.gql`
      mutation PatchMeasurements($modelId: ID! ${i}) {
        ${n}
      }
    `;return this.mutate(o,s).then((()=>{}))}async delete(...t){if(!t||0===t.length)return;const e=this.getViewId();let i="";for(const e of t){const{pathId:t}=e;i+=`delete${t}: deleteMeasurementPath(modelId: $modelId, pathId: "${t}")`}const s=Ue.gql`
      mutation DeleteMeasurements($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(s,{modelId:e}).then((()=>{}))}}var ti=i(50485),ei=i(76234),ii=i(58899),si=i(84917);class ni extends ii.r{constructor(t,e,i,s,n,o){super(t,e,i),this.group=s,this.units=n,this.id=this.group.info.sid,this.title=ni.getTitle(this.group,this.units,this.textParser),this.description=ni.getDescription(this.group,this.units),this.label=ni.getLabel(this.group,this.textParser),this.icon="icon-tape-measure",this.enabled=this.group.info.visible,this.typeId=l.jM.MEASUREMENTPATH,this.floorId=this.group.info.floorId,this.roomId=this.group.info.roomId||"",this.layerId=this.group.info.layerId,this.dateBucket=(0,si.n)(this.group.info.created),this.onSelect=async()=>{super.onSelect(),this.commandBinder.issueCommand(new j(this.id))},this.textParser=o}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}static getTitle(t,e,i){const s=(0,I.R5)(t.length,e),n=ni.getLabel(t,i);return n?`${s} ${n}`:s}static getLabel(t,e){return e.getPlainText(t.info.text)}static getDescription(t,e){if(t.count>2){return t.segmentLengths.map((t=>(0,I.R5)(t,e))).join(" – ")}return""}}var oi=i(39905),ai=i(94547),ri=i(74848),hi=i(95846),li=i(89395),di=i(28479),ci=i(13397),ui=i(95143),pi=i(53180),mi=i(45269),gi=i(97006),fi=i(55666),vi=i(68375);const yi=({item:t})=>{const e=(0,vi.s)(),i=(0,hi.B)(t.id),s=(0,ci.e)(),o=(0,li.E)(),a=(0,di.L)();if(!i)return null;const{id:r,textParser:h,title:l,description:d,icon:c}=t,u=r===o,p=i.info.type===n.FloorplanOnly?"floorplan":"dollhouse",m=s?(0,ui.x8)(l,s):l,g=s?(0,ui.x8)(d,s):d,f=(0,ri.jsxs)("div",Object.assign({className:"item-details"},{children:[(0,ri.jsxs)("div",Object.assign({className:"item-header"},{children:[(0,ri.jsx)(fi.L,{text:m||"",textParser:h,markers:ui.S8}),(0,ri.jsx)("div",Object.assign({className:"list-item-decal"},{children:(0,ri.jsx)(pi.I,{name:p})}))]})),d&&(0,ri.jsx)("div",Object.assign({className:"item-description"},{children:(0,ri.jsx)(fi.L,{text:g,textParser:h,markers:ui.S8})}))]}));return(0,ri.jsx)(mi.c,{id:r,className:"search-result-item",title:f,active:u,disabled:!t.enabled,onClick:async()=>{e.trackGuiEvent("search_item_measurement_click",{tool:a}),t.onSelect()},badge:(0,ri.jsx)(gi.E,{iconClass:c})},r)};var bi=i(56147);const{MEASUREMENTS:wi}=bi.A.SHOWCASE,Di=new oi.r({});var Si=i(39118),Ii=i(46192),Ti=i(4298),Pi=i(38069);class Ei extends o.n{constructor(){super(),this.name="measurement-mode",this.mutationRecord={[ei.Xw.added]:new Set,[ei.Xw.updated]:new Set,[ei.Xw.removed]:new Set},this.removedLayerMap=new Map,this.store=null,this.newDataBinding=null,this.roomboundData=null,this.longPressStart=Date.now(),this.threshold=800,this.lineSidToPointMap={},this.mobile=!1,this.cameraAndDragBlocked=!1,this.blockNavigation=()=>!1,this.visibilityFilterEnabled=!1,this.editable=!0,this.changeCursor=t=>{this.engine.commandBinder.issueCommand(new p.X(t))},this.onEdit=t=>{const e=this.data.getGroupInfo(t),i=e&&e.info.sid||null;this.data.editingGroupId!==i&&(this.data.editingGroupId=i,this.colliders.setEditingGroup(t))},this.onEditEnd=()=>{if(this.data.editingGroupId){const t=this.pointGroups.getGroupById(this.data.editingGroupId);t&&(this.mutationRecord.updated.add(t.info.sid),this.save(),this.engine.broadcast(new Fe.bV(this.buildAnalyticsMessageFromGroup(t))))}this.data.editingGroupId=null,this.colliders.setEditingGroup(void 0)},this.onCreatorAddNewLine=t=>{this.log.debug("onCreatorAddNewLine",t),this.data.creatingGroupId=t},this.onCreatorAddPoint=()=>{if(this.data.creatingGroupId){this.log.debug("onCreatorAddNewSegment",this.data.creatingGroupId);const t=this.pointGroups.getGroupById(this.data.creatingGroupId);if(t&&t.count>1&&t.length>0){const e=this.buildAnalyticsMessageFromGroup(t);this.engine.broadcast(new Fe.hR(Object.assign(Object.assign({},e),{startPosition:this.pointGroups.get(t.startIndex),endPosition:this.pointGroups.get(t.endIndex)})))}}},this.onCreatorStop=()=>{if(this.data.creatingGroupId){const t=this.pointGroups.getGroupById(this.data.creatingGroupId);t&&(t.count>1&&t.hasLength()?(this.engine.broadcast(new Fe.QZ(Object.assign({},this.buildAnalyticsMessageFromGroup(t)))),this.mutationRecord.added.add(t.info.sid),this.save()):this.engine.broadcast(new Fe.sN))}this.data.creatingGroupId=null},this.onToggleMeasurementMode=async(t,e,i)=>{this.toggleMeasuringMode(t,i)},this.onViewmodeChange=()=>{this.getPhase()!==Q.hb.CLOSED&&this.stopMeasuring()},this.onSweepChange=()=>{const t=this.getPhase();t!==Q.hb.CREATING&&t!==Q.hb.CREATING_NEXT_POINT&&this.setSelected(-1)},this.initStorageOnApplicationChange=async()=>{var t;const e=this.loadSavedMeasurements();this.data.modeActive()&&this.engine.commandBinder.issueCommand(new F.S(!1)),this.store&&e&&!this.newDataBinding?this.newDataBinding=this.store.onNewData((async t=>{this.getPhase()!==Q.hb.CLOSED&&this.stopMeasuring(),this.loadSavedMeasurements()?this.replaceContents(null==t?void 0:t.groups()):this.replaceContents(),this.clearMutationRecord()})):this.newDataBinding&&!e&&(this.newDataBinding.cancel(),this.newDataBinding=null,this.replaceContents()),e&&await(null===(t=this.store)||void 0===t?void 0:t.refresh())},this.getPhase=()=>this.data.phase,this.toggleCameraMovement=t=>{t||this.cameraAndDragBlocked?t&&this.cameraAndDragBlocked&&(this.dragInterceptor.cancel(),this.navigation.removeNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!1):(this.dragInterceptor.renew(),this.navigation.addNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!0)},this.getConstraint=()=>this.settings.tryGetProperty(R.Y.MeasurementSnapping,!1)?this.viewmodeData.isFloorplan()||(0,Lt.aY)(this.cameraData.pose.pitchFactor())?lt.floorplan:this.constraint:lt.disabled,this.selectedItemChanged=()=>{const{activeItemId:t,selectedType:e}=this.searchData;-1===this.getSelected()||t&&e===l.jM.MEASUREMENTPATH||this.setSelectedById(null)},this.getSelected=()=>this.data.selectedGroupIndex,this.setSelected=t=>{this.data.selectedGroupIndex!==t&&this.data.setSelectedGroupIndex(t)},this.setSelectedById=t=>{if(null===t)this.setSelected(-1);else{const e=this.pointGroups.getGroupById(t);e&&this.setSelected(e.index)}},this.deleteSelectedMeasurement=()=>{-1!==this.data.selectedGroupIndex&&(this.deleteMeasurement(this.data.selectedGroupIndex),this.setSelected(-1),this.changePhase(Q.hb.IDLE),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new p.X(c.b.DEFAULT))))},this.deleteMeasurementBySids=async t=>{const e=t.sids;for(const i of e){const e=this.pointGroups.getGroupById(i);if(!e)throw this.log.error("Measurement delete failed",Object.assign({},t)),Error("Measurement delete failed, not found");this.deleteMeasurement(e.index,!0)}this.save()},this.onToggleContinuous=()=>{this.stopMeasuring()},this.changePhase=t=>{this.getPhase()!==t&&(this.log.debug(`Phase Change: ${Q.hb[this.getPhase()]} -> ${Q.hb[t]}`),this.previousPhase=this.getPhase(),this.data.setPhase(t))},this.restorePreviousPhase=()=>{this.changePhase(this.previousPhase)},this.onPhaseChange=t=>{if(this.intersectionVisualizer.setMeasuringPhase(t),this.previousPhase!==t)switch(t){case Q.hb.CLOSED:case Q.hb.IDLE:this.engine.broadcast(new $.Vk(!0)),this.engine.commandBinder.issueCommand(new Y.RK);break;case Q.hb.EDITING:case Q.hb.CREATING:case Q.hb.POINT_PLACED:case Q.hb.CREATING_NEXT_POINT:case Q.hb.CONFIRMING_POINT:this.engine.broadcast(new $.Vk(!1)),this.engine.commandBinder.issueCommand(new Y.WH)}},this.buildAnalyticsMessage=t=>{const e=this.pointGroups.getGroup(t);return e&&e.hasLength()?this.buildAnalyticsMessageFromGroup(e):null},this.buildAnalyticsMessageFromGroup=t=>{const e=n[t.info.type];return Object.assign(Object.assign({sid:t.info&&t.info.sid?t.info.sid:t.describe(),totalLength:t?t.length:0,segments:t?t.count:0,temporary:!!t.info.temporary,viewmode:this.viewmodeData.peekabooCorrectedMode(this.cameraData),floorId:t.info.floorId,continuous:this.settings.tryGetProperty(R.Y.MeasurementContinuousLines,!1)},this.getAnalyticsForConstraints()),{type:e})},this.getAnalyticsForConstraints=()=>{const t=this.pointer.lastIntersection;if(t){const e=t.featureType,i=t.constraint;return{featureType:void 0!==e?Qt[e]:"None",constraint:tt[i]}}return null},this.toggleMeasuringMode=(t,e)=>{this.log.debug("toggleMeasuringMode",t);t!==(this.getPhase()!==Q.hb.CLOSED)&&(t?(this.editable=e,this.engine.toggleRendering(this,!0),this.changePhase(Q.hb.IDLE),this.lineStyler.activate(),this.renderer.activate(),this.textRenderer.activate(),this.editable&&(this.editor.activate(),this.colliders.activate(),this.textRenderer.activateInteraction()),this.scene.addChild(d.o.Root,this.textRenderer.container),this.engine.broadcast(new Fe.z(!0,this.viewmodeData.peekabooCorrectedMode(this.cameraData),this.pointGroups.groupCount))):(this.engine.toggleRendering(this,!1),this.stopMeasuring(),this.changePhase(Q.hb.CLOSED),this.toggleCameraMovement(!0),this.editable&&(this.editor.deactivate(),this.colliders.deactivate(),this.textRenderer.deactivateInteraction()),this.lineStyler.deactivate(),this.renderer.deactivate(),this.textRenderer.deactivate(),this.scene.removeChild(d.o.Root,this.textRenderer.container),this.engine.broadcast(new Fe.z(!1,this.viewmodeData.peekabooCorrectedMode(this.cameraData),this.pointGroups.groupCount))))},this.startMeasuring=()=>{this.settings.tryGetProperty(R.Y.MeasurementSnapping,!1)&&this.pointer.preload(),this.mobile||(this.navigation.addNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new p.X(c.b.XHAIR))),this.creator.start()},this.stopMeasuring=()=>{if(this.getPhase()===Q.hb.CLOSED)return;const t=this.isMeasurementComplete(this.data.selectedGroupIndex);this.isCreating()&&!t&&this.deleteSelectedMeasurement(),this.creator.stop(),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new p.X(c.b.DEFAULT)))},this.setupIntersectionVisuals=(t,e,i,s,n,o,a,r)=>{e.addVisibilityRule((()=>{const t=this.getPhase();return!(!o&&t===Q.hb.CREATING||t===Q.hb.CONFIRMING_POINT||t===Q.hb.CREATING_NEXT_POINT||t===Q.hb.EDITING)}));const h={cameraData:s,playerCamera:i.camera,scene:i};return new Yt(o,n,h,t,a,(()=>r.peekabooCorrectedMode(this.cameraData)===v.N3.Floorplan))},this.renameMeasurement=async t=>{const e=this.pointGroups.getGroupById(t.sid);if(!e)throw this.log.error("Measurement rename failed",Object.assign({},t)),Error("Measurement rename failed, not found");const i=void 0!==t.text&&t.text.length<=24;if(!e||!i)throw this.log.error("Measurement text invalid, text must be between 0 and 24 charachters in length.",Object.assign({},t)),new Error("Measurement text invalid");{const i=""===e.info.text&&t.text.length>0,s=!i&&e.info.text!==t.text;this.pointGroups.updateGroupInfo(e.index,Object.assign(Object.assign({},e.info),{text:t.text})),this.mutationRecord.updated.add(e.info.sid),this.save(),i&&this.engine.broadcast(new Fe.kC(t.sid,t.text)),s&&this.engine.broadcast(new Fe.wx(t.sid,e.info.text,t.text))}},this.onChangeVisibility=async t=>{const{sids:e,visible:i}=t;for(const s of e){const e=this.pointGroups.getGroupById(s);if(!e)throw this.log.error("Measurement visibility toggle failed",Object.assign(Object.assign({},t),{group:e})),new Error("Measurement visibility toggle failed, not found");{this.pointGroups.updateGroupInfo(e.index,Object.assign(Object.assign({},e.info),{visible:i})),this.mutationRecord.updated.add(e.info.sid);const t=this.buildAnalyticsMessage(e.index);t&&this.engine.broadcast(new Fe.bV(t)),i||e.index!==this.getSelected()||this.setSelected(-1)}}this.save()},this.filterVisibility=async t=>{this.data.idVisibility=new Set(t.sids),this.data.commit()},this.changeVisibilityFilterEnabled=async t=>{this.data.idVisibility=new Set,this.visibilityFilterEnabled=t.enabled,this.data.commit()},this.currentRoomId=()=>(0,Ii.C)(this.roomboundData,this.layersData,this.layersData.activeLayerId)?this.roomData.selected.value:null,this.clearMutationRecord=this.clearMutationRecord.bind(this),this.deleteMeasurement=this.deleteMeasurement.bind(this),this.replaceContents=this.replaceContents.bind(this),this.navigateToMeasurement=this.navigateToMeasurement.bind(this)}async init(t,e){var i;const{readonly:s,baseUrl:n}=t;this.config=t,this.mobile=(0,Oe.Fr)(),this.engine=e;const[o,a,d,c,u,p,v,y,b,w]=await Promise.all([e.getModuleBySymbol(r.M7),e.getModuleBySymbol(r.kM),e.getModuleBySymbol(r.mL),e.getModuleBySymbol(r.ZF),e.getModuleBySymbol(r.sA),e.market.waitForData(g.X),e.market.waitForData(m.M),e.market.waitForData(f.X),e.market.waitForData(L.A),e.market.waitForData(ti.q)]);[this.settings,this.playerOptions,this.layersData,this.searchData]=await Promise.all([e.market.waitForData(M.o),e.market.waitForData(x.EY),e.market.waitForData(He.P),e.market.waitForData(C.L)]),e.market.waitForData(Ti.A).then((t=>this.roomboundData=t)),this.playerOptions=await e.market.waitForData(x.EY),this.layersData=await e.market.waitForData(He.P),this.scene=o.getScene(),this.viewmodeData=y,this.cameraData=v,this.floorsViewData=p,this.roomData=w,this.input=d,this.navigation=await e.getModuleBySymbol(r.Kv),this.meshQueryModule=await e.getModuleBySymbol(r.PM);const D=await e.getModuleBySymbol(r.T9);this.applicationData=await e.market.waitForData(O.zH),this.lineDerivedDataFactory=new E(v,y,p,(()=>!!b.currentSweep&&b.isSweepAligned(b.currentSweep)),(()=>this.settings.tryGetProperty(R.Y.UnitType,A.t.IMPERIAL)),(()=>!0));const S=e.claimRenderLayer(this.name);this.data=new Z.s;const I=(0,Ce.Z)([]);this.pointGroups=new bt(I);const T=(t,e,i=!1)=>Et(I,t).createSubscription(e,i);this.dataSubscription=I.onChanged((()=>{this.data.repopulate(this.pointGroups.groups()),this.data.commit()})),this.store=new Je({context:this.layersData.mdsContext,readonly:s,baseUrl:n}),this.registerRoomAssociationSource(e),async function(t,e,i,s){const n=await t.market.waitForData(O.zH);let o=n.application===O.lg.WORKSHOP;const a=(n,a,r,h=[])=>{const l=s.tryGetProperty(R.Y.UnitType,A.t.METRIC),d=[],c=e.groups();if(0===h.length)for(const e of c)(o||e.info.visible&&i.layerToggled(e.info.layerId))&&n(ni.getTitle(e,l,Di),ni.getDescription(e,l))&&d.push(new ni(t.commandBinder,i,a,e,l,Di));return t.commandBinder.issueCommand(new W(d.map((t=>t.id)))),d},r=e=>{t.commandBinder.issueCommand(new z(!!e))},h=t=>new Ae.P(e.onDataChanged(t),s.onPropertyChanged(R.Y.UnitType,t)),d={renew:()=>{t.commandBinder.issueCommandWhenBound(new ai.Oc({id:l.jM.MEASUREMENTPATH,groupPhraseKey:wi.SEARCH_GROUP_HEADER,getSimpleMatches:a,registerChangeObserver:h,onSearchActivatedChanged:r,groupOrder:40,groupIcon:"tape-measure",batchSupported:!0,itemFC:yi}))},cancel:()=>{t.commandBinder.issueCommandWhenBound(new ai.tf(l.jM.MEASUREMENTPATH))}},c=()=>{o=n.application===O.lg.WORKSHOP,s.tryGetProperty(x.Q$.Measurements,!0)||o?d.renew():d.cancel()},u=n.onPropertyChanged("application",c),p=s.onPropertyChanged(x.Q$.Measurements,c);return c(),new Ae.P(d,u,p)}(e,this.data,this.layersData,this.settings).then((t=>this.bindings.push(t))),this.constraint=this.mobile?lt.mobile:lt.desktop,this.pointer=new ge(u,this.getConstraint,this.mobile,this.floorsViewData,this.viewmodeData,this.meshQueryModule,v.pose);const P=new ve(this.pointGroups,T,this.pointer,(()=>{const t=this.settings.tryGetProperty(R.Y.MeasurementContinuousLines,!1),e=this.getPhase()===Q.hb.CREATING||this.getPhase()===Q.hb.CREATING_NEXT_POINT||this.previousPhase===Q.hb.CREATING_NEXT_POINT&&this.getPhase()===Q.hb.EDITING;return t&&this.mobile&&e}));e.addComponent(this,P);const G=new Be(this.pointer,this.mobile,this.getPhase,this.scene,e.getRenderLayer);e.addComponent(this,G),this.creator=this.instantiateCreator(v),this.initStorageOnApplicationChange();const $=(t,e,i)=>{const s=this.pointGroups.getGroup(t),n=s.describe(i);this.lineSidToPointMap[n]=i;const o=this.lineDerivedDataFactory.get(n);return this.lineDerivedDataFactory.make(n,(()=>({start_position:this.pointGroups.get(e),end_position:this.pointGroups.get(i),visible:this.getMeasurementVisibility(s.info.sid,s.info.layerId,s.info.visible),floorId:s.info.floorId,roomId:s.info.roomId,type:s.info.type,text:this.pointGroups.isStartIndex(e)?s.info.text:""})),o)};this.renderer=new At(this.pointGroups,T,v,c,S,e.claimRenderLayer("measure-lines"),this.getSelected,$),await e.addComponent(this,this.renderer);const X=new h.Il({assetBasePath:null!==(i=this.settings.getProperty("assetBasePath"))&&void 0!==i?i:"",color:Pi.V.BLACK.clone(),background:!0,backgroundColor:Pi.V.WHITE.clone(),backgroundColliderType:Vt});this.textRenderer=new Nt(this.pointGroups,d,this.mobile,v,S,$t.X.labels,X,$,this.changeCursor,this.getPhase,this.setSelected),await e.addComponent(this,this.textRenderer),this.editor=new be(this.pointGroups,d,this.pointer,this.getPhase,this.onEdit,this.onEditEnd),this.colliders=new pe(this.pointGroups,this.input,v,this.mobile,this.changeCursor,this.getPhase,this.changePhase,this.restorePreviousPhase,this.setSelected,this.getSelected,this.onEdit,this.onEditEnd),this.lineStyler=new De(this.renderer.lines,this.renderer.getLinesForPoint,this.renderer.dottedMaterial,T,this.input,this.getPhase,this.getSelected);const[q]=await Promise.all([e.getModuleBySymbol(r._v)]);this.intersectionVisualizer=this.setupIntersectionVisuals(a,q,this.scene,v,this.pointer,this.mobile,e.getRenderLayer,this.viewmodeData),e.addComponent(this,this.intersectionVisualizer),this.dragInterceptor=new Ae.P(this.input.registerPriorityHandler(ce.jF,Kt.r,(()=>!0)),this.input.registerPriorityHandler(ce.jF,Me.W,(()=>!0))),this.dragInterceptor.cancel(),this.mobile||this.bindings.push(...this.hotkeys()),this.bindings.push(this.applicationData.onPropertyChanged("application",this.initStorageOnApplicationChange),y.makeModeChangeSubscription(this.onViewmodeChange),b.makeSweepChangeSubscription(this.onSweepChange),e.commandBinder.addBinding(F.S,(async t=>{this.onToggleMeasurementMode(t.on,t.dimWhileActive,t.editable)})),e.commandBinder.addBinding(B.X,(async()=>this.startMeasuring())),e.commandBinder.addBinding(V.y,(async t=>this.setSelected(t.index))),e.commandBinder.addBinding(N.R,(async()=>this.stopMeasuring())),e.commandBinder.addBinding(k.SH,(async()=>this.deleteSelectedMeasurement())),e.commandBinder.addBinding(k.tm,(async t=>this.deleteMeasurement(t.index))),e.commandBinder.addBinding(H,this.onChangeVisibility),e.commandBinder.addBinding(_,this.renameMeasurement),e.commandBinder.addBinding(k.CN,this.deleteMeasurementBySids),e.commandBinder.addBinding(U,(async t=>{var e;return this.replaceContents(null===(e=t.points)||void 0===e?void 0:e.groups())})),e.commandBinder.addBinding(W,this.filterVisibility),e.commandBinder.addBinding(z,this.changeVisibilityFilterEnabled),e.commandBinder.addBinding(j,this.navigateToMeasurement),this.dataSubscription,this.settings.onPropertyChanged(R.Y.MeasurementContinuousLines,(()=>this.onToggleContinuous())),D.onSave((()=>this.saveDiff()),{dataType:ke.p.MEASUREMENTS}),this.layersData.onPropertyChanged("currentViewId",(()=>this.updateSettings())),this.layersData.onPropertyChanged("activeLayerId",(()=>this.updatePendingMeasurement())),this.data.onPropertyChanged("phase",this.onPhaseChange),this.searchData.onPropertyChanged("activeItemId",this.selectedItemChanged)),e.market.register(Z.s,this.data),e.toggleRendering(this,!1),this.updateSettings(),this.registerDebugSettings()}replaceContents(t){this.lineDerivedDataFactory.clear();for(let t=this.pointGroups.groupCount;t>=0;t--){const e=this.pointGroups.getGroup(t);this.layersData.isInMemoryLayer(e.info.layerId)||this.pointGroups.removeGroup(t)}t&&this.pointGroups.copy(t,!1)}loadSavedMeasurements(){return this.config.readonly=this.applicationData.application!==O.lg.WORKSHOP,this.creator.syncReadonly(this.config.readonly),!this.config.readonly||this.playerOptions.options.measurements_saved}isCreating(){const t=this.getPhase();return t===Q.hb.CREATING||t===Q.hb.CREATING_NEXT_POINT}setConstraintStyle(t){this.log.debug("setConstraintStyle:",tt[t]),this.constraint=t}deleteMeasurement(t,e=!1){const i=this.buildAnalyticsMessage(t);i&&this.engine.broadcast(new Fe.To(Object.assign(Object.assign({},i),{count:this.pointGroups.groupCount-1})));const s=this.pointGroups.getGroup(t);if(s){const{sid:i,layerId:n}=s.info;this.pointGroups.removeGroup(t),i!==this.data.creatingGroupId&&(this.layersData.isInMemoryLayer(n)||(this.mutationRecord.removed.add(i),this.removedLayerMap.set(i,n),e||this.save()))}}isMeasurementComplete(t){if(-1===t||!this.isCreating())return!0;const e=this.getPhase(),i=this.pointGroups.getGroup(t);return this.settings.tryGetProperty(R.Y.MeasurementContinuousLines,!1)?i.count>2&&e===Q.hb.CREATING_NEXT_POINT:i.count>=2&&e===Q.hb.CREATING}hotkeys(){return[this.input.registerHandler(xe.k,(t=>{if(t.state===Re.$.PRESSED)switch(t.key){case Le.D.ESCAPE:this.getPhase()===Q.hb.CONFIRMING_POINT?(this.creator.stop(),this.creator.start(),this.changePhase(Q.hb.CREATING)):this.isCreating()?this.stopMeasuring():this.applicationData.application!==O.lg.WORKSHOP&&this.getPhase()!==Q.hb.CLOSED&&this.engine.commandBinder.issueCommand(new X.yU(q.S0.MEASUREMENTS,!1));break;case Le.D.BACKSPACE:case Le.D.DELETE:this.getPhase()!==Q.hb.CLOSED&&this.getPhase()!==Q.hb.EDITING&&this.deleteSelectedMeasurement();break;case Le.D.RETURN:const t=this.pointGroups.groupCount-1;this.isMeasurementComplete(t)&&this.stopMeasuring()}})),this.input.registerHandler(xe.k,(t=>{if(t.key===Le.D.SHIFT||t.key===Le.D.ALT){const{altKey:e,shiftKey:i}=t.modifiers,s=i&&e?lt.shiftAlt:e?lt.alt:i?lt.shift:lt.desktop;this.setConstraintStyle(s)}}))]}onUpdate(t){if(this.getPhase()===Q.hb.CLOSED)return;const e=this.data.selectedGroupIndex,i=this.mobile?Q.Vk.mobile[this.getPhase()]:Q.Vk.desktop[this.getPhase()];for(const s in this.lineSidToPointMap){const n=this.lineDerivedDataFactory.get(s);if(n){n.opacity.tick(t);const o=this.lineSidToPointMap[s],a=this.pointGroups.groupFromPointIndex(o),r=a===e&&n.visible?1:n.opacity.value,h=i&&!n.labelVisible?0:r;this.textRenderer.setTextOpacityByPoint(o,h),this.renderer.setLineOpacityByPoint(o,r),-1!==a&&this.colliders.setGroupVisible(a,r>0)}}if(this.mobile)if(this.getPhase()===Q.hb.CONFIRMING_POINT){const t=(Date.now()-this.longPressStart)/this.threshold;t<=1&&(this.data.pressProgress=t,this.data.commit())}else this.getPhase()===Q.hb.CREATING&&0!==this.data.pressProgress&&(this.data.pressProgress=0,this.data.commit())}dispose(){var t,e;this.data.modeActive()&&(this.stopMeasuring(),this.engine.commandBinder.issueCommand(new F.S(!1))),this.colliders.dispose(),this.textRenderer.dispose(),this.renderer.dispose(),this.engine.disposeRenderLayer(this.name),null===(t=this.store)||void 0===t||t.dispose(),this.store=null,null===(e=this.newDataBinding)||void 0===e||e.cancel(),this.newDataBinding=null,super.dispose(this.engine)}clearMutationRecord(){for(const t of Object.values(this.mutationRecord))t.clear()}async save(){if(!this.config.readonly)return this.engine.commandBinder.issueCommand(new Ge.F({dataTypes:[ke.p.MEASUREMENTS]}));this.clearMutationRecord()}async saveDiff(){var t,e;if(this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged(),this.config.readonly||!this.store)return void this.clearMutationRecord();const i=this.mutationRecord,s=[];this.log.debug("MDS mutation ops:",`{\n      added: '${[...i.added.keys()]}',\n      updated: '${[...i.updated.keys()]}',\n      removed: '${[...i.removed.keys()]}',\n    }`);const n=[];for(const t of i[ei.Xw.removed]){if(i[ei.Xw.added].has(t))i[ei.Xw.added].delete(t);else{const e=this.removedLayerMap.get(t);n.push({pathId:t,layerId:e})}i[ei.Xw.updated].delete(t)}this.removedLayerMap.clear();const o=this.store.delete(...n);s.push(o);for(const e of i[ei.Xw.added]){if(this.layersData.isInMemoryLayer(null===(t=this.data.getGroupInfoBySid(e))||void 0===t?void 0:t.info.layerId))continue;const n=this.pointGroups.getGroupById(e);if(n){const t=this.store.create(n).then((t=>{t&&(this.log.debug(`Updating group id for new path: ${n.info.sid} -> ${t}`),this.pointGroups.updateGroupInfo(n.index,Object.assign(Object.assign({},n.info),{sid:t}))),this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged()}));s.push(t)}i[ei.Xw.updated].delete(e)}const a=[];for(const t of i[ei.Xw.updated]){if(this.layersData.isInMemoryLayer(null===(e=this.data.getGroupInfoBySid(t))||void 0===e?void 0:e.info.layerId))continue;const i=this.pointGroups.getGroupById(t);i&&a.push(i)}const r=this.store.update(a);return s.push(r),this.clearMutationRecord(),Promise.all(s)}updatePendingMeasurement(){const t=this.data.creatingGroupId;if(t){const e=this.pointGroups.getGroupById(t);if(!e)return void this.log.error("Missing pending measurement group");if(!this.layersData.isInMemoryLayer(e.info.layerId)){const i=this.layersData.activeLayerId;this.pointGroups.updateGroupInfo(e.index,Object.assign(Object.assign({},e.info),{layerId:i}));const s=this.data.getGroupInfoBySid(t);s&&(s.info.layerId=i,this.data.commit(),this.data.notifyDataChanged())}}}getMeasurementVisibility(t,e,i){if(!this.data.modeActive())return!1;const{selectedGroupSid:s,creatingGroupId:n,editingGroupId:o,idVisibility:a}=this.data,r=this.applicationData.application===O.lg.WORKSHOP||this.layersData.layerToggled(e),h=this.layersData.layerVisible(e),l=[s,n,o].includes(t),d=!this.visibilityFilterEnabled||a.has(t);return r&&(l||i&&d&&h)}async registerDebugSettings(){const t=await this.engine.getModuleBySymbol(a.ZF);t.registerMenuEntry({header:"Measurement Debug",setting:"measure/fp_in_dh",initialValue:()=>!1,onChange:e=>(this.lineDerivedDataFactory.setDollhouseLineStyle(e?n.FloorplanOnly:n.ThreeD),t.updateSetting("measure/fp_in_dh",e))})}updateSettings(){const t=this.layersData.getCurrentView(),e=(null==t?void 0:t.viewType)===_e.jK.TRUEPLAN,i=this.settings.tryGetProperty(ft,!0),s=e||i;this.settings.setProperty(ft,s)}instantiateCreator(t){let e;const i=this.viewmodeData,s=()=>{const e=i.isFloorplan(),s=i.isDollhouse()&&t.pose.pitchFactor()<.01;return e||s},n=t=>{const e={floorId:t.floorId||"",roomId:t.roomId||"",layerId:this.layersData.activeLayerId};return this.meshQueryModule.inferMeshIdsFromPoint(e,t.point,!0),e};if(this.mobile){const i=(t,e)=>{this.longPressStart=t,this.threshold=e},o=e=>{const i=(0,Lt.bz)(t,e.point);this.data.setPointPosition(i.screenPosition)};e=new Pe(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,i,o,this.toggleCameraMovement,this.getPhase,(()=>this.settings.tryGetProperty(R.Y.MeasurementContinuousLines,!1)),s,(()=>this.floorsViewData.getHighestVisibleFloorId()),this.currentRoomId,(()=>this.layersData.activeLayerId),n)}else e=new Ee(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,this.getPhase,s,(()=>this.floorsViewData.getHighestVisibleFloorId()),this.currentRoomId,(()=>this.layersData.activeLayerId),(()=>this.settings.tryGetProperty(R.Y.MeasurementContinuousLines,!1)),n,this.meshQueryModule);return e.onGroupCreated=this.onCreatorAddNewLine,e.onGroupAddPoint=this.onCreatorAddPoint,e.onEdit=this.onEdit,e.onDone=this.onCreatorStop,e.syncReadonly(this.config.readonly),e}async navigateToMeasurement({groupId:t}){const e=this.data.getGroupInfoBySid(t);if(!e)return;const i=[];for(const t of e)i.push(t);const s=(new b.Box3).setFromPoints(i),o=e.info.type===n.FloorplanOnly?v.N3.Floorplan:v.N3.Dollhouse;s.expandByScalar(o===v.N3.Dollhouse?1.25:1);const a={mode:o,transition:u.fl.Interpolate,floorId:e.info.floorId};try{await this.navigation.focus(s,a),this.setSelectedById(t)}catch(t){this.log.info("Unable to navigateToMeasurement:",t)}}registerRoomAssociationSource(t){const e=this.data;t.commandBinder.issueCommandWhenBound(new Si.l({type:"measurements",getPositionId:function*(){for(const t of e.groups())yield{id:t.info.sid,roomId:t.info.roomId,floorId:t.info.floorId,position:t.get(0),layerId:t.info.layerId}},updateRoomForId:(t,i)=>{const s=e.getGroupInfoBySid(t);if(!s)throw new Error("Invalid measurement group id");s.info.roomId=i||void 0}}))}}const Ci=Ei},99276:(t,e,i)=>{"use strict";i.d(e,{B:()=>l});var s=i(68909),n=i(36476),o=i(30443),a=i(37458),r=i(5984),h=i(47299);class l extends r.r{constructor(t,e,i=n.H.ALL){super(),this._opacity=1,this._chunks=[],this.size=new s.Vector3,this.center=new s.Vector3,this.built=!1,this.layers.mask=i.mask,this.name=`RoomMesh:${t}-${e}`,this.meshGroup=t,this.meshSubgroup=e,this.renderOrder=a.X.default,this.castShadow=l.ShouldCastShadow,this.onBeforeRender=(t,e,i,s,n,o)=>{this.updateUniforms(n,o)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(t){-1===this._chunks.indexOf(t)&&this._chunks.push(t)}getChunk(t){return this._chunks[t]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;const t=(0,o.h0)(this._chunks.map((t=>t.geometry)));t.clearGroups();let e=0;this.material=[],this._chunks.forEach(((i,s)=>{i.geometry&&i.geometry.index&&(t.addGroup(e,i.geometry.index.count,s),e+=i.geometry.index.count,i.geometry.dispose(),i.geometry=t,i.notifyOnMaterialUpdated((t=>{Array.isArray(this.material)&&(this.material[s]=t),this.onMaterialUpdate&&this.onMaterialUpdate()})),i.onOpacityUpdate=t=>{this.opacity=t})})),this.geometry=t,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((t=>t.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithSingleChunk(t){if(this.built)return;const{meshGroup:e,meshSubgroup:i,lod:s}=t;this.name=`RoomMesh:${s}-${e}-${i}-${t.chunkIndex}`,this.meshGroup=e,this.meshSubgroup=i,this._chunks.push(t),t.notifyOnMaterialUpdated((t=>{this.material=t,this.onMaterialUpdate&&this.onMaterialUpdate()})),t.onOpacityUpdate=t=>{this.opacity=t},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(t,e){t instanceof s.ShaderMaterial&&(e?this.chunks[e.materialIndex].onBeforeDraw(t):this.chunks.length&&this.chunks[0].onBeforeDraw(t))}get boundingBox(){return(0,o.UX)(this.geometry)}set opacity(t){t!==this.opacity&&(this._opacity=t,this.raycastEnabled=t>h.u7.FADE_CLICKABLE_THRESHOLD,this.renderOrder=t<h.u7.FADE_OPAQUE?a.X.ghostFloor:a.X.default,this.onOpacityUpdate&&this.onOpacityUpdate(t))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}l.ShouldCastShadow=!1},83075:(t,e,i)=>{"use strict";i.d(e,{PO:()=>n,m2:()=>o});var s=i(99276);const n=t=>!!t&&t instanceof s.B,o={hasMeshGroup:t=>"object"==typeof t&&!!t&&"meshGroup"in t,hasMeshSubgroup:t=>"object"==typeof t&&!!t&&"meshSubgroup"in t,isRoomMesh:n,isVisibleRoomMesh:t=>n(t)&&t.raycastEnabled&&t.visible}},31993:(t,e,i)=>{"use strict";i.r(e),i.d(e,{ModelRatedMessage:()=>a.N,SubmitModelRatingCommand:()=>r.i,ToggleModelRatingDialogCommand:()=>r.c,default:()=>I});var s=i(6909),n=i(75578),o=i(77489),a=i(95522),r=i(26432),h=i(81088),l=i(22213),d=i(85846);const c=new(i(10843).Ay)("model-rating-data-store"),u=t=>t,p=t=>t;class m extends d.xO{constructor(t,e,i){super({queue:t,deserialize:u,serialize:p,path:`${e}/api/v1/jsonstore/model/model-rating/${i}`}),this.queue=t,this.baseUrl=e,this.modelId=i}async canPromptRating(){let t;try{t=await this.read()}catch(t){return c.error("Failed to read existing rating data from JSONStore"),!1}const e=!!t.rated_at;return!!!t.prompt_dismissed_at&&!e}async recordRatingSubmitted(){this.update({rated_at:(new Date).toISOString()})}async recordAutomaticPromptDismissed(){this.update({prompt_dismissed_at:(new Date).toISOString()})}async reset(){var t;const e=`${this.baseUrl}/api/v1/jsonstore/model/model-rating/${this.modelId}`;if(!(null===(t=this.modelId)||void 0===t?void 0:t.length))throw new Error(`Refusing to DELETE ${e}`);if(window.confirm("Are you sure you want to reset the Model Rated value for this space? This cannot be undone."))return this.queue.delete(e,this.options).then((()=>{window.location.reload()}))}}var g=i(87965),f=i(25316),v=i(33156),y=i(6539);const b=t=>864e5*t,w=b(1),D=b(7);class S extends n.n{constructor(){super(...arguments),this.name="model-rating",this.promptEnabled=!1,this.totalActiveTime=0,this.wasLastOpeningAutomatic=!1,this.canPrompt=async()=>{const t=Date.now(),e=+this.settings.tryGetProperty(g.Y.LastRatingPromptTime,null),i=!e||isNaN(e)||+new Date(t)-+new Date(e)>=w,s=await this.store.canPromptRating();return this.log.debug(`canPromptUser: ${i}, canPromptModel: ${s}`),i&&s},this.handleActivityPingMessage=async t=>{if(this.totalActiveTime+=t.durationDollhouse+t.durationFloorplan+t.durationInside,this.log.debug(`prompt timing update: totalActiveTime:${this.totalActiveTime}, threshHold: 74500`),this.totalActiveTime<74500||!this.promptEnabled)return;this.engine.unsubscribe(s.h,this.handleActivityPingMessage);if(await this.canPrompt()&&!this.viewData.isDialogVisible){this.log.debug("automatically prompting user for Model Rating");const t=(new Date).toISOString();this.settings.setLocalStorageProperty(g.Y.LastRatingPromptTime,t),this.engine.commandBinder.issueCommand(new r.c(!0)),this.wasLastOpeningAutomatic=!0}},this.handleSubmitModelRatingCommand=async({rating:t,didFinish:e})=>{this.log.info(t),this.engine.broadcast(new a.N(t)),this.store.recordRatingSubmitted(),e&&(this.engine.commandBinder.issueCommand(new r.c(!1)),this.engine.commandBinder.issueCommand(new h.X(l.a.RATING_THANK_YOU,!0)))},this.handleToggleDialogCommand=async({toVisible:t})=>{this.viewData.setDialogVisible(t);!this.viewData.isDialogVisible&&this.wasLastOpeningAutomatic&&(this.store.recordAutomaticPromptDismissed(),this.wasLastOpeningAutomatic=!1)}}async init(t,e){this.engine=e,this.config=t,this.viewData=new o.G,this.store=new m(t.queue,t.baseUrl,t.baseModelId),this.promptEnabled=t.promptEnabled,this.settings=await e.market.waitForData(f.o),this.userData=await e.market.waitForData(v.E),this.bindings.push(e.commandBinder.addBinding(r.c,this.handleToggleDialogCommand),e.commandBinder.addBinding(r.i,this.handleSubmitModelRatingCommand));const i=this.userData.getModelCreatedDate();let n=!!i&&Date.now()-+new Date(i)<D;this.promptEnabled&&t.debug&&(this.log.info("Debug Mode Enabled: Ignoring max model age requirement for rating prompt."),n=!0),this.log.debug(`promptEnabled: ${t.promptEnabled}, isModelEligible: ${n}`),this.promptEnabled&&n&&this.bindings.push(e.subscribe(s.h,this.handleActivityPingMessage)),e.market.register(o.G,this.viewData),this.registerSettings()}async registerSettings(){const t=await this.engine.getModuleBySymbol(y.ZF),{debug:e}=this.config;e&&t.registerMenuButton({header:"Model Rating",buttonName:"Reset Model Rated value",callback:()=>{this.settings.setLocalStorageProperty(g.Y.LastRatingPromptTime,null),this.store.reset()}})}dispose(t){this.bindings.forEach((t=>{t.cancel()})),this.bindings=[],super.dispose(t)}}const I=S},35699:(t,e,i)=>{"use strict";i.d(e,{X:()=>n});var s=i(55141);class n extends s.u{constructor(t=null){super(),this.payload={cursor:t}}}n.id="SET_MOUSE_CURSOR"},77510:(t,e,i)=>{"use strict";var s;i.d(e,{b:()=>s}),function(t){t.NONE="none",t.DEFAULT="default",t.MOVE="move",t.MOVE_LF="col-resize",t.MOVE_UD="row-resize",t.XHAIR="crosshair",t.PLUS="cell",t.QUESTION="help",t.NOPE="not-allowed",t.FINGER="pointer",t.TEXT="text",t.TEXT_VERT="vertical-text",t.ZOOM_IN="zoom-in",t.ZOOM_OUT="zoom-in",t.GRAB="grab",t.GRABBING="grabbing",t.ARROW_R="e-resize",t.ARROW_L="w-resize",t.ARROW_U="n-resize",t.ARROW_D="s-resize",t.ARROW_UR="ne-resize",t.ARROW_UL="nw-resize",t.ARROW_DR="se-resize",t.ARROW_DL="sw-resize",t.ARROW_LR="ew-resize",t.ARROW_UD="ns-resize",t.ARROW_URDL="nesw-resize",t.ARROW_ULDR="nwse-resize",t.ROOMBOUNDS_DEFAULT="rbe-default",t.ROOMBOUNDS_MOVING="rbe-moving",t.ROOMBOUNDS_PLACE_NODE="rbe-place-node",t.ROOMBOUNDS_FINISH_ROOM="rbe-finish-room"}(s||(s={}))},46192:(t,e,i)=>{"use strict";i.d(e,{C:()=>o});var s=i(93877),n=i(56547);function o(t,e,i){const o=t&&t.hasRooms(),a=i?e.getLayer(i):e.getActiveLayer();return a&&a.layerType===s.ku.COMMON_USER_LAYER?!o:!!(0,n.XF)(e.getCurrentView())||!o}},39118:(t,e,i)=>{"use strict";i.d(e,{l:()=>n});var s=i(55141);class n extends s.u{constructor(t){super(),this.payload={roomAssociation:t}}}n.id="REGISTER_ROOM_ASSOCIATION_SOURCE"},33930:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>nt});var s=i(75578),n=i(27947),o=i(22585),a=i(25316),r=i(15404),h=i(68986),l=i(45832),d=i(47737),c=i(77973),u=i(93358),p=i(50485),m=i(58687),g=i(98848),f=i(81530),v=i(4298),y=i(88186),b=i(39118),w=i(7584),D=i(84917),S=i(74381),I=i(87965),T=i(23339),P=i(24790),E=i(56147),C=i(94547),M=i(58899),x=i(58229),A=i(9997),R=i(99380),L=i(30169),O=i(15580),F=i(56208);class B extends M.r{constructor(t,e,i,s,n,o,a){super(t,e,s),this.room=n,this.title=o,this.id=this.room.id,this.icon=`icon-${(0,R.bt)(this.room.roomTypeIds)}`,this.typeId=S.jM.MODELROOM,this.layerId=P.qw,this.dateBucket=D.T.OLDER,this.enabled=!0,this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new A.Dd(this.room))},this.floorId=a,this.roomId=n.id;const r=i.tryGetProperty(I.Y.UnitType,T.t.IMPERIAL);this.description=this.room.getMeasurementText(r)}}var V=i(941),N=i(80788),k=i(20968),G=i(32126),H=i(10843),_=i(26348),U=i(68909),W=i(86866);const z=new H.Ay("MdsRoomBoundsDeserializer");class j{deserialize(t,e=!1){var i,s,n,o,a,r,h,l,d;const c={version:0,floors:{}};for(const e of t.floors||[]){const t={edges:{},vertices:{},rooms:{}};c.floors[e.id]=t;for(const i of e.vertices||[])i?t.vertices[i.id]={x:i.position.x,y:i.position.y}:z.warn("Found null vertex in floor vertices!");for(const i of e.edges||[]){if(!i||null===i.thickness||null===i.centerLineBias){z.warn("Invalid edge!");continue}for(const e of i.vertices||[])(null==e?void 0:e.position)&&(t.vertices[e.id]={x:e.position.x,y:e.position.y});const e={vertices:(i.vertices||[]).map((t=>null==t?void 0:t.id)),thickness:i.thickness,bias:i.centerLineBias,openings:{},type:i.type||void 0};t.edges[i.id]=e;for(const t of i.openings||[]){if(!t){z.warn("Found null opening!");continue}const i={height:t.height,lowerElevation:t.lowerElevation,relativePos:t.relativeCenter,type:t.type,width:t.width};e.openings[t.id]=i}}}for(const u of t.rooms||[]){if(!u||!u.floor){z.warn("Found null room");continue}if(!c.floors[u.floor.id]){z.warn("Unable to find floor for room!");continue}const t=u.classifications||[].sort(((t,e)=>(t.confidence||0)-(e.confidence||0))),p=null===(i=u.dimensionEstimates)||void 0===i?void 0:i.units,m=(u.label||"").trim();c.floors[u.floor.id].rooms[u.id]={edges:(null===(n=null===(s=u.boundary)||void 0===s?void 0:s.edges)||void 0===n?void 0:n.map((t=>t.id)))||[],holes:(null===(o=u.holes)||void 0===o?void 0:o.map((t=>{var e;return(null===(e=t.edges)||void 0===e?void 0:e.map((t=>t.id)))||[]})))||[],classifications:t,label:m,width:this.ensureMetric("distance",null===(a=u.dimensionEstimates)||void 0===a?void 0:a.width,p),length:this.ensureMetric("distance",null===(r=u.dimensionEstimates)||void 0===r?void 0:r.depth,p),area:this.ensureMetric("area",null===(h=u.dimensionEstimates)||void 0===h?void 0:h.area,p),areaIndoorWithWalls:this.ensureMetric("area",null===(l=u.dimensionEstimates)||void 0===l?void 0:l.areaIndoorWithWalls,p),height:this.ensureMetric("distance",null===(d=u.dimensionEstimates)||void 0===d?void 0:d.height,p)||NaN,keywords:u.keywords||[],ceiling:e?this.mdsCeilingToCeiling(u.ceiling,p):void 0}}return c}ensureMetric(t,e,i){if(null!=e&&null!=i){const s=i===S.WU.IMPERIAL,n="area"===t?_.D6:_.hV;return s?n(e):e}return NaN}mdsCeilingToCeiling(t,e){if(null!=t&&null!=t.maxHeight&&null!=t.minHeight&&null!=t.planes&&t.planes.length>0){const i=[];for(const s of t.planes)if(null!=s.measurements&&s.measurements.length>0){const t=[];for(const i of s.measurements)null!=i.height&&null!=i.bottom&&t.push({height:this.ensureMetric("distance",i.height,e),bottom:W.U$.fromVisionVector(new U.Vector3(i.bottom.x,i.bottom.y,i.bottom.z))});t.length>0&&i.push({measurements:t})}if(i.length>0)return{minHeight:this.ensureMetric("distance",t.minHeight,e),maxHeight:this.ensureMetric("distance",t.maxHeight,e),planes:i}}}}var $=i(98720),X=i(35336);class q extends k.g{constructor(t,e=!1,i=!1,s=()=>{}){super(t),this.writeRepairs=e,this.ceilingsEnabled=i,this.broadcast=s,this.queuedMutations=[],this.seenRooms=new Map,this.lastUpdates=new Map,this.entitiesToDelete=new Map,this.deserializer=new j}async read(t){var e,i;const s={modelId:this.getViewId()};t=Object.assign({anonymous:!0},t);const n=await this.query(G.GetRoomBounds,s,t);return(null===(i=null===(e=null==n?void 0:n.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.floors)?this.validateData(this.deserializer.deserialize(n.data.model,this.ceilingsEnabled)):null}async readClassifications({options:t,localizeFn:e}={}){var i;const s=Object.assign(Object.assign({},t),{prefetchKey:"data.roomClassifications",anonymous:!0});return((null===(i=(await this.query(G.GetRoomClassifications,{},s)).data)||void 0===i?void 0:i.roomClassifications)||[]).reduce(((t,i)=>(i&&(t[i.id]=e?e(i):i),t)),{})}get readonly(){return this.config.readonly}set readonly(t){this.config.readonly=t}queueAddNode(t){this.queueMutation(`addBoundaryVertex(modelId: $modelId, id: "${t.id}", vertex: ${this.vertexDetailsFromNode(t)}) { id }`)}queueUpdateNode(t){this.updateEntity("node",t.id,`patchBoundaryVertex(modelId: $modelId, id: "${t.id}", vertex: ${this.vertexDetailsFromNode(t)}) { id }`)}vertexDetailsFromNode(t){return`{\n      floorId: "${t.floorId}",\n      position: { x: ${t.x} y: ${-t.z} }\n    }`}queueRemoveNode(t){this.queueRemoveEntity("node",t.id)}queueAddWall(t){this.queueMutation(`addBoundaryEdge(modelId: $modelId, id: "${t.id}", edge: ${this.edgeDetailsFromWall(t)}) { id }`)}queueUpdateWall(t){this.updateEntity("wall",t.id,`patchBoundaryEdge(modelId: $modelId, id: "${t.id}" edge: ${this.edgeDetailsFromWall(t)}) { id }`)}edgeDetailsFromWall(t){return`\n    {\n      floorId: "${t.floorId}"\n      vertices: ["${t.from.id}", "${t.to.id}"]\n      thickness: ${t.width}\n      units: ${S.WU.METRIC}\n      centerLineBias: ${1-t.bias}\n      type: ${t.type===$.b.SOLID?S.gP.WALL:S.gP.INVISIBLE}\n    }\n    `}queueRemoveWall(t){this.queueRemoveEntity("wall",t.id)}queueAddOpening(t){this.queueMutation(`addEdgeOpenings(modelId: $modelId, id: "${t.wallId}", openings: [${this.openingDetailsFromOpening(t)}]) { id }`)}queueUpdateOpening(t){this.updateEntity("opening",t.id,`patchEdgeOpening(modelId: $modelId, id: "${t.wallId}", opening: ${this.openingDetailsFromOpening(t)}) { id }`)}openingDetailsFromOpening(t){return`\n    {\n      id: "${t.id}"\n      relativeCenter: ${t.relativePos}\n      type: ${t.type}\n      width: ${t.width}\n      height: 0.1,\n      lowerElevation: 0.1\n    }\n    `}queueRemoveOpening(t){this.queueMutation(`removeEdgeOpenings(\n        modelId: $modelId\n        id: "${t.wallId}"\n        openings: ["${t.id}"]\n      )`),this.clearEntityUpdate("opening",t.id)}queueAddRoom(t){this.queueMutation(`addRoom(\n        modelId: $modelId,\n        id: "${t.id}",\n        room: ${this.getRoomDetailsFromRoom(t)}\n      ) { id }`)}queueUpdateRoom(t){const e=this.seenRooms.get(t.id);e&&e!==t&&this.clearEntityUpdate("room",t.id),this.seenRooms.set(t.id,t),this.updateEntity("room",t.id,`patchRoom(\n        modelId: $modelId,\n        id: "${t.id}",\n        room: ${this.getRoomDetailsFromRoom(t)}\n      ) { id }`)}getRoomDetailsFromRoom(t){const e=!t.showDimensions,i=!t.showHeight,s=t.isFlatCeiling()?t.getMinCeilingHeight():NaN;return`\n    {\n      floorId: "${t.floorId}"\n      label: "${this.escapeUserString(t.name)}"\n      classifications: [${t.roomTypeIds.map((t=>`"${t}"`))}],\n      boundary: {\n        edges: [${Array.from(t.walls.values()).map((t=>`"${t.id}"`))}],\n      }\n      holes: [${Array.from(t.holes.values()).map((t=>`{ edges: [${Array.from(t.values()).map((t=>`"${t.id}"`))}] }`))}]\n      dimensionEstimates: {\n        room: "${t.id}",\n        area: ${Number.isNaN(t.area)?0:t.area},\n        areaIndoor: ${Number.isNaN(t.area)?null:t.area},\n        areaIndoorWithWalls: ${Number.isNaN(t.areaWithWalls)?null:t.areaWithWalls},\n        depth: ${Number.isNaN(t.length)||e?0:t.length}\n        width: ${Number.isNaN(t.width)||e?0:t.width}\n        height: ${Number.isNaN(s)||i?0:s}\n        units: ${S.WU.METRIC}\n      },\n      keywords: [${t.allKeywords().map((t=>`"${t}"`))}],\n      ${this.getCeilingDetailsForRoom(t)}\n    }\n    `}getCeilingDetailsForRoom(t){if(null!=t.ceiling){return`ceiling: {\n        planes: [${t.ceiling.planes.map((t=>`{\n          measurements: [${t.measurements.map((t=>{const e=W.U$.toVisionVector(t.bottom);return`{\n            height: ${t.height},\n            bottom: {\n              x: ${e.x},\n              y: ${e.y},\n              z: ${e.z},\n            }\n          }`}))}]\n        }`))}],\n      }`}return"ceiling: {\n        planes: null,\n      }"}queueRemoveRoom(t){this.seenRooms.delete(t.id),this.queueRemoveEntity("room",t.id)}queueRemoveLegacyRooms(t){const e=t.map((t=>`"${t}"`));this.queueMutation(`deleteRoomsAndBoundaryData(\n      modelId: $modelId,\n      selectedData: {\n        ids: [${e.join(",")}],\n        type: ${S.w0.ROOM}\n      }\n    )`)}queueUpdateRoomAssociations(t){if(0===t.length)return;this.queueMutation(`bulkPatchRoomData(\n        modelId: $modelId,\n        updatedRoomAssociations: [${t.map((t=>(t=>`{ ${Object.keys(t).map((e=>`${e}: ${JSON.stringify(t[e])}`)).join(",")} }`)(t)))}]\n      )`)}peekQueuedMutations(){return this.queuedMutations.slice()}async submitQueuedMutations(){if(this.checkForPendingDeletes(),0===this.queuedMutations.length)return;const t=this.queuedMutations.slice();this.queuedMutations.length=0;for(const t of this.lastUpdates.values())t.clear();const e=[];let i=0;const s=async()=>{if(0===e.length)return;const t=N.gql`
        mutation updateRoomBoundaries($modelId: ID!) {
          ${e.map(((t,e)=>`op${e}: ${t}`)).join("\n")}
        }
      `;await this.mutate(t,{modelId:this.getViewId()}),e.length=0,i=0};for(const n of t){const t=n.startsWith("delete");(e.length>40||i+n.length>65536||t)&&await s(),e.push(n),i+=n.length,t&&await s()}await s()}updateEntity(t,e,i){const s=this.lastUpdates.get(t)||new Map;this.lastUpdates.set(t,s);const n=s.get(e);void 0!==n?this.queuedMutations[n]=i:(this.queueMutation(i),s.set(e,this.queuedMutations.length-1))}clearEntityUpdate(t,e){const i=this.lastUpdates.get(t);i&&i.delete(e)}queueRemoveEntity(t,e){var i;const s=null!==(i=this.entitiesToDelete.get(t))&&void 0!==i?i:[];s.push(e),this.entitiesToDelete.set(t,s)}checkForPendingDeletes(){const t=[["room",S.w0.ROOM],["wall",S.w0.BOUNDARYEDGE],["node",S.w0.BOUNDARYVERTEX]];for(const[e,i]of t){const t=this.entitiesToDelete.get(e);if(t){const s=`deleteRoomsAndBoundaryData(\n            modelId: $modelId,\n            selectedData: {\n              ids: [${t.map((t=>`"${t}"`)).join(",")}],\n              type: ${i}\n            }\n          )\n        `;this.queuedMutations.push(s),t.forEach((t=>this.clearEntityUpdate(e,t)))}}this.entitiesToDelete.clear()}queueMutation(t){this.checkForPendingDeletes(),this.queuedMutations.push(t)}escapeUserString(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}validateData(t){var e,i,s;const n=this.config.readonly||!this.writeRepairs;Object.values(t.floors).forEach((t=>{const e={};Object.values(t.edges).forEach((t=>{t.vertices&&t.vertices.forEach((t=>{e[t]=!0}))}));const i={};Object.entries(t.vertices).forEach((([t,s])=>{e[t]?i[t]=s:n?this.broadcast(new X.Z(`validateData: Would delete orphan node: ${t}`)):(this.broadcast(new X.Z(`validateData: Deleting orphan node: ${t}`)),this.queueRemoveEntity("node",t))})),t.vertices=i})),Object.values(t.floors).forEach((t=>{Object.entries(t.edges).forEach((([e,i])=>{var s;2===(null===(s=i.vertices)||void 0===s?void 0:s.length)&&t.vertices[i.vertices[0]]&&t.vertices[i.vertices[1]]||(delete t.edges[e],n?this.broadcast(new X.Z(`validateData: Would delete invalid wall: ${e}`)):(this.broadcast(new X.Z(`validateData: Deleting invalid wall: ${e}`)),this.queueRemoveEntity("wall",e)))}))}));for(const o of Object.values(t.floors))for(const t of Object.keys(o.rooms)){const a=o.rooms[t];let r=!1;const h=(null!==(e=a.edges)&&void 0!==e?e:[]).concat(null!==(s=null===(i=a.holes)||void 0===i?void 0:i.flat())&&void 0!==s?s:[]);for(const t of h){o.edges[t]||(r=!0)}r&&(n?this.broadcast(new X.Z(`validateData: Would delete invalid room: ${t}`)):(this.broadcast(new X.Z(`validateData: Deleting invalid room: ${t}`)),this.queueRemoveEntity("room",t)),delete o.rooms[t])}return Object.values(t.floors).forEach((t=>{const e=e=>{n?this.broadcast(new X.Z(`validateData: Would delete existing wall: ${e}`)):(this.broadcast(new X.Z(`validateData: Deleting existing wall: ${e}`)),this.queueRemoveEntity("wall",e)),delete t.edges[e]},i=new Map;Object.entries(t.rooms).forEach((([t,e])=>{for(const s of e.edges||[]){const e=i.get(s)||[];e.push(t),i.set(s,e)}}));const s=new Map;Array.from(Object.entries(t.edges)).forEach((([n,o])=>{if(!o.vertices)return;const a=o.vertices.slice().sort().join(":");if(s.has(a))if(i.has(n)){const o=s.get(a);if(o&&!i.has(o))e(o),s.set(a,n);else if(o){const r=i.get(o);for(const e of r||[]){const i=t.rooms[e].edges||[];for(let t=0;t<i.length;t++)i[t]===o&&(i[t]=n)}e(o),s.set(a,n)}}else e(n);else s.set(a,n)}))})),n||this.submitQueuedMutations(),t}}var Y=i(85281),Q=i(85846);class Z extends Q.xO{constructor(t,e,i){const s=new K,n=new J;super({queue:t,path:`${e}/api/v1/jsonstore/model/room-bound-debug/${i}`,batchUpdate:!1,deserialize:t=>s.deserialize(t),serialize:t=>n.serialize(t)})}}class K{deserialize(t){if(!this.isValid(t))return null;return{mutations:t.mutations.slice(),error:t.error,localData:t.localData,actionList:t.actionList}}isValid(t){return!(!t||"object"!=typeof t)&&(t.mutations&&"object"==typeof t.mutations)}}class J{serialize(t,...e){return t}}var tt=i(46192),et=i(52030),it=i(6539);class st extends s.n{constructor(){super(...arguments),this.name="room_bound_data",this.associationSources=[],this.modifiedFloors=new Set,this.layersChecked=!1,this.mdsHasAreaIndoorWithWalls=!0,this.processPromise=Promise.resolve(),this.isProcessingCeilings=!1,this.ceilingRecalcQueue=[],this.afterFinalize=async()=>{if(!this.writeBindings||null==this.appData)throw new Error("Not permitted to write room bounds data");if(this.appData.error)return;const t=this.data.getSnapshot(),e=this.store.peekQueuedMutations();try{this.store.queueUpdateRoomAssociations(this.updateRoomAssociations()),await this.store.submitQueuedMutations(),this.data.getAndClearActionList()}catch(i){throw this.log.info("Error finalizing room bounds data",i),this.data.clearUndoBuffer(),this.appData.error=i,this.appData.commit(),this.debugStore.update({error:`${(new Date).toUTCString()} ${i.message}`,mutations:e,localData:t,actionList:this.data.getAndClearActionList()}),i}},this.addRoom=t=>{if(null!=this.roomData){if(this.roomData.get(t.id)||this.roomData.add(new u.W({id:t.id,floorId:t.floorId,meshSubgroup:-1})),this.addToModifiedFloors(t),this.data.legacyRoomIds.length){this.store.queueRemoveLegacyRooms(this.data.legacyRoomIds);for(const t of this.data.legacyRoomIds)this.roomData.remove(t);this.data.legacyRoomIds.length=0}this.store.queueAddRoom(t)}},this.removeRoom=t=>{null!=this.roomData&&(this.roomData.get(t.id)&&this.roomData.remove(t.id),this.addToModifiedFloors(t),this.store.queueRemoveRoom(t))}}async init(t,e){this.engine=e;const[i,s]=await Promise.all([e.market.waitForData(d.P),e.market.waitForData(a.o)]);this.layersData=i;const c=i.getBaseModelId();if(!c)return e.market.register(v.A,new v.A(null)),s.setProperty(w.qQ,!0),void e.broadcast(new X.t(new Error("Unable to find view for RoomBoundData")));this.store=new q({viewId:c,context:i.mdsContext,readonly:!0,baseUrl:t.baseUrl},1===s.getOverrideParam("rbeRepair",0),s.tryGetProperty(et.VS,!1),e.broadcast.bind(e));const u=await this.store.read();this.updateHasAreaIndoorWithWalls(u),this.issueCommand=e.commandBinder.issueCommand,this.localeModule=await e.getModuleBySymbol(l.gS),this.debugStore=new Z(t.requestQueue,t.baseUrl,c);const D=await this.store.readClassifications({localizeFn:t=>this.localizeRoomClassification(t)});V.xt.forEach((t=>{const e=t.join(V.NZ);D[e]={id:e,label:t.map((t=>{var e;return(null===(e=D[t])||void 0===e?void 0:e.label)||[]})).join(V.Ae),defaultKeywords:(0,y.vQ)(t.map((t=>D[t])))}})),this.data=new v.A(u,D,e.broadcast.bind(e)),this.data.commit(),this.data.rooms.size>0&&s.setProperty(Y.n,!0),this.data.clearUndoBuffer(),this.data.resetHistory(),t.readonly||Promise.all([e.market.waitForData(p.q),e.market.waitForData(m.M),e.getModuleBySymbol(l.T9)]).then((([t,i,s])=>{this.roomData=t,this.writeBindings=new h.P(this.data.onWallsChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddWall(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateWall(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveWall(t)}}),this.data.onNodesChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddNode(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateNode(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveNode(t)}}),this.data.onRoomsChanged({onAdded:this.addRoom,onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateRoom(t)},onChildUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateRoom(t)},onRemoved:this.removeRoom}),this.data.onOpeningsChanged({onAdded:t=>{this.addToModifiedFloors(t),this.store.queueAddOpening(t)},onUpdated:t=>{this.addToModifiedFloors(t),this.store.queueUpdateOpening(t)},onRemoved:t=>{this.addToModifiedFloors(t),this.store.queueRemoveOpening(t)}}),s.onSave((async()=>{i.setProcessingSubState(!0),await this.processPromise,i.setProcessingSubState(!1)}),{dataType:r.p.ROOM_BOUNDS,phase:g.w.BEFORE}),this.data.afterFinalize((async()=>{this.ceilingRecalcQueue.push((async()=>await this.data.recalculateCeilings())),this.isProcessingCeilings||(this.processPromise=this.flushCeilingCalculations()),this.engine.commandBinder.issueCommand(new f.F({dataTypes:[r.p.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0}))}))),this.writeBindings.cancel(),e.getModuleBySymbol(it.ZF).then((t=>{t.getSettingsGui().loadPromise.then((()=>{t.getSettingsGui().addButton(0,"Debug","Clear Ceilings",(()=>{this.data.clearAllCeilings(),this.engine.commandBinder.issueCommand(new f.F({dataTypes:[r.p.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0}))}))}))}))})),this.bindings.push(e.subscribe(o.E5,(t=>this.trackRoomBoundsABTest(e,t.application))),e.commandBinder.addBinding(b.l,(t=>this.registerRoomAssociationSource(t.roomAssociation)))),async function(t,e){const[i,s,o,r,c]=await Promise.all([t.market.waitForData(n.zH),t.market.waitForData(d.P),t.market.waitForData(a.o),t.market.waitForData(x.q),t.getModuleBySymbol(l.gS)]);let u=i.application===n.lg.WORKSHOP;const p=(i,n,a,h=[])=>{const l=o.tryGetProperty(O.n9,!1),d=o.tryGetProperty(O._z,!1),p=l||d||u,m=o.tryGetProperty(F.Q$.RoomBounds,!1)||u,g=0===h.length;if(!(m&&p&&g))return[];const f=[];for(const a of e.rooms.values()){const h=(0,L.Ay)(a.id,c,e);if(i(a.name)||i(h)){const e=r.getFloor(a.floorId);if(!e)throw new Error("Unable to find floor for room while generating search results.");f.push(new B(t.commandBinder,s,o,n,a,h,e.id))}}return f.sort(((t,e)=>t.title.localeCompare(e.title)))},m=t=>{},g=t=>new h.P(e.onChanged(t),o.onPropertyChanged(I.Y.UnitType,t)),f={renew:()=>{t.commandBinder.issueCommandWhenBound(new C.Oc({id:S.jM.MODELROOM,groupPhraseKey:E.A.SHOWCASE.ROOMS.SEARCH_GROUP_HEADER,getSimpleMatches:p,registerChangeObserver:g,onSearchActivatedChanged:m,groupOrder:100,groupIcon:"edit-floorplan",batchSupported:!1}))},cancel:()=>{t.commandBinder.issueCommandWhenBound(new C.tf(S.jM.MODELROOM))}},v=()=>{u=i.application===n.lg.WORKSHOP,o.tryGetProperty(F.Q$.RoomBounds,!1)||u?f.renew():f.cancel()},y=i.onPropertyChanged("application",v),b=o.onPropertyChanged(F.Q$.RoomBounds,v);return v(),new h.P(f,y,b)}(e,this.data).then((t=>this.bindings.push(t))),e.market.register(v.A,this.data),e.market.waitForData(n.zH).then((t=>{this.appData=t,this.trackRoomBoundsABTest(e,t.application)}))}dispose(t){super.dispose(t),this.writeBindings&&this.writeBindings.cancel()}async setReadOnly(t){t!==this.store.readonly&&(this.store.readonly=t,this.writeBindings&&(t?this.writeBindings.cancel():(this.writeBindings.renew(),this.layersChecked||(await this.issueCommand(new c.xI),this.layersData.getProxyLayerId()||await this.issueCommand(new c.KQ),this.data.validateGraph()))))}localizeRoomClassification(t){return this.localeModule?Object.assign(Object.assign({},t),{label:(0,L.TG)(t,this.localeModule)}):t}trackRoomBoundsABTest(t,e){Promise.all([t.getModuleBySymbol(l.aF),t.market.waitForData(a.o)]).then((([t,i])=>{const s=this.data.rooms.size>0,o=e===n.lg.WORKSHOP||s&&(0,w.h4)(i);t.trackFeatures(`${w.Yk}:${o}`)}))}addToModifiedFloors(t){this.modifiedFloors.add(t.floorId)}updateRoomAssociations(){const t=new Map;for(const e of this.associationSources)for(const i of e.getPositionId()){if(!i.floorId||!this.modifiedFloors.has(i.floorId)||!(0,tt.C)(this.data,this.layersData,i.layerId))continue;const s=this.data.findRoomIdForPosition(i.position,i.floorId,i.roomId);if(s!=i.roomId){const n=t.get(s)||(s?{roomId:s}:{resetRoom:!0}),o=n[e.type]||[];o.push(i.id),n[e.type]=o,t.set(s,n),e.updateRoomForId(i.id,s)}}return this.modifiedFloors.clear(),Array.from(t.values())}updateHasAreaIndoorWithWalls(t){if(t){for(const e in t.floors){const i=t.floors[e];if(i.rooms)for(const t in i.rooms){const e=i.rooms[t];if(null!=e.areaIndoorWithWalls&&!isNaN(e.areaIndoorWithWalls))return void(this.mdsHasAreaIndoorWithWalls=!0)}}this.mdsHasAreaIndoorWithWalls=!1}}async registerRoomAssociationSource(t){this.associationSources.push(t)}async flushCeilingCalculations(){for(this.isProcessingCeilings=!0;this.ceilingRecalcQueue.length>0;)await this.ceilingRecalcQueue[0](),this.ceilingRecalcQueue.shift();this.isProcessingCeilings=!1}async runMigrations(){await this.computeAllCeilingsIfNecessary(),await this.saveAreaIndoorWithWalls()}async computeAllCeilingsIfNecessary(){Array.from(this.data.rooms.values()).some((t=>null!=t.ceiling))||(this.ceilingRecalcQueue.push((async()=>await this.data.recalculateCeilings(!0))),this.processPromise=this.flushCeilingCalculations(),await this.processPromise)}async saveAreaIndoorWithWalls(){this.mdsHasAreaIndoorWithWalls||(this.data.markAllRoomsDirty(),await this.engine.commandBinder.issueCommand(new f.F({dataTypes:[r.p.ROOM_BOUNDS],onCallback:this.afterFinalize,skipDirtyUpdate:!0})))}}const nt=st},71101:(t,e,i)=>{"use strict";i.d(e,{S:()=>s,j:()=>n});var s,n,o=i(37458);!function(t){t[t.BASE=o.X.roomBounds]="BASE",t[t.OPENING_STENCIL=o.X.roomBounds+1]="OPENING_STENCIL",t[t.EDGE_STENCIL=o.X.roomBounds+2]="EDGE_STENCIL",t[t.ROOM=o.X.roomBounds+3]="ROOM",t[t.EDGE=o.X.roomBounds+4]="EDGE",t[t.OPENING_LINES=o.X.roomBounds+5]="OPENING_LINES",t[t.NODE=o.X.roomBounds+6]="NODE"}(s||(s={})),function(t){t[t.OPENINGS=0]="OPENINGS",t[t.EDGE=1]="EDGE"}(n||(n={}))},89505:(t,e,i)=>{"use strict";i.d(e,{y:()=>x});var s,n,o=i(38069),a=i(18952),r=i(52885),h=i(94814),l=i(68909),d=i(71101),c=i(23689),u=i(60552),p=i(87708),m=i(74634),g=i(36580),f=i(37458),v=i(3249);!function(t){t[t.PIXELS=0]="PIXELS",t[t.METERS=1]="METERS"}(s||(s={})),function(t){t[t.NONE=0]="NONE",t[t.FADE_IN=1]="FADE_IN",t[t.FADE_OUT=-1]="FADE_OUT"}(n||(n={}));class y extends l.Mesh{constructor(t,e,i){var n,o,a,r,h,d,c,u;const p=new Float32Array([-9999,-9999,-9999,9999,9999,9999,-9999,-9999,-9999,9999,9999,9999,9999,9999,9999,-9999,-9999,-9999]),m=new Float32Array([1,1,0,0,-1,-1]),y=new Float32Array([0,1,0,1,0,1]),b=new l.InstancedBufferGeometry;b.setAttribute("position",new l.Float32BufferAttribute(p,3)),b.setAttribute("offsetDirection",new l.Float32BufferAttribute(m,1)),b.setAttribute("t",new l.Float32BufferAttribute(y,1)),b.setIndex([0,1,3,2,0,3,2,3,5,4,2,5]);const w={},D={};(null==e?void 0:e.dashUnits)===s.METERS&&(w.WORLDSPACE_DASH=!0,D.derivatives=!0);const S=null==e?void 0:e.fadeDistanceFromCamera;null!=S&&(w.FADE_DISTANCE_FROM_CAMERA=S.toFixed(2));const I=null==e?void 0:e.fadeDepth,T=null==e?void 0:e.fadeDepthTexture;null!=I&&null!=T&&(w.FADE_DEPTH=I.toFixed(3));super(b,new l.ShaderMaterial({uniforms:l.UniformsUtils.clone(g.i.screenline.uniforms),side:l.DoubleSide,vertexShader:g.i.screenline.vertexShader,fragmentShader:g.i.screenline.fragmentShader,transparent:!0,depthTest:e.depthTest,depthWrite:e.depthWrite,depthFunc:e.depthFunc,stencilWrite:null!==(n=e.stencilWrite)&&void 0!==n&&n,stencilFunc:null!==(o=e.stencilFunc)&&void 0!==o?o:l.AlwaysStencilFunc,stencilRef:null!==(a=e.stencilRef)&&void 0!==a?a:0,stencilWriteMask:null!==(r=e.stencilWriteMask)&&void 0!==r?r:255,stencilFuncMask:null!==(h=e.stencilFuncMask)&&void 0!==h?h:255,stencilFail:null!==(d=e.stencilFail)&&void 0!==d?d:l.KeepStencilOp,stencilZFail:null!==(c=e.stencilZFail)&&void 0!==c?c:l.KeepStencilOp,stencilZPass:null!==(u=e.stencilZPass)&&void 0!==u?u:l.KeepStencilOp,defines:w,extensions:D})),this.cameraPose=i,this.transitionStartTime=0,this.transitionDuration=0,this.updateEndpoints(t),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.renderOrder=f.X.lines,this.transitionDuration=e.transitionDuration||300,this.onBeforeRender=t=>{t.getSize(this.material.uniforms.screenSize.value),this.material.uniforms.pixelRatio.value=t.getPixelRatio(),null!=this.cameraPose&&(this.material.uniforms.cameraPos.value.copy(this.cameraPose.position),this.material.uniforms.transitionProgress.value=(0,v.qE)(Math.abs(performance.now()-this.transitionStartTime)/this.transitionDuration,0,1))},this.material.uniforms.dashed.value=+e.dashed,this.material.uniforms.dashSize.value=e.dashSize,this.material.uniforms.gapSize.value=e.gapSize,this.material.uniforms.lineWidth.value=e.lineWidth,this.material.uniforms.color.value.copy(e.color),this.material.uniforms.globalOpacity.value=e.globalOpacity,this.material.uniforms.depthTex.value=null==T?void 0:T.texture,this.material.uniforms.transitionType.value=e.transitionType||0,this.frustumCulled=!1,this.matrixAutoUpdate=!1}updateEndpoints(t){var e;3*t.length!==(null===(e=this.start)||void 0===e?void 0:e.length)&&(this.geometry.dispose(),this.start=new Float32Array(3*t.length),this.startAttrib=new l.InstancedBufferAttribute(this.start,3),this.geometry.setAttribute("start",this.startAttrib),this.end=new Float32Array(3*t.length),this.endAttrib=new l.InstancedBufferAttribute(this.end,3),this.geometry.setAttribute("end",this.endAttrib),this.opacity=new Float32Array(t.length),this.opacityAttrib=new l.InstancedBufferAttribute(this.opacity,1),this.geometry.setAttribute("opacity",this.opacityAttrib));for(let e=0;e<t.length;e++){const i=t[e].points,s=t[e].opacity;i[0].toArray(this.start,3*e),i[1].toArray(this.end,3*e),this.opacity[e]=null!=s?s:1}this.startAttrib.needsUpdate=!0,this.endAttrib.needsUpdate=!0,this.opacityAttrib.needsUpdate=!0}setVisibilityAt(t,e){const i=e?1:0;this.opacity[t]=i,this.opacityAttrib.needsUpdate=!0}globalOpacity(t){this.material.uniforms.globalOpacity.value=t}color(t){this.material.uniforms.color.value.copy(t)}lineWidth(t){this.material.uniforms.lineWidth.value=t}startTransition(t=n.FADE_IN){this.material.uniforms.transitionType.value=t,this.material.uniforms.transitionProgress.value=0,this.transitionStartTime=performance.now()}}var b=i(19968),w=i(81662),D=i(45138),S=i.n(D),I=i(68216),T=i.n(I);const P={uniforms:{screenSize:{value:new l.Vector2(0,0)},color:{value:new l.Vector3(1,1,1)},radius:{value:10},opacity:{value:1}},vertexShader:S(),fragmentShader:T()};class E extends l.Mesh{constructor(t,e){const i=new Float32Array([-9999,-9999,-9999,9999,9999,9999,-9999,-9999,-9999,9999,9999,9999]),s=new Float32Array([-1,1,1,1,1,-1,-1,-1]),n=new l.InstancedBufferGeometry;n.setAttribute("position",new l.Float32BufferAttribute(i,3)),n.setAttribute("offsetDirection",new l.Float32BufferAttribute(s,2)),n.setIndex([0,3,1,1,3,2]);super(n,new l.ShaderMaterial({uniforms:l.UniformsUtils.clone(P.uniforms),vertexShader:P.vertexShader,fragmentShader:P.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1})),this.setPositions(t),this.setMaterialParams(e),this.frustumCulled=!1,this.onBeforeRender=t=>{t.getSize(this.material.uniforms.screenSize.value)}}setMaterialParams(t){null!=t.color&&this.material.uniforms.color.value.copy(t.color),null!=t.opacity&&(this.material.uniforms.opacity.value=t.opacity),null!=t.radius&&(this.material.uniforms.radius.value=t.radius)}setPositions(t){this.geometry.dispose();const e=new Float32Array(3*t.length);for(let i=0;i<t.length;i++)e[3*i]=t[i].position.x,e[3*i+1]=t[i].position.y,e[3*i+2]=t[i].position.z;const i=new l.InstancedBufferAttribute(e,3);this.geometry.setAttribute("center",i),i.needsUpdate=!0}}class C extends l.Object3D{constructor(t,e,i,a,r,h,d,c,p,m){super(),this.labelManager=a,this.floorId=r,this.units=h,this.cameraPoseData=d,this.roomBoundViewData=c,this.depthMesh=m,this.labels=[],this.userIsInside=!1,this.lines=[],this.datumLines=[],this.roofLinesOffset=0,this.tempUp=new l.Vector3,this.linesInScene=!1,this.labelsVisible=!1,this.removeLineTimeout=null,this.solidOutlines=new y(this.lines,{dashed:!1,dashSize:1,gapSize:1,lineWidth:.5,color:o.V.WHITE,dashUnits:s.METERS,depthWrite:!1,depthTest:!1,depthFunc:l.LessDepth,globalOpacity:1,fadeDistanceFromCamera:u.GG,fadeDepth:u.Zc,fadeDepthTexture:p,transitionType:n.FADE_IN,transitionDuration:u.rH},this.cameraPoseData),this.solidDatums=new y(this.lines,{dashed:!0,dashSize:10,gapSize:4,lineWidth:1,color:o.V.WHITE,dashUnits:s.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:l.LessDepth,globalOpacity:1,transitionType:n.FADE_IN,transitionDuration:u.rH},this.cameraPoseData),this.fadedDatums=new y(this.lines,{dashed:!0,dashSize:10,gapSize:4,lineWidth:1,color:o.V.WHITE,dashUnits:s.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:l.GreaterDepth,globalOpacity:.4,transitionType:n.FADE_IN,transitionDuration:u.rH},this.cameraPoseData),this.datumCircles=new E([],{radius:5}),this.linesInScene=!1,this.updateEndpoints(t,e,i),this.updateLabelEndpoints()}updateUnits(t){this.units=t,this.updateLabelEndpoints()}updateEndpoints(t,e,i){this.datumLines=t.map((t=>({points:t.points,opacity:1})));const s=[],n=[];if(null!=i){this.tempUp.copy(w.B1.UP).multiplyScalar(i);for(const t of e){const e=(new l.Vector3).copy(t.points[0]);e.y+=i,s.push({points:[t.points[0],e]}),n.push({points:[t.points[0].clone().add(this.tempUp),t.points[1].clone().add(this.tempUp)]})}}this.roofLinesOffset=e.length+s.length,this.lines=e.concat(s,n).map((t=>({points:t.points,opacity:1}))),this.solidOutlines.updateEndpoints(this.lines),this.solidDatums.updateEndpoints(this.datumLines),this.fadedDatums.updateEndpoints(this.datumLines);const o=[];for(const t of this.datumLines)for(const e of t.points)o.push({position:e});this.datumCircles.setPositions(o),this.updateLabelEndpoints()}onRender(t){var e,i;const s=1*t,n=.4*t;(s>.1||n>.1)&&this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible?this.addLinesToScene():this.removeLinesFromScene(),this.solidOutlines.globalOpacity(s),this.solidDatums.globalOpacity(s),this.fadedDatums.globalOpacity(n),this.datumCircles.setMaterialParams({opacity:s});const o=this.userIsInside&&this.roomBoundViewData.roomDimensionsVisible;if(o){for(const t of this.labels)t.setVisible(!0);null===(e=this.datumLabel)||void 0===e||e.setVisible(!0)}else{for(const t of this.labels)t.setVisible(!1);null===(i=this.datumLabel)||void 0===i||i.setVisible(!1)}this.labelsVisible!==o&&(this.labelManager.needsImmediateCollsisionDetection(),this.labelsVisible=o)}addLinesToScene(){this.linesInScene||(this.add(this.solidOutlines),this.solidOutlines.startTransition(),this.add(this.solidDatums),this.solidDatums.startTransition(),this.add(this.fadedDatums),this.fadedDatums.startTransition(),this.add(this.datumCircles),this.linesInScene=!0,this.depthMesh.visible=!0,this.removeLineTimeout&&(window.clearTimeout(this.removeLineTimeout),this.removeLineTimeout=null))}removeLinesFromScene(){if(this.linesInScene){const t=()=>{this.remove(this.solidOutlines),this.remove(this.solidDatums),this.remove(this.fadedDatums),this.remove(this.datumCircles),this.depthMesh.visible=!1,this.removeLineTimeout=null};null!=this.removeLineTimeout&&(window.clearTimeout(this.removeLineTimeout),this.removeLineTimeout=null),this.solidOutlines.startTransition(n.FADE_OUT),this.solidDatums.startTransition(n.FADE_OUT),this.fadedDatums.startTransition(n.FADE_OUT),this.removeLineTimeout=window.setTimeout(t,u.rH),this.linesInScene=!1}}setUserIsInsideRoom(t){this.userIsInside=t}updateLabelEndpoints(){var t;if(this.roofLinesOffset!==this.labels.length){const t=this.roofLinesOffset-this.labels.length;t>0?this.createLabels(t,this.labels):t<0&&this.deleteLabels(t,this.labels)}for(let t=0;t<this.roofLinesOffset;t++){const e=this.lines[t];this.labels[t].updateDimensions(e.points[0],e.points[1],0,this.units),this.labels[t].isVertical(e.points[0],e.points[1])&&(this.labels[t].labelGroupId="inside_height_label")}this.datumLines.length>0&&(null==this.datumLabel&&(this.datumLabel=this.labelManager.createDatumLabel(this.floorId,this),this.datumLabel.setVisible(!1)),null===(t=this.datumLabel)||void 0===t||t.updateDimensions(this.datumLines[0].points[0],this.datumLines[0].points[1],0,this.units))}createLabels(t,e){for(let i=0;i<t;i++){const t=this.labelManager.createInsideLabel(this.floorId,this);t.setVisible(!1),e.push(t)}}deleteLabels(t,e){for(let i=0;i<t;i++){const t=e.pop();null==t||t.dispose()}}}const M={baseState:{innerColor:o.V.LENS_GRAY,outerColor:o.V.WHITE,opacity:0},hoverState:{innerColor:o.V.WHITE,outerColor:o.V.WHITE,opacity:.25},selectState:{innerColor:o.V.NEPTUNE,outerColor:o.V.WHITE,opacity:0},dimState:{innerColor:o.V.LENS_GRAY,outerColor:o.V.WHITE,opacity:.5}};class x extends c.r{constructor(t,e,i,s,n,h,c,u,m,g){const f=x.getGeoFromRoom(t,i),v=new l.MeshBasicMaterial({color:o.V.LENS_GRAY,depthTest:!1,side:l.DoubleSide,transparent:!0,opacity:0,blending:l.NormalBlending,blendEquation:l.AddEquation,blendSrc:l.SrcAlphaFactor,blendDst:l.DstColorFactor,stencilRef:65535,stencilFuncMask:1<<d.j.EDGE,stencilFail:l.KeepStencilOp,stencilZFail:l.KeepStencilOp,stencilZPass:l.KeepStencilOp,stencilFunc:l.GreaterStencilFunc,stencilWrite:!0});super(t.id,e,f,v,s),this.floorId=e,this.baseHeight=i,this.roomBoundViewData=h,this.labelManager=c,this.units=u,this.calcBaseHeight=m,this.caretsInstanceBuffer=g,this.currRoomLabelRadius=.5,this.potentialLabels=[],this.perimeterLabels=[],this.hideMaterial=new l.ShaderMaterial({vertexShader:p.Om.vertexShader,fragmentShader:p.Om.fragmentShader,uniforms:l.UniformsUtils.clone(p.Om.uniforms),depthTest:!1,side:l.DoubleSide,transparent:!0}),this.depthMaterial=new l.ShaderMaterial({vertexShader:p.Tx.vertexShader,fragmentShader:p.Tx.fragmentShader,uniforms:l.UniformsUtils.clone(p.Tx.uniforms),depthTest:!0,side:l.FrontSide}),this.perimeterLabelsVisible=!1,this.fullLabelVisible=!1,this.hoverTimer=null,this.labelHovered=!1,this.heightLines=new l.Group,this.heightLinesInScene=!1,this.heightLabels=[],this.insideNess=1,this.getLabelRadiusPx=t=>{const e=t.split("\n"),i=e.reduce(((t,e)=>Math.max(t,e.length)),0),s=(0,a.yp)(i,0,0),n=.5*s.width,o=.5*s.height*e.length;return Math.max(n,o)},this.worldRadiusToScreen=(()=>{const t=[new l.Vector3(1,0,0),new l.Vector3(-1,0,0),new l.Vector3(0,0,1),new l.Vector3(0,0,-1)],e=new l.Vector3,i=new l.Vector2,s=new l.Vector2,n=new l.Vector3;return(o,a,r)=>{let h=Number.MAX_SAFE_INTEGER;(0,b.bz)(this.cameraData,o,i,n),r.copy(i);for(const r of t){e.copy(o).addScaledVector(r,a),(0,b.bz)(this.cameraData,e,s,n);const t=i.distanceTo(s);t<h&&(h=t)}return h}})(),this.updateCarets=(()=>{const t=[new l.Vector2,new l.Vector2,new l.Vector2,new l.Vector2];return()=>{const e=this.cameraData.metersPerPx(),i=this.room.length/e,s=this.room.width/e,n=this.roomLabel.getSize(),o=n.width+2>i,a=n.height+2>s,r=this.fullLabelVisible&&(o||a),h=this.roomBoundViewData.roomDimensionsVisible&&this.roomBoundViewData.roomWallsVisible;this.room.canDisplayDimensions()&&!this.perimeterLabelsVisible&&this.fullLabelVisible&&!r&&h?(this.caretsInstanceBuffer.setVisibilityForInstances(this,!0),t[0].subVectors(this.room.w2,this.room.w1).normalize(),t[1].subVectors(this.room.w1,this.room.w2).normalize(),t[2].subVectors(this.room.l2,this.room.l1).normalize(),t[3].subVectors(this.room.l1,this.room.l2).normalize(),this.caretsInstanceBuffer.updateStateForInstances(this,[{normal:t[0],tip:this.room.w1,height:this.baseHeight},{normal:t[1],tip:this.room.w2,height:this.baseHeight},{normal:t[2],tip:this.room.l1,height:this.baseHeight},{normal:t[3],tip:this.room.l2,height:this.baseHeight}])):this.caretsInstanceBuffer.setVisibilityForInstances(this,!1)}})(),this.baseHeight+=.01,this.standardMaterial=v,this.renderOrder=d.S.ROOM,this.roomLabel=this.labelManager.createRoomLabel(t.floorId,t.id,this),this.roomLabel.setVisible(!t.hide),this.room=t,this.caretsInstanceBuffer.allocInstance(this),this.updateRoomLabelPositionAndText(!0),this.colors=M,this.extrusionMesh=new l.Mesh(x.getExtrudedGeo(this.room,this.baseHeight),this.depthMaterial),this.animation.onChanged((()=>{const t=this.prevColorState;this.standardMaterial.color.lerpColors(t.innerColor,this.targetColorScheme.innerColor,this.animation.value);const e=(0,r.C)(t.opacity,this.targetColorScheme.opacity,this.animation.value);this.opacity=e}));const{datumLines:y,perimeterLines:w,height:D}=this.calculateInsideModeLinePositions();this.insideModeLines=new C(y,w,D,c,t.floorId,this.units,this.cameraData.pose,this.roomBoundViewData,n,this.extrusionMesh),this.add(this.insideModeLines),this.matrixAutoUpdate=!1}hasIntersectionPriorityWithRespectTo(t){return!(!t.object||!t.object.isModelMesh)}dispose(){this.labelManager.deleteLabel(this.roomLabel);for(const t of this.perimeterLabels)this.labelManager.deleteLabel(t),t.dispose();for(const t of this.heightLabels)this.labelManager.deleteLabel(t),t.dispose();this.datumLabel&&(this.labelManager.deleteLabel(this.datumLabel),this.datumLabel.dispose()),this.clearHoverTimer(),this.caretsInstanceBuffer.removeInstance(this),super.dispose()}hoverRoomLabel(t){const e=()=>{if(!t&&this.roomLabel.getDisplayingTooltip()===t||t&&this.fullLabelVisible)return void(t||(this.labelHovered=!1,this.updateMaterial()));this.roomLabel.setDisplayingTooltip(t),this.updateMaterial();const e=this.roomLabel.label.collider.material;e.opacity=t?.65:0,e.transparent=!0,this.updateRoomLabelPositionAndText(!1),this.updateCarets()};this.labelHovered=t,t?null===this.hoverTimer&&(this.hoverTimer=window.setTimeout(e,u.jd),this.updateMaterial()):(e(),this.clearHoverTimer())}updateUnits(t){this.units=t,this.insideModeLines.updateUnits(this.units),this.updateLabels()}updateGeo(t){this.room=t;const e=isNaN(this.room.floorHeight)?this.calcBaseHeight(this.room):this.room.floorHeight;this.baseHeight=e+.01;const i=x.getGeoFromRoom(t,e);this.geometry.dispose(),this.geometry=i,this.geometry.computeBoundingBox();const s=x.getExtrudedGeo(t,e);this.extrusionMesh.geometry.dispose(),this.extrusionMesh.geometry=s,this.updateRoomLabelPositionAndText(!1),this.updateLabels(),this.createHeightObjects();const{datumLines:n,perimeterLines:o,height:a}=this.calculateInsideModeLinePositions();this.insideModeLines.updateEndpoints(n,o,a)}beforeRender(){this.standardMaterial.opacity=this.opacity*(1-this.pitchFactor)*Number(this.roomBoundViewData.roomWallsVisible);const t=this.dimState.active?.5:1;this.caretsInstanceBuffer.setOpacityForInstances(this,t),this.updateLabelBillboard(),this.updateMaterial(),this.updateCarets()}updateLabelBillboard(){if(this.isRoomLabelVisible()){const{position:t,rotation:e,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,n=this.cameraData.isOrtho()?this.cameraData.zoom():1,o=this.cameraData.aspect(),a=.1;this.roomLabel.label.quaternion.copy(e),this.roomLabel.label.scaleBillboard(t,e,i,n,s,o,a),this.roomLabel.label.updateMatrix(),this.roomLabel.label.updateMatrixWorld()}}updateLabelVisibility(){const t=this.hoverState.active||this.labelHovered;this.perimeterLabelsVisible=this.roomBoundViewData.roomDimensionsVisible&&(this.selectState.active||t&&(0,b.aY)(this.pitchFactor))&&this.insideNess<.9,this.updateLabels();for(const t of this.perimeterLabels)t.setVisible(this.perimeterLabelsVisible);const e=this.perimeterLabelsVisible&&!(0,b.aY)(this.pitchFactor);for(const t of this.heightLabels)t.setVisible(e);this.datumLabel&&this.datumLabel.setVisible(e),this.updateCarets()}updateMaterial(){this.material=this.room.hide?this.hideMaterial:this.standardMaterial,super.updateMaterial();const t=this.hoverState.active||this.labelHovered,e=(0,b.aY)(this.pitchFactor);(this.selectState.active||t)&&!e&&this.roomBoundViewData.roomDimensionsVisible?this.heightLinesInScene||(this.add(this.heightLines),this.heightLinesInScene=!0):this.heightLinesInScene&&(this.remove(this.heightLines),this.heightLinesInScene=!1),t&&e&&(this.targetColorScheme=this.colors.hoverState),this.hideMaterial.uniforms.opacity.value=t?1:0;const i=this.standardMaterial;this.prevColorState.innerColor.copy(i.color),this.prevColorState.opacity=i.opacity,this.animation.modifyAnimation(0,1,u.JT,h.WD),this.roomLabel.setDimmed(this.dimState.active),this.roomLabel.setVisible(this.isRoomLabelVisible()),this.updateLabelVisibility()}isRoomLabelVisible(){const t=this.hoverState.active||this.labelHovered;return!(this.insideNess>.9)&&((!this.room.hide||t)&&this.potentialLabels.length>0)}updateText(t,e){this.potentialLabels=t,this.updateRoomLabelPositionAndText(e),this.updateCarets()}static getGeoFromRoom(t,e){const{points:i,faces:s}=t.getGeometry(),n=i.map((t=>[t.x,e,t.y])).flat(1),o=new l.BufferGeometry;return o.setAttribute("position",new l.BufferAttribute(new Float32Array(n),3)),o.setIndex(s.flat(1)),o}static getExtrudedGeo(t,e){const{points:i,faces:s}=t.getGeometry(),n=i.map((t=>[t.x,e,t.y])),o=s.slice(),a=t.calculateMinimalInnerLoop(.01);for(const t of a)for(let i=0;i<t.length;i++){const s=n.length,a=t[i],r=t[(i+1)%t.length],h=[a.x,e,a.z],l=[r.x,e,r.z],d=[r.x,e+100,r.z],c=[a.x,e+100,a.z];n.push(h,l,d,c),o.push([s+0,s+2,s+1],[s+0,s+3,s+2])}const r=new l.BufferGeometry;return r.setAttribute("position",new l.BufferAttribute(new Float32Array(n.flat(1)),3)),r.setIndex(o.flat(1)),r}updateRoomLabelPositionAndText(t){if(0===this.potentialLabels.length)return;const e=[];if(!t){const{position:t}=this.roomLabel.label,i={x:t.x,y:t.z};this.room.holesCW.find((t=>{const e=t.map((t=>({x:t.x,y:t.z})));return(0,m.L)(i,e)}))||e.push({point:t.clone(),radius:this.currRoomLabelRadius})}const i=this.room.getViewCenter(new l.Vector3,1.5);i.y=this.baseHeight+u.Dh;const s=this.room.getViewCenterDistance(1.5);e.push({point:i,radius:s});const{screenPosition:n}=(0,b.bz)(this.cameraData,i,new l.Vector2,new l.Vector3),o=new l.Vector2;for(const t of e){this.roomLabel.label.position.copy(t.point),this.roomLabel.label.position.y=this.baseHeight+u.Dh,this.currRoomLabelRadius=t.radius;let e=!1;this.fullLabelVisible=!0;for(const i of this.potentialLabels){const s=this.getLabelRadiusPx(i),a=1.5*this.worldRadiusToScreen(this.roomLabel.label.position,t.radius,o),r=o.distanceTo(n);if(!this.cameraData.pose.isOrtho()||s+r<=a||this.roomLabel.getDisplayingTooltip()){this.roomLabel.label.text=i,e=!0;break}this.fullLabelVisible=!1}if(e)break}}calculateInsideModeLinePositions(){const t=this.room.getMaxCeilingDatum(),e=[];if(t){const i=new l.Vector3(t.position.x,this.baseHeight,t.position.z),s=new l.Vector3(t.position.x,this.baseHeight+t.height,t.position.z);e.push({points:[i,s]})}const i=[],s=this.room.minimalInnerLoop;for(const t of s){const e=t.length;for(let s=0;s<e;s++){const n=(new l.Vector3).copy(t[s]);n.y=this.baseHeight;const o=(new l.Vector3).copy(t[(s+1)%e]);o.y=this.baseHeight,i.push({points:[n,o]})}}return{datumLines:e,perimeterLines:i,height:this.room.canDisplayHeight()?this.room.getMinCeilingHeight():void 0}}updateLabels(){var t;if(!this.perimeterLabelsVisible)return;const e=this.room.hide?[]:this.room.minimalInnerEdges,i=this.room.canDisplayHeight()?e.length:0;for(;e.length>this.perimeterLabels.length;)this.perimeterLabels.push(this.labelManager.createPerimeterLabel(this.room.floorId,this,!0));for(;i>this.heightLabels.length;){const t=this.labelManager.createHeightLabel(this.room.floorId,!1,this,!0);t.labelGroupId=this.room.id,this.heightLabels.push(t)}for(;e.length<this.perimeterLabels.length;){const t=this.perimeterLabels.pop();if(!t)throw new Error("Label should exist!");this.labelManager.deleteLabel(t)}for(;i<this.heightLabels.length;){const t=this.heightLabels.pop();if(!t)throw new Error("Label should exist!");this.labelManager.deleteLabel(t)}for(let t=0;t<e.length;t++){const s=e[t],n=s.start.clone();n.y=this.baseHeight;const o=s.end.clone();if(o.y=this.baseHeight,this.perimeterLabels[t].updateDimensions(n,o,0,this.units),i>0){const e=n.clone(),i=e.clone();i.y=this.baseHeight+this.room.getMinCeilingHeight(),this.heightLabels[t].updateDimensions(e,i,0,this.units)}}const s=this.room.getMaxCeilingDatum();if(null!=s){null==this.datumLabel&&(this.datumLabel=this.labelManager.createDatumLabel(this.room.floorId,this),this.datumLabel.labelGroupId=this.room.id+"_max_height",this.datumLabel.labelHeightFraction=2/3);const e=s.position.clone();e.y=this.baseHeight;const i=e.clone();i.y+=s.height,null===(t=this.datumLabel)||void 0===t||t.updateDimensions(e,i,0,this.units)}else this.datumLabel&&(this.datumLabel.dispose(),this.labelManager.deleteLabel(this.datumLabel),this.datumLabel=null);this.labelManager.needsImmediateCollsisionDetection()}clearHoverTimer(){null!==this.hoverTimer&&(clearTimeout(this.hoverTimer),this.hoverTimer=null)}createHeightObjects(){this.heightLines.clear();const t={dashed:!1,dashSize:1,gapSize:1,lineWidth:1,color:o.V.WHITE,dashUnits:s.METERS,depthWrite:!1,depthTest:!0,depthFunc:l.LessDepth,globalOpacity:1},e={dashed:!1,dashSize:.08,gapSize:.04,lineWidth:.5,color:o.V.WHITE,dashUnits:s.METERS,depthWrite:!1,depthTest:!0,depthFunc:l.GreaterDepth,globalOpacity:.3},i={dashed:!0,dashSize:10,gapSize:4,lineWidth:1,color:o.V.WHITE,dashUnits:s.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:l.LessDepth,globalOpacity:1},n={dashed:!0,dashSize:10,gapSize:4,lineWidth:1,color:o.V.WHITE,dashUnits:s.PIXELS,depthWrite:!1,depthTest:!0,depthFunc:l.GreaterDepth,globalOpacity:.3},a=[],r=(t,e,i=a)=>{i.push({points:[t.clone(),e.clone()]})},h=[],d=new l.Vector3,c=new l.Vector3,u=this.room.minimalInnerLoop,p=this.room.getMinCeilingHeight();for(const t of u){const e=t.length;for(let i=0;i<e;i++)d.copy(t[i]),d.y=this.baseHeight,c.copy(t[(i+1)%e]),c.y=this.baseHeight,r(d,c),this.room.canDisplayHeight()&&(d.y+=p,c.y+=p,r(d,c));if(this.room.canDisplayHeight())for(const e of t)d.copy(e),d.y=this.baseHeight,c.copy(d),c.y+=p,r(d,c)}const m=this.room.getMaxCeilingDatum();m&&(d.copy(m.position),d.y=this.baseHeight,c.copy(d),c.y+=m.height,r(d,c,h)),this.occlusionLine=new y(a,e,this.cameraData.pose),this.perspectiveLine=new y(a,t,this.cameraData.pose),this.occlusionDatums=new y(h,n,this.cameraData.pose),this.perspectiveDatums=new y(h,i,this.cameraData.pose);const g=[];for(const t of h)for(const e of t.points)g.push({position:e});this.datumCircles=new E(g,{radius:5}),this.heightLines.add(this.occlusionLine),this.heightLines.add(this.perspectiveLine),this.heightLines.add(this.occlusionDatums),this.heightLines.add(this.perspectiveDatums),this.heightLines.add(this.datumCircles)}setIsInside(t){this.insideModeLines.setUserIsInsideRoom(t)}onRender(t,e){this.pitchFactor=t,this.insideNess=e,this.raycastEnabled=e<.1&&(this.roomBoundViewData.roomDimensionsVisible||(0,b.aY)(this.pitchFactor)),this.insideModeLines.onRender(e);const i=(1-e)*t,s=1*i,n=.3*i;this.perspectiveLine&&this.occlusionLine&&(this.perspectiveLine.globalOpacity(s),this.occlusionLine.globalOpacity(n)),this.perspectiveDatums&&this.occlusionDatums&&this.datumCircles&&(this.perspectiveDatums.globalOpacity(s),this.occlusionDatums.globalOpacity(n),this.datumCircles.setMaterialParams({opacity:s}))}}},23689:(t,e,i)=>{"use strict";i.d(e,{r:()=>r});var s=i(19968),n=i(92237),o=i(68909),a=i(71101);class r extends o.Mesh{constructor(t,e,i,s,r){super(i,s),this.roomBoundsId=t,this.floorId=e,this.cameraData=r,this.animation=new n.z(0),this.prevColorState={opacity:1,innerColor:new o.Color,outerColor:new o.Color},this.pitchFactor=1,this.raycastEnabled=!0,this.fullyInitialized=!1,this.opacity=1,this.selectState={active:!1,on:()=>{this.updateMaterial()},off:()=>{this.updateMaterial()}},this.hoverState={active:!1,on:()=>{this.updateMaterial()},off:()=>this.updateMaterial()},this.highlightState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.dimState={active:!1,on:()=>this.updateMaterial(),off:()=>this.updateMaterial()},this.name=t,this.renderOrder=a.S.BASE}updateMaterial(){var t;let e=this.colors.baseState;this.dimState.active&&(e=this.colors.dimState),this.hoverState.active&&(e=this.colors.hoverState),this.highlightState.active&&(e=null!==(t=this.colors.highlightState)&&void 0!==t?t:this.colors.selectState),this.selectState.active&&(e=this.colors.selectState);e!==this.targetColorScheme&&(this.targetColorScheme=e)}tickAnimations(t){this.animation.tick(t)}dispose(){}raycast(t,e){if(!this.raycastEnabled)return;const i=[];super.raycast(t,i),i.length>0&&e.push(i[0])}beforeRender(){}onRender(t,e){this.pitchFactor=t,this.raycastEnabled=(0,s.aY)(this.pitchFactor)}}},57916:(t,e,i)=>{"use strict";i.r(e),i.d(e,{RoomBoundEdgeView:()=>m,RoomBoundEndHandleView:()=>T,RoomBoundHandleView:()=>y,RoomBoundOpeningHandleView:()=>S,RoomBoundOpeningView:()=>D,RoomBoundRenderer:()=>gt,RoomBoundStartHandleView:()=>I,RoomBoundView:()=>l.r,default:()=>xt});var s=i(38069),n=i(25601),o=i(52885),a=i(94814),r=i(68909),h=i(71101),l=i(23689),d=i(60552),c=i(68062);const u=(()=>{const t=new r.Vector3,e=new r.Vector2,i=new r.Vector2,s=new r.Line3;return(n,o,a,h,l,u,p)=>{s.set(n,o);const m=s.closestPointToPoint(u.ray.origin,!0,t);e.set(m.x,m.z),i.set(u.ray.origin.x,u.ray.origin.z);const g=e.distanceTo(i),f=u.ray.origin.distanceTo(s.start),v=(0,c.ff)(f,h.pose.projection.asThreeMatrix4(),h.width),y=d.ub*v;g<.5*Math.max(a,d.FY)+y&&p.push({distance:f,object:l,point:m.clone(),face:{a:-1,b:-1,c:-1,materialIndex:-1,normal:new r.Vector3(0,1,0)}})}})(),p={baseState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:1},hoverState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1},selectState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1},dimState:{innerColor:s.V.WHITE,outerColor:s.V.WHITE,opacity:.5},highlightState:{innerColor:s.V.WHITE,outerColor:s.V.NEPTUNE,opacity:1}};class m extends l.r{constructor(t,e,i,l,c,u){super(t,e,new r.BufferGeometry,new r.ShaderMaterial,i),this.floorId=e,this.instanceBuffer=l,this.lineLabel=c,this.isAddState=u,this.line3=new r.Line3(new r.Vector3,new r.Vector3),this.widthCache=.1,this.currOutlineColor=new r.Color,this.currInnerColor=new r.Color,this.updateMaterial=()=>{super.updateMaterial(),this.targetColorScheme!==p.highlightState||this.isAddState()||(this.targetColorScheme=p.baseState),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOutlineColor),this.prevColorState.opacity=this.opacity,this.animation.modifyAnimation(0,1,d.JT,a.WD),this.lineLabel.setVisible(this.selectState.active||this.highlightState.active||this.hoverState.active)},this.onEdgePositionChanged=(()=>{const t=new r.Vector3,e=new r.Vector3,i=new r.Vector3,s=new r.Vector3,o=new r.Vector3,a=new r.Vector3,h=new r.Vector3;return(r,l,d)=>{const c=r.getWall(this.roomBoundsId);c.from.getVec3(t),c.to.getVec3(e),c.getBiasAdjustmentVec(h),i.set(t.x,t.y+l,t.z),s.set(e.x,e.y+l,e.z),o.addVectors(i,h),a.addVectors(s,h),this.line3.start.copy(o),this.line3.end.copy(a),this.widthCache=c.width,this.lineLabel.updateDimensions(o,a,c.width,d);const u=(0,n.A)(c,r);this.instanceBuffer.setGeometryForInstance(this,l,o.x,o.z,a.x,a.z,c.width,i.x,i.z,s.x,s.z,u)}})(),this.instanceBuffer.allocInstance(this),this.renderOrder=h.S.EDGE,this.colors=p,this.animation.onChanged((()=>{const t=this.prevColorState,e=this.targetColorScheme;this.currOutlineColor.lerpColors(t.outerColor,e.outerColor,this.animation.value),this.currInnerColor.lerpColors(t.innerColor,e.innerColor,this.animation.value);const i=(0,o.C)(t.opacity,e.opacity,this.animation.value);this.opacity=i,this.instanceBuffer.setColorsForInstance(this,this.currOutlineColor,this.currInnerColor),this.instanceBuffer.setOpacityForInstance(this,this.opacity)})),this.instanceBuffer.setColorsForInstance(this,s.V.WHITE,s.V.WHITE),this.instanceBuffer.setOpacityForInstance(this,1),this.matrixAutoUpdate=!1,this.frustumCulled=!1}raycast(t,e){u(this.line3.start,this.line3.end,this.widthCache,this.cameraData,this,t,e)}tickAnimations(t){super.tickAnimations(t),this.lineLabel.tickAnimations(t)}setLabelVisible(t){this.lineLabel.setVisible(t)}dispose(){super.dispose(),this.lineLabel.dispose(),this.instanceBuffer.removeInstance(this)}onRender(t,e){super.onRender(t,e),this.lineLabel.update()}}var g=i(81662);const f={baseState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},hoverState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL},selectState:{opacity:1,innerColor:s.V.MP_BRAND,outerColor:s.V.WHITE},dimState:{opacity:1,innerColor:s.V.MIRROR,outerColor:s.V.PORTAL}},v=new r.Plane;class y extends l.r{constructor(t,e,i,s){super(t,e,new r.BufferGeometry,new r.ShaderMaterial,i),this.floorId=e,this.instanceBuffer=s,this.targetRadius=.3,this.prevRadius=.3,this.currOuterColor=f.baseState.outerColor.clone(),this.currInnerColor=f.baseState.innerColor.clone(),this.currRadius=d.m7,this.renderOrder=h.S.NODE,this.colors=f,this.animation.onChanged((()=>this.onAnimationChange())),this.instanceBuffer.allocInstance(this),this.instanceBuffer.setColorsForInstance(this,this.currOuterColor,this.currInnerColor),this.instanceBuffer.setRadiusForInstance(this,this.currRadius),this.instanceBuffer.setOpacityForInstance(this,1)}onAnimationChange(){const t=this.prevColorState,e=this.targetColorScheme;this.currOuterColor.lerpColors(t.outerColor,e.outerColor,this.animation.value),this.currInnerColor.lerpColors(t.innerColor,e.innerColor,this.animation.value),this.instanceBuffer.setColorsForInstance(this,this.currOuterColor,this.currInnerColor),this.opacity=(0,o.C)(t.opacity,e.opacity,this.animation.value),this.instanceBuffer.setOpacityForInstance(this,this.opacity);const i=(0,o.C)(this.prevRadius,this.targetRadius,this.animation.value);this.instanceBuffer.setRadiusForInstance(this,i)}onRender(t,e){super.onRender(t,e)}raycast(t,e){v.setFromNormalAndCoplanarPoint(g.B1.UP,this.position);const i=t.ray.intersectPlane(v,new r.Vector3);if(i){const s=t.ray.origin.distanceTo(this.position),n=(0,c.ff)(s,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width),o=d.ub*n;i.distanceTo(this.position)<d.m7+o&&e.push({point:i,normal:g.B1.UP.clone(),distance:i.distanceTo(t.ray.origin),object:this})}}updateMaterial(){this.prevRadius=this.currRadius,this.targetRadius=d.m7+(this.hoverState.active?d.xX:0)+(this.selectState.active?d.xX:0),super.updateMaterial(),this.prevColorState.innerColor.copy(this.currInnerColor),this.prevColorState.outerColor.copy(this.currOuterColor),this.prevColorState.opacity=this.opacity,this.animation.modifyAnimation(0,1,d.JT,a.WD)}updatePosition(t){this.position.copy(t),this.instanceBuffer.setPositionForInstance(this,t)}dispose(){this.instanceBuffer.removeInstance(this),super.dispose()}}var b=i(87708),w=i(34914);r.ShaderMaterial;class D extends l.r{constructor(t,e,i,n,o,a,l){super(t,e,new r.BufferGeometry,new r.ShaderMaterial,i),this.floorId=e,this.cameraData=i,this.roomBoundViewData=n,this.instanceBufferOpening=a,this.instanceBufferOpeningStencil=l,this.start=new r.Vector3,this.end=new r.Vector3,this.width=0,this.outlineColor=s.V.WHITE.clone(),this.onEdgePositionChanged=(()=>{const t=new r.Vector3,e=new r.Vector3;return(i,s,n,o)=>{this.start.copy(i),this.end.copy(s),this.width=n,t.subVectors(s,i);const a=t.length(),r=n;e.set(a,.05,r),this.instanceBufferOpening.setScaleForInstance(this,e),this.instanceBufferOpeningStencil.setScaleForInstance(this,e);const h=Math.atan2(s.x-i.x,s.z-i.z)+Math.PI/2;this.instanceBufferOpening.setRotationForInstance(this,h),this.instanceBufferOpeningStencil.setRotationForInstance(this,h);const l=t.addVectors(s,i).multiplyScalar(.5);this.instanceBufferOpening.setPositionForInstance(this,l),this.instanceBufferOpeningStencil.setPositionForInstance(this,l),this.startHandle.updatePosition(i),this.endHandle.updatePosition(s);const d=o===w.v.DOOR;this.instanceBufferOpening.setIsDoorForInstance(this,d),this.instanceBufferOpeningStencil.setIsDoorForInstance(this,d)}})(),this.renderOrder=h.S.OPENING_LINES,this.startHandle=new I(t,e,i,o,this),this.endHandle=new T(t,e,i,o,this),this.instanceBufferOpening.allocInstance(this),this.instanceBufferOpeningStencil.allocInstance(this),this.instanceBufferOpening.setColorForInstance(this,this.outlineColor),this.instanceBufferOpeningStencil.setColorForInstance(this,this.outlineColor),this.animation.onChanged((()=>{this.outlineColor.lerpColors(s.V.WHITE,s.V.NEPTUNE,this.animation.value),this.instanceBufferOpening.setColorForInstance(this,this.outlineColor),this.instanceBufferOpeningStencil.setColorForInstance(this,this.outlineColor)}))}onRender(t,e){super.onRender(t,e),this.visible=this.pitchFactor<1&&this.roomBoundViewData.roomWallsVisible,this.startHandle.onRender(t,e),this.endHandle.onRender(t,e)}updateMaterial(){const t=this.selectState.active||this.hoverState.active||this.highlightState.active;this.animation.modifyAnimation(this.animation.value,t?1:0,d.JT,a.WD)}tickAnimations(t){super.tickAnimations(t),this.startHandle.tickAnimations(t),this.endHandle.tickAnimations(t)}raycast(t,e){u(this.start,this.end,this.width,this.cameraData,this,t,e)}dispose(){super.dispose(),this.startHandle.dispose(),this.endHandle.dispose(),this.instanceBufferOpening.removeInstance(this),this.instanceBufferOpeningStencil.removeInstance(this)}}class S extends y{constructor(t,e,i,s,n){super(t,e,i,s),this.floorId=e,this.parentOpeningView=n}}class I extends S{}class T extends S{}var P=i(87965),E=i(23339);class C extends y{}var M=i(89505),x=i(35341),A=i.n(x),R=i(52514),L=i(37458),O=i(19968),F=i(18952),B=i(92237);class V{constructor(){this.corner=[new r.Vector2,new r.Vector2,new r.Vector2,new r.Vector2],this.axis=[new r.Vector2,new r.Vector2],this.origin=[0,0],this.aabb=new r.Box2}set(t){if(4!==t.length)throw new Error("Obb needs four points!");for(let e=0;e<t.length;e++)this.corner[e].copy(t[e]);this.aabb.setFromPoints(this.corner),this.axis[0].subVectors(this.corner[1],this.corner[0]),this.axis[1].subVectors(this.corner[3],this.corner[0]);for(let t=0;t<2;t++)this.axis[t].divideScalar(this.axis[t].lengthSq()),this.origin[t]=this.corner[0].dot(this.axis[t])}overlaps(t){return this.overlaps1Way(t)&&t.overlaps1Way(this)}overlaps1Way(t){for(let e=0;e<2;e++){let i=t.corner[0].dot(this.axis[e]),s=i,n=i;for(let o=1;o<4;o++)i=t.corner[o].dot(this.axis[e]),s=Math.min(s,i),n=Math.max(n,i);if(s>1+this.origin[e]||n<this.origin[e])return!1}return!0}}var N=i(93818),k=i(27906),G=i(12767);const H=new r.Vector2(0,0);class _{constructor(t,e,i,n,o,a){this.cameraData=i,this.getCurrFloorId=n,this.visibleDepthMeshes=o,this.debugContainer=a,this.labelsByFloor=new Map,this.needsImmediateCollisionDetectionCtr=5,this.lastCollisionTimestamp=0,this.tree=new(A()),this.distanceBehindDepthMesh=(()=>{const t=new r.Raycaster,e=new r.Vector3,i=new r.Vector3,s=new r.Vector3;return n=>{const o=this.cameraData.pose;i.subVectors(n.getAnchorPoint(s),o.position),e.copy(i).normalize(),t.set(o.position,e);const a=[];for(const e of this.visibleDepthMeshes())e.raycast(t,a);if(0===a.length)return Number.MAX_SAFE_INTEGER;{let t=Number.MAX_SAFE_INTEGER;for(const e of a)e.distance<t&&(t=e.distance);const e=i.length()-t;return e>0?e:Number.MAX_SAFE_INTEGER}}})(),this.roomLabelMaker=new R.Il({assetBasePath:t,lang:e,color:s.V.WHITE.clone(),outline:!0,background:!1,backgroundColor:s.V.BLACK.clone(),backgroundColliderType:q,disableDepth:!0}),this.wallLabelMaker=new R.Il({assetBasePath:t,color:s.V.BLACK.clone(),lang:e,background:!0,outline:!1,backgroundColor:s.V.WHITE.clone(),backgroundColliderType:X,disableDepth:!0,backgroundBorderHeight:.8,backgroundBorderWidth:.8}),this.insideLabelMaker=new R.Il({assetBasePath:t,color:s.V.BLACK.clone(),lang:e,background:!0,outline:!1,backgroundColor:s.V.WHITE.clone(),backgroundColliderType:X,disableDepth:!0,backgroundBorderHeight:.8,backgroundBorderWidth:.8})}createRoomLabel(t,e,i){const s=new W(U.ROOM,t,this.roomLabelMaker.createLabel(),this.cameraData,i);return s.label.collider.userData={roomId:e},this.addToFloorDict(t,s),s}createWallLabel(t,e){const i=new z(U.WALL,t,this.wallLabelMaker.createLabel(),this.cameraData,e,21);return this.addToFloorDict(t,i),this.needsImmediateCollsisionDetection(),i}createPerimeterLabel(t,e,i=!1){const s=new z(U.PERIMETER,t,this.wallLabelMaker.createLabel(),this.cameraData,e,21);return this.addToFloorDict(t,s),i||this.update(),this.needsImmediateCollsisionDetection(),s}createHeightLabel(t,e,i,s=!1){const n=e?U.HEIGHT_HIGH_PRIO:U.HEIGHT_LOW_PRIO,o=new z(n,t,this.wallLabelMaker.createLabel(),this.cameraData,i,21);return this.addToFloorDict(t,o),s||this.update(),this.needsImmediateCollsisionDetection(),o}createInsideLabel(t,e){const i=new $(U.PERIMETER,t,this.insideLabelMaker.createLabel(),this.cameraData,e,21,d.rH);return this.addToFloorDict(t,i),this.needsImmediateCollsisionDetection(),i}createDatumLabel(t,e){const i=new j(U.PERIMETER,t,this.insideLabelMaker.createLabel(),this.cameraData,e,21);return this.addToFloorDict(t,i),this.needsImmediateCollsisionDetection(),i}deleteLabel(t){this.removeFromFloorDict(t.floorId,t),t.dispose(),this.needsImmediateCollsisionDetection()}tickAnimations(t){for(const e of this.currFloorLabels())e.tickAnimations(t)}needsImmediateCollsisionDetection(){this.needsImmediateCollisionDetectionCtr=5}update(){this.debugContainer&&this.debugContainer.clear();for(const t of this.currFloorLabels())t.update();(this.needsImmediateCollisionDetectionCtr>0||performance.now()-this.lastCollisionTimestamp>2e3)&&(this.updateLabelCollisions(),this.needsImmediateCollisionDetectionCtr=Math.max(this.needsImmediateCollisionDetectionCtr-1,0),this.lastCollisionTimestamp=performance.now())}*currFloorLabels(){const t=this.getCurrFloorId();if(t){const e=this.labelsByFloor.get(t);if(e)for(const t of e)yield t}}addToFloorDict(t,e){let i=this.labelsByFloor.get(t);null==i&&(i=new Set,this.labelsByFloor.set(t,i)),i.add(e)}removeFromFloorDict(t,e){const i=this.labelsByFloor.get(t);null!=i&&i.delete(e)}updateLabelCollisions(){const t=new r.Vector2,e=new r.Vector3,i=new r.Vector3,s=[{x:-1,y:-1,screenPos:new r.Vector2},{x:1,y:-1,screenPos:new r.Vector2},{x:1,y:1,screenPos:new r.Vector2},{x:-1,y:1,screenPos:new r.Vector2}],n=[],o=(0,c.Gp)(this.cameraData.pose.projection),a=t=>{const e=t.positionPriority();let i=0;t.getDisplayingTooltip()&&(i+=1e3);return t.getDimmed()?i+=-1e4:t.type===U.ROOM?i+=200:t.type===U.HEIGHT_HIGH_PRIO?i+=100:t.type===U.HEIGHT_LOW_PRIO&&(i+=50),e+i},h=Array.from(this.currFloorLabels()).filter((t=>t.labelVisible&&t.fitsWall&&t.collisionDetection&&this.cameraData.pose.worldspaceFrustum.value.containsPoint(t.label.position))).map((t=>{const e=t.label;return{label:t,cameraDistance:o?Math.abs(e.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(e.position),priority:a(t)}})).sort(((t,e)=>e.priority-t.priority)).map((o=>{const{label:a,cameraDistance:h}=o,l=a.label,u=(0,c.ff)(h,this.cameraData.pose.projection.asThreeMatrix4(),this.cameraData.width)*d.IS;(0,O.bz)(this.cameraData,l.position,t,e);const{width:p,height:m}=l.getUnscaledSize();this.debugContainer&&(n.length=0),l.updateMatrixWorld();for(const t of s)i.set(p*t.x*.5+u*t.x,m*t.y*.5+(u+t.y),0),i.applyMatrix4(l.matrixWorld),this.debugContainer&&n.push(i.clone()),(0,O.bz)(this.cameraData,i,t.screenPos);if(this.debugContainer){const t=new r.Mesh(new r.ShapeGeometry(new r.Shape(n.map((t=>new r.Vector2(t.x,t.z))))).rotateX(Math.PI/2),new r.MeshBasicMaterial({color:"red",depthTest:!1,side:r.DoubleSide}));this.debugContainer.add(t)}const g=new V;g.set(s.map((t=>t.screenPos)));const f=g.aabb;return{label:a,oob:g,minX:f.min.x,minY:f.min.y,maxX:f.max.x,maxY:f.max.y,distance:h}})),l=new Set;this.tree.clear();for(const t of h){const e=this.tree.search(t).find((e=>e.oob.overlaps(t.oob))),i=t.label instanceof $&&(this.distanceBehindDepthMesh(t.label)>d.Zc||t.label.distanceToCamera()>=d.GG),s=e||i,n=t.label.labelGroupId,o=n&&l.has(n),a=!(s||o&&n);t.label.setCollides(!a),a&&(this.tree.insert(t),n&&l.add(n))}}}var U;!function(t){t[t.ROOM=0]="ROOM",t[t.WALL=1]="WALL",t[t.HEIGHT_HIGH_PRIO=2]="HEIGHT_HIGH_PRIO",t[t.HEIGHT_LOW_PRIO=3]="HEIGHT_LOW_PRIO",t[t.PERIMETER=4]="PERIMETER"}(U||(U={}));class W{constructor(t,e,i,s,n,o){this.type=t,this.floorId=e,this.label=i,this.cameraData=s,this.parent=n,this.length=0,this.labelGroupId=null,this.collisionDetection=!0,this.labelVisible=!1,this.collides=!1,this.dimmed=!1,this.displayingTooltip=!1,this.fitsWall=!0,this.inScene=!1,this.label.setRenderOrder(L.X.labels),i.matrixAutoUpdate=!1,this.labelOpacityAnimation=new B.z(1,void 0,o),this.updateOpacityTarget(0)}dispose(){this.label.dispose(),this.parent.remove(this.label)}tickAnimations(t){this.labelOpacityAnimation.tick(t)}setVisible(t){t!==this.labelVisible&&(this.labelVisible=t,this.updateOpacityTarget())}setCollides(t){t!==this.collides&&(this.collides=t,this.updateOpacityTarget(t?0:d.JT))}setFitsWall(t){t!==this.fitsWall&&(this.fitsWall=t,this.updateOpacityTarget())}setDimmed(t){t!==this.dimmed&&(this.dimmed=t,this.updateOpacityTarget())}getDimmed(){return this.dimmed}setDisplayingTooltip(t){this.displayingTooltip=t,this.updateOpacityTarget()}getDisplayingTooltip(){return this.displayingTooltip}update(){this.updateOpacity()}getSize(){const t=this.label.text.split("\n"),e=t.reduce(((t,e)=>Math.max(t,e.length)),0),i=(0,F.yp)(e,0,0);return{width:i.width,height:i.height*t.length}}updateOpacity(){this.label.opacity=this.labelOpacityAnimation.value,this.label.opacity>.01?this.inScene||(this.parent.add(this.label),this.inScene=!0):this.inScene&&(this.parent.remove(this.label),this.inScene=!1)}updateOpacityTarget(t=d.JT){const e=this.dimmed&&!this.displayingTooltip?.5:1,i=this.labelVisible&&!this.collides&&this.fitsWall?e:0;this.labelOpacityAnimation.modifyAnimation(t>0?this.labelOpacityAnimation.value:i,i,t)}positionPriority(){const t=this.cameraData.pose.isProjectionOrtho.value,e=this.label;return 1-((t?Math.abs(e.position.y-this.cameraData.pose.position.y):this.cameraData.pose.position.distanceTo(e.position))-G.Bv.near)/(G.Bv.far-G.Bv.near)}}class z extends W{constructor(t,e,i,s,n,o,a){super(t,e,i,s,n,a),this.cameraData=s,this.labelHeightPx=o,this.start=new r.Vector3,this.end=new r.Vector3,this.width=.1,this.collisionDetection=!0,this.tempMidpoint=new r.Vector3,this.getLinePositions=(()=>{const t=new r.Vector3,e=new r.Vector3,i=new r.Vector3,s=new r.Vector3,n=new r.Vector3,o=new r.Vector3,a=new r.Vector3,h=new r.Vector2,l=new r.Vector2,d=new r.Vector2,c=new r.Vector2,u=new r.Vector2,p=new r.Vector2,m=new r.Vector2;return(r=this.start,f=this.end)=>{t.copy(r),e.copy(f),o.subVectors(e,t).normalize().applyAxisAngle(g.B1.UP,Math.PI/2);const v=(0,F.CW)(t,e,this.cameraData),y=(0,F.yp)(this.label.text.length),b=v.pixelDistance>y.width&&this.labelVisible;this.setFitsWall(b);const w=this.cameraData.isOrtho();i.addVectors(t,e).multiplyScalar(.5),(0,O.bz)(this.cameraData,r,l,a),(0,O.bz)(this.cameraData,f,d,a),(0,O.bz)(this.cameraData,i,c,a);const D=a.z;u.copy(c),s.addVectors(i,o),(0,O.bz)(this.cameraData,s,p,a);const S=m.subVectors(p,c),I=d.sub(l).normalize().rotateAround(H,Math.PI/2);w?I.copy(S).normalize():I.y>0&&I.multiplyScalar(-1);const T=this.labelHeightPx;let P=c.addScaledVector(I,T),E=(0,O.wc)(P.x,P.y,this.cameraData.width,this.cameraData.height,h),C=a.set(E.x,E.y,D),M=(0,O.Ft)(this.cameraData.pose,C,n);const x=M.distanceTo(i)/T,A=2+(w?this.width/2/x:0)+this.labelHeightPx/2;return P=u.addScaledVector(I,A),E=(0,O.wc)(P.x,P.y,this.cameraData.width,this.cameraData.height,h),C=a.set(E.x,E.y,D),M=(0,O.Ft)(this.cameraData.pose,C,n),{start:t,end:e,center:i,labelPosition:M,lineRotation:v.rotation,heightScale:x}}})(),i.matrixAutoUpdate=!1}distanceToCamera(){return this.getAnchorPoint(this.tempMidpoint).distanceTo(this.cameraData.pose.position)}getAnchorPoint(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}updateDimensions(t,e,i,s){this.start.copy(t),this.end.copy(e),this.width=i;const n=this.start.distanceTo(this.end);this.length=n;const o=(0,N.R5)(n,s);this.label.text=o}update(){super.update(),this.updateBillboard()}updateBillboard(){if(!this.labelVisible)return;const{labelPosition:t,lineRotation:e,heightScale:i}=this.getLinePositions(),{label:s}=this;s.setPosition(t),s.setOrientation(this.cameraData.pose.rotation,e);const n=i,o=this.label.unscaledHeight,a=this.labelHeightPx*n/o;s.scaleFactor=a,s.updateMatrix(),s.updateMatrixWorld()}}class j extends z{constructor(){super(...arguments),this.labelHeightFraction=.5,this.center=new r.Vector3,this.dir=new r.Vector3}updateDimensions(t,e,i,s){this.start.copy(t),this.end.copy(e),this.dir.subVectors(this.end,this.start),this.center.copy(this.start).addScaledVector(this.dir,this.labelHeightFraction),this.width=i;const n=this.start.distanceTo(this.end);this.length=n;const o=(0,N.R5)(n,s);this.label.text=`Max: ${o}`,this.label.setPosition(this.center)}update(){super.updateOpacity();const{position:t,rotation:e,projection:i}=this.cameraData.pose,{height:s}=this.cameraData,n=this.cameraData.isOrtho()?this.cameraData.zoom():1,o=this.cameraData.aspect();this.label.quaternion.copy(e);this.label.scaleBillboard(t,e,i,n,s,o,.1),this.label.updateMatrix(),this.label.updateMatrixWorld()}}class $ extends z{constructor(){super(...arguments),this.collisionDetection=!0,this._t1=new r.Vector3}isVertical(t,e){const i=Math.abs(t.y-e.y),s=Math.abs(t.x-e.x),n=Math.abs(t.z-e.z);return i>0&&s<1e-6&&n<1e-6}positionPriority(){const t=this.label;this._t1.copy(t.position);const e=(0,O.jn)(this._t1,this.cameraData.pose.position,this.cameraData.pose.rotation,this.cameraData.pose.projection.asThreeMatrix4());return 1-Math.sqrt(e.x*e.x+e.y*e.y)}}class X extends r.Mesh{raycast(t,e){}}class q extends r.Mesh{constructor(){super(...arguments),this.intersectionPriority=k.I.RoomLabels}raycast(t,e){this.visible&&super.raycast(t,e)}}var Y=i(23184),Q=i(81544),Z=i(31002),K=i(78079),J=i(44667),tt=i(94790),et=i(60043),it=i(64491),st=i(56147);var nt=i(13777);class ot extends r.Mesh{constructor(t=100,e,i,s=1){super(e,i),this.capacity=t,this.numInstances=s,this.topIdx=0,this.indexMap=new Map,this.viewMap=new Map,this.frustumCulled=!1,this.matrixAutoUpdate=!1}allocInstance(t){const e=this.topIdx;return this.topIdx++,this.topIdx>=this.capacity&&this.doubleBufferCapacities(),this.indexMap.set(t,e),this.viewMap.set(e,t),this.geometry.instanceCount=this.topIdx*this.numInstances,e}removeInstance(t){const e=this.indexMap.get(t);if(null!=e){const i=this.topIdx-1;this.moveInstanceData(i,e),this.indexMap.delete(t),this.viewMap.delete(e);const s=this.viewMap.get(i);null!=s&&(this.indexMap.set(s,e),this.viewMap.set(e,s)),this.topIdx--,this.geometry.instanceCount=this.topIdx*this.numInstances}}removeAllInstances(){this.topIdx=0,this.geometry.instanceCount=0,this.indexMap.clear(),this.viewMap.clear()}moveInstanceData(t,e){if(t!==e)for(const i of this.allAttributeNames){const s=this[i];if(s instanceof r.InstancedBufferAttribute){const i=s.itemSize;for(let n=0;n<this.numInstances;n++)for(let o=0;o<i;o++)s.array[i*(this.numInstances*e+n)+o]=s.array[i*(this.numInstances*t+n)+o];s.needsUpdate=!0}}}get allAttributeNames(){const t=[];for(const e in this)this[e]instanceof r.InstancedBufferAttribute&&t.push(e);return t}*getIndices(t){const e=this.indexMap.get(t);if(null!=e)for(let t=0;t<this.numInstances;t++)yield this.numInstances*e+t}get capacityForAllInstances(){return this.capacity*this.numInstances}doubleBufferCapacities(){this.capacity=2*this.capacity;const t=[];for(const e of this.allAttributeNames){const i=this[e];i instanceof r.InstancedBufferAttribute&&t.push([e,this.expandCapacityForAttr(i)])}this.geometry.dispose();for(const[e,i]of t)this[e]=i,this.geometry.setAttribute(e,i)}expandCapacityForAttr(t){const e=t.array instanceof Uint8Array,i=!!e,s=new(e?Uint8Array:Float32Array)(this.capacity*t.itemSize*this.numInstances);return s.set(t.array),new r.InstancedBufferAttribute(s,t.itemSize,i)}}class at extends ot{constructor(t=100){const e=new Float32Array([0,1,2,3,4,5,6,7,8,9]),i=new r.InstancedBufferGeometry;i.setAttribute("vertIndex",new r.Float32BufferAttribute(e,1)),i.setIndex([0,1,2,0,2,3,0,3,4,0,4,5,3,2,6,3,7,4,0,9,1,0,5,8]);super(t,i,new r.ShaderMaterial({uniforms:r.UniformsUtils.clone(b.zP.uniforms),vertexShader:b.zP.vertexShader,fragmentShader:b.zP.fragmentShader,transparent:!0,depthTest:!1,stencilRef:65535,stencilFuncMask:1<<h.j.OPENINGS,stencilFail:r.KeepStencilOp,stencilZFail:r.KeepStencilOp,stencilZPass:r.KeepStencilOp,stencilFunc:r.GreaterStencilFunc,stencilWrite:!0})),this.baseHeight=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("baseHeight",this.baseHeight),this.fromLeft=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("fromLeft",this.fromLeft),this.fromRight=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("fromRight",this.fromRight),this.toLeft=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("toLeft",this.toLeft),this.toRight=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("toRight",this.toRight),this.colorAndOpacity=new r.InstancedBufferAttribute(new Uint8Array(4*this.capacityForAllInstances),4,!0),this.geometry.setAttribute("colorAndOpacity",this.colorAndOpacity),this.outlineColorAttr=new r.InstancedBufferAttribute(new Uint8Array(3*this.capacityForAllInstances),3,!0),this.geometry.setAttribute("outlineColorAttr",this.outlineColorAttr),this.lineBiasedStartAndEnd=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("lineBiasedStartAndEnd",this.lineBiasedStartAndEnd),this.lineStartAndEnd=new r.InstancedBufferAttribute(new Float32Array(4*this.capacityForAllInstances),4),this.geometry.setAttribute("lineStartAndEnd",this.lineStartAndEnd),this.widthAttr=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("widthAttr",this.widthAttr),this.renderOrder=h.S.EDGE}setGeometryForInstance(t,e,i,s,n,o,a,r,h,l,d,c){for(const u of this.getIndices(t)){const{fromLeft:t,fromRight:p,toLeft:m,toRight:g}=c;this.baseHeight.setX(u,e),this.baseHeight.needsUpdate=!0,this.lineBiasedStartAndEnd.setXYZW(u,i,s,n,o),this.widthAttr.setX(u,a),this.lineBiasedStartAndEnd.needsUpdate=!0,this.widthAttr.needsUpdate=!0,this.lineStartAndEnd.setXYZW(u,r,h,l,d),this.lineStartAndEnd.needsUpdate=!0,this.fromLeft.setXYZW(u,t.primary.x,t.primary.z,t.bevel.x,t.bevel.z),this.fromRight.setXYZW(u,p.primary.x,p.primary.z,p.bevel.x,p.bevel.z),this.toLeft.setXYZW(u,m.primary.x,m.primary.z,m.bevel.x,m.bevel.z),this.toRight.setXYZW(u,g.primary.x,g.primary.z,g.bevel.x,g.bevel.z),this.fromLeft.needsUpdate=!0,this.fromRight.needsUpdate=!0,this.toLeft.needsUpdate=!0,this.toRight.needsUpdate=!0}}setOpacityForInstance(t,e){for(const i of this.getIndices(t))this.colorAndOpacity.setW(i,e),this.colorAndOpacity.needsUpdate=!0}setColorsForInstance(t,e,i){for(const s of this.getIndices(t))this.outlineColorAttr.setXYZ(s,e.r,e.g,e.b),this.colorAndOpacity.setXYZ(s,i.r,i.g,i.b),this.outlineColorAttr.needsUpdate=!0,this.colorAndOpacity.needsUpdate=!0}onRender(t,e){this.material.depthTest=1===t;const i=(1-t)*Number(e.roomWallsVisible);this.material.uniforms.globalOpacity.value=i}}class rt extends r.ShaderMaterial{constructor(){super({fragmentShader:b.p$.fragmentShader,vertexShader:b.p$.vertexShader,uniforms:r.UniformsUtils.clone(b.p$.uniforms),name:"HandleMaterial",transparent:!0,depthTest:!1})}}class ht extends ot{constructor(t=100){const e=new Float32Array([-1,0,-1,1,0,-1,1,0,1,-1,0,1]),i=new r.InstancedBufferGeometry;i.setAttribute("position",new r.Float32BufferAttribute(e,3)),i.setIndex([0,2,1,0,3,2]),super(t,i,new rt),this.renderOrder=h.S.NODE,this.radius=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("radius",this.radius),this.opacity=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("opacity",this.opacity),this.innerColor=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("innerColor",this.innerColor),this.outerColor=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("outerColor",this.outerColor),this.centerPosition=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("centerPosition",this.centerPosition)}setPositionForInstance(t,e){for(const i of this.getIndices(t))this.centerPosition.setXYZ(i,e.x,e.y,e.z),this.centerPosition.needsUpdate=!0}setOpacityForInstance(t,e){for(const i of this.getIndices(t))this.opacity.setX(i,e),this.opacity.needsUpdate=!0}setRadiusForInstance(t,e){for(const i of this.getIndices(t))this.radius.setX(i,e),this.radius.needsUpdate=!0}setColorsForInstance(t,e,i){for(const s of this.getIndices(t))this.outerColor.setXYZ(s,e.r,e.g,e.b),this.innerColor.setXYZ(s,i.r,i.g,i.b),this.outerColor.needsUpdate=!0,this.innerColor.needsUpdate=!0}onRender(t,e){this.visible=t<1;const i=(1-t)*Number(e.roomWallsVisible);this.material.uniforms.globalOpacity.value=i}}class lt extends r.ShaderMaterial{constructor(){super({fragmentShader:b.zs.fragmentShader,vertexShader:b.zs.vertexShader,uniforms:r.UniformsUtils.clone(b.zs.uniforms),name:"OpeningMaterial",depthTest:!1,transparent:!0,stencilFunc:r.AlwaysStencilFunc,stencilWrite:!1})}}class dt extends ot{constructor(t=100){const e=new Float32Array([-.5,0,-.5,.5,0,-.5,.5,0,.5,-.5,0,.5]),i=new r.InstancedBufferGeometry;i.setAttribute("position",new r.Float32BufferAttribute(e,3)),i.setIndex([0,2,1,0,3,2]),super(t,i,new lt),this.renderOrder=h.S.OPENING_LINES,this.rotationY=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("rotationY",this.rotationY),this.offset=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("offset",this.offset),this.scaleAttr=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("scaleAttr",this.scaleAttr),this.baseColor=new r.InstancedBufferAttribute(new Float32Array(3*this.capacityForAllInstances),3),this.geometry.setAttribute("baseColor",this.baseColor),this.isDoor=new r.InstancedBufferAttribute(new Uint8Array(this.capacityForAllInstances),1,!0),this.geometry.setAttribute("isDoor",this.isDoor)}setPositionForInstance(t,e){for(const i of this.getIndices(t))this.offset.setXYZ(i,e.x,e.y,e.z),this.offset.needsUpdate=!0}setScaleForInstance(t,e){for(const i of this.getIndices(t))this.scaleAttr.setXYZ(i,e.x,e.y,e.z),this.scaleAttr.needsUpdate=!0}setRotationForInstance(t,e){for(const i of this.getIndices(t))this.rotationY.setX(i,e),this.rotationY.needsUpdate=!0}setColorForInstance(t,e){for(const i of this.getIndices(t))this.baseColor.setXYZ(i,e.r,e.g,e.b),this.baseColor.needsUpdate=!0}setIsDoorForInstance(t,e){for(const i of this.getIndices(t))this.isDoor.setX(i,Number(e)),this.isDoor.needsUpdate=!0}onRender(t,e){this.visible=t<1&&e.roomWallsVisible;const i=(1-t)*Number(e.roomWallsVisible);this.material.uniforms.globalOpacity.value=i}}class ct extends dt{constructor(t=100){super(t),this.renderOrder=h.S.OPENING_STENCIL,this.material.colorWrite=!1,this.material.stencilRef=65535,this.material.stencilFuncMask=1<<h.j.OPENINGS,this.material.stencilWriteMask=1<<h.j.OPENINGS,this.material.stencilFail=r.ReplaceStencilOp,this.material.stencilZFail=r.ReplaceStencilOp,this.material.stencilZPass=r.ReplaceStencilOp,this.material.stencilFunc=r.AlwaysStencilFunc,this.material.stencilWrite=!0}}class ut extends ot{constructor(t=100){const e=new Float32Array([-1,0,-1,1,1,1,1,0]),i=new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0]),s=new r.InstancedBufferGeometry;s.setAttribute("offset",new r.Float32BufferAttribute(e,2)),s.setAttribute("normal",new r.Float32BufferAttribute(i,3)),s.setIndex([0,3,1,3,2,1]);super(t,s,new r.ShaderMaterial({uniforms:r.UniformsUtils.clone(b.OW.uniforms),vertexShader:b.OW.vertexShader,fragmentShader:b.OW.fragmentShader,side:r.DoubleSide,transparent:!0,depthTest:!1}),4),this.tip=new r.InstancedBufferAttribute(new Float32Array(2*this.capacityForAllInstances),2),this.geometry.setAttribute("tip",this.tip),this.normal=new r.InstancedBufferAttribute(new Float32Array(2*this.capacityForAllInstances),2),this.geometry.setAttribute("normal",this.normal),this.height=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("height",this.height),this.opacity=new r.InstancedBufferAttribute(new Float32Array(this.capacityForAllInstances),1),this.geometry.setAttribute("opacity",this.opacity),this.visibility=new r.InstancedBufferAttribute(new Uint8Array(this.capacityForAllInstances),1,!0),this.geometry.setAttribute("visibility",this.visibility),this.renderOrder=h.S.EDGE}updateStateForInstances(t,e){let i=0;for(const s of this.getIndices(t)){const t=e[i];this.tip.setXY(s,t.tip.x,t.tip.y),this.normal.setXY(s,t.normal.x,t.normal.y),this.height.setX(s,t.height),i++}this.tip.needsUpdate=!0,this.normal.needsUpdate=!0,this.height.needsUpdate=!0}setOpacityForInstances(t,e){for(const i of this.getIndices(t))this.opacity.setX(i,e);this.opacity.needsUpdate=!0}setVisibilityForInstances(t,e){for(const i of this.getIndices(t))this.visibility.setX(i,Number(e));this.visibility.needsUpdate=!0}onRender(t,e,i,s){this.material.uniforms.metersPerPx.value=t,this.material.uniforms.screenSize.value.set(e,i),this.material.uniforms.globalOpacity.value=1-s}}var pt=i(52030),mt=i(31036);class gt{constructor(t,e,i,s,n,o,a,h,l,d,c,u,p,m,g,f,v,y){this.readonly=t,this.data=e,this.scene=i,this.input=s,this.viewListener=n,this.isAdding=o,this.floorsViewData=a,this.cameraData=h,this.locale=l,this.settingsData=d,this.roomBoundsViewData=c,this.viewmodeData=u,this.sweepData=p,this.toolsData=m,this.rttModule=g,this.generatorSpreader=f,this.canHoverRoomLabels=v,this.onRoomLabelHover=y,this.lastCollisionTimestamp=0,this.rootObjects={},this.viewByFloor=new Map,this.roomByFloor=new Map,this.wallInstanceBuffers={},this.handleInstanceBuffers={},this.openingInstanceBuffers={},this.openingStencilInstanceBuffers={},this.caretsInstanceBuffers={},this.viewMap=new Map,this.nodeMap=new Map,this.roomMap=new Map,this.openingMap=new Map,this.visibleWallLabels=new Set,this.depthScene={},this.drawDepthToScreen=!1,this.hideCurrentFloorViews=()=>{if(this.prevFloorId){const t=this.rootObjects[this.prevFloorId],e=this.viewByFloor.get(this.prevFloorId);if(null!=e)for(const t of e)this.unregisterViewToInput(t);this.scene.remove(t)}},this.showCurrentFloorViews=()=>{if(this.currentFloorId){const t=this.rootObjects[this.currentFloorId];this.scene.add(t);const e=this.viewByFloor.get(this.currentFloorId);if(null!=e)for(const t of e)this.registerViewToInput(t)}},this.updateCurrentFloor=()=>{this.hideCurrentFloorViews(),this.showCurrentFloorViews()},this.updateOpeningView=(()=>{const t=new r.Vector3,e=new r.Vector3,i=new r.Vector3,s=new r.Vector3,n=new r.Vector3,o=new r.Vector3;return a=>{const r=this.data.getWall(a.wallId),h=this.baseHeightForFloor(r.floorId);o.set(0,h,0),r.getBiasAdjustmentVec(n),r.from.getVec3(i).add(n).add(o),r.to.getVec3(s).add(n).add(o),e.subVectors(s,i).normalize(),t.copy(i),t.lerp(s,a.relativePos),i.copy(t).addScaledVector(e,-.5*a.width),s.copy(t).addScaledVector(e,.5*a.width);const l=this.openingMap.get(a.id);if(!l)throw new Error("Unable to find view for opening while updating");l.onEdgePositionChanged(i,s,r.width,a.type)}})(),this.onMoveEnd=()=>{for(const t of this.data.rooms.values())this.updateRoomView(t,!0)},this.resizeDepthTextureIfNecessary=(()=>()=>{const t=this.depthTex.width,e=this.depthTex.height,i=this.cameraData.width,s=this.cameraData.height,n=Math.floor(.5*i),o=Math.floor(.5*s);e===o&&t===n||this.depthTex.setSize(n,o)})(),this.floorsViewData.floors.iterate((t=>{this.rootObjects[t.id]=new r.Object3D,this.depthScene[t.id]=new r.Scene;const e=new at;this.wallInstanceBuffers[t.id]=e,this.rootObjects[t.id].add(e);const i=new ht;this.handleInstanceBuffers[t.id]=i,this.rootObjects[t.id].add(i);const s=new dt;this.openingInstanceBuffers[t.id]=s,this.rootObjects[t.id].add(s);const n=new ct;this.openingStencilInstanceBuffers[t.id]=n,this.rootObjects[t.id].add(n);const o=new ut;this.caretsInstanceBuffers[t.id]=o,this.rootObjects[t.id].add(o),this.viewByFloor.set(t.id,new Set),this.roomByFloor.set(t.id,new Set)})),this.depthTex=this.rttModule.createRenderTarget2D(1024),this.depthTex.texture.type=r.HalfFloatType,this.depthTex.texture.format=r.RedFormat,this.depthTex.texture.internalFormat="R16F",this.depthTex.texture.magFilter=r.LinearFilter,this.depthTex.texture.minFilter=r.LinearFilter,this.currentFloorObservable=new mt.r((()=>{var t;const e=this.viewmodeData.isInside()&&(null===(t=this.sweepData.currentAlignedSweepObject)||void 0===t?void 0:t.floorId)||null;return this.floorsViewData.currentFloorNoTransitionObservable.value||e}),[t=>this.floorsViewData.currentFloorNoTransitionObservable.onChanged(t),t=>this.sweepData.onPropertyChanged("currentSweep",t),t=>this.viewmodeData.onChanged(t)]),this.bindings=[this.data.onWallsChanged({onRemoved:t=>this.removeViewForWall(t),onUpdated:t=>this.updateWallView(t),onChildUpdated:t=>this.updateWallView(t),onAdded:t=>this.makeWallView(t)}),this.data.onNodesChanged({onRemoved:t=>this.removeViewForNode(t),onUpdated:t=>this.updateNodeView(t),onChildUpdated:t=>this.updateNodeView(t),onAdded:t=>this.makeNodeView(t)}),this.data.onRoomsChanged({onRemoved:t=>this.removeViewForRoom(t),onUpdated:t=>this.updateRoomView(t,!1),onChildUpdated:t=>this.updateRoomView(t,!1),onAdded:t=>this.makeRoomView(t)}),this.data.onOpeningsChanged({onRemoved:t=>this.removeViewForOpening(t),onUpdated:t=>this.updateOpeningView(t),onChildUpdated:t=>this.updateOpeningView(t),onAdded:t=>this.makeOpeningView(t)}),this.data.afterFinalize(this.onMoveEnd),this.currentFloorObservable.onChanged((()=>{this.updateCurrentFloor()})),this.settingsData.onPropertyChanged(P.Y.UnitType,(t=>{for(const t of this.data.rooms.values())this.updateRoomViewText(t,!0);for(const t of this.data.walls.values())this.updateWallView(t)})),this.roomBoundsViewData.onChanged((()=>{for(const t of this.data.rooms.values())this.updateRoomViewText(t,!0)})),this.sweepData.onPropertyChanged("currentSweep",(()=>{for(const t of this.data.rooms.values())this.updateRoomViewSweep(t)})),this.viewmodeData.onChanged((()=>{for(const t of this.data.rooms.values())this.updateRoomViewSweep(t)})),this.toolsData.onPropertyChanged("activeToolName",(()=>{for(const t of this.data.rooms.values())this.updateRoomView(t,!0)}))],(0,it.C8)()||this.bindings.push(this.input.registerMeshHandler(Q.L,Y.f.isInstanceOf(q),((t,e)=>this.roomLabelHover(e,!0))),this.input.registerMeshHandler(Q.q,Y.f.isInstanceOf(q),((t,e)=>this.roomLabelHover(e,!1)))),this.bindings.push(this.input.registerMeshHandler(Z.rX,Y.f.isInstanceOf(q),((t,e)=>this.roomLabelClick(e)))),this.labelManager=new _(d.tryGetProperty("assetBasePath",""),l.languageCode,h,(()=>this.currentFloorId),(()=>this.visibleIdealizedDepthMeshes())),this.bindings.push(this.input.registerUnfilteredHandler(K.CD,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(Z.rX,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(J.s,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(tt.SK,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(tt._w,(()=>this.recalculateLabelVisibility())),this.input.registerUnfilteredHandler(et.k,(()=>this.recalculateLabelVisibility()))),this.bindings.forEach((t=>t.cancel())),this.updateCurrentFloor()}get currentFloorId(){return this.currentFloorObservable.value}get prevFloorId(){return this.currentFloorObservable.prevValue}init(){}render(t){var e,i,n,o,a;this.labelManager.tickAnimations(t);const r=this.cameraData.pose.pitchFactor(),h=this.viewmodeData.insideModeTransitionProgress(),l=this.currentFloorId;l&&(null===(e=this.wallInstanceBuffers[l])||void 0===e||e.onRender(r,this.roomBoundsViewData),null===(i=this.handleInstanceBuffers[l])||void 0===i||i.onRender(r,this.roomBoundsViewData),null===(n=this.openingInstanceBuffers[l])||void 0===n||n.onRender(r,this.roomBoundsViewData),null===(o=this.openingStencilInstanceBuffers[l])||void 0===o||o.onRender(r,this.roomBoundsViewData),null===(a=this.caretsInstanceBuffers[l])||void 0===a||a.onRender(this.cameraData.metersPerPx(),this.cameraData.width,this.cameraData.height,r));for(const e of this.currentFloorViews())e.onRender(r,h),e.tickAnimations(t);if(l){const t=this.depthScene[l];t&&(this.resizeDepthTextureIfNecessary(),this.rttModule.clearRenderTarget2D(this.depthTex,s.V.BLACK),this.rttModule.render(this.depthTex,t,this.scene.camera,void 0,!1),this.drawDepthToScreen&&this.rttModule.renderToScreen(this.depthTex))}}dispose(){}beforeRender(){this.labelManager.update(),performance.now()-this.lastCollisionTimestamp>d.kt&&!this.generatorSpreader.hasTask(d.wX)&&(this.recalculateRoomLabelCollisions(),this.lastCollisionTimestamp=performance.now()),this.updateRoomViews()}async activate(){const t=this;await this.generatorSpreader.enqueue("load-room-bound",function*(){yield;const e=t.readonly?0:1;let i=0;if(!t.readonly)for(const[s,n]of t.data.nodes)t.makeNodeView(n),i+=e,i>=50&&(i=0,yield);for(const[e,s]of t.data.walls)t.makeWallView(s),i+=3,i>=50&&(i=0,yield);for(const[e,s]of t.data.rooms)t.makeRoomView(s),i+=20,i>=50&&(i=0,yield);for(const[e,s]of t.data.wallOpenings)t.makeOpeningView(s),i+=2,i>=50&&(i=0,yield)}(),void 0,!0),this.bindings.forEach((t=>t.renew())),this.updateCurrentFloor()}deactivate(){this.bindings.forEach((t=>t.cancel()));for(const t in this.rootObjects){const e=this.rootObjects[t];this.scene.remove(e);for(const t of e.children.slice())t instanceof l.r&&t.dispose(),e.remove(t);this.wallInstanceBuffers[t].removeAllInstances(),this.handleInstanceBuffers[t].removeAllInstances(),this.openingInstanceBuffers[t].removeAllInstances(),this.openingStencilInstanceBuffers[t].removeAllInstances(),this.caretsInstanceBuffers[t].removeAllInstances();const i=this.viewByFloor.get(t);if(i)for(const t of i)this.unregisterViewToInput(t)}for(const[t,e]of this.viewByFloor.entries())e.clear();for(const[t,e]of this.roomByFloor.entries())e.clear()}updateRoomViews(){for(const t of this.currentFloorViews(!0))t.beforeRender()}registerViewToInput(...t){for(const e of t)this.currentFloorId===e.floorId&&this.input.registerMesh(e,!1)}unregisterViewToInput(...t){for(const e of t)this.input.unregisterMesh(e)}makeNodeView(t){var e;const i=new C(t.id,t.floorId,this.cameraData,this.handleInstanceBuffers[t.floorId]),s=this.baseHeightForFloor(t.floorId);i.updatePosition(new r.Vector3(t.x,s,t.z)),this.nodeMap.set(t.id,i),i.fullyInitialized=!0,null===(e=this.viewByFloor.get(t.floorId))||void 0===e||e.add(i),this.registerViewToInput(i),this.viewListener.addView(i,t.id)}updateNodeView(t){const e=this.nodeMap.get(t.id);if(e){const i=this.baseHeightForFloor(t.floorId);e.updatePosition(new r.Vector3(t.x,i,t.z))}}removeViewForNode(t){var e;const i=this.nodeMap.get(t.id);i&&(null===(e=this.viewByFloor.get(t.floorId))||void 0===e||e.delete(i),i.fullyInitialized=!1,this.nodeMap.delete(t.id),i.dispose(),this.unregisterViewToInput(i),this.viewListener.removeView(t.id))}makeWallView(t){var e;const i=this.wallInstanceBuffers[t.floorId],s=this.labelManager.createWallLabel(t.floorId,this.rootObjects[t.floorId]);s.updateDimensions(t.from.getVec3(),t.to.getVec3(),t.width,this.getUnits());const n=new m(t.id,t.floorId,this.cameraData,i,s,this.isAdding);this.viewMap.set(t.id,n),null===(e=this.viewByFloor.get(t.floorId))||void 0===e||e.add(n),this.updateWallView(t),s.update(),n.fullyInitialized=!0,this.registerViewToInput(n),this.viewListener.addView(n,t.id)}updateWallView(t){const e=this.viewMap.get(t.id);if(e){const i=this.baseHeightForFloor(t.floorId);e.onEdgePositionChanged(this.data,i,this.getUnits())}}removeViewForWall(t){var e;const i=this.viewMap.get(t.id);i&&(this.labelManager.deleteLabel(i.lineLabel),this.viewMap.delete(t.id),this.visibleWallLabels.delete(i),null===(e=this.viewByFloor.get(t.floorId))||void 0===e||e.delete(i),i.dispose(),i.fullyInitialized=!1,this.unregisterViewToInput(i),this.viewListener.removeView(t.id))}makeRoomView(t){var e,i;const s=this.rootObjects[t.floorId],n=this.depthScene[t.floorId],o=this.caretsInstanceBuffers[t.floorId];this.roomMap.has(t.id)&&this.removeViewForRoom(t);const a=this.baseHeightForFloor(t.floorId),r=new M.y(t,t.floorId,a,this.cameraData,this.depthTex,this.roomBoundsViewData,this.labelManager,this.getUnits(),(t=>this.medianSweepHeightForRoom(t)||this.baseHeightForFloor(t.floorId)),o);s.add(r),n.add(r.extrusionMesh),null===(e=this.viewByFloor.get(t.floorId))||void 0===e||e.add(r),null===(i=this.roomByFloor.get(t.floorId))||void 0===i||i.add(r),r.fullyInitialized=!0,this.roomMap.set(t.id,r),this.registerViewToInput(r),this.updateRoomView(t,!0),this.viewListener.addView(r,t.id)}updateRoomViewText(t,e){const i=this.roomMap.get(t.id);if(!i)throw new Error("Unable to find view for room while updating.");i.updateUnits(this.getUnits());const s=this.data.getPotentialRoomCanvasLabels(t.id,this.locale.t(st.A.SHOWCASE.ROOMS.DEFAULT_NAME),this.getUnits(),this.roomBoundsViewData.roomNamesVisible,this.roomBoundsViewData.roomDimensionsVisible);i.updateText(s,e)}updateRoomView(t,e){const i=this.roomMap.get(t.id);if(!i)throw new Error("Unable to find view for room while updating.");this.updateRoomViewText(t,e),i.updateGeo(t),i.beforeRender(),this.updateRoomViewSweep(t)}updateRoomViewSweep(t){const e=this.roomMap.get(t.id);if(!e)throw new Error("Unable to find view for room while updating.");const i=this.sweepData.currentAlignedSweepObject,s=!!i&&i.floorId===t.floorId&&t.containsPoint(i.floorPosition.x,i.floorPosition.z),n=this.settingsData.tryGetProperty(pt.VS,!1)&&s&&this.viewmodeData.insideModeTransitionProgress()>0;e.setIsInside(n)}removeViewForRoom(t){var e,i;const s=this.roomMap.get(t.id);if(!s)throw new Error("Unable to find view for room while deleting.");this.rootObjects[t.floorId].remove(s),this.depthScene[t.floorId].remove(s.extrusionMesh),s.fullyInitialized=!1,null===(e=this.viewByFloor.get(t.floorId))||void 0===e||e.delete(s),null===(i=this.roomByFloor.get(t.floorId))||void 0===i||i.delete(s),this.roomMap.delete(t.id),s.dispose(),this.input.unregisterMesh(s),this.viewListener.removeView(t.id)}makeOpeningView(t){const e=this.data.getWall(t.wallId),i=new D(t.id,e.floorId,this.cameraData,this.roomBoundsViewData,this.handleInstanceBuffers[e.floorId],this.openingInstanceBuffers[e.floorId],this.openingStencilInstanceBuffers[e.floorId]);i.fullyInitialized=!0,i.startHandle.fullyInitialized=!0,i.endHandle.fullyInitialized=!0;const s=this.viewByFloor.get(t.floorId);null!=s&&(s.add(i),s.add(i.startHandle),s.add(i.endHandle)),this.openingMap.set(t.id,i),this.registerViewToInput(i),i.startHandle&&this.registerViewToInput(i.startHandle),i.endHandle&&this.registerViewToInput(i.endHandle);for(const e of[i,i.startHandle,i.endHandle])this.viewListener.addView(e,t.id);this.updateOpeningView(t)}removeViewForOpening(t){const e=this.openingMap.get(t.id);if(!e)throw new Error("Unable to find view for opening while deleting.");e.fullyInitialized=!1,e.startHandle.fullyInitialized=!1,e.endHandle.fullyInitialized=!1;const i=this.viewByFloor.get(t.floorId);null!=i&&(i.delete(e),i.delete(e.startHandle),i.delete(e.endHandle)),this.openingMap.delete(t.id),e.dispose(),this.unregisterViewToInput(e),this.unregisterViewToInput(e.startHandle),this.unregisterViewToInput(e.endHandle),this.viewListener.removeView(t.id)}isInsideMode(){return this.viewmodeData.isInside()}roomLabelHover(t,e){if(this.isInsideMode()||!this.canHoverRoomLabels())return;const i=t.userData.roomId,s=this.roomMap.get(i);s&&s instanceof M.y&&(s.hoverRoomLabel(e),this.onRoomLabelHover(e))}roomLabelClick(t){return!(!this.isInsideMode()&&this.canHoverRoomLabels())}getUnits(){return this.settingsData.tryGetProperty(P.Y.UnitType,E.t.IMPERIAL)}baseHeightForFloor(t){var e;return(null===(e=this.floorsViewData.floors.getFloor(t))||void 0===e?void 0:e.medianSweepFloorHeight())||0}medianSweepHeightForRoom(t){const e=[];for(const i of this.sweepData.sweeps())if(i.floorId===t.floorId&&t.containsPoint(i.floorPosition.x,i.floorPosition.z)&&e.push(i.floorPosition.y),e.length>=5)break;if(e.length>0){const t=e.sort(((t,e)=>t-e));return t[Math.floor(t.length/2)]}return null}recalculateLabelVisibility(){this.labelManager.needsImmediateCollsisionDetection(),this.recalculateRoomLabelCollisions()}recalculateRoomLabelCollisions(){const t=function*(t){yield;let e=0;for(const i of t.values())i.updateRoomLabelPositionAndText(!1),e++,e>=10&&(e=0,yield)}(this.roomMap);this.generatorSpreader.enqueue(d.wX,t,nt.Gq.BACKGROUND)}*currentFloorViews(t=!1){const e=t?this.roomByFloor:this.viewByFloor,i=null!=this.currentFloorId?e.get(this.currentFloorId):null;if(i)for(const t of null==i?void 0:i.values())yield t}visibleIdealizedDepthMeshes(){const t=[];if(null!=this.currentFloorId){const e=this.depthScene[this.currentFloorId];if(e.children.length>0)for(const i of e.children)i.visible&&i instanceof r.Mesh&&t.push(i)}return t}toggleDepthDebugView(){this.drawDepthToScreen=!this.drawDepthToScreen}}var ft=i(75578),vt=i(4298),yt=i(45832),bt=i(39209),wt=i(20599),Dt=i(25316),St=i(68387),It=i(99583),Tt=i(62372),Pt=i(96319),Et=i(35699),Ct=i(77510),Mt=i(6539);class xt extends ft.n{constructor(){super(...arguments),this.name="room-bound-renderer"}async init(t,e){this.engine=e,[this.data,this.renderer,this.input,this.floorsViewData,this.cameraData,this.locale,this.settingsData,this.roomBoundViewData,this.viewmodeData,this.sweepData,this.toolsData,this.rttModule]=await Promise.all([e.market.waitForData(vt.A),e.getModuleBySymbol(yt.M7),e.getModuleBySymbol(yt.mL),e.market.waitForData(bt.X),e.market.waitForData(wt.M),e.getModuleBySymbol(yt.gS),e.market.waitForData(Dt.o),e.market.waitForData(St.B),e.market.waitForData(It.X),e.market.waitForData(Tt.A),e.market.waitForData(Pt.M),e.getModuleBySymbol(yt.kM)]),e.getModuleBySymbol(Mt.ZF).then((t=>{t.getSettingsGui().loadPromise.then((()=>{t.getSettingsGui().addButton(0,"Debug","Toggle Room Depth",(()=>{var t;null===(t=this.roomBoundRenderer)||void 0===t||t.toggleDepthDebugView()}))}))}))}async dispose(t){this.roomBoundRenderer&&this.engine.removeComponent(this,this.roomBoundRenderer)}async startRendering(t,e,i,s){if(this.roomBoundRenderer)throw new Error("Already rendering!!");this.roomBoundRenderer=new gt(t,this.data,this.renderer.getScene(),this.input,e,i,this.floorsViewData,this.cameraData,this.locale,this.settingsData,this.roomBoundViewData,this.viewmodeData,this.sweepData,this.toolsData,this.rttModule,this.engine.generatorSpreader,s,(t=>{t?this.engine.commandBinder.issueCommand(new Et.X(Ct.b.FINGER)):this.engine.commandBinder.issueCommand(new Et.X(Ct.b.DEFAULT))})),await this.engine.addComponent(this,this.roomBoundRenderer)}async stopRendering(){if(!this.roomBoundRenderer)throw new Error("Not rendering!");this.engine.removeComponent(this,this.roomBoundRenderer),this.roomBoundRenderer.dispose(),this.roomBoundRenderer=null}}},60552:(t,e,i)=>{"use strict";i.d(e,{Dh:()=>d,FY:()=>o,GG:()=>g,IS:()=>h,JT:()=>r,Zc:()=>m,jd:()=>l,kt:()=>c,m7:()=>s,rH:()=>p,ub:()=>n,wX:()=>u,xX:()=>a});const s=.06,n=7,o=.1,a=.02,r=100,h=8,l=500,d=.9,c=1e3,u="room-label-collision",p=300,m=.1,g=20},87708:(t,e,i)=>{"use strict";i.d(e,{OW:()=>F,Om:()=>O,Tx:()=>B,p$:()=>A,zP:()=>R,zs:()=>L});var s=i(38069),n=i(68909),o=i(32686),a=i.n(o),r=i(47876),h=i.n(r),l=i(82312),d=i.n(l),c=i(93854),u=i.n(c),p=i(63380),m=i.n(p),g=i(1834),f=i.n(g),v=i(66083),y=i.n(v),b=i(4605),w=i.n(b),D=i(69555),S=i.n(D),I=i(17709),T=i.n(I),P=i(12201),E=i.n(P),C=i(76539),M=i.n(C),x=i(40160);const A={uniforms:{outlinePct:{value:.8},globalOpacity:{value:0}},vertexShader:a(),fragmentShader:h()},R={uniforms:{selectedWidth:{value:.03},globalOpacity:{value:0}},vertexShader:d(),fragmentShader:u()},L={uniforms:{globalOpacity:{value:0}},vertexShader:m(),fragmentShader:f()},O={uniforms:{opacity:{value:1},centerSpacing:{value:24},radius:{value:4},color:{value:s.V.LENS_GRAY}},vertexShader:y(),fragmentShader:w()},F={uniforms:{color:{type:"v4",value:s.V.WHITE},globalOpacity:{type:"f",value:0},outline:{value:1},outlineColor:{value:s.V.BLACK},screenSize:{value:new n.Vector2},tipPaddingPx:{value:2},widthPx:{value:12},heightPx:{value:6},aaPaddingPx:{value:2},metersPerPx:{value:.01},autoScale:{value:1}},vertexShader:S(),fragmentShader:T()},B={uniforms:{maxDistance:{value:x.sv}},vertexShader:E(),fragmentShader:M()}},9859:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>tt});var s=i(75578),n=i(27947),o=i(22585),a=i(25316),r=i(45832),h=i(56208),l=i(4298),d=i(73566),c=i(96319),u=i(3066),p=i(68986);class m{constructor(t){this.map=new Map,t.forEach((t=>this.map.set(t.state,t.subs)))}renew(t){(this.map.get(t)||[]).forEach((t=>t.renew()))}cancel(t){if(t){(this.map.get(t)||[]).forEach((t=>t.cancel()))}else this.map.forEach((t=>t.forEach((t=>t.cancel()))))}update(t,e){this.map.set(t,e)}}var g=i(89928),f=i(31002),v=i(81544),y=i(89505),b=i(3694),w=i(22937),D=i(23184),S=i(64491),I=i(39417),T=i(85616),P=i(95330),E=i(89103),C=i(10843),M=i(52018);const x=new C.Ay("editor");var A,R;!function(t){t.DragAndDropBase=class{subscribe(t,e){return this.events.subscribe(t,e)}constructor(t=new s,e){this.state=t,this.eventConstructors=e,this.events=new I.Q,this.bindings=[],this.validator=null,this.state.commit(),this.bindings.push(this.state.onPropertyChanged("toolState",(()=>{x.debug("toolState:",{from:this.state.previousToolState,to:this.state.toolState},this.state),this.events.broadcast(new i.StateChange(this.state.toolState,this.state.previousToolState))})),this.onSelectedChanged(((t,i)=>{this.events.broadcast(new e.SelectChange(t,i))})),this.onHoveredChanged(((t,e)=>{this.events.broadcast(new i.HoverChange(t,e))})),this.state.onCurrentIdChanged(((t,i)=>{this.events.broadcast(new e.CurrentChange(t,i))}))),this.bindings.forEach((t=>t.cancel()))}setState(t){t!==this.state.toolState&&(this.state.previousToolState=this.state.toolState,this.state.toolState=t,this.state.commit())}start(){const{toolState:t}=this.state;if(t!==e.CLOSED)throw new n("Editor already started");this.bindings.forEach((t=>t.renew())),this.setState(e.IDLE),this.events.broadcast(new i.Start)}setEnabled(t){if(this.state.toolState===e.CLOSED)throw new n("Editor not started");if(t)this.state.toolState===e.DISABLED&&this.setState(e.IDLE);else switch(this.state.toolState){case e.DISABLED:break;case e.IDLE:this.setState(e.DISABLED);break;default:this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard(),this.setState(e.DISABLED)}}exit(){this.state.toolState!==e.CLOSED&&(this.state.toolState!==e.DISABLED&&(this.unhover({commit:!1}),this.deselect({commit:!1}),this.discard()),this.setState(e.CLOSED),this.bindings.forEach((t=>t.cancel())),this.events.broadcast(new i.Exit))}setValidator(t){this.validator=t}onDiscard(t){this.state.onBeforeDiscard=t||null}internalEdit(t){if(this.assertActive(),null!==this.state.pendingEdit)throw x.error(`Trying to edit asset ${t}, but currently editing ${this.state.pendingEdit}`),new n("Edit in progress");this.state.pendingEdit=t,this.setState(e.EDITING),this.events.broadcast(new this.eventConstructors.EditStart(t,!1))}waitForAdd(){if(this.assertActive(),null!==this.state.pendingAdd)throw x.error(`Entering wait for add state, but already adding ${this.state.pendingAdd}`),new n("Add in progress");null!==this.state.selected&&(x.debug(`Entering the wait for add state, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.events.broadcast(new i.WaitForAddStart),this.setState(e.WAIT_FOR_ADD)}internalAdd(t){if(this.assertActive(),null!==this.state.pendingAdd)throw x.error(`Trying to add new asset ${t}, but already adding ${this.state.pendingAdd}`),new n("Add in progress");null!==this.state.selected&&(x.debug(`Add ${t} called, deselecting previous ${this.state.selected}`),this.deselect({commit:!1})),this.state.pendingAdd=t,this.events.broadcast(new this.eventConstructors.AddStart(t)),this.setState(e.ADDING)}internalPlace(t){this.assertActive();const{pendingAdd:i,pendingEdit:s}=this.state,n=i||s;n&&t===n||(this.state.pendingEdit=t),this.setState(e.PLACING),this.events.broadcast(new this.eventConstructors.EditStart(t,!0))}move(t){this.assertActive(),this.validate(t);const{pendingAdd:e,pendingEdit:i,selected:s}=this.state,n=e||i||s;n&&this.events.broadcast(new this.eventConstructors.Move(n,t)),this.state.ndcPosition.value=t.clientPosition}highlight(...t){this.assertActive();for(const e of t)this.state.highlighted.add(e),this.events.broadcast(new i.HighlightAdd(e))}clearHighlight(...t){this.assertActive();for(const e of t)this.state.highlighted.delete(e),this.events.broadcast(new i.HighlightClear(e))}clearAllHighlights(){this.assertActive();for(const t of this.state.highlighted)this.events.broadcast(new i.HighlightClear(t));this.state.highlighted.clear()}dim(t){this.assertActive(),this.state.dimmed.add(t),this.events.broadcast(new i.DimAdd(t))}clearDim(t){this.assertActive(),this.state.dimmed.delete(t),this.events.broadcast(new i.DimClear(t))}clearAllDims(){this.assertActive();for(const t of this.state.dimmed)this.events.broadcast(new i.DimClear(t));this.state.dimmed.clear()}internalSelect(t,i){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||(this.state.previousSelected=this.state.selected,this.state.selected=t,this.state.commit(),i&&i.transitionTo?this.setState(i.transitionTo):this.setState(e.SELECTED))}deselect(t={commit:!0}){this.assertActive(),this.state.pendingAdd||this.state.pendingEdit||null!==this.state.selected&&(this.state.previousSelected=this.state.selected,this.state.selected=null,t.commit&&this.state.commit(),t&&t.transitionTo?this.setState(t.transitionTo):this.setState(e.IDLE))}hover(t){this.assertActive(),t!==this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=t,this.state.commit())}unhover(t={commit:!0}){this.state.hovered&&(this.state.previousHovered=this.state.hovered,this.state.hovered=null,t.commit&&this.state.commit())}tryCommit(){this.assertActive();const t=this.state.pendingAdd,e=this.state.pendingEdit;if(!1===this.state.pendingValid)return x.warn("nop, pendingValid",this.state.pendingValid),!1;let i=!1;const s=this.state.selected,n=this.state.pendingAdd||this.state.pendingEdit;if(n){const o=null===this.state.pendingValid||!0===this.state.pendingValid;o&&(this.state.pendingAdd=null,this.state.pendingEdit=null,this.state.pendingValid=null,this.state.onBeforeDiscard=null,e&&this.events.broadcast(new this.eventConstructors.EditConfirm(e)),t&&this.events.broadcast(new this.eventConstructors.AddConfirm(t)),this.state.pendingAdd||this.state.pendingEdit||s!==this.state.selected||this.internalSelect(n)),i=o}return i}discard(){const t=this.state.pendingAdd||this.state.pendingEdit,i=this.state.pendingAdd,s=this.state.pendingEdit;t&&(this.state.onBeforeDiscard&&this.state.onBeforeDiscard(),s&&(this.state.pendingEdit=null,this.events.broadcast(new this.eventConstructors.EditDiscard(s))),i&&(this.state.pendingAdd=null,this.events.broadcast(new this.eventConstructors.AddDiscard(i))),this.events.broadcast(new this.eventConstructors.ValidChange(null,null)),this.state.pendingValid=null,this.state.onBeforeDiscard=null),this.unhover({commit:!1}),this.deselect({commit:!1}),this.state.toolState!==e.IDLE&&this.setState(e.IDLE),this.state.commit()}validate(t){const e=this.state.pendingAdd||this.state.pendingEdit||this.state.selected;if(e){const i=this.state.pendingValid;let s=!0;this.validator?(s=this.validator.validate(e,t),this.state.pendingValid=s):this.state.pendingValid=null,null!==this.state.pendingValid&&i!==this.state.pendingValid&&this.events.broadcast(new this.eventConstructors.ValidChange(s?e:null,s?null:e))}}assertActive(){if(this.state.toolState===t.ToolState.CLOSED)throw new n("Editor closed");if(this.state.toolState===t.ToolState.DISABLED)throw new n("Editor disabled")}onSelectedChanged(t){return this.state.onPropertyChanged("selected",(()=>t(this.state.selected,this.state.previousSelected)))}onHoveredChanged(t){return this.state.onPropertyChanged("hovered",(()=>t(this.state.hovered,this.state.previousHovered)))}};let e,i;t.EventConstructors=class{constructor(t,e,i,s,n,o,a,r,h,l,d){this.AddStart=t,this.EditStart=e,this.AddConfirm=i,this.AddDiscard=s,this.EditConfirm=n,this.EditDiscard=o,this.Delete=a,this.Move=r,this.CurrentChange=h,this.SelectChange=l,this.ValidChange=d}},function(t){t.CLOSED="CLOSED",t.DISABLED="DISABLED",t.IDLE="IDLE",t.SELECTED="SELECTED",t.WAIT_FOR_ADD="WAIT_FOR_ADD",t.ADDING="ADDING",t.EDITING="EDITING",t.PLACING="PLACING"}(e=t.ToolState||(t.ToolState={}));class s extends T.v{constructor(){super(...arguments),this.toolState=e.CLOSED,this.previousToolState=e.CLOSED,this.pendingAdd=null,this.pendingEdit=null,this.selected=null,this.previousSelected=null,this.hovered=null,this.previousHovered=null,this.highlighted=new Set,this.dimmed=new Set,this.ndcPosition=new P.L(null),this.onBeforeDiscard=null,this.pendingValid=null}get currentId(){return this.pendingAdd||this.pendingEdit||this.selected||null}onCurrentIdChanged(t,e=!1){let i=this.currentId;const s=()=>{this.currentId!==i&&(t(this.currentId,i),i=this.currentId)},n=new p.P(this.onPropertyChanged("selected",s),this.onPropertyChanged("pendingAdd",s),this.onPropertyChanged("pendingEdit",s));return e?n.renew():n.cancel(),n}}t.BaseState=s;class n extends M.t{constructor(t="invalid state"){super(t),this.name="invalid state"}}t.EditorException=n,function(t){class e extends E.QB{}e.type="edit",t.EditEvent=e;class i extends e{constructor(t){super(),this.target=t}}i.type="editt",t.BaseEditTarget=i;class s extends e{constructor(t,e){super(),this.target=t,this.previous=e}}s.type="edittp",t.BaseEditTargetAndPrev=s;class n extends e{constructor(t,e){super(),this.target=t,this.previous=e}}n.type="toolchange",t.StateChange=n;class o extends e{}o.type="editorstart",t.Start=o;class a extends e{}a.type="editorexit",t.Exit=a;class r extends e{}r.type="waitforaddstart",t.WaitForAddStart=r;class h extends i{}h.type="addstart",t.BaseAddStart=h;class l extends i{constructor(t,e){super(t),this.placeOnly=e}}l.type="editstart",t.BaseEditStart=l;class d extends i{}d.type="addconfirm",t.BaseAddConfirm=d;class c extends i{}c.type="adddiscard",t.BaseAddDiscard=c;class u extends i{}u.type="editconfirm",t.BaseEditConfirm=u;class p extends i{}p.type="editdiscard",t.BaseEditDiscard=p;class m extends i{}m.type="delete",t.BaseDelete=m;class g extends i{constructor(t,e){super(t),this.target=t,this.ev=e}}g.type="move",t.BaseMove=g;class f extends s{}f.type="target",t.BaseCurrentChange=f;class v extends s{}v.type="hover",t.HoverChange=v;class y extends s{}y.type="select",t.BaseSelectChange=y;class b extends i{}b.type="highlight",t.HighlightAdd=b;class w extends i{}w.type="highlightclear",t.HighlightClear=w;class D extends i{}D.type="dim",t.DimAdd=D;class S extends i{}S.type="dimclear",t.DimClear=S;class I extends s{}I.type="valid",t.BaseValidChange=I,t.hasTarget=function(t){return t instanceof i},t.hasTargetAndPrev=function(t){return t instanceof s}}(i=t.Events||(t.Events={}))}(A||(A={})),function(t){class e extends A.DragAndDropBase{constructor(t=new i){super(t,new A.EventConstructors(s.AddStart,s.EditStart,s.AddConfirm,s.AddDiscard,s.EditConfirm,s.EditDiscard,s.Delete,s.Move,s.CurrentChange,s.SelectChange,s.ValidChange)),this.state=t}add(t){this.internalAdd(t)}edit(t){this.internalEdit(t)}place(t){this.internalPlace(t)}select(t,e){this.internalSelect(t,e)}toggleSelect(t){this.state.selected===t?this.deselect():this.select(t)}}t.DragAndDrop=e;class i extends A.BaseState{}let s;t.State=i,function(t){class e extends A.Events.BaseAddStart{}t.AddStart=e;class i extends A.Events.BaseEditStart{}t.EditStart=i;class s extends A.Events.BaseAddConfirm{}t.AddConfirm=s;class n extends A.Events.BaseAddDiscard{}t.AddDiscard=n;class o extends A.Events.BaseEditConfirm{}t.EditConfirm=o;class a extends A.Events.BaseEditDiscard{}t.EditDiscard=a;class r extends A.Events.BaseDelete{}t.Delete=r;class h extends A.Events.BaseMove{}t.Move=h;class l extends A.Events.BaseCurrentChange{}t.CurrentChange=l;class d extends A.Events.BaseSelectChange{}t.SelectChange=d;class c extends A.Events.BaseValidChange{}t.ValidChange=c}(s=t.Events||(t.Events={}))}(R||(R={}));var L=i(35699),O=i(77510);const F=new C.Ay("room-bounds-editor");class B extends R.DragAndDrop{constructor(t,e,i,s){super(new R.State),this.messageBus=t,this.commandBinder=e,this.input=i,this.isRoomHoverAllowed=s,this.allViewsComparator=D.f.is((t=>t instanceof y.y)),this.subscribe(A.Events.StateChange,(async({target:t})=>{this.inputStates||(this.inputStates=this.bindInputToEditorStates()),this.inputStates.cancel(),this.inputStates.renew(t)}))}bindInputToEditorStates(){const t=()=>{this.setEnabled(!1),this.commandBinder.issueCommand(new L.X(O.b.DEFAULT))},e=()=>this.setEnabled(!0),i=new p.P((0,u.Sh)((()=>this.messageBus.subscribe(w.zM,t)),(()=>this.messageBus.unsubscribe(w.zM,t)),!1),(0,u.Sh)((()=>this.messageBus.subscribe(w.pT,e)),(()=>this.messageBus.unsubscribe(w.pT,e)),!1),this.isRoomHoverAllowed.onChanged((i=>{i?e():t()}))),s=(0,S.C8)()?new p.P:new p.P(this.input.registerMeshHandler(v.L,this.allViewsComparator,((t,e)=>{this.hover(e.roomBoundsId),this.commandBinder.issueCommand(new L.X(O.b.FINGER))})),this.input.registerMeshHandler(v.q,this.allViewsComparator,(()=>{this.unhover(),this.commandBinder.issueCommand(new L.X(O.b.DEFAULT))})));s.cancel();const n=new p.P(this.input.registerMeshHandler(f.rX,this.allViewsComparator,this.onToggleSelectInput.bind(this)));n.cancel();const o=[this.input.registerMeshHandler(f.rX,D.f.isType(b.W),(t=>!!this.state.selected&&(this.discard(),t.preventDefault(),!0)))],a=new p.P(...o);a.cancel();const r=this.messageBus.subscribe(g.G,(()=>this.discard())),h=new p.P(i,s,n,a,r,(t=>{const e=F.debug;return(0,u.Sh)((()=>e(`${t}.renew()`)),(()=>e(`${t}.cancel()`)),!1)})("ToolState.SELECTED || ToolState.IDLE -> bindings"));return new m([{state:A.ToolState.DISABLED,subs:[i]},{state:A.ToolState.SELECTED,subs:[h]},{state:A.ToolState.IDLE,subs:[h]}])}onToggleSelectInput(t,e){const i=e.roomBoundsId,s=this.state.selected===i;return i&&setTimeout((()=>{e.parent&&(s?t instanceof f.rX&&(this.discard(),this.deselect()):(this.select(i),this.hover(i)))}),0),!s}}var V,N,k=i(88186),G=i(98720);!function(t){class e extends A.DragAndDropBase{constructor(t=new i){super(t,new A.EventConstructors(s.AddStart,s.EditStart,s.AddConfirm,s.AddDiscard,s.EditConfirm,s.EditDiscard,s.Delete,s.Move,s.CurrentChange,s.SelectChange,s.ValidChange)),this.state=t}add(t){this.internalAdd(new Set(t))}edit(t){this.internalEdit(new Set(t))}place(t){this.internalPlace(new Set(t))}select(t,e){const i=(null==e?void 0:e.addToExistingSelection)&&this.state.selected?Array.from(this.state.selected.keys()).concat(t):t;this.internalSelect(new Set(i),e)}toggleSelect(t){var e;const i=new Set(null===(e=this.state.selected)||void 0===e?void 0:e.keys());for(const e of t)i.has(e)?i.delete(e):i.add(e);this.internalSelect(i)}}t.DragAndDrop=e;class i extends A.BaseState{}let s;t.State=i,function(t){class e extends A.Events.BaseAddStart{}t.AddStart=e;class i extends A.Events.BaseEditStart{}t.EditStart=i;class s extends A.Events.BaseAddConfirm{}t.AddConfirm=s;class n extends A.Events.BaseAddDiscard{}t.AddDiscard=n;class o extends A.Events.BaseEditConfirm{}t.EditConfirm=o;class a extends A.Events.BaseEditDiscard{}t.EditDiscard=a;class r extends A.Events.BaseDelete{}t.Delete=r;class h extends A.Events.BaseMove{}t.Move=h;class l extends A.Events.BaseCurrentChange{}t.CurrentChange=l;class d extends A.Events.BaseSelectChange{}t.SelectChange=d;class c extends A.Events.BaseValidChange{}t.ValidChange=c}(s=t.Events||(t.Events={}))}(V||(V={})),function(t){const e={[A.Events.HoverChange.type]:"hoverState",[A.Events.HighlightAdd.type]:"highlightState",[A.Events.HighlightClear.type]:"highlightState",[A.Events.DimAdd.type]:"dimState",[A.Events.DimClear.type]:"dimState"};class i{constructor(t){this.editor=t,this.bindings=[],this.entities=new Map,this.bindings.push(this.editor.subscribe(A.Events.HoverChange,(t=>this.bindTargetedCallback(A.Events.HoverChange.type,t))),this.editor.subscribe(A.Events.HighlightAdd,(t=>this.bindTargetedCallback(A.Events.HighlightAdd.type,t))),this.editor.subscribe(A.Events.HighlightClear,(t=>this.bindClearCallback(A.Events.HighlightClear.type,t))),this.editor.subscribe(A.Events.DimAdd,(t=>this.bindTargetedCallback(A.Events.DimAdd.type,t))),this.editor.subscribe(A.Events.DimClear,(t=>this.bindClearCallback(A.Events.DimClear.type,t))))}registerEntity(t,...e){let i=this.entities.get(t);i||(i=[]),i.push(...e),this.entities.set(t,i)}unregisterEntity(t){return this.entities.delete(t)}bindTargetedCallback(t,e){const{target:i,previousTarget:s}=this.getTargetAndPrevIds(e),n=this.eventToCallbackMapping[t];if(!n)throw Error(`implement targetted callback for ${t}`);for(const t of s)(this.entities.get(t)||[]).forEach((t=>{n in t&&(t[n].active=!1,t[n].off())}));for(const t of i)(this.entities.get(t)||[]).forEach((t=>{n in t&&(t[n].active=!0,t[n].on())}))}bindMoveCallback(t){const{target:e}=this.getTargetAndPrevIds(t);for(const i of e)(this.entities.get(i)||[]).forEach((e=>{e.mover&&t.target&&e.mover.onMove(i,t.ev)}))}bindClearCallback(t,e){const i=this.eventToCallbackMapping[t],{target:s}=this.getTargetAndPrevIds(e);for(const t of s)(this.entities.get(t)||[]).forEach((t=>{i in t&&(t[i].active=!1,t[i].off())}))}}t.BaseEditorEntityAdapter=i;t.EditorEntityAdapter=class extends i{constructor(t){super(t),this.eventToCallbackMapping=Object.assign(Object.assign({},e),{[R.Events.SelectChange.type]:"selectState",[R.Events.ValidChange.type]:"validState",[R.Events.Move.type]:"mover"}),this.bindings.push(this.editor.subscribe(R.Events.SelectChange,(t=>this.bindTargetedCallback(R.Events.SelectChange.type,t))),this.editor.subscribe(R.Events.ValidChange,(t=>this.bindTargetedCallback(R.Events.ValidChange.type,t))),this.editor.subscribe(R.Events.Move,(t=>this.bindMoveCallback(t))))}getTargetAndPrevIds(t){if(A.Events.hasTargetAndPrev(t))return{target:t.target?[t.target]:[],previousTarget:t.previous?[t.previous]:[]};if(A.Events.hasTarget(t))return{target:t.target?[t.target]:[],previousTarget:[]};throw new Error("Unexpected message!!")}};t.MultiSelectEditorEntityAdapter=class extends i{constructor(t){super(t),this.eventToCallbackMapping=Object.assign(Object.assign({},e),{[V.Events.SelectChange.type]:"selectState",[V.Events.ValidChange.type]:"validState",[V.Events.Move.type]:"mover"}),this.bindings.push(this.editor.subscribe(V.Events.SelectChange,(t=>this.bindTargetedCallback(V.Events.SelectChange.type,t))),this.editor.subscribe(V.Events.ValidChange,(t=>this.bindTargetedCallback(V.Events.ValidChange.type,t))),this.editor.subscribe(V.Events.Move,(t=>this.bindMoveCallback(t))))}getTargetAndPrevIds(t){const e=t=>t instanceof Set?Array.from(t.keys()):null!==t?[t]:[];if(A.Events.hasTargetAndPrev(t))return{target:t.target?e(t.target):[],previousTarget:t.previous?e(t.previous):[]};if(A.Events.hasTarget(t))return{target:t.target?e(t.target):[],previousTarget:[]};throw new Error("Unexpected message!!")}}}(N||(N={}));class H{constructor(t,e){this.editor=t,this.data=e,this.readBindings=[],this.mover={onMove:(t,e)=>{}},this.onCurrentChange=({target:t})=>{this.editor.state.toolState!==A.ToolState.ADDING&&this.clearHighlightedViews(),this.highlightView(t)},this.onSelectChange=({target:t})=>{this.setSelectedView(t)},this.onHoverChange=({target:t,previous:e})=>{if(this.editor.state.toolState===A.ToolState.ADDING)return;if(!t)return this.editor.clearAllDims(),this.editor.clearAllHighlights(),void(this.editor.state.selected&&this.setSelectedView(this.editor.state.selected));const i=this.data.getEntity(t);this.hoverView(i)},this.editableEntities=new N.EditorEntityAdapter(this.editor)}addEditableEntity(t,e){this.editableEntities.registerEntity(e,this,t)}removeEditableEntity(t){this.editableEntities.unregisterEntity(t)}activate(){0===this.readBindings.length?this.readBindings.push(this.editor.subscribe(R.Events.CurrentChange,this.onCurrentChange),this.editor.subscribe(R.Events.SelectChange,this.onSelectChange),this.editor.subscribe(A.Events.HoverChange,this.onHoverChange)):this.readBindings.forEach((t=>t.renew()))}deactivate(){this.readBindings.forEach((t=>t.cancel()))}clearHighlightedViews(){this.editor.clearAllHighlights()}highlightView(t){if(!t)return;const e=this.data.getEntity(t);e instanceof G.j&&this.editor.highlight(t,e.from.id,e.to.id)}setSelectedView(t){if(!t)return void this.editor.clearAllDims();const e=this.data.getEntity(t);e instanceof G.j&&this.editor.highlight(e.from.id,e.to.id),e instanceof k.pQ&&(this.clearHighlightedViews(),this.dimAllRooms(),this.selectRoom(e))}dimAllRooms(){this.editor.clearAllDims();for(const[,t]of this.data.rooms)this.dimRoom(t)}hoverView(t){t instanceof k.pQ&&this.hoverRoom(t)}hoverRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id);for(const e of t.points)this.editor.clearDim(e.id)}selectRoom(t){const e=t.id;this.editor.clearDim(e);for(const e of t.walls)this.editor.clearDim(e.id);for(const e of t.points)this.editor.clearDim(e.id)}dimRoom(t){const e=t.id;this.editor.dim(e);for(const e of t.walls)this.editor.dim(e.id);for(const e of t.points)this.editor.dim(e.id)}}var _=i(68387),U=i(55141);class W extends U.u{constructor(t){super(),this.payload={id:t}}}W.id="roombound_unselect";class z extends U.u{constructor(t){super(),this.payload={allowRendering:t}}}z.id="room_bound_set_allow_rendering";var j=i(99583),$=i(41535),X=i(28454),q=i(31036),Y=i(84710);class Q extends Y.B{constructor(t){super(),this.editorState=t,this.name="room-bound-editor-state-data",this.commit()}}const Z=[d.S0.SEARCH,d.S0.LAYERS,d.S0.ROOM_VIEW,d.S0.HLR,d.S0.MEASUREMENTS],K=new Map,J=new Set([$.hb.CLOSED,$.hb.IDLE]);class tt extends s.n{constructor(){super(...arguments),this.name="room_bound",this.active=!1,this.allowRendering=!0,this.externalControl=!1,this.isActivatingOrDeactivating=!1,this.viewListener={addView:(t,e)=>this.inputManager.addEditableEntity(t,e),removeView:t=>this.inputManager.removeEditableEntity(t)},this.activate=async()=>{this.isActivatingOrDeactivating=!0,this.active||(this.active=!0,this.editor.start(),await this.startRenderer(),this.viewData.setRoomBoundVisible(!0),this.inputManager.activate()),this.isActivatingOrDeactivating=!1},this.deactivate=async()=>{this.isActivatingOrDeactivating=!0,this.active&&(this.active=!1,this.editor.exit(),this.stopRenderer(),this.viewData.setRoomBoundVisible(!1),this.inputManager.deactivate()),this.isActivatingOrDeactivating=!1},this.unselect=async t=>{t&&(await this.updateShowcaseVisibility(),this.active&&this.editor.deselect())}}get getAllowRendering(){return this.allowRendering}async init(t,e){this.engine=e;const[i,s,u,p,m,g,f]=await Promise.all([e.getModuleBySymbol(r.mL),e.market.waitForData(l.A),e.market.waitForData(a.o),e.market.waitForData(n.zH),e.market.waitForData(c.M),e.market.waitForData(j.X),e.market.waitForData(X.s)]);this.data=s,this.data.onActionError=t=>{this.applicationData.error=t,this.applicationData.commit()},this.applicationData=p,this.toolsData=m,this.settingsData=u,this.viewData=new _.B(this.data,p,m),e.market.register(_.B,this.viewData),this.viewmodeData=g,this.isRoomHoverAllowed=new q.r((()=>this.applicationData.application!==n.lg.SHOWCASE||this.toolsData.activeToolName!==d.S0.MEASUREMENTS||J.has(f.phase)),[t=>f.onPhaseChanged(t),t=>this.toolsData.onPropertyChanged("activeToolName",t),t=>this.applicationData.onChanged(t)]),this.editor=new B(e.msgBus,e.commandBinder,i,this.isRoomHoverAllowed);const v=new Q(this.editor.state);e.market.register(Q,v),this.inputManager=new H(this.editor,s),this.bindings.push(e.commandBinder.addBinding(W,(async t=>this.unselect(t.id))),e.commandBinder.addBinding(z,(async t=>await this.setAllowRendering(t.allowRendering))),this.applicationData.onChanged((()=>this.updateShowcaseVisibility())),this.viewmodeData.onChanged((()=>this.updateShowcaseVisibility())),this.toolsData.onPropertyChanged("activeToolName",(()=>this.updateShowcaseVisibility())),this.settingsData.onPropertyChanged(h.Q$.RoomBounds,(()=>this.updateShowcaseAvailability())),e.subscribe(o.Fj,(t=>{this.updateShowcaseVisibility()}))),await this.updateShowcaseAvailability()}dispose(t){super.dispose(t),t.market.unregister(_.B)}toggleVisibilityForViewer(t){this.viewData.commit(),this.updateShowcaseVisibility()}async startRenderer(){const t=await this.engine.getModuleBySymbol(r.A5);await t.startRendering(!0,this.viewListener,(()=>!1),(()=>this.isRoomHoverAllowed.value))}async stopRenderer(){(await this.engine.getModuleBySymbol(r.A5)).stopRendering()}async updateShowcaseAvailability(){this.settingsData.tryGetProperty(h.Q$.RoomBounds,!1)&&!this.viewData.visibleInShowcase?this.toggleVisibilityForViewer(!0):await this.updateShowcaseVisibility()}async updateShowcaseVisibility(){if(this.isActivatingOrDeactivating||this.externalControl)return;const{application:t}=this.applicationData,e=t===n.lg.SHOWCASE,i=t===n.lg.WORKSHOP,s=this.settingsData.tryGetProperty(h.Q$.RoomBounds,!1),o=e&&this.viewData.visibleInShowcase&&s||i,a=null==this.toolsData.activeToolName||Z.includes(this.toolsData.activeToolName),r=null!=this.toolsData.activeToolName?K.get(this.toolsData.activeToolName):null,l=null!=r&&null!=this.viewmodeData.currentMode&&r.includes(this.viewmodeData.currentMode),d=a||l,c=this.data.rooms.size>0;o&&d&&c&&this.allowRendering?await this.activate():await this.deactivate()}async takeoverVisibilityControl(){this.externalControl=!0,await this.deactivate()}async returnVisibilityControl(){this.externalControl=!1,this.updateShowcaseVisibility()}async setAllowRendering(t){this.allowRendering=t,this.updateShowcaseVisibility()}}},93358:(t,e,i)=>{"use strict";i.d(e,{W:()=>s});class s{constructor(t){this.tags=[],t&&Object.assign(this,t)}}},33062:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>g});var s=i(75578),n=i(10843),o=i(85616);class a extends o.v{equals(t){return this.id===t.id}copy(t){return this.id=t.id,this.name=t.name,this.vendor=t.vendor,this.model=t.model,this.captureMode=t.captureMode,this.depthCameraType=t.depthCameraType,this.cameraTypes=t.cameraTypes.slice(),this.sensorSerialNumbers=t.sensorSerialNumbers.slice(),this.serialNumber=t.serialNumber,this.mountCalibrationVersion=t.mountCalibrationVersion,this.softwareVersion=t.softwareVersion,this}}class r extends o.v{constructor(t){super(),t&&(t.id&&(this.id=t.id),void 0!==t.index&&(this.index=t.index),this.name=t.name||"",this.created=t.created||"",this.alignment=t.alignment||"",this.options=t.options||[],this.camera=t.camera||new a)}equals(t){return this.id===t.id}copy(t){return this.id=t.id,this.index=t.index,this.name=t.name,this.created=t.created,this.alignment=t.alignment,this.options=t.options.slice(),this.camera=(new a).copy(t.camera),this}}const h=new n.Ay("mds-scaninfo-serializer");class l{deserialize(t){if(!t||!this.validate(t))return h.debug("Deserialized invalid ScanInfo data from MDS",t),null;const e=t,i=new r;i.id=e.id,i.anchorId=e.anchor&&e.anchor.id||"",i.index=e.index||-1,i.name=e.name||"",i.created=e.created||"",i.alignment=e.alignment||"",i.url=e.url||"",i.timeOfDay=e.timeOfDay||"",i.options=e.options||[];const s=e.camera;return i.camera=new a,i.camera.id=s&&s.id||"",i.camera.name=s&&s.name||"",i.camera.vendor=s&&s.vendor||"",i.camera.model=s&&s.model||"",i.camera.captureMode=s&&s.captureMode||"",i.camera.depthCameraType=s&&s.depthCameraType||"",i.camera.cameraTypes=((null==s?void 0:s.cameraTypes)||[]).filter((t=>t)),i.camera.sensorSerialNumbers=((null==s?void 0:s.sensorSerialNumbers)||[]).filter((t=>t)),i.camera.serialNumber=s&&s.serialNumber||"",i.camera.mountCalibrationVersion=(null==s?void 0:s.mountCalibrationVersion)?s.mountCalibrationVersion:void 0,i.camera.softwareVersion=s&&s.softwareVersion||"",i}validate(t){if(!t)return!1;return["id"].every((e=>e in t))}}var d=i(20968),c=i(34558);class u{}class p extends d.g{constructor(){super(...arguments),this.deserializer=new l}async fetch(){const t=this.getViewId();return this.query(c.GetScans,{modelId:t},{fetchPolicy:"no-cache"}).then((t=>{var e,i,s;const n=(null===(s=null===(i=null===(e=t.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.assets)||void 0===s?void 0:s.scans)||[],o={},a={};for(const t of n){const e=this.deserializer.deserialize(t);e&&(o[e.id]=e,e.anchorId&&(a[e.anchorId]=e))}const r=new u;return r.scansById=o,r.scansByAnchor=a,r}))}async read(){return this.scans||(this.scans=this.fetch()),this.scans}async refresh(){return this.scans=this.fetch(),this.scans}}var m=i(47737);class g extends s.n{constructor(){super(...arguments),this.name="scaninfo-data",this.getScanInfo=t=>this.store.read().then((e=>e?e.scansByAnchor[t]:void 0)),this.getScanDownloadURL=t=>this.store.refresh().then((e=>{if(e){const i=e.scansByAnchor[t];return i?i.url:void 0}}))}async init(t,e){const i=await e.market.waitForData(m.P);this.store=new p({context:i.mdsContext,readonly:!0})}}},58899:(t,e,i)=>{"use strict";i.d(e,{r:()=>r});var s=i(39905),n=i(94547),o=i(93877);const a=new s.r({});class r{constructor(t,e,i){this.commandBinder=t,this.layersData=e,this.dataTypeGroup=i,this.textParser=a,this.enabled=!0,this.bindings=[]}getLayerType(){var t;const e=this.getLayerGroupId();if(!e)return;const i=null===(t=this.layersData)||void 0===t?void 0:t.getLayer(e);return null==i?void 0:i.layerType}getGroupingId(t){switch(t){case o.Hj.TYPE:return this.getTypeId();case o.Hj.FLOOR:return this.getFloorId();case o.Hj.ROOM:return this.getRoomId();case o.Hj.LAYER:return this.getLayerGroupId();case o.Hj.DATE:return this.dateBucket}}getFloorId(){return this.floorId}getRoomId(){return this.roomId}getDateBucket(){return this.dateBucket}getTypeId(){return this.typeId}supportsBatchDelete(){return!1}supportsLayeredCopyMove(){return!1}getLayerGroupId(){var t,e;const i=null===(t=this.layersData)||void 0===t?void 0:t.getBaseLayerId(),s=null===(e=this.layersData)||void 0===e?void 0:e.getViewLayerId();return this.layerId&&s&&this.layerId===i?s:this.layerId}isLayerVisible(){return!this.layersData||!this.layerId||this.layersData.layerVisible(this.layerId)}onSelect(t,e,i){this.commandBinder.issueCommand(new n.Xx(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((t=>t.cancel()))}}},94547:(t,e,i)=>{"use strict";i.d(e,{$M:()=>a,Oc:()=>c,Pb:()=>o,Xx:()=>d,_d:()=>h,_w:()=>l,tA:()=>n,tf:()=>u,xg:()=>r});var s=i(55141);class n extends s.u{constructor(t){super(),this.payload={query:t}}}n.id="UPDATE_SEARCH_QUERY";class o extends s.u{constructor(t){super(),this.payload={keywords:t}}}o.id="UPDATE_SEARCH_QUERY_KEYWORDS";class a extends s.u{constructor(t){super(),this.payload={keywordId:t}}}a.id="TOGGLE_SEARCH_QUERY_KEYWORD";class r extends s.u{constructor(t){super(),this.payload={grouping:t}}}r.id="CHANGE_SEARCH_GROUPING";class h extends s.u{constructor(){super()}}h.id="SEARCH_FILTER_CLEAR";class l extends s.u{constructor(t,e){super(),this.payload={groupId:t,enabled:e}}}l.id="SEARCH_FILTER_TOGGLE";class d extends s.u{constructor(t,e){super(),this.payload={id:t,typeId:e}}}d.id="SELECT_SEARCH_RESULT";class c extends s.u{constructor(t){super(),this.payload=t}}c.id="SEARCH_GROUP_REGISTER";class u extends s.u{constructor(t){super(),this.payload={id:t}}}u.id="SEARCH_GROUP_DEREGISTER"},13397:(t,e,i)=>{"use strict";i.d(e,{e:()=>o});var s=i(87805),n=i(78849);const o=(0,s.u)(n.L,"query","")},2812:(t,e,i)=>{"use strict";i.d(e,{O:()=>r});var s=i(84710),n=i(45205),o=i(2803),a=i(97696);class r extends s.B{constructor(t){super(),this.name="snapshots",this.snapshots={};for(const e in t)this.snapshots[e]=t[e].clone()}get(t){return this.snapshots[t]}async getImageUrl(t){const e=this.get(t),i=new URL(await e.imageUrl.get());return"panorama"===e.category&&(i.searchParams.delete("height"),i.searchParams.delete("fit")),i.toString()}get collection(){return this.snapshots}get snapshotsCount(){return this.snapshots?Object.keys(this.snapshots).length:0}getSortedCollection(t){if(!this.snapshotsCount)return[];let e=Object.values(this.snapshots);return(null==t?void 0:t.filterFn)&&(e=e.filter(t.filterFn)),e.sort((null==t?void 0:t.compareFn)||a.PN)}setSelectedPhoto(t){this.selectedPhotoId=t,this.commit()}add(t){t.sid=this.validateSid(t.sid),this.snapshots[t.sid]=t,this.updateOnStaleCallbacks(),this.commit()}remove(t){delete this.snapshots[t]}validateSid(t){for(;!t||this.snapshots[t];)t=(0,n.D)(11);return t}set onStale(t){this.hydrate=t,this.updateOnStaleCallbacks()}updateOnStaleCallbacks(){this.hydrate&&(0,o._)(this.snapshots,(async()=>{const t=await this.hydrate();for(const e in this.snapshots)t&&t[e]&&this.snapshots[e].refresh(t[e])}))}}},10574:(t,e,i)=>{"use strict";i.d(e,{V:()=>n});var s=i(55141);class n extends s.u{constructor(t){super(),this.payload={navSize:t}}}n.id="SET_NAV_PANO_SIZE"},17196:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>R});var s=i(75578),n=i(23184),o=i(3694),a=i(5984),r=i(3956),h=i(80191),l=i(55141);class d extends l.u{constructor(t){super(),this.payload={enabled:t}}}d.id="TOGGLE_PUCK_EDITING";var c=i(1197),u=i(72268),p=i(78079),m=i(31002),g=i(25316),f=i(20599),v=i(4288),y=i(99583),b=i(2993),w=i(9997),D=i(90834),S=i(62568),I=i(45832),T=i(38069);const P=[{outerRadius:1,innerRadius:.97,color:T.V.BLACK.clone(),opacity:.1},{outerRadius:.97,innerRadius:.65,color:T.V.WHITE.clone(),opacity:.64},{outerRadius:.65,innerRadius:.62,color:T.V.BLACK.clone(),opacity:.13}];var E=i(25686),C=i(3066),M=i(35699),x=i(77510);const A={enabled:P,enabledHover:P};class R extends s.n{constructor(){super(...arguments),this.name="sweep-pucks",this.IDLE_OPACITY=.3,this.EDITING_OPACITY=.9,this.IDLE_COLOR=T.V.WHITE.clone(),this.SELECTION_COLOR=T.V.MP_BRAND.clone(),this.defaultCheckRenderModes=()=>!0,this.unselectingSweep=null,this.editingEnabled=!1,this.selectionBindings=[],this.unselectionBindings=[],this.isHoveringPuck=!1,this.selectionHandled=!0,this.unselectionHandled=!0,this.handlePuckClickedMessage=t=>{if(!t)throw new Error("SweepPucks -> on PuckClickedMessage: Tried to move to invalid sweep id.");this.canSelectPuck()||this.sweepViewData.data.canTransition()&&this.cameraData.canTransition()&&this.engine.commandBinder.issueCommand(new w.aj({transition:(0,S.xl)(this.interactionmodeData.mode),sweep:t}))},this.handlePuckHoverMessage=({hovered:t})=>{this.isHoveringPuck=t,this.engine.commandBinder.issueCommand(new M.X(t?x.b.FINGER:null))},this.cursorVisibilityRule=()=>!this.isHoveringPuck,this.handleSweepSelectionChange=()=>{this.updateHighlightOnSelectedPuck(!1),this.selectedSweep=this.sweepViewData.selectedSweep,this.updateHighlightOnSelectedPuck(!0),this.updateHandlers()},this.updateViewmode=()=>{this.viewmode=this.viewmodeData.currentMode,this.updateHighlightOnSelectedPuck(this.editingEnabled),this.updateHandlers()},this.updateHandlers=()=>{this.selectionHandled=this.toggleHandlers(this.canSelectPuck(),this.selectionBindings,this.selectionHandled),this.unselectionHandled=this.toggleHandlers(this.canUnselectPuck(),this.unselectionBindings,this.unselectionHandled)},this.unselectPuck=()=>{this.unselectingSweep=null,this.sweepViewData.setSelectedSweep(null)},this.onUnselectPuck=t=>{const e=this.sweepViewData.selectedSweep;return e&&(t.down?this.unselectingSweep=e:this.unselectingSweep&&this.unselectPuck()),!0},this.onPointerOnPuck=(t,e)=>{if(t.button!==u.m.PRIMARY)return;const i=this.renderer.getSweepId(e.id);i&&(t.down?i===this.selectedSweep?this.unselectingSweep=i:(this.unselectingSweep=null,this.sweepViewData.setSelectedSweep(i)):(i===this.unselectingSweep&&this.unselectPuck(),this.unselectingSweep=null))}}async init(t,e){this.engine=e,void 0!==t.checkRenderModes&&(this.defaultCheckRenderModes=t.checkRenderModes);const i=(await e.getModuleBySymbol(I.M7)).getScene(),s=await e.getModuleBySymbol(I.mL),l=await e.getModuleBySymbol(I._v),[c,u,b,w,S]=await Promise.all([e.market.waitForData(g.o),e.market.waitForData(f.M),e.market.waitForData(v.O),e.market.waitForData(y.X),e.market.waitForData(D.O)]);this.viewmodeData=w,this.viewmode=w.currentMode,this.sweepViewData=b,this.cameraData=u,this.interactionmodeData=S;this.renderer=new r.J(i.scene,s,c,b,A,!0,this.defaultCheckRenderModes,this.IDLE_COLOR,this.SELECTION_COLOR,this.IDLE_OPACITY,this.EDITING_OPACITY,void 0,void 0,e.claimRenderLayer(this.name)),e.addComponent(this,this.renderer),this.bindings.push(e.commandBinder.addBinding(d,(async t=>this.togglePuckEditing(t.enabled))),e.subscribe(h.A,(t=>this.handlePuckClickedMessage(t.sweepId))),e.subscribe(E.A,this.handlePuckHoverMessage),(0,C.Sh)((()=>l.addVisibilityRule(this.cursorVisibilityRule)),(()=>l.removeVisibilityRule(this.cursorVisibilityRule)))),this.selectionBindings.push(s.registerMeshHandler(p.CD,n.f.isType(r.U),this.onPointerOnPuck),s.registerHandler(p.$3,(()=>{this.unselectingSweep=null}))),this.selectionHandled=this.toggleHandlers(!1,this.selectionBindings,this.selectionHandled),this.selectionSub=this.sweepViewData.onSelectedSweepChanged(this.handleSweepSelectionChange),this.selectionSub.cancel(),this.unselectionBindings.push(s.registerPriorityHandler(m.rX,a.r,(()=>!0)),s.registerPriorityHandler(p.CD,a.r,this.onUnselectPuck),s.registerPriorityHandler(p.CD,o.W,this.onUnselectPuck)),this.unselectionHandled=this.toggleHandlers(!1,this.unselectionBindings,this.unselectionHandled)}dispose(t){for(const t of this.bindings)t.cancel();this.bindings=[],this.togglePuckEditing(!1),super.dispose(t)}updatePuckImagery(t={}){const e=Object.assign(Object.assign({},A),t);e.disabled&&!e.disabledHover&&(e.disabledHover=e.disabled),this.renderer.updatePuckImagery(e)}updateCheckRenderModes(t){this.renderer.updateCheckRenderModes(t||this.defaultCheckRenderModes)}updateHighlightOnSelectedPuck(t){const e=this.selectedSweep;if(e){if(!this.sweepViewData.isSweepAligned(e))return;const i=this.viewmode===b.N3.Dollhouse||this.viewmode===b.N3.Floorplan;this.renderer.renderPuckHighlight(e,this.editingEnabled&&i&&t)}}togglePuckEditing(t){this.editingEnabled=t,this.selectedSweep=this.sweepViewData.selectedSweep,this.updateViewmode(),this.renderer.toggleEditingEnabled(t),t?(this.engine.subscribe(c.A,this.updateViewmode),this.selectionSub.renew()):(this.engine.unsubscribe(c.A,this.updateViewmode),this.selectionSub.cancel())}canUnselectPuck(){const t=this.viewmode===b.N3.Dollhouse||this.viewmode===b.N3.Floorplan;return this.editingEnabled&&!!this.selectedSweep&&t}canSelectPuck(){const t=this.viewmode===b.N3.Dollhouse||this.viewmode===b.N3.Floorplan;return this.editingEnabled&&t}toggleHandlers(t,e,i){if(t!==i)for(const i of e)t?i.renew():i.cancel();return t}}},97851:(t,e,i)=>{"use strict";i.r(e),i.d(e,{FAST_FORWARD_FACTOR:()=>ot,default:()=>at});var s=i(48734),n=i(60152),o=i(75578),a=i(2993),r=i(96425),h=i(21875),l=i(44481),d=i(99583),c=i(13893),u=i(22937),p=i(78079),m=i(44667),g=i(27947),f=i(22585),v=i(25316),y=i(20599),b=i(53172),w=i(86866),D=i(88664),S=i(56208),I=i(90160),T=i(1333);class P{constructor(t=-1){this.active=!1,this.type=T.gX.Nop,this.promise=Promise.resolve(),this.stop=()=>Promise.resolve(),this.duration=0,this.started=-1,this.stopped=-1,this.toIndex=t}}var E=i(48539);class C{constructor(t){this.type=T.gX.Delay,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.cancelDelay=()=>null,this.duration=t}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(this.cancelDelay(),this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e){if(this.active)throw Error("Transition already active");void 0!==t.duration&&(this.duration=t.duration);const i=(0,E.op)(this.duration);return this.cancelDelay=()=>{i.resolveEarly()},this.currentTransitionPromise=i.promise.then((()=>this.stop())),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}}class M{constructor(t,e,i){this.zoom=t,this.stopZooming=e,this.type=T.gX.Zoom,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.duration=i}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e){if(this.active)throw Error("Transition already active");void 0!==t.duration&&(this.duration=t.duration);return this.currentTransitionPromise=this.zoom(this.duration,-5).then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this.onStopRequested=async()=>{await this.stopZooming()},this}}var x=i(68909),A=i(81662),R=i(33007);class L{constructor(t,e,i){this.settingsData=t,this.rotate=e,this.stopRotating=i,this.type=T.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.getPanDirection=(t,e)=>{let i=T.ND.Right;if(t&&t.metadata.scanId&&t.metadata.cameraQuaternion&&t.metadata.cameraPosition&&e&&e.metadata.scanId&&e.metadata.cameraPosition&&e.metadata.cameraQuaternion){const s=A.B1.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),n=e.metadata.cameraPosition,o=t.metadata.cameraPosition;let a=n.clone().sub(o).normalize();a.lengthSq()<R.A.epsilon&&(a=A.B1.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion)),s.cross(a).y>0&&(i=T.ND.Left)}return i}}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e,i){if(this.active)throw Error("Transition already active");if(!t)throw Error("Tour pan requires two snapshots");if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this.toIndex=e,this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:s}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides,i);return this.currentTransitionPromise=s.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}build(t,e,i,s){const{panDirection:n,panAngle:o}=i,a=J.getPanValues(this.settingsData,!1,n,o);let r=a.direction;void 0!==r&&r!==T.ND.Auto||(r=this.getPanDirection(t,e)),this.onStopRequested=async()=>{await this.stopRotating()},this.duration=void 0!==s?s:a.ms;return{deferred:this.rotate(this.duration,new x.Vector2(r*a.radiansPerMs,0))}}}var O=i(94814),F=i(31093);const B=.001,V=(t,e,i,s)=>{const n=Math.max(.75,Math.min(t.distanceTo(e),5)),o=n*(1/s)*1e3;let a=o;const r=i/o;if(r>B){a+=a*((r-B)/B)}const h=Math.abs(t.clone().setX(0).setZ(0).distanceTo(e.clone().setX(0).setZ(0))/Math.max(n,1));if(h>.1){a*=.9+.75*h}return a};class N{constructor(t,e,i,s,n,o){this.settingsData=t,this.cameraPose=e,this.moveToSweep=i,this.updateTransitionSpeed=s,this.setRestrictedSweeps=n,this.generators=o,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentGenerator=null,this.currentTransitionPromise=null,this.type=T.gX.Move}get active(){return null!==this.currentTransitionPromise||null!==this.currentGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentGenerator&&(this.generators.stopGenerator(this.currentGenerator),this.currentGenerator=null)}start(t,e){if(this.active)throw Error("Transition already active");const{generator:i,deferred:s}=this.build(t.path,t.orientations);return this.generators.startGenerator(i),this.currentGenerator=i,this.currentTransitionPromise=s.nativePromise(),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}build(t,e){const i=new F.i,n=this;let o=!1;return this.onStopRequested=async()=>{o=!0,await this.updateTransitionSpeed(ot)},{generator:function*(){let a=1;for(;a<t.length&&!o;){const i=a-1,o=t[a],r=o.position,h=t[i],l=e[a],d=(0,w.HN)(n.cameraPose.rotation,l),u=J.getTransitionSpeed(n.settingsData),p=V(h.position,r,d,u),m={transitionType:c.fl.Interpolate,sweepId:o.id,rotation:l,transitionTime:p,easing:O.p9};n.duration=p,n.setRestrictedSweeps(t,i);const g=n.moveToSweep(m);yield new s.sv(g.nativePromise()),a++}n.setRestrictedSweeps(null),i.resolve(),n.currentTransitionPromise=null,n.stop()},deferred:i}}}var k=i(39209);const G=new(i(10843).Ay)("tours");class H{constructor(t,e,i,n,o,a,r,h,l){this.settingsData=t,this.cameraPose=e,this.cameraTransition=i,this.sweepTransition=n,this.sweepControl=o,this.cameraControl=a,this.generators=r,this.setRestrictedSweeps=h,this.getCurve=l,this.type=T.gX.Path,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionGenerator=null,this.currentTransitionPromise=null,this.canceling=!1,this.buildTransition=(t,e)=>{if(t.length<=2)throw G.debug(`invalid path: ${t}`),new Error("smooth path requires more than 2 stops");const i=this,n=new F.i;i.setRestrictedSweeps(t);const o=t.map((t=>t.position)),a=i.getCurve(o),r=O.p9,h=O.rn,l=O.dV,d=J.getTransitionSpeed(i.settingsData);this.duration=((t,e,i)=>{let s=0;for(let n=0;n<t.length-1;n++){const o=(0,w.HN)(e[n],e[n+1]);s+=V(t[n].position,t[n+1].position,o,i)}return s})(t,e,d),G.debug(`path duration: ${this.duration.toFixed(0)}ms, at speed: ${d}m/s`),i.cameraControl.beginExternalTransition();return{generator:function*(){n.notify(0);const o=new x.Vector3,u=new x.Quaternion;let p=0,m=0,g=0,f=1,v=t[f].id;yield new s.sv(i.sweepControl.activateSweepUnsafe({sweepId:v}).then((()=>{i.sweepControl.beginSweepTransition({sweepId:v,transitionTime:i.duration,internalProgress:!1})}))),t.length>2&&i.sweepControl.activateSweepUnsafe({sweepId:t[2].id});let y=i.cameraPose.rotation.clone();for(;p<i.duration&&!i.canceling;){const d=p/i.duration;g>0&&(y=e[g].clone());const c=e[f],b=a.normalSourceDistances[g],D=a.normalSourceDistances[f],S=t[f];if(m=(0,w.OF)(d,b,D,0,1),m<=1){const t=l(m,0,1,1);i.sweepTransition.progress.modifyAnimation(t,1,0);const e=h(m,0,1,1);u.copy(y).slerp(c,e)}d<1&&o.copy(a.curve.getPointAt(r(d,0,1,1))),i.cameraControl.updateCameraPosition(o),i.cameraControl.updateCameraRotation(u),d>=D&&(i.sweepControl.endSweepTransition({sweepId:S.id}),g++,f++,v=t[g+1].id,yield new s.sv(i.sweepControl.activateSweepUnsafe({sweepId:v}).then((()=>{i.sweepControl.beginSweepTransition({sweepId:v,transitionTime:i.duration,internalProgress:!1})}))),t.length>g+2&&i.sweepControl.activateSweepUnsafe({sweepId:t[g+2].id})),n.notify(d),p=Date.now()-i.cameraTransition.startTime,yield new s.oN}if(i.cameraControl.endExternalTransition(),i.canceling){i.canceling=!1;const e=t[f].position,n=V(i.cameraPose.position,e,0,d),o=i.cameraControl.moveTo({transitionTime:n/ot,transitionType:c.fl.Interpolate,pose:{position:e}});o.progress((t=>{const e=(0,w.OF)(t,0,1,m,1);i.sweepTransition.progress.modifyAnimation(e,1,0)})),yield new s.sv(o.nativePromise())}i.sweepControl.endSweepTransition({sweepId:v}),i.setRestrictedSweeps(null),n.notify(1),n.resolve()},deferred:n}}}get active(){return null!==this.currentTransitionPromise||null!==this.currentTransitionGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.canceling=!0,this.currentTransitionPromise&&(await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now()),this.currentTransitionGenerator&&(this.generators.stopGenerator(this.currentTransitionGenerator),this.currentTransitionGenerator=null)}start(t,e){if(G.debug(`starting smooth transition with ${t.path.length-1} stops`),this.active)throw Error("Transition already active");this.canceling=!1;const{generator:i,deferred:s}=this.buildTransition(t.path,t.orientations);return this.generators.startGenerator(i),this.currentTransitionGenerator=i,this.currentTransitionPromise=s.nativePromise().then((()=>{this.currentTransitionPromise=null,this.currentTransitionGenerator=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}}var _=i(62372);class U{constructor(t,e,i,s,n,o,a,r){this.settingsData=t,this.cameraPose=e,this.viewmodeData=i,this.cameraControl=s,this.sweepControl=n,this.switchToMode=o,this.setRestrictedSweeps=a,this.generators=r,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=T.gX.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e){if(this.active)throw Error("Transition already active");if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:i}=this.build(t.snapshot,t.currentSweep,t.transitionType);return this.currentTransitionPromise=i.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}build(t,e,i){let s=Promise.resolve();const n=t.metadata.cameraMode,o=t.metadata.cameraQuaternion;let r;t.metadata.scanId&&(r=this.sweepControl.getSweepOnView(t.metadata.scanId,t.sourceViewId).id);const h=this.cameraPose.rotation,l=(0,w.HN)(h,o),d=t.metadata.cameraPosition,c=!t.is360,u={position:d,rotation:o,sweepID:r,zoom:t.metadata.orthoZoom};let p;const m=this.viewmodeData.isDollhouse()&&!this.cameraPose.isPitchFactorOrtho,g=this.viewmodeData.isFloorplan()||this.cameraPose.isPitchFactorOrtho,f=n===a.N3.Floorplan,v=n===a.N3.Dollhouse&&!m||f&&!g;if(n!==this.viewmodeData.currentMode||v)p=J.getOtherModeTransitionTime(this.settingsData,l,i),s=this.switchToMode(n,i,u,p);else{if(!!r&&this.viewmodeData.isInside()){r&&(!e||r!==e)?(p=J.getTransitionTime(this.settingsData),s=this.standardTransitionSweepMovePromise(u,r,c,p)):(p=J.getSamePanoTransitionTime(this.settingsData,l),s=this.standardTransitionSameSweepRotationPromise(u,l,p))}else p=J.getOtherModeTransitionTime(this.settingsData,l,i),s=this.cameraControl.moveTo({transitionType:i,pose:u,transitionTime:p}).nativePromise()}return this.duration=null!=p?p:0,{deferred:s}}standardTransitionSameSweepRotationPromise(t,e,i){if(!t.rotation)throw Error("Rotation transition requires a rotation");return e<.01?Promise.resolve():(this.setRestrictedSweeps(null),this.cameraControl.moveTo({transitionType:c.fl.Interpolate,pose:{rotation:t.rotation},transitionTime:i}).nativePromise())}standardTransitionSweepMovePromise(t,e,i,n){if(!t.position)throw Error("Push transition requires a position");const o=t.position.clone().sub(this.cameraPose.position).normalize(),a=this.cameraPose.position.clone().add(o.multiplyScalar(.15)),r=new F.i;this.setRestrictedSweeps(null);const h=this;return this.generators.startGenerator((function*(){yield new s.sv(h.sweepControl.activateSweepUnsafe({sweepId:e}));const o=new x.Vector3,l=h.cameraPose.position.clone(),d=Date.now();let u,p=0,m=!1,g=!1;for(;p<n;){const r=(0,O.Do)(p,0,p/n,n);i&&h.cameraControl.updateCameraPosition(o.copy(l).lerp(a,r)),r>=.3&&!g&&(u=h.cameraControl.moveTo({transitionType:c.fl.FadeToBlack,pose:t,transitionTime:n,blackoutTime:.5*n}).progress((t=>{t>=.5&&!m&&(h.sweepControl.instantSweepTransition(e),m=!0)})),g=!0),yield new s.oN,p=Date.now()-d}u&&(yield new s.sv(u.nativePromise())),r.resolve()})),r.nativePromise()}}class W{constructor(t,e,i,s){this.moveToSweep=t,this.viewmodeData=e,this.cameraControl=i,this.switchToMode=s,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.type=T.gX.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e){if(this.active)throw Error("Transition already active");if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this.started=Date.now(),this.stopped=Date.now(),this;const{deferred:i}=this.build(t.snapshot,t.currentSweep);return this.currentTransitionPromise=i.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}build(t,e){let i=Promise.resolve();const s=t.metadata.cameraMode,n=t.metadata.cameraQuaternion,o=t.metadata.scanId,a={position:t.metadata.cameraPosition,rotation:n,sweepID:o,zoom:t.metadata.orthoZoom},r=s!==this.viewmodeData.currentMode,h=!!o&&this.viewmodeData.isInside();if(r)i=this.switchToMode(s,c.fl.Instant,a);else if(h){const t={transitionType:c.fl.Instant,sweepId:o,rotation:n};i=this.moveToSweep(t).nativePromise()}else i=this.cameraControl.moveTo({transitionType:c.fl.Instant,pose:a}).nativePromise();return{deferred:i}}}var z=i(72773),j=i(23272);class ${constructor(t,e){this.issueCommand=t,this.currentFloorId=e,this.type=T.gX.FloorChange,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=z.t$,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e){if(this.active)throw Error("Transition already active");let i=Promise.resolve();const s=t.targetSnapshot.metadata.floorId,n=s!==this.currentFloorId(),o=t.targetSnapshot.metadata.cameraMode;return!(0,a.nI)(o)&&o!==a.N3.Outdoor&&n&&(i=this.issueCommand(new j.i1(s,!0,this.duration))),this.currentTransitionPromise=i.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}}class X{constructor(t,e,i){this.settingsData=t,this.rotate=e,this.stopRotating=i,this.type=T.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e,i){if(this.active)throw Error("Transition already active");if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:s}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides,i);return this.currentTransitionPromise=s.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}build(t,e,i,s){const{panDirection:n,panAngle:o}=i,a=J.getPanValues(this.settingsData,!0,n,o);let r=-1*a.radiansPerMs;this.duration=void 0!==s?s:a.ms;const h=a.direction;if(void 0!==h&&h!==T.ND.Auto)r*=h;else if(t&&t.metadata.cameraQuaternion&&e&&e.metadata.cameraQuaternion){const i=A.B1.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),s=A.B1.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion),n=Math.sign(i.cross(s).y);r=0!==n?r*n:r}this.onStopRequested=async()=>{await this.stopRotating()};return{deferred:this.rotate(this.duration,new x.Vector2(r,0))}}}class q{constructor(t,e,i,s,n){this.settingsData=t,this.cameraPose=e,this.rotate=i,this.stopRotating=s,this.getCurve=n,this.type=T.gX.Burns,this.toIndex=-1,this.started=-1,this.stopped=-1,this.duration=0,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null,this.stopped=Date.now())}start(t,e,i){if(this.active)throw Error("Transition already active");const{deferred:s}=this.build(t.path,t.snapshot,t.nextSnapshot,t.panOverrides,i);return this.currentTransitionPromise=s.then((()=>{this.currentTransitionPromise=null,this.stopped=Date.now()})),this.toIndex=e,this.started=Date.now(),this.stopped=-1,this}build(t,e,i,s,n){this.onStopRequested=async()=>{await this.stopRotating()};const{panDirection:o,panAngle:r}=s,h=J.getPanValues(this.settingsData,!1,o,r),l=h.direction;let d=h.radiansPerMs;if(void 0!==l&&l!==T.ND.Auto)d*=l;else if(t){const e=this.cameraPose.position.clone().setY(0),i=t.map((t=>t.position)),s=this.getCurve(i).curve.getPointAt(.1).setY(0).clone().sub(e).normalize(),n=A.B1.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),o=Math.sign(n.cross(s).y);d=0!==o?d*o:d}else if(i&&e){if(!(0,a.nI)(e.metadata.cameraMode)&&(d=-d),e.metadata.scanId===i.metadata.scanId){const t=A.B1.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),e=A.B1.FORWARD.clone().applyQuaternion(i.metadata.cameraQuaternion),s=Math.sign(t.cross(e).y);d=0!==s?d*s:d}}const c=i&&!(0,a.nI)(i.metadata.cameraMode);this.duration=void 0!==n?n:h.ms;return{deferred:this.rotate(this.duration,new x.Vector2(d,0),!c)}}}const Y={sharpTurnDotThreshold:.65,directionWeightFactorStd:.75,directionWeightFactorSharp:.2,positionalWeightFactorStd:.4,positionalWeightFactorSharp:.2,finalWalkingNodeDirectionWeight:5,lookAheadNodes:3};class Q{constructor(t=Y){this.settings=t}getOrientationsForPath(t,e){const i=[];for(let s=0;s<t.length;s++){const n=new x.Vector3;this.getLookVectorsForPathNode(t,s,e,n);const o=(new x.Matrix4).lookAt(t[s],n,A.B1.UP);i[s]=(new x.Quaternion).setFromRotationMatrix(o)}return i.push(e),i}getLookVectorsForPathNode(t,e,i,s){const n=new x.Vector3,o=new x.Vector3,a=new x.Vector3,r=new x.Vector3,h=t.length;if(e>=h)return!1;let l=1,d=1;const c=new x.Vector3;let u;for(let s=e;s<e+this.settings.lookAheadNodes&&s<h;s++){if(u=t[s],this.getOrientationForPathNode(t,s,i,a),s===e&&n.copy(a),s>e){const t=n.dot(a)<this.settings.sharpTurnDotThreshold;l*=t?this.settings.directionWeightFactorSharp:this.settings.directionWeightFactorStd,d*=t?this.settings.positionalWeightFactorSharp:this.settings.positionalWeightFactorStd}s===h-1&&(l=this.settings.finalWalkingNodeDirectionWeight,d=1),c.copy(a),a.multiplyScalar(l),o.add(a),r.lerp(u,d)}return o.normalize(),s.copy(r),s.add(o),!0}getOrientationForPathNode(t,e,i,s){if(e>=t.length)return!1;if(e===t.length-1)s.copy(A.B1.FORWARD).applyQuaternion(i);else{const i=t[e],n=t[e+1];s.copy(n).sub(i)}return s.normalize(),!0}}var Z=i(45832);class K{constructor(t,e,i,s){this.sweepModule=t,this.pathModule=e,this.tourData=i,this.viewmodeData=s,this.getValidWalkingPath=t=>{var e,i;const s=null===(e=this.sweepModule.data.currentSweepObject)||void 0===e?void 0:e.platformId;let o;t.metadata.scanId&&(o=null===(i=this.sweepModule.data.getSweep(t.metadata.scanId))||void 0===i?void 0:i.platformId);let r=null;const h=this.tourData.getTourCurrentSnapshotSid();if(h&&(r=this.tourData.getSnapshot(h)),!r||this.viewmodeData.currentMode!==a.N3.Panorama||!s||!o||s===o||r.is360||t.is360)return null;const l=this.pathModule.findShortestPath(s,o,n.W0.walkingTourIncludeExtraPanosDistance,n.W0.walkingStageMinimumDistance,n.W0.maxWalkingSweepsBetweenSnapshots)||[];if(0===l.length)return null;if(t.sourceViewId||r.sourceViewId){const e=[];for(const i of l)0===e.length?e.push(this.sweepModule.getSweepOnView(i.platformId,r.sourceViewId)):e.push(this.sweepModule.getSweepOnView(i.platformId,t.sourceViewId));return e}return l}}}class J{constructor(t,e,i,s,n){this.engine=t,this.tourData=e,this.cameraData=i,this.settingsData=s,this.viewmodeData=n,this.init=async()=>{this.sweepModule=await this.engine.getModuleBySymbol(Z.Wh),this.sweepData=await this.engine.market.waitForData(_.A),this.cameraPoseController=await this.engine.getModuleBySymbol(Z.jh),this.pathModule=await this.engine.getModuleBySymbol(Z.Np),this.floorsViewData=await this.engine.market.waitForData(k.X),this.commonControlsModule=await this.engine.getModuleBySymbol(Z.X7),this.viewmodeModule=await this.engine.getModuleBySymbol(Z.SD),this.pathOrientHelper=new Q,this.setRestrictedSweeps=this.pathModule.setRestrictedSweeps.bind(this.pathModule),this.getCurveForPath=this.pathModule.getCurveForPath.bind(this.pathModule),this.moveToSweep=this.sweepModule.moveToSweep.bind(this.sweepModule),this.updateTransitionSpeed=this.cameraPoseController.updateTransitionSpeed.bind(this.cameraPoseController),this.switchToMode=this.viewmodeModule.switchToMode.bind(this.viewmodeModule),this.startRotateTransition=this.commonControlsModule.startRotateTransition.bind(this.commonControlsModule),this.stopCamera=this.commonControlsModule.stop.bind(this.commonControlsModule),this.startZoomTransition=this.commonControlsModule.startZoomTransition.bind(this.commonControlsModule),this.issueCommand=this.engine.commandBinder.issueCommand.bind(this.engine.commandBinder),this.walkingPath=new K(this.sweepModule,this.pathModule,this.tourData,this.viewmodeData)}}static isDelayTransition(t,e,i){return!(0,n.ht)(t)||e!==T._y.Zoom&&0===J.getPanDegrees(t,i.panAngle)}static getTourBurnsStyle(t,e,i){return J.isDelayTransition(t,e,i)?T._y.Delay:e}static getPanDegrees(t,e){let i;return i=(0,n.ht)(t)?-1!==t.getOverrideParam(n.I5,-1)?(0,n.H1)(t):void 0!==e?e:t.tryGetProperty(S.Q$.PanAngle,n.V4):0,Math.max(i,0)}static getPanDirection(t,e){return void 0!==e?e:t.tryGetProperty(S.Q$.PanDirection,D.ek)}static getDelayDuration(t){return-1!==t.getOverrideParam(n.R8,-1)||0===t.getOverrideParam(n.Yh,-1)?(0,n.Lh)(t):n.DE}static getZoomDuration(t){return-1!==t.getOverrideParam(n.R8,-1)?(0,n.Lh)(t):t.tryGetProperty(S.Q$.ZoomDuration,n.cS)}static getPanRadiansPerMs(t,e,i){if(-1!==t.getOverrideParam(n.R8,-1)){const e=(0,n.Lh)(t);return e>0?i/e:0}const s=e?t.tryGetProperty(S.Q$.DollhousePanSpeed,n.lo):t.tryGetProperty(S.Q$.PanSpeed,n.BU);return(0,I.rX)(s)}static getPanValues(t,e,i,s){const o=J.getPanDirection(t,i),a=J.getPanDegrees(t,s),r=(0,b.pu)(a),h=J.getPanRadiansPerMs(t,e,r);let l=h>0?r/h:0;return e&&void 0===s&&(l=(0,n.Lh)(t)),{degrees:a,radiansPerMs:h,ms:l,direction:o}}static getTransitionSpeed(t){if(-1!==t.getOverrideParam("wts",-1))return t.tryGetProperty(n._V,n.aS);const e=t.tryGetProperty(S.Q$.TransitionSpeed,n.Dj);return(0,I.f7)(e/1e3)}static getTransitionTime(t){const e=t.tryGetProperty(S.Q$.TransitionTime,n.VD);return Math.min(Math.max(n.K1,e),n.s$)}static getOtherModeTransitionTime(t,e,i){if(i===c.fl.FadeToBlack){return J.getTransitionTime(t)+n.IT}let s=n.BS,o=n.uO;if(-1===t.getOverrideParam("wts",-1)){const e=1e3*J.getTransitionSpeed(t);s=Math.sqrt(2*(e-n.g$))+45,e!==n.Dj&&(o=n.Jb)}const a=1e3*e/(b.fy*s);return Math.max(a,o)}static getSamePanoTransitionTime(t,e){const i=t.tryGetProperty(S.Q$.PanSpeed,n.BU);if(i===n.BU)return Math.max(1e3*e/(b.fy*n.Md),n.fi);{const t=(0,w.m9)(i,n.Ih,n.at,n.mf,n.QR),s=(0,I.rX)(t);return s>0?e/s:0}}getFloorTransition(t){const e=this.tourData.getTourSnapshotSid(t),i=this.tourData.getSnapshot(e);if(!i){return new P(t)}return new $(this.issueCommand,(()=>this.floorsViewData.currentFloorId)).start({targetSnapshot:i},t)}getMainTransition(t,e){const i=this.tourData.getTourSnapshotSid(t),s=this.tourData.getSnapshot(i);if(!s){return new P(t)}let n=null;if(e===c.fl.Interpolate){const e=s.metadata.cameraQuaternion,i=this.walkingPath.getValidWalkingPath(s);if(i){const s=i.map((t=>t.position)),o=this.pathOrientHelper.getOrientationsForPath(s,(0,w.V5)(e));n=i.length>2?new H(this.settingsData,this.cameraData.pose,this.cameraData.transition,this.sweepData.transition,this.sweepModule,this.cameraPoseController,this.engine,this.setRestrictedSweeps,this.getCurveForPath).start({path:i,orientations:o},t):new N(this.settingsData,this.cameraData.pose,this.moveToSweep,this.updateTransitionSpeed,this.setRestrictedSweeps,this.engine).start({path:i,orientations:o},t)}}else if(e===c.fl.Instant){const e=this.sweepData.currentSweep;n=new W(this.moveToSweep,this.viewmodeData,this.cameraPoseController,this.switchToMode).start({snapshot:s,currentSweep:e},t)}if(!n){const i=this.sweepData.currentSweep;n=new U(this.settingsData,this.cameraData.pose,this.viewmodeData,this.cameraPoseController,this.sweepModule,this.switchToMode,this.setRestrictedSweeps,this.engine).start({snapshot:s,currentSweep:i,transitionType:e},t)}return n}getBurnsTransition(t,e,i){const s=this.tourData.getTourSnapshotSid(t),n=(t+1)%this.tourData.getSnapshotCount(),o=this.tourData.getTourSnapshotSid(n),a=this.tourData.getTourStop(s),r={};a.reelEntry&&a.reelEntry.overrides&&(r.panDirection=a.reelEntry.overrides.panDirection,r.panAngle=a.reelEntry.overrides.panAngle);const h=this.tourData.getSnapshot(o);let l=new P(t);switch(e){case T._y.Pan:if(h){const e=this.walkingPath.getValidWalkingPath(h);l=new q(this.settingsData,this.cameraData.pose,this.startRotateTransition,this.stopCamera,this.getCurveForPath).start({path:e,snapshot:a.snapshot,nextSnapshot:h,panOverrides:r},t,i)}l.type===T.gX.Nop&&(l=new L(this.settingsData,this.startRotateTransition,this.stopCamera).start({snapshot:a.snapshot,nextSnapshot:h,panOverrides:r},t,i));break;case T._y.PanDollhouse:l=new X(this.settingsData,this.startRotateTransition,this.stopCamera).start({snapshot:a.snapshot,nextSnapshot:h,panOverrides:r},t,i);break;case T._y.Zoom:l=new M(this.startZoomTransition,this.stopCamera,J.getZoomDuration(this.settingsData)).start({duration:i},t);break;case T._y.Delay:const e=J.getDelayDuration(this.settingsData);l=new C(e).start({duration:i},t);break;case T._y.None:l=new P(t);break;default:throw Error("unhandled TourBurnsStyle")}return l}}var tt=i(8333),et=i(78763),it=i(68930),st=i(35447),nt=i(47737);const ot=5;class at extends o.n{constructor(){super(...arguments),this.name="tours-controls",this.getBurnsStyleForSnapshot=(t,e)=>{const i=this.data,s=i.getTourSnapshotSid(t),n=i.getTourStop(s),o=i.getSnapshotCount();if(!n||!n.snapshot)return T._y.None;if(t===o-1&&this.isLastStopStatic(e))return this.toursViewData.getTourStoryMode()?T._y.Delay:T._y.None;const r=n.snapshot.metadata.cameraMode,h=r===a.N3.Dollhouse?T._y.PanDollhouse:r===a.N3.Floorplan?T._y.Zoom:T._y.Pan;return J.getTourBurnsStyle(this.settingsData,h,e)},this.canChangeTourLocation=()=>{const t=this.data.getTourState(),e=this.data.isTourTransitionActive(),i=this.cameraData.canTransition();return t===r.Ci.Inactive&&!e&&!(this.viewmodeData.transition&&this.viewmodeData.transition.active)&&i}}async init(t,e){this.engine=e,[this.cameraData,this.viewmodeData,this.settingsData,this.data,this.toursViewData]=await Promise.all([e.market.waitForData(y.M),e.market.waitForData(d.X),e.market.waitForData(v.o),e.market.waitForData(h.R),e.market.waitForData(l.F)]);const i=await e.market.waitForData(nt.P);e.getModuleBySymbol(Z.mL).then((t=>{t.registerHandler(p.CD,(()=>{this.handleTourInputInterrupt()})),t.registerHandler(m.s,(()=>{this.handleTourInputInterrupt()}))})),this.transitionFactory=new J(e,this.data,this.cameraData,this.settingsData,this.viewmodeData),await this.transitionFactory.init(),this.setupAutoPlay(e),this.bindings.push(e.commandBinder.addBinding(et.mT,(async t=>this.startTour(t.index,t.steps,t.loop)))),this.bindings.push(e.commandBinder.addBinding(et.IP,(async t=>this.stopTour(t.willResume)))),this.bindings.push(e.commandBinder.addBinding(et.OR,(async t=>this.tourGoTo(t.index,t.instant?c.fl.Instant:void 0)))),this.bindings.push(e.commandBinder.addBinding(et.Qn,(async t=>t.forward?this.tourGoNext(t.instant):this.tourGoPrevious(t.instant)))),this.bindings.push(e.commandBinder.addBinding(et.FU,(async t=>{const e=this.data.tourPlaying;try{e&&await this.stopTour(!0),await this.tourGoNext(!1),e&&await this.startTour()}catch(t){this.log.debug(t)}}))),this.bindings.push(e.commandBinder.addBinding(et.jL,(async t=>{const e=this.data.tourPlaying;try{e&&await this.stopTour(!0),await this.tourGoPrevious(!1),e&&await this.startTour()}catch(t){this.log.debug(t)}}))),this.bindings.push(i.onPropertyChanged("currentViewId",(()=>this.stopTour(!1))))}handleTourInputInterrupt(){this.data.getTourState()!==r.Ci.Inactive&&this.stopTour()}canTourProceed(t,e,i){const s=this.data.getSnapshotCount();if(0===s||0===i||this.data.getTourState()!==r.Ci.Inactive)return!1;if(void 0!==e){if(e<-1)return!1;if(!0!==t&&e>s-1)return!1}return!0}shouldTourContinue(t,e,i,s){return void 0!==s?i<s:e<t-1}startTour(t,e,i){if(!this.canChangeTourLocation())throw new it.r("Cannot start tour at this time, another transition is active");const n=void 0!==i?i:this.data.isLooping();if(!this.canTourProceed(n,t,e))return;this.data.setLooping(n);const o=this.data.getActiveReelTourMode(),a=(0,st.Kl)(this.settingsData,o),h=this.data.getTourCurrentSnapshotIndex(),l=this.data.getSnapshotCount(),d=this.data.transition,c=h===l-1&&(T.h9.includes(d.type)||!a)&&d.toIndex===l-1&&d.stopped-d.started>=d.duration;let p,m=0;p=void 0!==t?t-1:c?-1:Math.max(h-1,-1);const g=this.settingsData.tryGetProperty(tt.Oe,null);this.settingsData.setProperty(tt.Oe,null);const f=this;this.tourGenerator=function*(){for(;f.shouldTourContinue(l,p,m,e);){const t=p+1,e=f.composeTourTransition(t);yield new s.sv(e),p=t,p===l-1&&n&&(p=-1),m++}f.stopTour(),f.settingsData.setProperty(tt.Oe,g)},this.engine.startGenerator(this.tourGenerator),this.data.setTourState(r.Ci.Active),this.data.tourEnded=!1,this.data.tourWillResume=!1,this.data.tourPlaying=!0,this.data.commit(),this.engine.broadcast(new u.zM)}async composeTourTransition(t,e,i){var s,o,h;const l=this.data.getTourSnapshotSid(t),d=this.data.getTourStop(l);if(!d.snapshot)throw Error(`Highlight not found for reel index ${t}`);const p=this.data.getTourCurrentSnapshotSid()===l,m=this.cameraData.transition.startTime>this.data.transition.stopped;let g=0;const f=this.data.transition.duration;if(p){const{started:t,stopped:e}=this.data.transition;g=(e-t)/f||0,g=Math.min(1,g)}if(m||!p){let e=this.settingsData.tryGetProperty(D.zk,c.fl.Interpolate);const n=d.snapshot.metadata.cameraMode,h=n===a.N3.Dollhouse||n===a.N3.Floorplan,l=(0,a.nI)(n),p=!this.viewmodeData.isInside()&&l,m=this.viewmodeData.isInside()&&h,g=!this.viewmodeData.isInside()&&h,f=this.viewmodeData.isInside()&&l;(p||m||g)&&(e=c.fl.Interpolate),void 0!==(null===(o=null===(s=d.reelEntry)||void 0===s?void 0:s.overrides)||void 0===o?void 0:o.transitionType)&&(e=d.reelEntry.overrides.transitionType),f&&0===t&&(e=c.fl.FadeToBlack),void 0!==i&&(e=i),this.engine.broadcast(new u.zb(t));const v=this.transitionFactory.getFloorTransition(t);if(this.data.useTransition(v),await v.promise,this.data.getTourState()===r.Ci.StopScheduled)return;const y=this.transitionFactory.getMainTransition(t,e);this.data.useTransition(y),await y.promise,this.data.setTourCurrentSnapshotByIndex(t),this.engine.broadcast(new u.n1(t))}if(this.data.getTourState()===r.Ci.StopScheduled)return;const v={};(null===(h=d.reelEntry)||void 0===h?void 0:h.overrides)&&(v.panAngle=d.reelEntry.overrides.panAngle,v.panDirection=d.reelEntry.overrides.panDirection);const y=e||this.getBurnsStyleForSnapshot(t,v);let b;if(this.toursViewData.getTourStoryMode()){t===this.data.getSnapshotCount()-1&&this.isLastStopStatic(v)&&(b=n.Dw)}g>0&&(b=(1-g)*f);const w=this.transitionFactory.getBurnsTransition(t,y,b);this.engine.broadcast(new u.BW(t,w.type,w.duration)),this.data.useTransition(w),await w.promise}isLastStopStatic(t){const e=J.getPanDirection(this.settingsData,t.panDirection),i=J.getPanDegrees(this.settingsData,t.panAngle),s=this.data.getActiveReelTourMode(),n=(0,st.Kl)(this.settingsData,s);return 0===i||!n&&e===T.ND.Auto}async stopTour(t=!1){this.data.getTourState()===r.Ci.Active&&(this.data.setTourState(r.Ci.StopScheduled),this.data.tourWillResume=t,this.data.tourPlaying=!1,await this.data.stopTourTransition(),this.tourGenerator&&this.engine.stopGenerator(this.tourGenerator),this.engine.broadcast(new u.pT(t)),this.data.getTourCurrentSnapshotIndex()!==this.data.getSnapshotCount()-1||this.data.isLooping()||(this.data.tourEnded=!0,this.engine.broadcast(new u.YH)),this.data.setTourState(r.Ci.Inactive),this.data.commit())}async tourGoNext(t){let e=this.data.getTourCurrentSnapshotIndex()+1;e>=this.data.getSnapshotCount()&&(e=0);const i=t?c.fl.Instant:void 0;return this.tourGoTo(e,i)}async tourGoPrevious(t){let e=this.data.getTourCurrentSnapshotIndex();e<0&&(e=0);let i=e-1;i<0&&(i=this.data.getSnapshotCount()-1);const s=t?c.fl.Instant:void 0;return this.tourGoTo(i,s)}async tourGoTo(t,e=c.fl.FadeToBlack){if(!this.canChangeTourLocation())throw new it.K("Cannot change tour location at this time, another transition is active");if(this.viewmodeData.transition&&this.viewmodeData.transition.active)throw new it.K("Cannot go to tour location during viewmode transition");if(this.data.getTourState()!==r.Ci.Inactive)throw new it.K("Cannot jump to tour location while tour is active");try{this.data.setTourState(r.Ci.Active),await this.composeTourTransition(t,T._y.None,e)}catch(t){this.log.error(t)}finally{this.data.setTourState(r.Ci.Inactive)}}setupAutoPlay(t){const e=1e3*(0,n.dJ)(this.settingsData),i=()=>{let t=!0;const i=this.cameraData.pose.onChanged((()=>{t=!1,i.cancel()}));setTimeout((()=>{t&&this.startTour(),i.cancel()}),e)};if(e>=0){const e=t.market.tryGetData(g.zH);if(e&&e.phase===g.Jj.PLAYING)i();else{const e=s=>{s.phase===g.Jj.PLAYING&&(i(),t.unsubscribe(f.uv,e))};t.subscribe(f.uv,e)}}}}},62140:(t,e,i)=>{"use strict";i.r(e),i.d(e,{HighlightReel:()=>v,ToggleForceShowStoryTextCommand:()=>G.CL,ToggleHighlightReelOpenCommand:()=>G.CQ,TourAddPosition:()=>k.dO,TourChangeDescriptionCommand:()=>G.w7,TourChangeTitleCommand:()=>G.W2,TourData:()=>s.R,TourMode:()=>k.cR,TourRenameCommand:()=>G.qt,TourSetTourModeCommand:()=>G.zd,TourState:()=>k.Ci,ToursViewData:()=>n.F,default:()=>tt});var s=i(21875),n=i(44481),o=i(75578),a=i(25316),r=i(2993),h=i(62372),l=i(2812),d=i(56208),c=i(15580),u=i(20968),p=i(93327),m=i(10843),g=i(12554),f=i(85616);class v extends f.v{constructor(t){super(),this.reel=(0,g.Z)([]),this.modified=new Date,this.mode=t,this.commit()}replace(t){this.atomic((()=>{this.sid=t.sid,this.reel.replace(Array.from(t.reel.values())),this.mode=t.mode,this.modified=t.modified}))}}var y=i(13893),b=i(1333),w=i(25481),D=i(44094),S=i(74381);const I=new m.Ay("mds-reel-element-serializer"),T={[S.ES.FADE_TO_BLACK]:y.fl.FadeToBlack,[S.ES.INSTANT]:y.fl.Instant,[S.ES.INTERPOLATE]:y.fl.Interpolate},P={[S.Zw.LEFT]:b.ND.Left,[S.Zw.RIGHT]:b.ND.Right,[S.Zw.AUTO]:b.ND.Auto};class E{deserialize(t){var e;if(!t||!(null===(e=null==t?void 0:t.asset)||void 0===e?void 0:e.id))return I.debug("Deserialized invalid highlight reel entry from MDS",t),null;const i=t.overrides,s={},n=(null==i?void 0:i.transitionType)?T[null==i?void 0:i.transitionType]:void 0,o=(null==i?void 0:i.panDirection)?P[null==i?void 0:i.panDirection]:void 0,a=null==i?void 0:i.panAngle;(0,D.s)(n)&&(s.transitionType=n),(0,D.s)(o)&&(s.panDirection=o),(0,w.Et)(a)&&(s.panAngle=a);const r={sid:t.asset.id,overrides:s};return t.title&&(r.title=t.title),t.description&&(r.description=t.description),r}}const C=new m.Ay("mds-highlight-reel-serializer");class M{constructor(t){this.defaultTourMode=t,this.reelEntrySerializer=new E}deserialize(t){if(!t||!this.validate(t))return C.debug("Deserialized invalid active reel data from MDS",t),null;const e=new v(t.mode||this.defaultTourMode);if(e.sid=t.id,t.reel)for(const i of t.reel){if(!i)continue;const t=this.reelEntrySerializer.deserialize(i);t&&e.reel.push(t)}return e}validate(t){return["id"].every((e=>e in t))}}const x={[y.fl.FadeToBlack]:S.ES.FADE_TO_BLACK,[y.fl.Instant]:S.ES.INSTANT,[y.fl.Interpolate]:S.ES.INTERPOLATE,[y.fl.MoveToBlack]:S.ES.FADE_TO_BLACK,[y.fl.OrbitTo]:S.ES.INTERPOLATE},A={[b.ND.Left]:S.Zw.LEFT,[b.ND.Right]:S.Zw.RIGHT,[b.ND.Auto]:S.Zw.AUTO};class R{serialize(t){const e={id:t.sid};return t.title&&(e.title=t.title),t.description&&(e.description=t.description),t.overrides&&(e.overrides={},void 0!==t.overrides.transitionType&&(e.overrides.transitionType=x[t.overrides.transitionType]),void 0!==t.overrides.panDirection&&(e.overrides.panDirection=A[t.overrides.panDirection]),void 0!==t.overrides.panAngle&&(e.overrides.panAngle=t.overrides.panAngle)),e}}const L=new m.Ay("mds-highlight-reel-store");class O extends u.g{constructor(t,e,i){super(t),this.baseModelId=i,this.serializer=new R,this.prefetchKey="data.model.activeHighlightReel",this.deserializer=new M(e)}async read(t={}){var e;const i={modelId:null!==(e=null==t?void 0:t.modelId)&&void 0!==e?e:this.getViewId(),prefetchKey:this.prefetchKey};return this.query(p.GetHighlightReel,i,t).then((t=>{var e,i;const s=null===(i=null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.model)||void 0===i?void 0:i.activeHighlightReel;return this.deserializer.deserialize(s)}))}async update(t){const e=this.getViewId(),i=t.reel.map((t=>this.serializer.serialize(t))),s=t.mode;return this.mutate(p.PutActiveReel,{modelId:e,elements:i,mode:s}).then((async t=>{L.debug(t)}))}async fetchAllTourSweeps(){var t,e;const i={modelId:this.baseModelId},s=null===(e=null===(t=(await this.query(p.GetHighlightReelSweeps,i,{fetchPolicy:"no-cache"})).data)||void 0===t?void 0:t.model)||void 0===e?void 0:e.views,n=[];return s&&s.forEach((t=>{var e,i;const s=null===(i=null===(e=t.model)||void 0===e?void 0:e.activeHighlightReel)||void 0===i?void 0:i.reel;s&&s.forEach((e=>{var i,s,o;const a=null===(o=null===(s=null===(i=e.asset)||void 0===i?void 0:i.snapshotLocation)||void 0===s?void 0:s.anchor)||void 0===o?void 0:o.id;a&&n.push({viewId:t.id,sweepId:a})}))})),n}}var F=i(2391),B=i(45395),V=i(15404),N=i(81530),k=i(96425),G=i(30217),H=i(35447),_=i(45832),U=i(27947),W=i(68986),z=i(56147),j=i(94547),$=i(84917),X=i(58899),q=i(78763);const{HLR:Y}=z.A.WORKSHOP;class Q extends X.r{constructor(t,e,i,s,n,o){if(super(t,void 0,e),this.reelEntry=i,this.index=s,this.tourMode=n,this.locale=o,this.id=this.reelEntry.id,this.title=this.reelEntry.title||"",this.description=this.reelEntry.description||"",this.icon="icon-toolbar-hlr",this.typeId=S.jM.HIGHLIGHTREEL,this.floorId="",this.roomId="",this.dateBucket=(0,$.n)(this.reelEntry.snapshot.created),this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new q.OR(this.index)),this.tourMode===k.cR.STORIES?await this.commandBinder.issueCommand(new G.CL(!0)):this.commandBinder.issueCommand(new G.CQ(!0))},n===k.cR.STORIES){const t=!!i.title,e=!!i.snapshot.name;this.title=t&&e?i.snapshot.name+" - "+i.title:t||e?i.title?i.title:i.snapshot.name:this.getDefaultName()}else this.title=i.snapshot.name?i.snapshot.name:this.getDefaultName(),this.description="";this.imgUrl=this.reelEntry.snapshot.thumbnailUrl}supportsBatchDelete(){return!1}getDefaultName(){return this.locale.t(Y.SEARCH_HIGHLIGHT_DEFAULTNAME)+" "+(this.index+1)}}const{HLR:Z}=z.A.WORKSHOP;var K=i(87743),J=i(47737);class tt extends o.n{constructor(){super(...arguments),this.name="tours-data",this.defaultModes=[r.N3.Panorama,r.N3.Outdoor],this.fetchAllTourSweeps=async()=>{const t=await this.store.fetchAllTourSweeps();return this.viewData.setSweepsInToursAcrossViews(t),t},this.query=async t=>this.store.read(t),this.updateTourMode=()=>{this.viewData.currentTourMode=this.getCurrentTourMode(),this.viewData.setTourModeSetting(this.getTourModeSetting()),this.viewData.commit()},this.closeReelIfEmpty=()=>{0===this.tourData.getSnapshotCount()&&this.viewData.reelOpen&&this.toggleReel(!1)},this.saveTourModeChange=async t=>{const{tourMode:e}=t;e===k.cR.STORIES?this.tourData.setActiveReelTourMode(S.UR.STORY):e===k.cR.LEGACY&&this.tourData.setActiveReelTourMode(S.UR.REEL),this.updateTourMode()},this.onToggleReel=async t=>{this.toggleReel(t.open)},this.onForceShowStoryText=async t=>{this.engine.broadcast(new K.lz)},this.onUpdateSnapshots=()=>{this.tourData.updateSnapshots(this.snapshotsData.collection)}}async init(t,e){const{readonly:i,baseUrl:o,storyToursFeature:r,baseModelId:c}=t;this.engine=e,this.config=t;const[u,p,m,g,f]=await Promise.all([e.market.waitForData(a.o),e.market.waitForData(h.A),e.market.waitForData(l.O),e.market.waitForData(J.P),e.market.waitForData(U.zH)]);this.settingsData=u,this.appData=f,this.snapshotsData=m;const y=r?S.UR.STORY:S.UR.REEL;if(this.tourData=new s.R(this.snapshotsData.collection,new v(y),(()=>this.getFilterModes(this.defaultModes.slice())),p.isSweepDisabled,t.looping,this.log),this.viewData=new n.F(this.tourData,this.getTourModeSetting(),this.getCurrentTourMode()),!1===i){const t=await e.getModuleBySymbol(_.T9),i=this.tourData.getReel();this.monitor=new F.V(i,{aggregationType:B.D.NextFrame},e),this.monitor.onChanged((()=>{this.monitor.hasDiffRecord()&&this.engine.commandBinder.issueCommand(new N.F({dataTypes:[V.p.HIGHLIGHTS]}))})),this.bindings.push(t.onSave((()=>this.save()),{dataType:V.p.HIGHLIGHTS}),t.onSave((()=>this.fetchAllTourSweeps()),{dataType:V.p.SWEEPS})),this.bindings.push(e.commandBinder.addBinding(G.zd,this.saveTourModeChange),this.settingsData.onPropertyChanged(d.Q$.TourButtons,this.updateTourMode),this.settingsData.onPropertyChanged(d.Q$.HighlightReel,this.updateTourMode))}const b=()=>this.tourData.updateEnabledStops(this.getFilterModes(this.defaultModes.slice()));this.bindings.push(this.appData.onChanged((()=>b())),this.settingsData.onPropertyChanged(d.Q$.Dollhouse,(()=>b())),this.settingsData.onPropertyChanged(d.Q$.FloorPlan,(()=>b()))),this.store=new O({context:g.mdsContext,readonly:i,baseUrl:o},y,c),this.bindings.push(this.store.onNewData((async t=>{this.tourData.atomic((()=>{var e;const i=this.tourData.getActiveReelTourMode();this.tourData.setHighlightReel(t||new v(i)),null===(e=this.monitor)||void 0===e||e.clearDiffRecord()})),this.updateTourMode(),this.closeReelIfEmpty()}))),await this.store.refresh(),this.bindings.push(e.commandBinder.addBinding(G.CQ,this.onToggleReel),e.commandBinder.addBinding(G.CL,this.onForceShowStoryText),this.snapshotsData.onChanged(this.onUpdateSnapshots)),async function(t,e,i){const s=await t.market.waitForData(U.zH),n=await t.getModuleBySymbol(_.gS),o=(s,o,a,r=[])=>{const h=[],l=e.getCurrentTourState().highlights,d=i.currentTourMode;if(r.length>0||d===k.cR.NONE)return h;const c=d===k.cR.STORIES;let u=0;return l.forEach((e=>{const i=e.title&&c?e.title:n.t(Z.SEARCH_HIGHLIGHT_DEFAULTNAME)+" "+(u+1);if(s(i)||e.snapshot.name&&s(e.snapshot.name)||c&&e.description&&s(e.description)){const i=new Q(t.commandBinder,o,e,u,d,n);h.push(i)}u++})),h},a=t=>new W.P(e.onChanged(t),i.onTourModeSettingChanged(t)),r=()=>{t.commandBinder.issueCommandWhenBound(new j.Oc({id:S.jM.HIGHLIGHTREEL,groupPhraseKey:Z.SEARCH_TOUR_HEADER,getSimpleMatches:o,registerChangeObserver:a,groupOrder:10,groupIcon:"toolbar-hlr",batchSupported:!1}))},h=()=>{t.commandBinder.issueCommandWhenBound(new j.tf(S.jM.HIGHLIGHTREEL))},l={renew:r,cancel:h},d=t=>{h(),r()},c=s.onPropertyChanged("application",d);d(s.application),new W.P(l,c)}(e,this.tourData,this.viewData),e.market.register(s.R,this.tourData),i?e.market.register(n.F,this.viewData):this.fetchAllTourSweeps().then((()=>{e.market.register(n.F,this.viewData)}))}dispose(t){this.store.dispose(),super.dispose(t)}async save(){if(!this.monitor||this.config.readonly)return void this.log.warn("Tour changes will NOT be saved");const t=this.tourData.getReel();await this.store.update(t),this.fetchAllTourSweeps(),this.monitor.clearDiffRecord()}getCurrentTourMode(){return(0,H.v)(this.settingsData,this.tourData.getActiveReelTourMode())}getTourModeSetting(){return(0,H.EI)(this.settingsData,this.tourData.getActiveReelTourMode())}toggleReel(t){t?this.engine.broadcast(new K.Yg):this.engine.broadcast(new K.e0),this.viewData.reelOpen=t,this.viewData.commit()}getFilterModes(t){const e=this.appData.application===U.lg.WORKSHOP;return(e||this.settingsData.tryGetProperty(c.n9,!1))&&t.push(r.N3.Dollhouse),(e||this.settingsData.tryGetProperty(c._z,!1))&&t.push(r.N3.Floorplan),t}}},88545:(t,e,i)=>{"use strict";i.r(e),i.d(e,{RecorderState:()=>c,default:()=>m});var s=i(6539),n=i(45832),o=i(75578),a=i(78763),r=i(22937),h=i(64491),l=i(64124);class d{constructor(){this._dateNow=Date.now,this._performanceNow=performance.now,this.nowOverride=0}slowTime(t){this.fps=t,this.nowOverride=Date.now(),Date.now=()=>this.nowOverride,performance.now=()=>this.nowOverride}tick(){this.nowOverride+=1e3/this.fps}resetTime(){Date.now=this._dateNow,performance.now=this._performanceNow}}var c,u=i(97573),p=i(48734);!function(t){t[t.STOPPED=0]="STOPPED",t[t.RECORDING=1]="RECORDING"}(c||(c={}));class m extends o.n{constructor(){super(...arguments),this.name="video-recorder-module",this.state=c.STOPPED,this.frostMage=new d}get currentState(){return this.state}async init(t,e){this.settingsModule=await e.getModuleBySymbol(s.ZF),this.canvasModule=await e.getModuleBySymbol(n.CE),this.engine=e,this.engine.diContainer.bindConstant("$FrostMage",this.frostMage),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 1080p @ 60",(()=>{this.state===c.STOPPED&&this.record(1920,1080,60)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 720p @ 30",(()=>{this.state===c.STOPPED&&this.record(1280,720,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram",(()=>{this.state===c.STOPPED&&this.record(1080,1080,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram story",(()=>{this.state===c.STOPPED&&this.record(1080,1920,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Stop & download current",(()=>{this.state===c.RECORDING&&this.stop()}))}async record(t,e,s){if(this.state!==c.STOPPED)return void this.log.warn("Can't start recording... we're already recording!");this.log.info("Starting recording of tour. Now is a good time to get a coffee :)"),this.state=c.RECORDING;const n=await Promise.all([i.e(287),i.e(504),i.e(780)]).then(i.bind(i,34649));this.encoder=new n.WebMWriter({quality:.95,frameRate:s}),this.frostMage.slowTime(s),await this.engine.commandBinder.issueCommand(new l.E({resizeDimensions:[{property:l.U.width,setDimension:t,duration:0},{property:l.U.height,setDimension:e,duration:0}]})),await this.engine.commandBinder.issueCommand(new a.mT);const o=this.engine.subscribe(r.pT,(()=>{o.cancel(),this.state===c.RECORDING&&this.stop()})),h=this,d=this.canvasModule.element;this.engine.startGenerator((function*(){for(;h.state===c.RECORDING;)h.encoder.addFrame(d),yield new p.oN,h.frostMage.tick(),yield new p.oN}))}async stop(){if(this.state!==c.RECORDING)return void this.log.warn("Can't stop recording, we weren't recording at all");this.frostMage.resetTime(),this.state=c.STOPPED,await this.engine.commandBinder.issueCommand(new l.E((0,u.EH)(0))),this.log.info("Encoding tour to video...");const t=await this.encoder.complete();this.log.info("Tour encoded! Prompting user to download."),(0,h.x_)(t,"tour.webm")}}},25647:(t,e,i)=>{"use strict";i.r(e),i.d(e,{default:()=>bt});var s=i(68909),n=i(75578),o=i(45832),a=i(68986),r=i(53172),h=i(86866),l=i(81662),d=i(20599),c=i(5243),u=i(10574),p=i(76318),m=i(99583),g=i(46793),f=i(94790),v=i(19968);const y=new s.Vector3(0,-100,0),b=new s.Vector2(-2,-2),w=new s.Vector3(-1,-1,-1),D=new s.Vector3(1,1,1);class S{constructor(t){this.raycaster=t,this.currentRay=new s.Ray,this.origin=y,this.direction=new s.Vector3,this.pointerNdc=b,this.cameraCache={position:new s.Vector3,quaternion:new s.Quaternion,camera:void 0},this.cast=t=>{const e=this.currentRay,i=this.raycaster.cast(e.origin,e.direction,t).slice();return i.length&&(this.lastHit=i[0]),i},this.update3D=(t,e,i)=>{t instanceof s.Vector3&&this.origin.copy(t),e instanceof s.Vector3&&this.direction.copy(e),this.cameraCache.camera=i,this.currentRay.set(this.origin,this.direction)},this.updateNDCPosition=()=>{const t=this.lastHit;if(this.cameraCache.camera&&t&&t.point){const e=this.cameraCache.camera;this.cameraCache.position.setFromMatrixPosition(e.matrixWorld),this.cameraCache.quaternion.setFromRotationMatrix(e.matrixWorld);const i=(0,v.jn)(t.point,this.cameraCache.position,this.cameraCache.quaternion,e.projectionMatrix);i.clamp(w,D),this.pointerNdc.set(i.x,i.y)}},this.updatePointer=()=>{}}get pointerRay(){return this.currentRay}get ndcPosition(){return this.updateNDCPosition(),this.pointerNdc}}var I=i(89103);class T extends I.QB{}class P extends T{constructor(t){super(),this.trackedCamera=t}}class E extends T{}class C extends T{}var M,x=i(86721),A=i(39417),R=i(36476);!function(t){t[t.Mono=0]="Mono",t[t.Stereo=1]="Stereo",t[t.SixDof=2]="SixDof",t[t.__length=3]="__length"}(M||(M={}));const L={controllers:Object.freeze([0,1]),rotationDegrees:25};var O;!function(t){t[t.touchpadX=0]="touchpadX",t[t.touchpadY=1]="touchpadY",t[t.thumbstickX=2]="thumbstickX",t[t.thumbstickY=3]="thumbstickY"}(O||(O={}));const F=new class{constructor(t=!0){this.values=new Map,t&&this.show()}show(){if(this.debugDiv)return;this.debugDiv=document.createElement("div");const t=this.debugDiv.style;t.fontFamily="monospace",t.position="fixed",t.backgroundColor="#aa11aa",t.left="20px",t.top="20px",t.zIndex="999899",t.pointerEvents="none",t.touchAction="none",document.body.appendChild(this.debugDiv),this.drawValues()}hide(){this.debugDiv&&(document.body.removeChild(this.debugDiv),this.debugDiv=void 0)}logValue(t,e){this.values.set(t,e),this.drawValues()}logMaxValue(t,e){this.values.has(t)?e>this.values.get(t)&&this.logValue(t,e):this.logValue(t,e)}logVector2(t,e){this.logValue(t,`(${e.x}, ${e.y})`)}logVector3(t,e){this.logValue(t,`(${e.x}, ${e.y}, ${e.z})`)}logVector4(t,e){this.logValue(t,`(${e.x}, ${e.y}, ${e.z} ${e.w})`)}logPose(t,e){this.logVector3(t+"-pos",e.position),this.logVector4(t+"-rot",e.rotation),this.logValue(t+"-focalDist",e.focalDistance)}showPt(t){if(this.pointDiv)this.pointDiv.style.left=`${t.x}px`,this.pointDiv.style.top=`${t.y}px`;else{this.pointDiv=document.createElement("div");const e=this.pointDiv.style;e.position="fixed",e.width="8px",e.height="8px",e.backgroundColor="#aaffaa",e.left=t.x-4+"px",e.top=t.y-4+"px",e.zIndex="99999",e.pointerEvents="none",e.touchAction="none",document.body.appendChild(this.pointDiv)}}drawValues(){if(!this.debugDiv)return;let t="";for(const[e,i]of this.values.entries())t+=`${e}: ${i}<br>`;this.debugDiv.innerHTML=t}},B={x:0,y:0,z:0,w:1};let V=0;class N extends A.Q{constructor(t,e,i,n,o=!1){super(),this.renderer=t,this.webglScene=e,this.cameraData=i,this.cameraModule=n,this.DEBUG=o,this.trackingStyle=M.Stereo,this.session=null,this.baseReferenceSpace=null,this.cameraRig=null,this.rotations={initialYawOffset:new s.Quaternion,yawOffset:new s.Quaternion,invYawOffset:new s.Quaternion,trackingOffset:new s.Quaternion},this.player={vrCameraRef:new s.Vector3,rigPos:new s.Vector3,offset:new s.Vector3,orientation:new s.Quaternion,leftEye:new s.Vector3,rightEye:new s.Vector3,centerEye:new s.Vector3,neckOffset1:new s.Vector3,neckOffset2:new s.Vector3,ipd:0,localHeightOffset:null},this.setTrackingStyle=(t,e=!0)=>{t<M.__length&&(this.trackingStyle=t,e&&this.resetInitialRotation())},this.offsetRotation=t=>{this.rotations.invYawOffset.multiply(t),this.rotations.yawOffset.copy(this.rotations.invYawOffset).invert()},this.resetPlayerYOffset=()=>{this.player.localHeightOffset=null},this.onPresentStart=(t,e)=>{if(t.cameras[0].layers.mask=R.H.ALL.mask,t.cameras[1].layers.mask=R.H.ALL.mask,t.cameras[0].far=t.far,t.cameras[1].far=t.far,t.layers.mask=R.H.ALL.mask,this.resetInitialRotation(),this.resetPlayerYOffset(),this.baseReferenceSpace=this.renderer.xr.getReferenceSpace(),this.baseReferenceSpace){const t=this.getReferenceSpace(e,this.webglScene.cameraRig,this.baseReferenceSpace);this.renderer.xr.setReferenceSpace(t)}this.broadcast(new E)},this.resetInitialRotation=()=>{const t=this.cameraData.pose.rotation.clone();(0,h.Vs)(t,this.rotations.initialYawOffset),this.rotations.yawOffset.copy(this.rotations.initialYawOffset),this.rotations.invYawOffset.copy(this.rotations.initialYawOffset).invert()},this.onPresentEnd=()=>{this.baseReferenceSpace=null,this.renderer.xr.setReferenceSpace(null),this.webglScene.cameraRig.reset(),this.broadcast(new C)},this.onUpdate=()=>{this.frame&&this.session&&this.baseReferenceSpace&&(this.cameraModule.updateCameraRotation(this.rotations.trackingOffset),this.webglScene.beforeRender(),this.cameraRig=this.webglScene.cameraRig)},this.applyTrackingOverrides=(t,e,i)=>{if(t.xr.isPresenting&&i instanceof s.ArrayCamera){t.clear();const e=t.xr.getCamera(),i=e.cameras[0],s=e.cameras[1];if(this.frame=this.renderer.xr.getFrame(),!this.session&&this.frame&&(this.session=t.xr.getSession(),this.onPresentStart(e,this.frame)),this.frame&&this.session&&this.baseReferenceSpace){if(this.rotations.trackingOffset.copy(this.rotations.yawOffset).multiply(e.quaternion),this.cameraRig){const t=this.getReferenceSpace(this.frame,this.cameraRig,this.baseReferenceSpace);this.renderer.xr.setReferenceSpace(t)}if(this.trackingStyle===M.Mono)s.matrixWorld.copy(i.matrixWorld),s.matrixWorldInverse.copy(s.matrixWorld),s.matrixWorldInverse.invert();this.broadcast(new P(e))}}else this.session&&(this.session=null,this.onPresentEnd())},this.getReferenceSpace=(t,e,i)=>{if(!e)return i;const s=this.renderer.xr.getCamera();this.player.rigPos.copy(e.position),this.player.vrCameraRef.copy(s.position),this.player.offset.copy(s.position).sub(e.position),this.DEBUG&&(F.logValue("xr.tracking",M[this.trackingStyle]),F.logVector3("xr.cameraRig.position",this.player.rigPos),F.logVector3("xr.cameraVR",s.position),F.logVector3("xr.cameraVR offset",this.player.offset));const n=t.getViewerPose(i),o=(null==n?void 0:n.views[0].transform.position)||B,a=(null==n?void 0:n.views[1].transform.position)||B,r=(null==n?void 0:n.views[0].transform.orientation)||B;this.player.leftEye.set(o.x,o.y,o.z),this.player.rightEye.set(a.x,a.y,a.z),this.player.orientation.set(r.x,r.y,r.z,r.w),this.player.ipd=this.player.leftEye.distanceTo(this.player.rightEye);const h=new DOMPointReadOnly((o.x+a.x)/2,(o.y+a.y)/2,(o.z+a.z)/2);this.player.centerEye.set(h.x,h.y,h.z),this.player.neckOffset1.copy(l.B1.BACK).applyQuaternion(this.player.orientation).multiplyScalar(this.player.ipd/2),this.player.neckOffset2.copy(l.B1.DOWN).applyQuaternion(this.player.orientation).multiplyScalar(this.player.ipd/2);const d=this.player.centerEye.add(this.player.neckOffset1).add(this.player.neckOffset2);this.DEBUG&&(F.logVector3("xr.leftEye",this.player.leftEye),F.logVector3("xr.rightEye",this.player.rightEye),F.logVector3("xr.centerEye",h),F.logVector3("xr.neckPivot",d),F.logValue("xr.ipd",this.player.ipd));let c=B;switch(this.trackingStyle){case M.Mono:c=new DOMPointReadOnly(o.x,o.y,o.z);break;case M.Stereo:c=new DOMPointReadOnly(d.x,d.y,d.z);break;case M.SixDof:null===this.player.localHeightOffset&&(this.player.localHeightOffset=h.y,this.DEBUG&&F.logValue(`xr.localHeightOffset${V}`,`${this.player.localHeightOffset}, ${(new Date).toLocaleString()}`),V=(V+1)%5),c=new DOMPointReadOnly(0,this.player.localHeightOffset,0)}const u=new XRRigidTransform({x:c.x-e.position.x,y:c.y-e.position.y,z:c.z-e.position.z,w:1}),p=i.getOffsetReferenceSpace(u),m=this.rotations.invYawOffset,g=this.cameraData.pose.position,f=new XRRigidTransform({x:g.x,y:g.y,z:g.z,w:1},{x:m.x,y:m.y,z:m.z,w:m.w});return p.getOffsetReferenceSpace(f)},this.webglScene.scene.onBeforeRender=this.applyTrackingOverrides}}var k=i(95330),G=i(95102),H=i(91994),_=i(29628),U=i(52026),W=i(63362),z=i(3956),j=i(62372),$=i(90834),X=i(22299),q=i(32024);const Y=i.p+"images/selected_sweep_glow.png";class Q{get container(){return this._container}constructor(t){this.meshQuery=t,this.active=!1,this.target=new k.L(null),this.previousSweep=null,this.activate=()=>{this.active||(this.updateLoopSub.renew(),this.selectionChangeSub.renew(),this.ray.toggle(!0),this.targetDecoration.toggle(!0),this.active=!0)},this.deactivate=()=>{this.active&&(this.target.value=null,this.selectionChangeSub.cancel(),this.updateLoopSub.cancel(),this.ray.toggle(!1),this.targetDecoration.toggle(!1),this.active=!1)},this.getTargetSweep=(t,e,i)=>{let s=null;if(e.object instanceof z.U)return s=t.getSweep(e.object.userData.sid),s;const n=(0,U.LX)(t,i);if(s=n.length>0?n[0].sweep:null,!s){const i=(0,U.I9)(t,!0,e.intersection,this.meshQuery);s=i.length>0?i[0].sweep:null}return s}}async init(t){this.engine=t,this._container=new s.Group,this._container.name="XRNavigationVisuals",this.ray=new Z(this.container),this.targetDecoration=new K(this.container);const e=await this.engine.market.waitForData(c.$),i=await this.engine.market.waitForData(X.J);return this.updateLoopSub=new a.P(e.onChanged((()=>this.update(e))),i.opacity.onChanged((()=>this.update(e)))),this.updateLoopSub.cancel(),this.selectionChangeSub=this.target.onChanged((t=>{null!==this.previousSweep&&this.engine.commandBinder.issueCommand(new W.WW(this.previousSweep.id,!1,200)),null!==t&&(this.engine.commandBinder.issueCommand(new W.WW(t.id,!0,200)),this.targetDecoration.updateTargetPosition(t.floorPosition)),this.previousSweep=t})),this.selectionChangeSub.cancel(),this}update(t){const e=this.engine.market.tryGetData(j.A),i=this.engine.market.tryGetData(d.M),s=this.engine.market.tryGetData(m.X),n=this.engine.market.tryGetData(X.J),o=this.engine.market.tryGetData($.O);if(!(e&&i&&s&&o&&n))return;if(!o.isVR())return;if(!s.isInside())return;const{hit:a,pointerDirection:r,pointerOrigin:h}=t;if(!a)return;const l=this.getTargetSweep(e,a,r);this.target.value=l,this.ray.update(h,a.point,n.opacity.value),this.targetDecoration.update(i.pose.rotation,n.opacity.value)}}class Z{constructor(t){this.container=t,this.styles={ray:{color:"white",transparent:!0,opacity:.3,linewidth:2,depthWrite:!1},hit:{color:"white",transparent:!0,opacity:.3},hitScale:.02},this.update=(t,e,i)=>{this.ray.updatePositions(t,e).opacity(Math.min(i,this.styles.ray.opacity)),this.hitMarker.position.copy(e),this.hitMarker.material.opacity=Math.min(i,this.styles.hit.opacity)},this.toggle=t=>{t?(this.container.add(...this.ray.children),this.container.add(this.hitMarker)):(this.container.remove(...this.ray.children),this.container.remove(this.hitMarker))};const{ray:e,hit:i}=this.styles,n=(0,H.makeLineMaterial)(e.color,!1,e);this.ray=new _.e(new s.Vector3,new s.Vector3,n,{}),this.ray.updateResolution(window.innerWidth,window.innerHeight),this.hitMarker=new G.m(new s.SphereGeometry(this.styles.hitScale),new s.MeshBasicMaterial(i)),this.hitMarker.name="hit"}}class K{constructor(t){this.container=t,this.styles={scale:.46,animationSpeed:1,plane:{color:"white",transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,map:(0,q.y)(Y)}},this.position=new s.Vector3,this.quaternion=new s.Quaternion,this.updateTargetPosition=t=>{this.position.copy((0,h.$i)(t,l.B1.UP,.05))},this.update=(t,e)=>{const i=(0,h.Vs)(t,this.quaternion);this.target.quaternion.copy(i),this.target.position.lerp(this.position,this.styles.animationSpeed),this.target.material.opacity=Math.min(e,this.styles.plane.opacity)},this.toggle=t=>{t?this.container.add(this.target):this.container.remove(this.target)};const e=new s.PlaneGeometry(1),i=new s.Matrix4;i.makeRotationFromEuler(new s.Euler(-Math.PI/2,0,0,"XYZ")),e.applyMatrix4(i),this.target=new G.m(e,new s.MeshBasicMaterial(this.styles.plane)),this.target.name="Destination",this.target.scale.set(this.styles.scale,this.styles.scale,this.styles.scale)}}class J{constructor(t){this.controllers=t,this._lastInputWas=-1}focus(t){t!==this._lastInputWas&&(L.controllers.forEach((e=>{const i=this.controllers.controller(e);i.grip.visible=e===t,i.hand.visible=e===t,i.handPointer&&(i.handPointer.visible=e===t)})),this._lastInputWas=t)}}var tt=i(3066),et=i(58574),it=i(30386),st=i(50308);class nt{constructor(t,e){this.renderer=t,this.options=e,this._defaultController=0,this.controllerGroups=[],this.bindings=[],this.cancel=()=>{this.bindings.forEach((t=>t.cancel())),this.bindings.length=0},this.container=new s.Group,this.container.name="XRControllerMesh",L.controllers.forEach((t=>{const e=this.createControllerGroup(t);this.controllerGroups.push(e),this.container.add(e.grip,e.pointer,e.hand)})),this.container.matrixAutoUpdate=!1}controller(t=this._defaultController){return this.controllerGroups[t]}setDefault(t){this._defaultController=t}createControllerGroup(t){const e=this.renderer.xr.getController(t);e.name=`Controller Ray ${t}`;const i=this.renderer.xr.getControllerGrip(t);i.name=`Controller Grip ${t}`,i.visible=!1;const s=(new it.XRControllerModelFactory).createControllerModel(i);i.add(s);const n=this.renderer.xr.getHand(t);let o;if(this.options.supportHands){o=new et.OculusHandPointerModel(n,e),o.name=`hand pointer ${t}`,n.add(o);const i=(new st.XRHandModelFactory).createHandModel(n,"spheres");n.add(i)}n.visible=!1;const a={index:t,pointer:e,grip:i,connected:!1,handedness:"none",hand:n,handPointer:o,handSource:void 0},r=t=>{a.handedness=t.data.handedness,a.connected=!0,t.data.hand&&(a.handSource=t.data.hand,null==o||o.setAttached(!0))},h=()=>{a.handedness="none",a.connected=!1,a.handSource=void 0,null==o||o.setAttached(!1)};return this.bindings.push((0,tt.Sh)((()=>e.addEventListener("connected",r)),(()=>e.removeEventListener("connected",r))),(0,tt.Sh)((()=>e.addEventListener("disconnected",h)),(()=>e.removeEventListener("disconnected",h)))),this.options.supportHands&&this.bindings.push((0,tt.Sh)((()=>n.addEventListener("connected",r)),(()=>n.removeEventListener("connected",r))),(0,tt.Sh)((()=>n.addEventListener("disconnected",h)),(()=>n.removeEventListener("disconnected",h)))),a}}const ot=new(i(10843).Ay)("xr-input-forwarding");class at{constructor(t){this.options=t,this.dispatchPointerDown=t=>{this.forwardEvent("pointerdown",this.mockPointerEventInit(t))},this.dispatchPointerUp=t=>{this.forwardEvent("pointerup",this.mockPointerEventInit(t))},this.target=t.forwardToElement}dispatchPointerMove(t){this.forwardEvent("pointermove",this.mockPointerEventInit(t))}mockPointerEventInit(t){let e=0,i=0;if(this.options.getPointerScreenPosition){const t=this.options.getPointerScreenPosition();e=t.x,i=t.y}return{pointerType:"gamepad",pointerId:t,clientX:e,clientY:i}}forwardEvent(t,e){let i;try{i=window.PointerEvent?new PointerEvent(t,e):new MouseEvent(t,e),i&&this.target.dispatchEvent(i)}catch(t){ot.error(t)}}}const rt=["pinchstart","pinchend"],ht=["selectstart","select","selectend","squeeze","squeezestart","squeezeend"];class lt extends s.EventDispatcher{constructor(t,e){super(),this.renderer=t,this.options={forwardNativeXrEvents:!0,axisMoveTriggerThreshold:.5,supportHands:!1,ignoreTransientPointer:!0},this.previousGamepad=new Map,this.active=!1,this.renew=()=>{!this.active&&this.options.forwardNativeXrEvents&&(this.addSessionListeners(),this.active=!0)},this.cancel=()=>{this.active&&this.options.forwardNativeXrEvents&&(this.removeSessionListeners(),this.active=!1)},this.updateFromGamepads=()=>{if(!this.active)return;const t=this.renderer.xr.getSession();if(!t)return;let e=0;for(const i of t.inputSources){if(!i||!i.gamepad)continue;if(this.options.ignoreTransientPointer&&"transient-pointer"===i.targetRayMode)continue;const t=this.renderer.xr.getController(e),s=this.previousGamepad.get(i),n={buttons:i.gamepad.buttons.map((t=>t.value)),axes:new Float32Array(i.gamepad.axes.slice())},o={controllerIndex:e,inputSource:i,axes:n.axes};n.buttons.forEach(((e,i)=>{(null==s?void 0:s.buttons)&&e!==s.buttons[i]&&(1===e?this.sendGamepadEvent(t,Object.assign(Object.assign({},o),{type:"buttondown",value:e,index:i,target:t})):0===e&&this.sendGamepadEvent(t,Object.assign(Object.assign({},o),{type:"buttonup",value:e,index:i,target:t})))})),n.axes.forEach(((e,i)=>{var n;const a=null!==(n=null==s?void 0:s.axes[i])&&void 0!==n?n:0;if(e!==a){this.sendGamepadEvent(t,Object.assign(Object.assign({},o),{type:"axesmove",value:e,index:i,target:t})),0===a&&this.sendGamepadEvent(t,Object.assign(Object.assign({},o),{type:"axesmovestart",value:e,index:i,target:t}));const s=this.options.axisMoveTriggerThreshold;Math.abs(a)<s&&Math.abs(e)>s&&this.sendGamepadEvent(t,Object.assign(Object.assign({},o),{type:"axestriggered",value:e,index:i,target:t})),0===e&&this.sendGamepadEvent(t,Object.assign(Object.assign({},o),{type:"axesmoveend",value:e,index:i,target:t}))}})),this.previousGamepad.set(i,n),e++}},this.onGamepadEvent=(t,e)=>(0,tt.Sh)((()=>super.addEventListener(t,e)),(()=>super.removeEventListener(t,e))),this.onSessionEvent=(t,e)=>(0,tt.Sh)((()=>super.addEventListener(t,e)),(()=>super.removeEventListener(t,e))),this.sendGamepadEvent=(t,e)=>{this.dispatchEvent(e)},this.sendSessionEvent=(t,e,i)=>{this.dispatchEvent({type:t,controllerIndex:e,data:i})},this.addSessionListeners=()=>{L.controllers.forEach((t=>{const e=this.renderer.xr.getController(t);for(const i of ht)e.addEventListener(i,(e=>this.sendSessionEvent(e.type,t,e.data)));if(this.options.supportHands){const e=this.renderer.xr.getHand(t);for(const i of rt)e.addEventListener(i,(e=>this.sendSessionEvent(e.type,t,void 0)))}}))},this.removeSessionListeners=()=>{L.controllers.forEach((t=>{const e=this.renderer.xr.getController(t);for(const i of ht)e.removeEventListener(i,(e=>this.sendSessionEvent(e.type,t,e)));if(this.options.supportHands){const e=this.renderer.xr.getHand(t);for(const i of rt)e.removeEventListener(i,(e=>this.sendSessionEvent(e.type,t,e)))}}))},e&&(this.options=Object.assign(Object.assign({},this.options),e)),this.renew()}}var dt=i(4896),ct=i(21320),ut=i(64491);var pt=i(49953),mt=i(78671),gt=i(47004);const ft=(new s.Quaternion).setFromAxisAngle(l.B1.UP,r.fy*L.rotationDegrees),vt=(new s.Quaternion).setFromAxisAngle(l.B1.UP,r.fy*-L.rotationDegrees);class yt extends n.n{constructor(){super(...arguments),this.name="webxr",this.framebufferScaledTo=1,this.framebufferScale=0,this.ray={forward:new s.Vector3,origin:new s.Vector3},this.onXrPresentBegin=()=>{if(this.renderer.xr.getSession()){if(this.engine.commandBinder.issueCommand(new u.V(p.MF.HIGH)),!this.viewmodeData.isInside()||this.config.xrMesh){let t=g.w5.INSIDE;this.config.xrMesh&&(this.trackingOverrides.setTrackingStyle(M.SixDof,!1),t=g.w5.MESH),this.engine.commandBinder.issueCommand(new g.S2(t))}this.inputModule.overrideDragThreshold(.15),this.xrPointer=new S(this.raycaster.picking),this.raycaster.setOverridePointer(this.xrPointer),this.xrNavVisuals.activate()}},this.onXrPresentEnd=()=>{this.engine.commandBinder.issueCommand(new u.V(null)),this.inputModule.overrideDragThreshold(null),this.xrNavVisuals.deactivate(),this.raycaster.setOverridePointer(null),this.cameraModule.updateCameraRotation((0,h.Vs)(this.cameraData.pose.rotation,new s.Quaternion)),this.webglScene.setCameraDirty()},this.onXrTrackingApplied=t=>{const e=this.controllerMesh.controller();if(e.connected){let i=this.ray.origin.setFromMatrixPosition(e.grip.matrixWorld),s=this.ray.forward.copy(l.B1.FORWARD).applyQuaternion(e.pointer.quaternion);const{hand:n,handPointer:o}=e;n&&o&&o.isAttached()&&(o.updateMatrixWorld(),i=o.raycaster.ray.origin,s=o.raycaster.ray.direction),this.xrPointer.update3D(i,s,t.trackedCamera),this.xrPointerInput.dispatchPointerMove(e.index)}this.xrGamepadInput.updateFromGamepads()},this.tryEndSession=async()=>{var t;await(null===(t=this.activeXrSession)||void 0===t?void 0:t.end()),this.activeXrSession=void 0},this.requestSession=async(t,e)=>{var i;if(await(0,dt.M1)(this.config.xrBrowsersUnlocked)!==dt.wc.webxr)return null;if(this.renderer.xr.isPresenting)return this.renderer.xr.getSession();if(ct.A.apiExists()){this.config.xrHandTracking&&!e.includes("hand-tracking")&&e.push("hand-tracking");const s=await(null===(i=navigator.xr)||void 0===i?void 0:i.requestSession(t,{optionalFeatures:e}));if(!s)return null;this.activeXrSession=s;const n=XRWebGLLayer.getNativeFramebufferScaleFactor(s);return this.framebufferScaledTo=this.framebufferScale*(n-1)+1,this.log.info("Scaling framebuffer by:",this.framebufferScaledTo,"native size:",n," * factor:",this.framebufferScale),0!==this.framebufferScale&&this.renderer.xr.setFramebufferScaleFactor(this.framebufferScaledTo),this.renderer.xr.setSession(s),s}return null}}async init(t,e){this.config=t,this.engine=e;const[i,n]=await Promise.all([e.getModuleBySymbol(o.M7),e.getModuleBySymbol(o.PM)]);this.renderer=i.threeRenderer,this.webglScene=i.getScene(),this.bindings.push(e.commandBinder.addBinding(x.X,(t=>this.requestSession(t.type,t.features))),e.commandBinder.addBinding(x.P,(()=>this.tryEndSession())));if(await(0,dt.M1)(t.xrBrowsersUnlocked)!==dt.wc.webxr)return;[this.canvasModule,this.cameraModule,this.raycaster,this.inputModule]=await Promise.all([e.getModuleBySymbol(o.CE),e.getModuleBySymbol(o.jh),e.getModuleBySymbol(o.sA),e.getModuleBySymbol(o.mL)]),[this.cameraData,this.raycasterData,this.viewmodeData,this.policyData]=await Promise.all([e.market.waitForData(d.M),e.market.waitForData(c.$),e.market.waitForData(m.X),e.market.waitForData(pt.L)]),this.renderer.xr.setReferenceSpaceType("local"),this.framebufferScale=this.config.framebufferScaling||function(t){const e=(0,ut.Fr)();return!e||e&&function(t){return/Adreno \(TM\) (540|[6-9]\d\d)/.test(t.renderer)}(t)?1:0}(i.gpuInfo);const r=new N(this.renderer,this.webglScene,this.cameraData,this.cameraModule,t.xrDebug);let h=M.Mono;switch(t.webxr){case"stereo":h=M.Stereo;break;case"6dof":h=M.SixDof,this.config.xrMesh=!0;break;default:h=M.Mono}r.setTrackingStyle(h,!1),this.trackingOverrides=r,this.bindings.push(r.subscribe(E,this.onXrPresentBegin),r.subscribe(C,this.onXrPresentEnd),r.subscribe(P,this.onXrTrackingApplied),e.subscribe(gt.A,(t=>{t.toSweep!==t.fromSweep&&r.resetPlayerYOffset()}))),this.controllerMesh=new nt(this.renderer,{supportHands:t.xrHandTracking}),this.webglScene.addChild(this.webglScene.ids.CameraRig,this.controllerMesh.container);const l=new J(this.controllerMesh);l.focus(0),this.controllerMesh.setDefault(0);this.xrPointerInput=new at({forwardToElement:this.canvasModule.element,getPointerScreenPosition:()=>this.raycasterData.pointerScreenPosition}),this.xrGamepadInput=new lt(this.renderer,{supportHands:t.xrHandTracking});const u=t=>{const e=this.renderer.xr.getFrame(),i=this.renderer.xr.getReferenceSpace();if(e&&i&&"transient-pointer"===t.data.targetRayMode){const{targetRaySpace:n,gripSpace:o}=t.data;if(e&&i){const t=e.getPose(o,i),a=e.getPose(n,i);if(t&&a){const e=t.transform.position,i=(new s.Vector3).set(e.x,e.y,e.z),n=a.transform.orientation,o=(new s.Vector3).set(n.x,n.y,n.z);this.xrPointer.update3D(i,o,this.webglScene.cameraRig.camera)}}}},p=[this.xrGamepadInput.onGamepadEvent("axestriggered",(t=>{if(t.index===O.thumbstickX||t.index===O.touchpadX){this.log.debug(`${t.inputSource.handedness} ${O[t.index]} axis.value over threshold, do the rotate!`);Math.sign(t.value)>0?r.offsetRotation(ft):r.offsetRotation(vt)}l.focus(t.controllerIndex),this.controllerMesh.setDefault(t.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectstart",(t=>{u(t),this.xrPointerInput.dispatchPointerDown(t.controllerIndex),l.focus(t.controllerIndex),this.controllerMesh.setDefault(t.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectend",(t=>{u(t),this.xrPointerInput.dispatchPointerUp(t.controllerIndex),l.focus(t.controllerIndex),this.controllerMesh.setDefault(t.controllerIndex)})),this.xrGamepadInput.onSessionEvent("squeezestart",(t=>{l.focus(t.controllerIndex),this.controllerMesh.setDefault(t.controllerIndex)}))];this.config.xrHandTracking&&p.push(this.xrGamepadInput.onSessionEvent("pinchstart",(t=>{this.xrPointerInput.dispatchPointerDown(t.controllerIndex),l.focus(t.controllerIndex),this.controllerMesh.setDefault(t.controllerIndex)})),this.xrGamepadInput.onSessionEvent("pinchend",(t=>{this.xrPointerInput.dispatchPointerUp(t.controllerIndex)}))),this.policyData.hasPolicy(mt.I)&&p.push(this.xrGamepadInput.onGamepadEvent("buttondown",(t=>{4===t.index?(h=(h+1)%M.__length,r.setTrackingStyle(h,!1)):5===t.index&&(h=(M.__length+h-1)%M.__length,r.setTrackingStyle(h,!1)),l.focus(t.controllerIndex),this.controllerMesh.setDefault(t.controllerIndex)}))),p.push(this.inputModule.registerUnfilteredHandler(f.Ve,(t=>{if(this.activeXrSession&&Math.abs(t.fullDelta.x)>Math.abs(t.fullDelta.y)&&Math.abs(t.fullDelta.x)>.25){const e=Math.sign(t.fullDelta.x);e<0?r.offsetRotation(ft):e>0&&r.offsetRotation(vt)}})));const g=new a.P(...p);this.bindings.push(g,this.xrGamepadInput),this.xrNavVisuals=new Q(n),this.xrNavVisuals.init(e),this.webglScene.add(this.xrNavVisuals.container)}onUpdate(t){this.activeXrSession&&this.trackingOverrides.onUpdate()}}const bt=yt},52947:(t,e,i)=>{"use strict";i.d(e,{Ay:()=>o,F7:()=>r,cF:()=>a});var s=i(68909);class n{constructor(t,e){this.raycast=(()=>{const t=new s.Vector3,e=new s.Box3;return(i,s,o,h)=>{const l=e.copy(this.bounds).expandByScalar(s);if(i.ray.intersectsBox(l))for(const e of this.children)if(e instanceof n)e.raycast(i,s,o,h);else if(e instanceof a){if(!1===(null==h?void 0:h(e)))continue;const n=t,a=i.ray.distanceSqToSegment(e.start,e.end,void 0,t),r=Math.sqrt(a);r<s&&o.push({distance:i.ray.origin.distanceTo(n),object:e,distanceToRay:r,point:n.clone(),isLineOctreeIntersection:!0})}else if(e instanceof r){if(!1===(null==h?void 0:h(e)))continue;const t=i.ray.distanceToPoint(e);t<s&&o.push({distance:i.ray.origin.distanceTo(e),object:e,distanceToRay:t,point:e.clone(),isLineOctreeIntersection:!0})}}})(),this.level=e,this.bounds=t.clone(),this.clear()}clear(){this.childNodes=[],this.children=[]}add(t){let e=!1;const i=t instanceof s.Line3?[t.start,t.end]:[t];if(this.level<4){0===this.childNodes.length&&this.buildChildNodes();for(const s of this.childNodes)i.every((t=>s.bounds.containsPoint(t)))&&(e=!0,s.add(t))}e||this.children.push(t)}remove(t){const e=t instanceof s.Line3?[t.start,t.end]:[t];for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s instanceof n){if(e.every((t=>s.bounds.containsPoint(t)))&&s.remove(t))return!0}else if(s===t)return this.children.splice(i,1),!0}return!1}buildChildNodes(){const t=this.bounds.max.clone().sub(this.bounds.min).clone().multiplyScalar(.5);for(let e=0;e<2;e++)for(let i=0;i<2;i++)for(let o=0;o<2;o++){const a=this.bounds.min.x+t.x*o,r=a+t.x,h=this.bounds.min.y+t.y*e,l=h+t.y,d=this.bounds.min.z+t.z*i,c=d+t.z,u=new s.Box3(new s.Vector3(a,h,d),new s.Vector3(r,l,c)),p=new n(u,this.level+1);this.childNodes.push(p),this.children.push(p)}}spherecast(t,e){if(t.intersectsBox(this.bounds))for(const i of this.children)if(i instanceof n)i.spherecast(t,e);else if(i instanceof a){const n=i.closestPointToPoint(t.center,!0,new s.Vector3);n.distanceTo(t.center)<t.radius&&e.push(new r(n))}else i instanceof s.Vector3&&i.distanceTo(t.center)<t.radius&&e.push(i)}traverse(t){for(const e of this.children)e instanceof n?e.traverse(t):t(e)}}class o{constructor(t){this.pointCount=0,this.lineCount=0,this.root=new n(t,0)}add(t){t instanceof s.Line3?this.lineCount++:t instanceof s.Vector3&&this.pointCount++,this.root.add(t)}remove(t){t instanceof a?this.lineCount--:t instanceof r&&this.pointCount--,this.root.remove(t)}clear(){this.root.clear(),this.pointCount=0,this.lineCount=0}traverse(t){this.root.traverse(t)}raycast(t,e,i){const s=[];return this.root.raycast(t,e,s,i),s}}class a extends s.Line3{constructor(t,e){super(t,e),this.start=t,this.end=e,this.isSnapLine3=!0}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}clone(){return new a(this.start,this.end)}}class r extends s.Vector3{constructor(t){super(),this.point=t,this.isSnapVector3=!0,super.copy(t)}copy(t){return this.point.copy(t.point),this}clone(){return new r(this.point)}}},95102:(t,e,i)=>{"use strict";i.d(e,{m:()=>n});var s=i(68909);class n extends s.Mesh{constructor(t,e){super(t,e)}}},45269:(t,e,i)=>{"use strict";i.d(e,{c:()=>h});var s=i(74848),n=i(96540),o=i(32485),a=i.n(o),r=i(18856);const h=(0,n.forwardRef)((({title:t,className:e,variant:i,actions:n,badge:o,decals:h,active:l=!1,selected:d=!1,disabled:c=!1,selectMode:u=!1,selectDisabled:p=!1,onSelect:m,id:g,onClick:f,onMouseEnter:v,onMouseLeave:y},b)=>{const w=a()("mp-nova-list-item",e,{[`mp-nova-list-item-${i}`]:void 0!==i,"mp-nova-disabled":c,"mp-nova-multi-select":u,interactive:!!f,selected:d,active:l});return(0,s.jsxs)("div",Object.assign({className:w,onClick:f,onMouseEnter:v,onMouseLeave:y,"data-id":g,ref:b},{children:[u&&(0,s.jsx)(r.S,{id:`mp-list-checkbox-${g}`,defaultChecked:d,onChange:m,onClick:t=>t.stopPropagation(),disabled:p}),o&&(0,s.jsx)("span",Object.assign({className:"mp-list-item-badge"},{children:o})),(0,s.jsxs)("span",Object.assign({className:"mp-list-item-title"},{children:[(0,s.jsx)("span",Object.assign({className:"mp-list-item-text"},{children:t})),h&&(0,s.jsx)("span",Object.assign({className:"mp-list-item-decals"},{children:h}))]})),n&&(0,s.jsx)("span",Object.assign({className:"mp-list-item-actions"},{children:n}))]}))}))},17709:t=>{t.exports="precision highp float;uniform float aaPaddingPx;uniform vec3 color;uniform float globalOpacity;varying vec2 vOffsetPx;uniform float outline;uniform vec3 outlineColor;varying vec2 scaledWidthHeightPx;varying float vOpacity;float sdTriangle(vec2 p,vec2 p0,vec2 p1,vec2 p2){vec2 e0=p1-p0;vec2 e1=p2-p1;vec2 e2=p0-p2;vec2 v0=p-p0;vec2 v1=p-p1;vec2 v2=p-p2;vec2 pq0=v0-e0*clamp(dot(v0,e0)/dot(e0,e0),0.,1.);vec2 pq1=v1-e1*clamp(dot(v1,e1)/dot(e1,e1),0.,1.);vec2 pq2=v2-e2*clamp(dot(v2,e2)/dot(e2,e2),0.,1.);float s=e0.x*e2.y-e0.y*e2.x;vec2 d=min(min(vec2(dot(pq0,pq0),s*(v0.x*e0.y-v0.y*e0.x)),vec2(dot(pq1,pq1),s*(v1.x*e1.y-v1.y*e1.x))),vec2(dot(pq2,pq2),s*(v2.x*e2.y-v2.y*e2.x)));return-sqrt(d.x)*sign(d.y);}void main(){float padding=aaPaddingPx+outline;float halfWidth=scaledWidthHeightPx.x/2.;vec2 p0=vec2(-halfWidth,scaledWidthHeightPx.y+padding);vec2 p1=vec2(halfWidth,scaledWidthHeightPx.y+padding);vec2 p2=vec2(0.,padding);float sd=sdTriangle(vOffsetPx,p0,p1,p2);float aaOpacity=1.-smoothstep(outline,outline+0.5,sd);float colorMix=smoothstep(0.,outline,sd);vec3 colorWithOutline=mix(color,outlineColor,colorMix);gl_FragColor=linearToOutputTexel(vec4(colorWithOutline,aaOpacity*globalOpacity*vOpacity));}"},69555:t=>{t.exports="precision highp float;uniform vec2 screenSize;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return(vec2(pt.x,pt.y)+vec2(1.,1.))*screenSize/2.;}vec2 screenToNdc(vec2 pt){return(pt*2./screenSize)-vec2(1.,1.);}\n#define MIN_SCALE  0.4\n#define MIN_METERS_PER_PX  0.006\n#define MAX_METERS_PER_PX  0.012\nuniform float tipPaddingPx;uniform float widthPx;uniform float heightPx;uniform float aaPaddingPx;uniform float metersPerPx;uniform float outline;uniform float autoScale;attribute vec2 offset;attribute vec2 tip;attribute float height;attribute float opacity;attribute float visibility;varying vec2 vOffsetPx;varying vec2 scaledWidthHeightPx;varying float vOpacity;vec2 scaleByZoom(){float t=clamp((metersPerPx-MIN_METERS_PER_PX)/(MAX_METERS_PER_PX-MIN_METERS_PER_PX),0.,1.);float scale=1.;if(autoScale>0.){scale=mix(1.,MIN_SCALE,t);}return vec2(widthPx,heightPx)*scale;}void main(){if(visibility>0.){vec2 yAxis=normal.xy;vec2 xAxis=rotate90(yAxis);vec4 tipWorld=vec4(tip.x,height,tip.y,1.);vec4 xOffsetWorld=tipWorld+vec4(xAxis.x,0.,xAxis.y,0.);vec4 yOffsetWorld=tipWorld+vec4(yAxis.x,0.,yAxis.y,0.);vec4 ndcTip=projectionMatrix*modelViewMatrix*tipWorld;vec2 tipScreen=ndcToScreen(ndcTip/ndcTip.w);vec4 ndcXOffset=projectionMatrix*modelViewMatrix*xOffsetWorld;vec2 xOffsetScreen=ndcToScreen(ndcXOffset/ndcXOffset.w);vec4 ndcYOffset=projectionMatrix*modelViewMatrix*yOffsetWorld;vec2 yOffsetScreen=ndcToScreen(ndcYOffset/ndcYOffset.w);vec2 xAxisScreen=normalize(xOffsetScreen-tipScreen);vec2 yAxisScreen=normalize(yOffsetScreen-tipScreen);float padding=aaPaddingPx+outline;scaledWidthHeightPx=scaleByZoom();float halfWidth=scaledWidthHeightPx.x/2.+padding;float quadHeight=scaledWidthHeightPx.y+padding*2.;vec2 vertexScreen=(tipScreen+yAxisScreen*tipPaddingPx)+xAxisScreen*halfWidth*offset.x+yAxisScreen*quadHeight*offset.y;vec2 ndcVert=screenToNdc(vertexScreen);vOffsetPx=vec2(offset.x*halfWidth,offset.y*quadHeight);vOpacity=opacity;gl_Position=vec4(ndcVert*ndcTip.w,ndcTip.z,ndcTip.w);}else{gl_Position=vec4(-1000.,-1000.,-1000.,-1000.);}}"},4605:t=>{t.exports="precision highp float;uniform float opacity;uniform float centerSpacing;uniform float radius;uniform vec3 color;void main(){vec2 center=mod(gl_FragCoord.xy,vec2(centerSpacing))-vec2(centerSpacing*0.5);float polkaDot=1.-smoothstep(radius-(radius*0.2),radius,length(center));gl_FragColor=linearToOutputTexel(vec4(color,opacity*polkaDot));}"},66083:t=>{t.exports="precision highp float;void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},47876:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float globalOpacity;uniform float outlinePct;varying vec3 vOuterColor;varying vec3 vInnerColor;varying float vRadius;varying float vOpacity;varying vec3 vPosition;void main(){float fragRadius=length(vPosition.xz);float outlineRadius=vRadius*outlinePct;float smoothAmt=fwidth(fragRadius)*ANTIALIAS_WIDTH;float mixAmt=smoothstep(outlineRadius-smoothAmt,outlineRadius,fragRadius);gl_FragColor=linearToOutputTexel(vec4(mix(vInnerColor,vOuterColor,mixAmt),1.));gl_FragColor.a=globalOpacity*vOpacity*(1.-smoothstep(vRadius-smoothAmt,vRadius,fragRadius));}"},32686:t=>{t.exports="precision highp float;attribute vec3 centerPosition;attribute float radius;attribute float opacity;attribute vec3 innerColor;attribute vec3 outerColor;varying vec3 vPosition;varying float vRadius;varying float vOpacity;varying vec3 vInnerColor;varying vec3 vOuterColor;void main(){vPosition=position;vRadius=radius;vOpacity=opacity;vInnerColor=innerColor;vOuterColor=outerColor;vec3 worldPos=position+centerPosition;gl_Position=projectionMatrix*modelViewMatrix*vec4(worldPos,1.);}"},76539:t=>{t.exports="precision highp float;precision highp int;vec3 closestPointToRay(vec3 point,vec3 origin,vec3 direction){vec3 d=point-origin;float D=dot(d,direction);return origin+D*direction;}vec3 rayIntersectsSphere(vec3 origin,float radius,vec3 rayOrigin,vec3 rayDirection){vec3 chordPoint=closestPointToRay(origin,rayOrigin,rayDirection);float D1=length(rayOrigin-chordPoint);float D=length(chordPoint-origin);float D2=sqrt(radius*radius-D*D);return rayOrigin+(D1+D2)*rayDirection;}uniform vec3 color;uniform float maxDistance;varying vec3 vWorldPosition;vec4 normalizeDepth(float depth){float depthNormalized=clamp(depth/maxDistance,0.,1.);return vec4(depthNormalized,0.,0.,1.);}void main(){float distanceToCamera=distance(cameraPosition,vWorldPosition);gl_FragColor=normalizeDepth(distanceToCamera);}"},12201:t=>{t.exports="precision highp float;precision highp int;varying vec3 vWorldPosition;void main(){vWorldPosition=(modelMatrix*vec4(position,1.)).xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},1834:t=>{t.exports="precision highp float;uniform float globalOpacity;varying vec3 vBaseColor;varying float vIsDoor;varying vec3 vPosition;void main(){const float lineWidth=0.15;if(vIsDoor>0.){const float startZ=0.15;const float endZ=startZ+lineWidth;float alpha=(abs(vPosition.z)>startZ&&abs(vPosition.z)<endZ)?1.:0.;gl_FragColor=vec4(vBaseColor,alpha*globalOpacity);}else{float alpha=(abs(vPosition.z)<lineWidth*0.5)?1.:0.;gl_FragColor=vec4(vBaseColor,alpha*globalOpacity);}gl_FragColor=linearToOutputTexel(gl_FragColor);}"},63380:t=>{t.exports="precision highp float;attribute float rotationY;attribute vec3 offset;attribute vec3 scaleAttr;attribute vec3 baseColor;attribute float isDoor;varying vec3 vPosition;varying vec3 vBaseColor;varying float vIsDoor;vec3 rotateY(vec3 v,float r){float c2=cos(r/2.);float s2=sin(r/2.);float qy=s2;float qw=c2;float tx=2.*qy*v.z;float tz=2.*(-qy*v.x);float x=v.x+qw*tx+qy*tz;float y=v.y;float z=v.z+qw*tz-qy*tx;return vec3(x,y,z);}void main(){vPosition=position;vBaseColor=baseColor;vIsDoor=isDoor;vec3 wsPosition=rotateY(position*scaleAttr,rotationY)+offset;gl_Position=projectionMatrix*modelViewMatrix*vec4(wsPosition,1.);}"},93854:t=>{t.exports="#define ANTIALIAS_WIDTH  1.0\nprecision highp float;uniform float selectedWidth;uniform float globalOpacity;varying vec3 outlineColor;varying vec3 color;varying float opacity;varying float width;varying vec3 lineStart;varying vec3 lineEnd;varying vec3 vWorldPos;float distanceBetween(vec2 l1,vec2 l2,vec2 p){float D=length(l2-l1);float N=abs((l2.x-l1.x)*(l1.y-p.y)-(l1.x-p.x)*(l2.y-l1.y));return N/D;}void main(){float distanceToLine=distanceBetween(lineStart.xz,lineEnd.xz,vWorldPos.xz);float aaWidth=fwidth(distanceToLine)*ANTIALIAS_WIDTH;float lineLerp=smoothstep(selectedWidth-aaWidth,selectedWidth,distanceToLine);float halfWidth=width*0.5;float aaOpacity=smoothstep(halfWidth,halfWidth-aaWidth,distanceToLine);float finalOpacity=opacity*globalOpacity*aaOpacity;gl_FragColor=linearToOutputTexel(mix(vec4(outlineColor,finalOpacity),vec4(color,finalOpacity),lineLerp));if(gl_FragColor.a<0.01){discard;}}"},82312:t=>{t.exports="precision highp float;attribute vec4 colorAndOpacity;attribute vec3 outlineColorAttr;attribute vec4 lineBiasedStartAndEnd;attribute float widthAttr;attribute float baseHeight;attribute vec4 fromLeft;attribute vec4 fromRight;attribute vec4 toLeft;attribute vec4 toRight;attribute vec4 lineStartAndEnd;attribute float vertIndex;varying vec3 outlineColor;varying vec3 color;varying float opacity;varying float width;varying vec3 lineStart;varying vec3 lineEnd;varying vec3 vWorldPos;void main(){vec3 position=vec3(0.,0.,0.);if(floor(vertIndex)==0.){position=vec3(lineStartAndEnd.x,baseHeight,lineStartAndEnd.y);}else if(floor(vertIndex)==3.){position=vec3(lineStartAndEnd.z,baseHeight,lineStartAndEnd.w);}else if(floor(vertIndex)==1.){position=vec3(fromRight.x,baseHeight,fromRight.y);}else if(floor(vertIndex)==2.){position=vec3(toRight.x,baseHeight,toRight.y);}else if(floor(vertIndex)==4.){position=vec3(toLeft.x,baseHeight,toLeft.y);}else if(floor(vertIndex)==5.){position=vec3(fromLeft.x,baseHeight,fromLeft.y);}else if(floor(vertIndex)==9.){position=vec3(fromRight.z,baseHeight,fromRight.w);}else if(floor(vertIndex)==6.){position=vec3(toRight.z,baseHeight,toRight.w);}else if(floor(vertIndex)==7.){position=vec3(toLeft.z,baseHeight,toLeft.w);}else if(floor(vertIndex)==8.){position=vec3(fromLeft.z,baseHeight,fromLeft.w);}outlineColor=outlineColorAttr;color=colorAndOpacity.xyz;opacity=colorAndOpacity.w;width=widthAttr;lineStart=vec3(lineBiasedStartAndEnd.x,baseHeight,lineBiasedStartAndEnd.y);lineEnd=vec3(lineBiasedStartAndEnd.z,baseHeight,lineBiasedStartAndEnd.w);vWorldPos=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},68216:t=>{t.exports="precision highp float;uniform vec3 color;uniform float opacity;uniform float radius;varying vec2 vCenter;varying vec2 vScreenPos;void main(){float distanceFromCenter=length(vScreenPos-vCenter);float sdfOpacity=1.-smoothstep(radius-0.5,radius+0.5,distanceFromCenter);float alpha=sdfOpacity*opacity;if(alpha<0.01){discard;}gl_FragColor=linearToOutputTexel(vec4(color,alpha));}"},45138:t=>{t.exports="precision highp float;uniform vec2 screenSize;vec2 rotate90(vec2 v){return vec2(-v.y,v.x);}vec2 ndcToScreen(vec4 pt){return(vec2(pt.x,pt.y)+vec2(1.,1.))*screenSize/2.;}vec2 screenToNdc(vec2 pt){return(pt*2./screenSize)-vec2(1.,1.);}\n#define ANTIALIAS_BUFFER  10.0\nuniform float radius;attribute vec3 center;attribute vec2 offsetDirection;varying vec2 vCenter;varying vec2 vScreenPos;void main(){vec4 centerNdc=projectionMatrix*modelViewMatrix*vec4(center,1.);vec2 centerScreen=ndcToScreen(centerNdc/centerNdc.w);vec2 vertexScreen=centerScreen+normalize(offsetDirection)*(radius+ANTIALIAS_BUFFER);vec2 vertexNdc=screenToNdc(vertexScreen);vCenter=centerScreen;vScreenPos=vertexScreen;gl_Position=vec4(vertexNdc*centerNdc.w,centerNdc.z,centerNdc.w);}"}}]);