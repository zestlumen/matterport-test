/*! For license information please see 514.735a8542c2a27b7cae2b.js.LICENSE.txt */
"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[514],{32502:(e,t,s)=>{var i;s.d(t,{f:()=>i}),function(e){e[e.Standard=0]="Standard",e[e.Depth=1]="Depth",e[e.Transparent=2]="Transparent",e[e.Wireframe=3]="Wireframe",e[e.UV=4]="UV",e[e.CeilingSample=5]="CeilingSample",e[e.FloorSample=6]="FloorSample"}(i||(i={}))},75078:(e,t,s)=>{s.d(t,{$:()=>o});var i=s(37458),r=s(68909),n=s(47299);class o extends r.Mesh{constructor(e){super(),this.roomMesh=e,this.excludeFromOctree=!0,this.layers.mask=e.layers.mask,this.name=`DepthPassRoomMesh:${e.meshGroup}-${e.meshSubgroup}`,this.renderOrder=i.X.ghostFloorDepthPrepass,this.visible=!1,this.roomMesh.onOpacityUpdate=e=>{this.visible=e<n.u7.FADE_OPAQUE},this.roomMesh.onBuild=()=>{this.geometry=this.roomMesh.geometry,this.material=this.roomMesh.material},this.roomMesh.onMaterialUpdate=()=>{this.material=this.roomMesh.material};let t=!0,s=!0;this.onBeforeRender=(e,i,r,n,o,a)=>{this.roomMesh.updateUniforms(o,a),t=o.colorWrite,s=o.depthWrite,o.colorWrite=!1,o.depthWrite=!0},this.onAfterRender=(e,i,r,n,o,a)=>{o.colorWrite=t,o.depthWrite=s}}}},93121:(e,t,s)=>{s.d(t,{o:()=>h});var i=s(68909),r=s(3066),n=s(86866),o=s(47299);class a{constructor(){this._configs={},this._orders={},this._maxLod=-1/0,this._maxTs=1/0,this._streamAbove=0}static encodeKey(e,t){return e-t}get maxLod(){return this._maxLod}get maxTexelSize(){return this._maxTs}limitStreamingBelow(e){this._streamAbove=e}order(e,t=!1){return t&&!this._orders[e]&&(this._orders[e]=[]),this._orders[e]}reset(){this._configs={},this._orders={},this._maxTs=1/0,this._maxLod=-1/0}lods(){return Object.keys(this._orders).map((e=>Number.parseInt(e,10)))}valid(e){return e in this._configs}get(e){if(!this.valid(e))throw new Error("invalid quality level "+e);return this._configs[e]}max(e){return e<this._streamAbove?this.min(e):this.order(e)[this.order(e).length-1]}min(e){return this.order(e)[0]}fromPixelSize(e,t){const s=this.order(e),i=this.min(e);let r=this.max(e);for(let e=s.length-1;e>=0;e--)t>this.get(s[e]).texelSize&&s.indexOf(r)>s.indexOf(i)&&(r=s[e]);return r}moreDetailed(e,t){let s=this.min(e);const i=this.max(e),r=this.order(e),n=r.indexOf(t);return n+1===r.length?i:(-1!==n&&(s=Math.min(i,r[n+1%r.length])),s)}lessDetailed(e,t){const s=this.order(e),i=s.indexOf(t);let r=t;return-1!==i&&(r=s[Math.max(0,i-1)]),r}minSize(){return Object.values(this._configs).sort(l)[0]}maxSize(){const e=Object.values(this._configs).sort(l);return e[e.length-1]}nearestQuality(e,t){const s=this.order(e),i=this.max(e),r=(0,n.OF)(t,1,4,0,s.length-1);return Math.min(i,s[Math.round(r)])}registerQualities(e,t,s,i,r="max"){const n=this._configs,l=this.order(e,!0),h=t*i;for(let i=t,d=s;i>=h;i*=.5,d*=2){const s=a.encodeKey(e,d),h=n[s];(!h||h&&h.assetSize<t)&&(this._maxTs=Math.min(this._maxTs,d),this._maxLod=Math.max(this._maxLod,e),n[s]={key:s,lod:e,texelSize:d,textureSize:i,assetSize:t,assetType:r,tileSize:Math.min(i,o.Ay.textureTileSize)}),-1===l.indexOf(s)&&l.push(s)}l.sort(((e,t)=>n[t].texelSize-n[e].texelSize))}}function l(e,t){return e.textureSize>t.textureSize?1:-1}class h extends i.Object3D{constructor(){super(...arguments),this.boundingBox=new i.Box3,this.size=new i.Vector3,this.center=new i.Vector3,this._detail="default",this.textureQualityMap=new a,this.addToOctree=!0,this._chunks=[],this.onChunksLoaded=new Set,this.flipDownload=!0,this.flipUpload=!0}get detail(){return this._detail}get chunks(){return this._chunks}get visibleChunks(){return this._chunks}notifyOnChunksLoaded(e){return(0,r.Sh)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}dispose(){for(const e of this._chunks)e.dispose();this._chunks.length=0}overrideMaxDetail(e){}}},99276:(e,t,s)=>{s.d(t,{B:()=>h});var i=s(68909),r=s(36476),n=s(30443),o=s(37458),a=s(5984),l=s(47299);class h extends a.r{constructor(e,t,s=r.H.ALL){super(),this._opacity=1,this._chunks=[],this.size=new i.Vector3,this.center=new i.Vector3,this.built=!1,this.layers.mask=s.mask,this.name=`RoomMesh:${e}-${t}`,this.meshGroup=e,this.meshSubgroup=t,this.renderOrder=o.X.default,this.castShadow=h.ShouldCastShadow,this.onBeforeRender=(e,t,s,i,r,n)=>{this.updateUniforms(r,n)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(e){-1===this._chunks.indexOf(e)&&this._chunks.push(e)}getChunk(e){return this._chunks[e]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;const e=(0,n.h0)(this._chunks.map((e=>e.geometry)));e.clearGroups();let t=0;this.material=[],this._chunks.forEach(((s,i)=>{s.geometry&&s.geometry.index&&(e.addGroup(t,s.geometry.index.count,i),t+=s.geometry.index.count,s.geometry.dispose(),s.geometry=e,s.notifyOnMaterialUpdated((e=>{Array.isArray(this.material)&&(this.material[i]=e),this.onMaterialUpdate&&this.onMaterialUpdate()})),s.onOpacityUpdate=e=>{this.opacity=e})})),this.geometry=e,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((e=>e.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithSingleChunk(e){if(this.built)return;const{meshGroup:t,meshSubgroup:s,lod:i}=e;this.name=`RoomMesh:${i}-${t}-${s}-${e.chunkIndex}`,this.meshGroup=t,this.meshSubgroup=s,this._chunks.push(e),e.notifyOnMaterialUpdated((e=>{this.material=e,this.onMaterialUpdate&&this.onMaterialUpdate()})),e.onOpacityUpdate=e=>{this.opacity=e},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(e,t){e instanceof i.ShaderMaterial&&(t?this.chunks[t.materialIndex].onBeforeDraw(e):this.chunks.length&&this.chunks[0].onBeforeDraw(e))}get boundingBox(){return(0,n.UX)(this.geometry)}set opacity(e){e!==this.opacity&&(this._opacity=e,this.raycastEnabled=e>l.u7.FADE_CLICKABLE_THRESHOLD,this.renderOrder=e<l.u7.FADE_OPAQUE?o.X.ghostFloor:o.X.default,this.onOpacityUpdate&&this.onOpacityUpdate(e))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}h.ShouldCastShadow=!1},14907:(e,t,s)=>{s.d(t,{T:()=>o});var i,r,n=s(55141);!function(e){e.all="all",e.byMeshGroup="byMeshGroup",e.byMeshSubGroup="byMeshSubGroup"}(i||(i={})),function(e){e.explicit="explicit",e.random="random"}(r||(r={}));class o extends n.u{constructor(e,t,s){super(),this.payload={meshIds:null!=s?s:[],selectBy:(null==t?void 0:t.style)||i.all,colorStyle:(null==e?void 0:e.style)||r.explicit,color:(null==e?void 0:e.color)||null,alpha:(null==e?void 0:e.alpha)||.5,index:null==t?void 0:t.index}}}o.id="SET_MESH_OVERLAY_COLOR",o.selectBy=i,o.colorBy=r,o.COLOR_DIM={x:0,y:0,z:0,w:.3}},70497:(e,t,s)=>{var i;s.d(t,{X:()=>i}),function(e){e[e.Min=0]="Min",e[e.Standard=1]="Standard",e[e.High=2]="High",e[e.Detail=3]="Detail"}(i||(i={}))},39034:(e,t,s)=>{s.d(t,{f:()=>K});var i=s(36476),r=s(73927),n=s(68909);const o=new n.Vector3,a=(new n.Matrix4).set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),l=a.clone().invert();function h(e,t){if(!1!==t(e)&&e.children)for(const s of e.children)h(s,t)}function d(e,t){const{box:s,boxTransformInverse:i}=function(e){let t=u.get(e);if(!t){const s=e.boundingVolume.box,i=new n.Box3,r=new n.Matrix4,o=new n.Vector3(s[3],s[4],s[5]),a=new n.Vector3(s[6],s[7],s[8]),l=new n.Vector3(s[9],s[10],s[11]),h=o.length(),d=a.length(),c=l.length();o.normalize(),a.normalize(),l.normalize(),0===h&&o.crossVectors(a,l),0===d&&a.crossVectors(o,l),0===c&&l.crossVectors(o,a),r.set(o.x,a.x,l.x,s[0],o.y,a.y,l.y,s[1],o.z,a.z,l.z,s[2],0,0,0,1).invert(),i.min.set(-h,-d,-c),i.max.set(h,d,c),t={box:i,boxTransformInverse:r},u.set(e,t)}return t}(t);return o.copy(e).applyMatrix4(a).applyMatrix4(i),s.containsPoint(o)}const u=new WeakMap;function c(e){for(var t;e;){const s=null===(t=e.extras)||void 0===t?void 0:t.level;if("number"==typeof s)return s;e=e.parent}return-1}var m=s(83075),g=s(596),p=s(44345),f=s(93121),y=s(3066),x=s(31093),M=s(10843),v=s(79243),T=s(65936),b=s(94631),L=s(61728),w=s(17888);class _{constructor(){this.caches=new Map}registerPlugin(e,t){this.caches.has(e)||this.caches.set(e,new Map);const s=this.caches.get(e);e.pluginCallbacks.unshift((e=>new S(e,t,s)))}unregisterLoader(e){this.caches.delete(e)}unregisterAllLoaders(){this.caches.clear()}}class S{constructor(e,t,s){this.parser=e,this.modelKey=t,this.textureCache=s,this.name="CrossModelTextureCache"}key(e){return`${e} @ ${this.modelKey}`}loadTexture(e){var t;const s=this.textureCache,i=this.parser,r=i.json,n=r.textures[e];let o=n.source;Object.keys(n.extensions).forEach((e=>o=o||n.extensions[e].source));const a=null===(t=r.images[o])||void 0===t?void 0:t.uri;if(void 0===a)return null;const l=s.get(this.key(a));if(l)return l;let h=i._invokeOne((t=>t===this?null:t.loadTexture&&t.loadTexture(e)));h||(h=i.loadTexture(e));const d=h.then((e=>{const t=()=>{s.delete(this.key(a)),null==e||e.removeEventListener("dispose",t)};return null==e||e.addEventListener("dispose",t),e}));return s.set(this.key(a),d),d}}var C=s(79545),k=s(99276);class O{constructor(e){this.parser=e,this.name="MTTR_three_mesh_bvh"}async loadMesh(e){const t=async(t,s)=>{var i,r;const n=this.parser.json.meshes[e].primitives[s];if(null===(i=n.extensions)||void 0===i?void 0:i.MTTR_three_mesh_bvh){const e=null===(r=n.extensions)||void 0===r?void 0:r.MTTR_three_mesh_bvh,s={roots:(await Promise.all(e.roots.map((e=>this.parser.loadAccessor(e))))).map((e=>{const t=e.array;return t.byteLength!==t.buffer.byteLength?t.slice().buffer:t.buffer})),index:new Uint8Array(0)};t.geometry.boundsTree=C.G.deserialize(s,t.geometry,{setIndex:!1})}},s=[],i=await this.loadMeshInternal(e);if(i)if("Group"===i.type){const e=i;s.push(...e.children.map(((e,s)=>t(e,s))))}else"Mesh"===i.type&&s.push(t(i,0));return await Promise.all(s),i}async loadMeshInternal(e){const t=this.parser,s=t,r=this.parser.json.meshes[e],o=r.primitives,a=[];for(let e=0,i=o.length;e<i;e++){const i=void 0===o[e].material?t.createDefaultMaterial(s.cache):t.getDependency("material",o[e].material);a.push(i)}return a.push(t.loadGeometries(o)),Promise.all(a).then((function(s){const a=s.slice(0,s.length-1),l=s[s.length-1],h=[];for(let s=0,n=l.length;s<n;s++){const n=l[s],d=o[s];let u;const c=a[s];if(d.mode!==R.TRIANGLES&&void 0!==d.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+d.mode);u=new k.B(0,0,i.H.DEFAULT),u.geometry=n,u.material=c,u.name=t.createUniqueName(r.name||"mesh_"+e),D(u,r),t.assignFinalMaterial(u),h.push(u)}if(1===h.length)return h[0];const d=new n.Group;for(let e=0,t=h.length;e<t;e++)d.add(h[e]);return d}))}}const R={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};function D(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}var A=s(71916),E=s(97084);class U extends A.KTX2Loader{constructor(e,t,s){super(s),this.urlSigner=e,this.api=t,this.taskCache=new WeakMap}load(e,t,s,i){const r=new n.CompressedTexture([],0,0,n.RGB_ETC2_Format);return this.urlSigner(e).then((async e=>{const i=await this.api.get(e,{onProgress:s,responseType:"arraybuffer",priority:E.QK.MEDIUM});let n=this.taskCache.get(i);if(!n){n={promise:this._createTexture(i)},this.taskCache.set(i,n)}const o=await n.promise;r.copy(o),r.needsUpdate=!0,t(r)})).catch(i),r}preload(){this.init()}}let I;const B=/\gltf$/,F=/\glb$/;var P=s(3812);var V,z=s(70497);class G extends P.M{constructor(e,t,s,i){super(),this.urlSigner=e,this.api=t,this.onProgress=i,this.priorityCallback=s}add(e,t){return super.add(e,(async e=>{var s,i,r;if(null===(s=null==e?void 0:e.content)||void 0===s?void 0:s.uri){const s=e.content.uri;try{const n=null===(i=this.onProgress)||void 0===i?void 0:i.bind(this,e);if(e.content.uri=await this.urlSigner(s),(null===(r=e.extras)||void 0===r?void 0:r.level)===z.X.Min)return t(e).then((e=>n?function(e,t){if(e.ok&&e.body){const s=e.body.getReader(),i=e.headers.get("Content-Length");let r=i?+i:0,n=0!==r,o=0;const a=new ReadableStream({async start(e){for(;;){const{done:i,value:a}=await s.read();if(a&&(o+=a.byteLength,e.enqueue(a)),i&&(r=o,n=!0),null==t||t(new ProgressEvent("progress",{lengthComputable:n,loaded:o,total:r})),i){e.close();break}}}});e=new Response(a)}return e}(e,n):e));{const s=window.fetch;try{return window.fetch=async(e,t)=>{const s=await this.api.get(e,{responseType:"blob",priority:E.QK.MEDIUM,onProgress:n,signal:null==t?void 0:t.signal});return new Response(s)},t(e)}finally{window.fetch=s}}}finally{e.content.uri=s}}}))}}class H extends P.M{constructor(e){super(),this.settings=e,this.prioritizeBy=V.FRUSTUM_ERROR_THRESH,this.priorityCallback=(e,t)=>this.prioritizeBy===V.FRUSTUM_ERROR_THRESH?this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=this.settings.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]):this.defaultPriorityCallback(e,t)}sortBySelectors(e,t,s){for(const i of s){const s=this.compareTile(e,t,i);if(null!==s)return s}return 0}compareTile(e,t,s){const i=s(e),r=s(t);return i===r?null:i>r?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}!function(e){e.DEFAULT="DEFAULT",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH"}(V||(V={}));var N=s(75078),Q=s(39994);const j=3;class ${constructor(e,t,s,i,r,n,o,a){this.container=e,this.threeRenderer=t,this.chunkFactory=s,this.tilesetInfo=i,this.commandBinder=r,this.api=n,this.gltfConfig=o,this.settings=a,this.name="MttrTileLoader",this.log=new M.Ay("3d-tiles"),this.loadStats={startTimes:{start:0,tileset:0,lod0:0},timings:{tileset:"",lod0:""}},this.lodDeferreds=[],this.tileProgress=new WeakMap,this.onChunksLoaded=new Set,this.onChunksUnloaded=new Set,this.tileSetLoaded=!1,this.minimalLoaded=!1,this.minimalTileCount=0,this.signUrl=async e=>{if(e.startsWith("blob"))return e;return(await this.tilesetInfo.urlTemplate.get()).replace(this.settings.urlTemplateToken,e)},this.onTileGltfDownloadProgress=(e,t)=>{this.tileProgress.set(e,t.lengthComputable?.5*t.loaded/t.total:0),this.checkLoadStatus()},this.checkLoadStatus=(()=>{const e=[];let t=!1,s=!1;return(0,v.n)((()=>{t&&s||!this.tileSetLoaded||(0===e.length&&(e.push([],[]),this.tilesRenderer.traverse(((t,s,i)=>{var r;const n=null===(r=t.extras)||void 0===r?void 0:r.level;return 0!==n&&1!==n||e[n].push(t),!1}),null)),t||(t=this.notifyIfFullyLoaded(0,e,!0),t&&(this.tilesRenderer.update(),this.log.debug("LOD0 fully downloaded, allow showing more lods"),this.minimalLoaded=!0,this.minimalTileCount=e[0].length,this.loadStats.timings.lod0=(performance.now()-this.loadStats.startTimes.lod0).toFixed(1)+"ms")),s||(s=this.notifyIfFullyLoaded(1,e,!1),s&&(e.length=0)))}),16)})()}async init(){this.loadStats.startTimes.start=performance.now();const e=await this.signUrl(this.tilesetInfo.rootFilename);this.tilesRenderer=new b.d(e),this.tilesRenderer.manager=new n.LoadingManager;const t=function(e,t,s,i,r,n){const o=new L.DRACOLoader(t);o.setDecoderPath(`${r.dracoDecoderPath}`),o.preload();const a=new w.GLTFLoader(t);a.setDRACOLoader(o),a.register((e=>new O(e))),I||(I=new _),I.registerPlugin(a,n);const l=new U(s,i,t);return l.setTranscoderPath(r.basisTranscoderPath),l.detectSupport(e),l.preload(),a.setKTX2Loader(l),t.removeHandler(B),t.addHandler(B,a),t.removeHandler(F),t.addHandler(F,a),a}(this.threeRenderer,this.tilesRenderer.manager,this.signUrl,this.api,this.gltfConfig,e);this.configureTilesRenderer(this.tilesRenderer,t)}setCamera(e,t,s){this.tilesRenderer.setCamera(e),this.tilesRenderer.setResolution(e,t,s)}hasCamera(e){return this.tilesRenderer.hasCamera(e)}deleteCamera(e){return this.tilesRenderer.deleteCamera(e)}notifyOnChunksLoaded(e){return(0,y.Sh)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}notifyOnChunksUnloaded(e){return(0,y.Sh)((()=>this.onChunksUnloaded.add(e)),(()=>this.onChunksUnloaded.delete(e)),!0)}notifyOnLodProgress(e,t){this.getLodDeferred(e).progress(t)}awaitLod(e){return this.getLodDeferred(e).nativePromise()}getLodDeferred(e){return this.lodDeferreds[e]||(this.lodDeferreds[e]=new x.i)}update(){const{minimalLoaded:e,tilesRenderer:t}=this;e?(t.displayActiveTiles=this.settings.displayActiveTiles,t.loadSiblings=this.settings.loadSiblings,t.stopAtEmptyTiles=this.settings.stopAtEmptyTiles,t.autoDisableRendererCulling=this.settings.autoDisableRendererCulling,t.downloadQueue.maxJobs=this.settings.downloadQueueConcurrency,t.parseQueue.maxJobs=this.settings.parseQueueConcurrency):(t.loadSiblings=!0,t.downloadQueue.maxJobs=1/0,t.parseQueue.maxJobs=1/0),t.optimizeRaycast=this.settings.optimizeRaycast,t.errorTarget=this.settings.errorTarget,t.lruCache.maxSize=e?Math.max(this.settings.lruMaxTiles,this.minimalTileCount):1/0,t.update(),t.lruCache.minSize=this.settings.lruMinExtraTiles+t.lruCache.usedSet.size,t.lruCache.unloadPercent=this.settings.lruUnloadPercent}getDownloadParseStatus(){return this.tilesRenderer.stats}configureTilesRenderer(e,t){const s=e.calculateError.bind(e);e.calculateError=e=>{s(e),this.adjustScreenSpaceError&&(e.__error=this.adjustScreenSpaceError(e.__error,e))},e.errorTarget=this.settings.errorTarget,e.loadSiblings=this.settings.loadSiblings,e.stopAtEmptyTiles=this.settings.stopAtEmptyTiles,e.displayActiveTiles=this.settings.displayActiveTiles;const i=e.preprocessNode.bind(e);e.preprocessNode=function(e,t,s){return i(e,t,"")},this.configurePriorityQueues(),this.container.add(e.group);const r=(new n.Quaternion).setFromAxisAngle(new n.Vector3(-1,0,0),n.MathUtils.degToRad(90));this.container.quaternion.copy(r),this.container.updateMatrixWorld(!0),e.onLoadTileSet=this.onLoadTileset.bind(this),e.onLoadModel=this.onLoadModel.bind(this),e.onDisposeModel=this.onDisposeModel.bind(this);const o=e.setTileActive.bind(e);e.setTileActive=(e,t)=>{o(e,t),this.onTileActiveChange&&this.onTileActiveChange(e,t)};const a=e.setTileVisible.bind(e);e.setTileVisible=(e,t)=>{a(e,t),this.onTileVisibleChange&&this.onTileVisibleChange(e,t)};const l=e.tileInView.bind(e);e.tileInView=e=>{let t=l(e);return this.adjustTileInView&&(t=this.adjustTileInView(t,e)),t}}configurePriorityQueues(){const{tilesRenderer:e}=this;e.downloadQueue=new G(this.signUrl,this.api,e.downloadQueue.priorityCallback,this.onTileGltfDownloadProgress),e.parseQueue=new H(this.settings);const t=e=>{this.commandBinder.issueCommand(new T.m("mesh/tiled/priorityQueue",e,100))};e.parseQueue.schedulingCallback=t,e.downloadQueue.schedulingCallback=t}async onLoadModel(e,t){const s=function(e,t,s){var i;const r=[],n=(null===(i=t.extras)||void 0===i?void 0:i.id)||""+e.id;return e.name=n,e.traverse((i=>{var o,a;if(i.matrixAutoUpdate=!1,i.updateMatrix(),i instanceof k.B){const l=new N.$(i);e.add(l);const{group:h,subgroup:d,chunkIndex:u}=(0,Q.g8)(`${n}-${i.name}`),c=i.material,m=c.map;let g=null!==(o=null==m?void 0:m.name)&&void 0!==o?o:c.name;g=g.replace(".jpg","");const p=s(h,d,i.geometry,g);p.textureLODInfo=function(e,t){if(t&&(null==t?void 0:t.maxTextureSize)&&(null==t?void 0:t.texelSize)&&(null==t?void 0:t.textureScale)&&t.textureScale>0){const s=t.textureScale;return{name:e,maxTexelSize:.001*t.texelSize,maxTextureSize:t.maxTextureSize,minTexelSize:1/s*t.texelSize*.001,minTextureSize:s*t.maxTextureSize,minScale:s}}return null}(g,t.extras)||void 0,p.lod=(null===(a=t.extras)||void 0===a?void 0:a.level)||0,p.chunkIndex=u,p.notifyOnMaterialUpdated((e=>{i.material=e}));const f={};f.map=m,i.buildWithSingleChunk(p),i.material=p.setMaterialsUniform(f),p.name=i.name,p.embeddedTexture=f.map,r.push(p)}})),e.matrixWorld.copy(e.matrix),e.matrixWorld.premultiply(l),e.children.forEach((e=>e.updateMatrixWorld(!0))),r}(e,t,this.chunkFactory);for(const e of s)this.container.addChunk(e);for(const e of this.onChunksLoaded.values())e(s,t);this.onModelLoaded&&this.onModelLoaded(e,t),this.tileProgress.set(t,1),await new Promise((e=>setTimeout(e,0))),this.checkLoadStatus()}onDisposeModel(e,t){e.traverse((e=>{if((0,m.PO)(e)){const s=e.chunks;if(!s)return void this.log.error("Missing chunks from RoomMesh");for(const e of s)this.container.removeChunk(e);for(const e of this.onChunksUnloaded.values())e(s,t)}})),this.onModelUnloaded&&this.onModelUnloaded(e,t),e.traverse((e=>{(0,m.PO)(e)&&e.reset()}))}onLoadTileset(e,t){var s;const i=!this.tileSetLoaded;let r="";i&&(r=(performance.now()-this.loadStats.startTimes.start).toFixed(1),this.loadStats.timings.tileset=r+"ms");const n=null===(s=t.match(/[^/]*\.json/))||void 0===s?void 0:s[0];this.log.debug(`Tileset ${n} load${i?`: ${r}ms`:""}`,e),i&&(this.loadStats.startTimes.lod0=performance.now()),this.tileSetLoaded=!0,this.onTilesetLoaded&&this.onTilesetLoaded(e,t),this.tilesRenderer.update()}notifyIfFullyLoaded(e,t,s){if(!t[e])return!1;const i=t[e],r=i.filter((e=>e.__loadingState!==j)),n=this.getLodDeferred(e);return s&&n.notify(i.reduce(((e,t)=>e+(this.tileProgress.get(t)||0)/i.length),0)),0===r.length&&n.resolve(),0===r.length}}var W=s(47299),X=s(80112);class K extends f.o{constructor(e,t=i.H.ALL,s){super(),this.uuid=e,this.renderLayer=t,this.chunkSharedState=s,this.boundingBox=new n.Box3,this.size=new n.Vector3,this.center=new n.Vector3,this.tilesByChunkId=new Map,this.bindings=[],this.roomMeshesByTile=new Map,this.activeRoomMeshes=new Set,this.visibleRoomMeshes=new Set,this.activeTiles=new Set,this.tileActiveDescendantCounts=new WeakMap,this.isActiveRoomMeshFilter=e=>this.activeRoomMeshes.has(e),this.isActiveRoomMeshSnapFilter=e=>{var t,s,i;const r=null===(t=e.meta)||void 0===t?void 0:t.tile;if(r){const{snappingMaxLOD:e}=this.settings,t=null!==(i=null===(s=r.extras)||void 0===s?void 0:s.level)&&void 0!==i?i:1/0;if(t===e&&(this.tileActiveDescendantCounts.get(r)||0)>0||t<=e&&this.activeTiles.has(r))return!0}return!1},this.settings=Object.assign({},X.W),this.maxLOD=this.settings.maxLOD,this.layers.mask=t.mask,this.overriddenIsTileInView=this.overriddenIsTileInView.bind(this),this.flipDownload=!1,this.flipUpload=!1}dispose(){super.dispose(),this.bindings.forEach((e=>e.cancel())),this.bindings=[]}async load(e,t,s,i,n,o,a,h,d,u){this.renderer=t,this.cameraData=i,o.root=this,this.maxLOD=this.settings.maxLOD=n.maxLOD,this.tileLoader=new $(this,t.threeRenderer,a,n,e.commandBinder,d,u,this.settings),await this.tileLoader.init(),this.tileLoader.setCamera(s,i.width,i.height),this.bindings.push(e.subscribe(r.h,(e=>{this.tileLoader.setCamera(s,e.width,e.height)}))),this.tileLoader.onModelLoaded=(e,t)=>{let s=this.roomMeshesByTile.get(t);s||(s=[],this.roomMeshesByTile.set(t,s)),e.traverse((e=>{e.layers.mask=this.renderLayer.mask,(0,m.PO)(e)&&(o.rooms.add(e),s.push(e),this.inputIni&&this.registerMeshForCollision(this.inputIni,e,t))})),o.commit()},this.tileLoader.onModelUnloaded=(e,t)=>{e.traverse((e=>{e instanceof k.B&&(o.rooms.delete(e),this.inputIni&&this.unregisterMeshFromCollision(this.inputIni,e))})),o.commit(),this.tileLoader.onTileActiveChange(t,!1),this.tileLoader.onTileVisibleChange(t,!1),this.roomMeshesByTile.delete(t)},this.tileLoader.onTileActiveChange=(e,t)=>{var s;const i=t?"add":"delete";null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.activeRoomMeshes[i](e)})),this.activeTiles[i](e);for(let s=e.parent;s;s=s.parent){const e=this.tileActiveDescendantCounts.get(s)||0;this.tileActiveDescendantCounts.set(s,e+(t?1:-1))}},this.tileLoader.onTileVisibleChange=(e,t)=>{var s;null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.visibleRoomMeshes[t?"add":"delete"](e)}))},this.initTileLodAdjustments(this.tileLoader,h),this.tileLoader.notifyOnLodProgress(0,(t=>{e.broadcast(new p.EX(t,1))})),this.tileLoader.notifyOnChunksLoaded(((e,s)=>{var i;0===(null===(i=s.extras)||void 0===i?void 0:i.level)&&e.forEach((e=>{t.threeRenderer.initTexture(e.embeddedTexture)}))})),this.tileLoader.update(),this._detail="minimal",await this.tileLoader.awaitLod(this.settings.initialMaxLOD),this._detail="default",this.tileLoader.tilesRenderer.getBounds(this.boundingBox),this.boundingBox.getSize(this.size).applyMatrix4(l),this.boundingBox.getCenter(this.center).applyMatrix4(l);const c=this.size.clone().multiplyScalar(.5).length(),{smallMeshThreshold:g,smallMeshErrorMultiplier:f}=this.settings;c<g&&(this.settings.errorTarget=Math.min(this.settings.errorTarget,c*f))}initTextureLoader(e,t){return e.limitMemoryUsage=this.settings.limitMemoryUsage,e.setModel(this,this._chunks,t),this.bindings.push(this.tileLoader.notifyOnChunksLoaded((t=>{e.addChunkSlots(this,t);for(const e of this.onChunksLoaded.values())e(t)})),this.tileLoader.notifyOnChunksUnloaded((t=>{e.removeChunks(t)}))),e.allowTextureDownload=()=>{const{downloading:e,parsing:t}=this.tileLoader.getDownloadParseStatus();return 0===e&&0===t},Promise.resolve()}initTileLodAdjustments(e,t){e.adjustTileInView=this.overriddenIsTileInView;const s=this.tilesByChunkId,i=new Map;let r=0;this.bindings.push(e.notifyOnChunksLoaded(((e,t)=>{for(const i of e)s.set(i.id,t)})),t.notifyOnNewSighting(((e,t)=>{r++;const n=s.get(e.id);if(n){for(let e=n.parent;e;e=e.parent)i.set(e,r);h(n,(e=>!(e!==n&&!d(t.point,e))&&(i.set(e,r),!0)))}})),this.tileLoader.notifyOnChunksUnloaded((e=>{for(const t of e)s.delete(t.id),t.dispose()}))),e.adjustScreenSpaceError=(e,t)=>{var s,n;if(1!==this.settings.errorMultiplierRaycastOcclusion){(null!==(s=i.get(t))&&void 0!==s?s:-1/0)<r-W.xT.sightingMaxAge&&(e*=this.settings.errorMultiplierRaycastOcclusion)}if(1!==this.settings.errorMultiplierHiddenFloors){(null===(n=this.roomMeshesByTile.get(t))||void 0===n?void 0:n.some((e=>e.chunks.some((e=>e.getOpacity()>W.u7.FADE_TILE_VISIBLE_THRESHOLD)))))||(e*=this.settings.errorMultiplierHiddenFloors)}return c(t)<this.settings.minLOD&&(e=Math.max(e,this.settings.errorTarget+1e-10)),e}}registerCollision(e){this.inputIni=e,this.tileLoader.tilesRenderer.forEachLoadedModel(((t,s)=>{t.traverse((t=>{(0,m.PO)(t)&&this.registerMeshForCollision(e,t,s)}))}))}unregisterCollision(e){this.tileLoader.tilesRenderer.forEachLoadedModel(((t,s)=>{t.traverse((t=>{(0,m.PO)(t)&&this.unregisterMeshFromCollision(e,t)}))}))}addChunk(e){this._chunks.push(e)}removeChunk(e){const t=this._chunks.indexOf(e);this._chunks.splice(t,1)}onUpdate(){this.settings.disableTileUpdates||(this.tileLoader.tilesRenderer.setResolution(this.renderer.getCamera(),this.cameraData.width,this.cameraData.height),this.tileLoader.update(),this.checkDispose()),this.downgradeIfMemoryConstrained()}setTextureQuality(e,t,s){e.setQuality(g.M.LOW,s)}get visibleChunks(){const e=this.visibleRoomMeshes;return{*[Symbol.iterator](){for(const t of e)for(const e of t.chunks)yield e}}}registerMeshForCollision(e,t,s){e.registerMesh(t,this.addToOctree,this.isActiveRoomMeshFilter),t.chunks[0].lod<=this.settings.snappingMaxLOD&&e.registerSnappingMeshGeometry(t.name,t.geometry,{tile:s,meshGroup:t.meshGroup},this.isActiveRoomMeshSnapFilter)}unregisterMeshFromCollision(e,t){e.unregisterMesh(t),e.unregisterSnappingMeshGeometry(t.name)}overriddenIsTileInView(e,t){const s=c(t.parent);if("minimal"===this._detail&&-1===s)return!0;let i=this.settings.nonMeshMaxLOD;return"max"===this._detail&&(i=this.settings.maxLOD),"minimal"===this._detail&&(i=this.settings.initialMaxLOD),!(s>=i)&&e}overrideMaxDetail(e){if(e!==this._detail)switch(this._detail=e,this._detail){case"minimal":this.setMaxLOD(0);break;case"max":this.setMaxLOD(null);break;default:const e=this.size.length()/2<this.settings.smallMeshThreshold;this.setMaxLOD(e?this.settings.maxLOD:this.settings.nonMeshMaxLOD)}}setMaxLOD(e){e=null!=e?e:this.maxLOD,this.settings.maxLOD=e}downgradeIfMemoryConstrained(){this.renderer.estimatedGPUMemoryAllocated()>2**20*(this.settings.limitMemoryUsage?this.settings.allocatedMegsBeforeLimitingLod:1/0)&&this.settings.maxLOD>0&&this.setMaxLOD(this.settings.maxLOD-1)}checkDispose(){if(this.settings.disposeModel){const e=this.tileLoader.tilesRenderer,t=e;for(const e of t.cameras)t.deleteCamera(e);const s=.001,i=new n.OrthographicCamera(-s,s,s,-s,s,2*s);i.position.set(0,-1e4,0),i.rotation.setFromVector3(new n.Vector3(0,-1,0)),i.updateMatrix(),i.updateMatrixWorld(),this.tileLoader.setCamera(i,100,100),e.lruCache.minSize=0,e.lruCache.unloadPercent=1,e.lruCache.markAllUnused(),e.update(),e.dispose(),this.chunkSharedState.dispose(),this.settings.disableTileUpdates=!0}}}},80112:(e,t,s)=>{s.d(t,{W:()=>o});var i=s(64491),r=s(75778),n=s(70497);const o={urlTemplateToken:"<file>",initialMaxLOD:n.X.Min,nonMeshMaxLOD:n.X.Standard,maxLOD:n.X.High,minLOD:n.X.Min,loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,disableTileUpdates:!1,disposeModel:!1,limitMemoryUsage:(0,i.Fr)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,i.Fr)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,downloadQueueConcurrency:8,parseQueueConcurrency:10,snappingMaxLOD:n.X.Standard,errorTarget:Number((0,r.P3)("errorTarget",(0,i.Fr)()?6:4)),errorMultiplierHiddenFloors:.01,errorMultiplierRaycastOcclusion:.1,smallMeshThreshold:Number((0,r.P3)("smallMeshThreshold",40)),smallMeshErrorMultiplier:Number((0,r.P3)("smallMeshErrorMultiplier",.1))}},83075:(e,t,s)=>{s.d(t,{PO:()=>r,m2:()=>n});var i=s(99276);const r=e=>!!e&&e instanceof i.B,n={hasMeshGroup:e=>"object"==typeof e&&!!e&&"meshGroup"in e,hasMeshSubgroup:e=>"object"==typeof e&&!!e&&"meshSubgroup"in e,isRoomMesh:r,isVisibleRoomMesh:e=>r(e)&&e.raycastEnabled&&e.visible}},14971:(e,t,s)=>{s.d(t,{Jn:()=>h,rt:()=>l});var i=s(68909);const r=s(47299).Ay.sightingMaxAge,n=new i.Color;let o,a=-1;const l=(e,t,s)=>{o||(o=new i.InstancedMesh(new i.SphereGeometry(.005,8,4),new i.MeshBasicMaterial,r),o.frustumCulled=!1,d(o));const l=new i.Matrix4;return({point:i,distance:h})=>{const d=h/s.fovDistanceScale();l.makeScale(d,d,d).setPosition(i),o.setMatrixAt(++a%r,l),o.instanceMatrix.needsUpdate=!0;for(let t=r;t--;)o.setColorAt((a-t+r)%r,n.setHex(e).multiplyScalar(1-t/r));o.instanceColor&&(o.instanceColor.needsUpdate=!0),o.parent||t.scene.add(o)}},h=()=>{var e;o&&(null===(e=o.parent)||void 0===e||e.remove(o),d(o))};function d(e){const t=(new i.Matrix4).makeScale(0,0,0);for(let s=0;s<r;s++)e.setMatrixAt(s,t)}new i.Vector4(1,0,0,1),new i.Vector4(0,1,0,1),new i.Vector4(0,0,1,1),new i.Vector4(1,1,0,1),new i.Vector4(1,0,1,1),new i.Vector4(1,1,1,1),new i.Vector4(0,1,1,1),new i.Vector4(0,0,0,1)},39994:(e,t,s)=>{s.d(t,{QN:()=>o,g8:()=>r,tn:()=>n,yL:()=>a});var i=s(68909);function r(e){const t=e.match(/group([0-9]+)/),s=e.match(/sub([0-9]+)/),i=e.match(/type([0-9]+)/),r=e.match(/mirror([0-9]+)/),n=e.match(/window([0-9]+)/),o=e.match(/chunk([0-9]+)/),a=e.match(/_chunk([0-9]+)/),l=i?parseInt(i[1],10):r&&!isNaN(parseInt(r[1],10))?100:n&&!isNaN(parseInt(n[1],10))?101:0;return{group:t?parseInt(t[1],10):0,subgroup:s?parseInt(s[1],10):0,chunkIndex:o?parseInt(o[1],10):0,nodeIndex:a?parseInt(a[1],10):0,type:l}}function n(e,t=!1){let s=e.getAttribute("barycentric");if(s)return s;const r=(e.getIndex()||e.getAttribute("position")).count/3,n=[];for(let e=0;e<r;e++){const s=t?1:0;e%2==0?n.push(0,0,1,0,1,0,1,0,s):n.push(0,1,0,0,0,1,1,0,s)}const o=new Float32Array(n);return s=new i.BufferAttribute(o,3),e.setAttribute("barycentric",s),s}function o(e=16777215*Math.random(),t=1){const s=function(e,t,s,i=1){const r=document.createElement("canvas");r.width=t,r.height=s;const n=r.getContext("2d");return n&&(n.fillStyle=`rgba(${255*e.r|0},${255*e.g|0},${255*e.b|0}, ${255*i|0})`,n.fillRect(0,0,t,s)),r}((new i.Color).setHex(e),1,1,t),r=new i.CubeTexture([s,s,s,s,s,s]);return r.format=i.RGBAFormat,r.needsUpdate=!0,r}const a=(()=>{const e=new i.Vector3,t=new i.Vector3,s=new i.Vector3,r=new i.Vector3,n=new i.Vector3,o=new i.Vector3;return a=>{const l=new i.Vector3,h=a.index,d=a.getAttribute("position");if(null!=d&&null!=h){let i=0;for(let a=0,u=h.count;a<u;a+=3){const u=h.getX(a+0),c=h.getX(a+1),m=h.getX(a+2);e.fromBufferAttribute(d,u),t.fromBufferAttribute(d,c),s.fromBufferAttribute(d,m),r.subVectors(s,t),n.subVectors(e,t),r.cross(n);const g=r.length()/2;g>0&&(i+=g,o.set(0,0,0).add(e).add(t).add(s).multiplyScalar(1/3*g),l.add(o))}i>0?l.multiplyScalar(1/i):a.boundingBox&&a.boundingBox.getCenter(l)}return l}})()},84440:(e,t,s)=>{s.d(t,{Mq:()=>a,Zd:()=>o,_o:()=>l});var i=s(68909);const r=()=>Math.random(),n={},o=(e,t=r())=>(n[t]||(n[t]=new i.Vector4(r(),r(),r(),e)),n[t]),a=()=>new i.Color(r(),r(),r()),l=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e}}]);