{"version":3,"file":"environment.js","sourceRoot":"","sources":["../../src/features/environment.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {property} from 'lit/decorators.js';\nimport {ACESFilmicToneMapping, AgXToneMapping, NeutralToneMapping, Texture} from 'three';\n\nimport ModelViewerElementBase, {$needsRender, $progressTracker, $renderer, $scene, $shouldAttemptPreload} from '../model-viewer-base.js';\nimport {clamp, Constructor, deserializeUrl} from '../utilities.js';\n\nexport const BASE_OPACITY = 0.5;\nconst DEFAULT_SHADOW_INTENSITY = 0.0;\nconst DEFAULT_SHADOW_SOFTNESS = 1.0;\nconst DEFAULT_EXPOSURE = 1.0;\n\nexport type ToneMappingValue = 'auto'|'aces'|'agx'|'commerce'|'neutral';\n\nexport const $currentEnvironmentMap = Symbol('currentEnvironmentMap');\nexport const $currentBackground = Symbol('currentBackground');\nexport const $updateEnvironment = Symbol('updateEnvironment');\nconst $cancelEnvironmentUpdate = Symbol('cancelEnvironmentUpdate');\n\nexport declare interface EnvironmentInterface {\n  environmentImage: string|null;\n  skyboxImage: string|null;\n  skyboxHeight: string;\n  shadowIntensity: number;\n  shadowSoftness: number;\n  exposure: number;\n  hasBakedShadow(): boolean;\n}\n\nexport const EnvironmentMixin = <T extends Constructor<ModelViewerElementBase>>(\n    ModelViewerElement: T): Constructor<EnvironmentInterface>&T => {\n  class EnvironmentModelViewerElement extends ModelViewerElement {\n    @property({type: String, attribute: 'environment-image'})\n    environmentImage: string|null = null;\n\n    @property({type: String, attribute: 'skybox-image'})\n    skyboxImage: string|null = null;\n\n    @property({type: Number, attribute: 'shadow-intensity'})\n    shadowIntensity: number = DEFAULT_SHADOW_INTENSITY;\n\n    @property({type: Number, attribute: 'shadow-softness'})\n    shadowSoftness: number = DEFAULT_SHADOW_SOFTNESS;\n\n    @property({type: Number}) exposure: number = DEFAULT_EXPOSURE;\n\n    @property({type: String, attribute: 'tone-mapping'})\n    toneMapping: ToneMappingValue = 'auto';\n\n    @property({type: String, attribute: 'skybox-height'})\n    skyboxHeight: string = '0';\n\n    protected[$currentEnvironmentMap]: Texture|null = null;\n    protected[$currentBackground]: Texture|null = null;\n\n    private[$cancelEnvironmentUpdate]: ((...args: any[]) => any)|null = null;\n\n    updated(changedProperties: Map<string|number|symbol, unknown>) {\n      super.updated(changedProperties);\n\n      if (changedProperties.has('shadowIntensity')) {\n        this[$scene].setShadowIntensity(this.shadowIntensity * BASE_OPACITY);\n        this[$needsRender]();\n      }\n\n      if (changedProperties.has('shadowSoftness')) {\n        this[$scene].setShadowSoftness(this.shadowSoftness);\n        this[$needsRender]();\n      }\n\n      if (changedProperties.has('exposure')) {\n        this[$scene].exposure = this.exposure;\n        this[$needsRender]();\n      }\n\n      if (changedProperties.has('toneMapping')) {\n        this[$scene].toneMapping = this.toneMapping === 'aces' ?\n            ACESFilmicToneMapping :\n            this.toneMapping === 'agx' ? AgXToneMapping :\n                                         NeutralToneMapping;\n        this[$needsRender]();\n      }\n\n      if ((changedProperties.has('environmentImage') ||\n           changedProperties.has('skyboxImage')) &&\n          this[$shouldAttemptPreload]()) {\n        this[$updateEnvironment]();\n      }\n\n      if (changedProperties.has('skyboxHeight')) {\n        this[$scene].setGroundedSkybox();\n        this[$needsRender]();\n      }\n    }\n\n    hasBakedShadow(): boolean {\n      return this[$scene].bakedShadows.size > 0;\n    }\n\n    async[$updateEnvironment]() {\n      const {skyboxImage, environmentImage} = this;\n\n      if (this[$cancelEnvironmentUpdate] != null) {\n        this[$cancelEnvironmentUpdate]!();\n        this[$cancelEnvironmentUpdate] = null;\n      }\n\n      const {textureUtils} = this[$renderer];\n\n      if (textureUtils == null) {\n        return;\n      }\n\n      const updateEnvProgress =\n          this[$progressTracker].beginActivity('environment-update');\n\n      try {\n        const {environmentMap, skybox} =\n            await textureUtils.generateEnvironmentMapAndSkybox(\n                deserializeUrl(skyboxImage),\n                environmentImage,\n                (progress: number) => updateEnvProgress(clamp(progress, 0, 1)),\n                this.withCredentials);\n\n        if (this[$currentEnvironmentMap] !== environmentMap) {\n          this[$currentEnvironmentMap] = environmentMap;\n          this.dispatchEvent(new CustomEvent('environment-change'));\n        }\n        if (skybox != null) {\n          // When using the same environment and skybox, use the environment as\n          // it gives HDR filtering.\n          this[$currentBackground] =\n              skybox.name === environmentMap.name ? environmentMap : skybox;\n        } else {\n          this[$currentBackground] = null;\n        }\n\n        this[$scene].setEnvironmentAndSkybox(\n            this[$currentEnvironmentMap], this[$currentBackground]);\n      } catch (errorOrPromise) {\n        if (errorOrPromise instanceof Error) {\n          this[$scene].setEnvironmentAndSkybox(null, null);\n          throw errorOrPromise;\n        }\n      } finally {\n        updateEnvProgress(1.0);\n      }\n    }\n  }\n\n  return EnvironmentModelViewerElement;\n};\n"]}